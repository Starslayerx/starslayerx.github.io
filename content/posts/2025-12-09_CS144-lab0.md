+++
date = '2025-12-08T8:00:00+08:00'
draft = true
title = 'CS144 - lab0'
tags = ['Netowrk']
+++

[CS 144: Introduction to Computer Networking, Fall 2025](https://cs144.github.io/)

本篇文章对应 `check0.pdf` 的内容

## 3 Network by hand

### 3.1 Fetch a Web page

这个介绍怎么发送一个 GET 请求

1. `telent cs144.keithw.org http`

   该命令告诉 telnet 打开一个可靠字节流(reliable byte stream)，并在我电脑上运行一个 http 服务

   预计会收到这样的内容

   ```text
   Trying 104.196.238.229...
   Connected to cs144.keithw.org.
   Escape character is '^]'.
   ^]
   telnet> close
   Connection closed.
   ```

   该命令不能使用常见的 `Ctrl-C` 之类方法退出，而是 `Ctrl-]` 然后输入 close

2. `GET /hello HTTP/1.1`

   该命令告诉服务器 URL 的 _path_ 部分

3. `Host: cs144.keithw.org`

   该命令告诉服务器 URL 的 _host_ 部分

4. `Connection: close`

   该命令告诉服务器这是最后一个 HTTP 请求，服务器在发送完最后一字节的响应数据后应主动关闭 TCP 连接

   再按一次回车，会发送一个空行给服务器，表明发送的 HTTP 请求完成了，这会看到和浏览器一样的响应内容
   这不是关闭连接，它只是 HTTP 请求报文语法的结束符

   ```text
   HTTP/1.1 200 OK
   Date: Tue, 09 Dec 2025 07:32:01 GMT
   Server: Apache
   Last-Modified: Thu, 13 Dec 2018 15:45:29 GMT
   ETag: "e-57ce93446cb64"
   Accept-Ranges: bytes
   Content-Length: 14
   Connection: close
   Content-Type: text/plain

   Hello, CS144!
   Connection closed by foreign host.
   ```

   `Connection: close` 属于 HTTP 语义层，告诉服务器：“响应完就关闭连接”

   空行 CRLF 属于 HTTP 报文语法，告诉服务器：“我的请求已经完整，可以开始处理”

### 3.2 Send yourself an email

这个介绍怎么通过 SMTP 协议发送邮件

首先看课程文档里面的步骤：

`ssh sunetid@cardinal.stanford.edu` 这里要用 Stanford 的学生 id 去登陆

1. `telnet 67.231.149.169 smtp`

   使用 SMTP (Simple Mail Transfer Protocol) 服务连接到服务器，应该会显示

   ```text
   Trying 67.231.149.169...
   Connected to 67.231.149.169.
   Escape character is '^]'.
   220 mx0a-00000d07.pphosted.com ESMTP mfa-m0342459
   ```

2. `HELO mycomputer.stanford.edu`

   该命令会建立会话，一般后是个域名或者 `[IP]` 这种形式，也可以自定义字段，但可能会因此被归类为垃圾邮件

   实际上现代的 SMTP 一般都支持 `EHLO` 扩展命令，这里就不详细说了

   会返回类似下面内容

   ```text
   250 ... Hello cardinal3.stanford.edu [171.67.24.75], pleased to meet you
   ```

3. `MAIL FROM: sunetid@stanford.edu`

   这里是明确发送方的 email，由于早期互联网是一个信任网络，因此这里可以随便写

   但现在一般服务器都会去检测，如果是乱写的会被拒绝

   返回如下

   ```text
   250 2.1.0 Sender ok
   ```

4. `RCPT TO: sunetid@stanford.edu`

   这里指定接收人的地址，可以直接指定自己，这样就是自己给自己发邮件

   也可以指定其他任意地址，不过要注意可能会被当成垃圾邮件

   返回内容如下

   ```text
   250 2.1.5 Recipient ok.
   ```

5. `DATA`

   输入该命令后，下面就是信封的文本内容了，如果正常会看到下面输出：

   ```text
   354 End data with <CR><LF>.<CR><LF>
   ```

   现在需要先写好发件人、收件人、主题

   ```text
   From: sunetid@stanford.edu
   To: sunetid@stanford.edu
   Subject: Hello from CS144 Lab 0!

   This is an email sent via SMTP manually! ...
   .
   ```

   这些内容是给人类看的，当然可以随便写，但有些比较严格的服务器会检测这些字段内容。
   如果和上面的 `MAIL FROM: / RCPT TO:` 不一致，可能会被拒收。
   我试了下，qq 邮件会拒收，并会收到拒收码；而网易 126 邮箱就可以随便写。

   ```text
   抱歉，您的信件被退回
   尊敬的用户 **@126.com：
   您发送到 **@qq.com 的邮件被系统退回，以下是退信相关信息：
   因信头from字段拒收邮件
   建议解决方案：建议您检查邮件信头是否包含from字段，from字段中的邮箱地址是否正确，是否存在多个from字段等问题，并进行相应调整。您也可以尝试使用网页版邮箱或邮箱大师发送邮件。如果仍然投递失败，请联系收件方协助调整，或通过网易邮件帮助中心进行反馈问题。
   ------------------------------- 原邮件信息 -------------------------------
   发送时间：2025-12-09 22:08:36
   邮件主题：CS144 - Test Message
   收件地址：**@qq.com
   服务器返回码：
   SMTP error, DOT: Host qq.com(157.255.221.253) DOT said 550 The "From" header is missing or invalid. Please follow RFC5322, RFC2047, RFC822 standard protocol. [MPaFZkPlT3GZDlVMiasbtU2tOYMzMMEOLjt1R3UrOzI24oWss6B56APQJEAznwCF9Q== IP: ***.***.***.*]. https://service.mail.qq.com/detail/124/995.
   ```

   在 Subject 后面的邮件正文，必须要隔一行空格才行，否则解析会出错，最后邮件看不到正文信息。

6. `.`

   单行的点代表结束，会收到下面类似返回

   ```text
   250 2.0.0 33h24dpdsr-1 Message accepted for delivery
   ```

7. `QUIT`

   该命令结束邮件服务器的会话，一般邮件会加入队列，过一会儿才会收到。

好了，上面介绍的是课程文档里面写的，但由于没有 sunetid，也就无法 ssh 到 Standard 去完成该课程实验，但是可以可以通过 126 邮箱完成。

注释一个 126 邮箱，去设置里面找到 POP3/SMTP/IMAP 相关项，把服务给打开，然后弄个授权码，等下可以使用这个连接到 126 服务器（QQ 不行）。

得到授权码后，要对邮件和授权吗进行编码

```text
% echo -n "xxx@126.com" | base64
a********************=

% echo -n "授权码" | base64
T*********************==
```

由于现实中都使用 https，因此无法直接使用 telnet 连接，这里使用 openssl

```text
openssl s_client -connect smtp.126.com:465 -quiet
```

然后通过命令 `HELO` 或 `EHLO` 后面加任意内容建立连接

这里使用上面生成的编码进行验证：

```text
AUTH LOGIN
```

输入验证登陆命令后，复制上面 邮件编码 回车，再复制 授权码编码 回车，这样就登陆成功了，接下来和前面的内容就一样了！

下面简单复制粘贴一个示例参考一下

```text
% openssl s_client -connect smtp.126.com:465 -quiet

Connecting to 220.197.33.216
depth=2 C=US, O=DigiCert Inc, OU=www.digicert.com, CN=DigiCert Global Root G2
verify return:1
depth=1 C=US, O=DigiCert, Inc., CN=GeoTrust G2 TLS CN RSA4096 SHA256 2022 CA1
verify return:1
depth=0 C=CN, ST=Zhejiang, L=Hangzhou, O=NetEase (Hangzhou) Network Co., Ltd, CN=*.126.com
verify return:1
220 126.com Anti-spam GT for Coremail System (126com[20140526])
HELO macbook.sx
250 OK
AUTH LOGIN
334 dXNlcm5hbWU6
a**********************=
334 UGFzc3dvcmQ6
T*********************==
235 Authentication successful
MAIL FROM: <**@126.com>
250 Mail OK
MAIL TO: <**@126.com>
503 bad sequence of commands
RCPT TO: <**@126.com>
250 Mail OK
DATA
354 End data with <CR><LF>.<CR><LF>
From: **@126.com
To: **@126.com
Subject: CS144 Test

This is an email sent via SMTP manually!
.
250 Mail OK queued as gzga-smtp-mtada-g1-1,_____wD3f1hH6DdpREvXAQ--.30649S2 1765271741
QUIT
221 Bye
00488F0302000000:error:0A000126:SSL routines::unexpected eof while reading:ssl/record/rec_layer_s3.c:701:
00488F0302000000:error:0A000197:SSL routines:SSL_shutdown:shutdown while in init:ssl/ssl_lib.c:2834:
```

### 3.3 Listening and Connecting

之前的实验都是通过 telnet 运行的 **client** 程序，下面来运行一个 **server** 程序

```text
netcat -v -l -p 9090
```

然后再开一个窗口，连接到该服务器

```text
telnet localhost 9090
```

应该会看到 server 输出 `Connection fromlocalhost 53500 received!` 这样的内容，在两个窗口里输出任何内容回车，会立刻显示在两个窗口中，在 netcat 窗口按 `Ctrl-C` 会使两个窗口都被关闭。

## 4 Writing a network program using an OS system socket
