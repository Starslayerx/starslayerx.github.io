<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Claude Code 分析 06：新颖组件 | Starslayerx&#39; Blog</title>
<meta name="keywords" content="Agent">
<meta name="description" content="✨ 新颖组件：定义 Claude Code 的创新
graph TB
    subgraph &#34;流式处理挑战&#34;
        PartialJSON[部分 JSON 流]
        PartialXML[部分 XML 流]
        Progress[并发进度]

        PartialJSON --&gt; Parser1[流式 JSON 解析器]
        PartialXML --&gt; Parser2[自定义 XML 解析器]
        Progress --&gt; Aggregator[进度聚合器]
    end

    subgraph &#34;数据挑战&#34;
        LargeObjects[大型对象]
        Circular[循环引用]
        TypedData[特殊类型]

        LargeObjects --&gt; Normalizer[normalizeToSize]
        Circular --&gt; Normalizer
        TypedData --&gt; Normalizer
    end

    subgraph &#34;LLM 挑战&#34;
        Errors[工具错误]
        Context[动态上下文]
        Synthesis[多结果合成]

        Errors --&gt; Formatter[错误格式化器]
        Context --&gt; Assembler[上下文组装器]
        Synthesis --&gt; Synthesizer[AgentTool 合成器]
    end
流式 JSON 解析器：处理 LLM 的部分思考
当 LLM 流式传输工具使用请求时，它不会一次性发送完整的 JSON。相反，你可能会收到这样的片段：">
<meta name="author" content="Starslayerx">
<link rel="canonical" href="http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-06%E6%96%B0%E9%A2%96%E7%BB%84%E4%BB%B6/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css" integrity="sha256-2jIR5e&#43;Ge/K3X9WmUVz&#43;1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.svg">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon.svg">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon.svg">
<link rel="mask-icon" href="http://localhost:1313/favicon.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-06%E6%96%B0%E9%A2%96%E7%BB%84%E4%BB%B6/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-06%E6%96%B0%E9%A2%96%E7%BB%84%E4%BB%B6/">
  <meta property="og:site_name" content="Starslayerx&#39; Blog">
  <meta property="og:title" content="Claude Code 分析 06：新颖组件">
  <meta property="og:description" content="✨ 新颖组件：定义 Claude Code 的创新 graph TB subgraph &#34;流式处理挑战&#34; PartialJSON[部分 JSON 流] PartialXML[部分 XML 流] Progress[并发进度] PartialJSON --&gt; Parser1[流式 JSON 解析器] PartialXML --&gt; Parser2[自定义 XML 解析器] Progress --&gt; Aggregator[进度聚合器] end subgraph &#34;数据挑战&#34; LargeObjects[大型对象] Circular[循环引用] TypedData[特殊类型] LargeObjects --&gt; Normalizer[normalizeToSize] Circular --&gt; Normalizer TypedData --&gt; Normalizer end subgraph &#34;LLM 挑战&#34; Errors[工具错误] Context[动态上下文] Synthesis[多结果合成] Errors --&gt; Formatter[错误格式化器] Context --&gt; Assembler[上下文组装器] Synthesis --&gt; Synthesizer[AgentTool 合成器] end 流式 JSON 解析器：处理 LLM 的部分思考 当 LLM 流式传输工具使用请求时，它不会一次性发送完整的 JSON。相反，你可能会收到这样的片段：">
  <meta property="og:locale" content="en-US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-14T14:00:00+01:00">
    <meta property="article:modified_time" content="2025-11-14T14:00:00+01:00">
    <meta property="article:tag" content="Agent">
      <meta property="og:image" content="http://localhost:1313/images/og-default.avif">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/images/og-default.avif">
<meta name="twitter:title" content="Claude Code 分析 06：新颖组件">
<meta name="twitter:description" content="✨ 新颖组件：定义 Claude Code 的创新
graph TB
    subgraph &#34;流式处理挑战&#34;
        PartialJSON[部分 JSON 流]
        PartialXML[部分 XML 流]
        Progress[并发进度]

        PartialJSON --&gt; Parser1[流式 JSON 解析器]
        PartialXML --&gt; Parser2[自定义 XML 解析器]
        Progress --&gt; Aggregator[进度聚合器]
    end

    subgraph &#34;数据挑战&#34;
        LargeObjects[大型对象]
        Circular[循环引用]
        TypedData[特殊类型]

        LargeObjects --&gt; Normalizer[normalizeToSize]
        Circular --&gt; Normalizer
        TypedData --&gt; Normalizer
    end

    subgraph &#34;LLM 挑战&#34;
        Errors[工具错误]
        Context[动态上下文]
        Synthesis[多结果合成]

        Errors --&gt; Formatter[错误格式化器]
        Context --&gt; Assembler[上下文组装器]
        Synthesis --&gt; Synthesizer[AgentTool 合成器]
    end
流式 JSON 解析器：处理 LLM 的部分思考
当 LLM 流式传输工具使用请求时，它不会一次性发送完整的 JSON。相反，你可能会收到这样的片段：">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Claude Code 分析 06：新颖组件",
      "item": "http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-06%E6%96%B0%E9%A2%96%E7%BB%84%E4%BB%B6/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Claude Code 分析 06：新颖组件",
  "name": "Claude Code 分析 06：新颖组件",
  "description": "✨ 新颖组件：定义 Claude Code 的创新 graph TB subgraph \u0026#34;流式处理挑战\u0026#34; PartialJSON[部分 JSON 流] PartialXML[部分 XML 流] Progress[并发进度] PartialJSON --\u0026gt; Parser1[流式 JSON 解析器] PartialXML --\u0026gt; Parser2[自定义 XML 解析器] Progress --\u0026gt; Aggregator[进度聚合器] end subgraph \u0026#34;数据挑战\u0026#34; LargeObjects[大型对象] Circular[循环引用] TypedData[特殊类型] LargeObjects --\u0026gt; Normalizer[normalizeToSize] Circular --\u0026gt; Normalizer TypedData --\u0026gt; Normalizer end subgraph \u0026#34;LLM 挑战\u0026#34; Errors[工具错误] Context[动态上下文] Synthesis[多结果合成] Errors --\u0026gt; Formatter[错误格式化器] Context --\u0026gt; Assembler[上下文组装器] Synthesis --\u0026gt; Synthesizer[AgentTool 合成器] end 流式 JSON 解析器：处理 LLM 的部分思考 当 LLM 流式传输工具使用请求时，它不会一次性发送完整的 JSON。相反，你可能会收到这样的片段：\n",
  "keywords": [
    "Agent"
  ],
  "articleBody": "✨ 新颖组件：定义 Claude Code 的创新 graph TB subgraph \"流式处理挑战\" PartialJSON[部分 JSON 流] PartialXML[部分 XML 流] Progress[并发进度] PartialJSON --\u003e Parser1[流式 JSON 解析器] PartialXML --\u003e Parser2[自定义 XML 解析器] Progress --\u003e Aggregator[进度聚合器] end subgraph \"数据挑战\" LargeObjects[大型对象] Circular[循环引用] TypedData[特殊类型] LargeObjects --\u003e Normalizer[normalizeToSize] Circular --\u003e Normalizer TypedData --\u003e Normalizer end subgraph \"LLM 挑战\" Errors[工具错误] Context[动态上下文] Synthesis[多结果合成] Errors --\u003e Formatter[错误格式化器] Context --\u003e Assembler[上下文组装器] Synthesis --\u003e Synthesizer[AgentTool 合成器] end 流式 JSON 解析器：处理 LLM 的部分思考 当 LLM 流式传输工具使用请求时，它不会一次性发送完整的 JSON。相反，你可能会收到这样的片段：\n{\"file_path\": \"/src/ {\"file_path\": \"/src/main. {\"file_path\": \"/src/main.ts\", \"old_str {\"file_path\": \"/src/main.ts\", \"old_string\": \"console.log('hell 流式 JSON 解析器优雅地解决了这个问题：\nclass StreamingToolInputParser { private buffer: string = ''; private state = { depth: 0, // {} 或 [] 的嵌套层级 inString: boolean, // 当前是否在字符串内？ escape: boolean, // 前一个字符是反斜杠？ stringChar: '\"' | \"'\" | null, // 哪个引号开始了当前字符串 }; addChunk(chunk: string): ParseResult { this.buffer += chunk; // 逐字符更新解析器状态 for (let i = 0; i \u003c chunk.length; i++) { const char = chunk[i]; const prevChar = i \u003e 0 ? chunk[i-1] : this.buffer[this.buffer.length - chunk.length - 1]; // 处理转义序列 if (this.escape) { this.escape = false; continue; } if (char === '\\\\\\\\' \u0026\u0026 this.state.inString) { this.escape = true; continue; } // 字符串边界检测 if (!this.state.inString \u0026\u0026 (char === '\"' || char === \"'\")) { this.state.inString = true; this.state.stringChar = char; } else if (this.state.inString \u0026\u0026 char === this.state.stringChar) { this.state.inString = false; this.state.stringChar = null; } // 在字符串外跟踪嵌套深度 if (!this.state.inString) { if (char === '{' || char === '[') { this.state.depth++; } else if (char === '}' || char === ']') { this.state.depth--; // 当我们返回到深度 0 时尝试解析 if (this.state.depth === 0) { return this.tryParse(); } } } } // 即使没有达到深度 0 也可能是完整的（格式错误的 JSON） if (this.buffer.length \u003e 10000) { // 安全限制 return this.tryParseWithRecovery(); } return { complete: false }; } private tryParse(): ParseResult { try { const parsed = JSON.parse(this.buffer); return { complete: true, value: parsed }; } catch (e) { return { complete: false, partial: this.buffer }; } } private tryParseWithRecovery(): ParseResult { let attemptBuffer = this.buffer; // 恢复策略 1：关闭未闭合的字符串 if (this.state.inString \u0026\u0026 this.state.stringChar) { attemptBuffer += this.state.stringChar; // 尝试关闭所有未闭合的结构 attemptBuffer += '}'.repeat(Math.max(0, this.state.depth)); attemptBuffer += ']'.repeat( Math.max(0, (attemptBuffer.match(/\\[/g) || []).length - (attemptBuffer.match(/\\]/g) || []).length) ); } // 恢复策略 2：基于结构分析自动关闭 const braceBalance = (attemptBuffer.match(/{/g) || []).length - (attemptBuffer.match(/}/g) || []).length; const bracketBalance = (attemptBuffer.match(/\\[/g) || []).length - (attemptBuffer.match(/\\]/g) || []).length; attemptBuffer += '}'.repeat(Math.max(0, braceBalance)); attemptBuffer += ']'.repeat(Math.max(0, bracketBalance)); try { const parsed = JSON.parse(attemptBuffer); return { complete: true, value: parsed, wasRepaired: true, repairs: { closedStrings: this.state.inString, addedBraces: braceBalance, addedBrackets: bracketBalance } }; } catch (e) { // 恢复策略 3：提取我们能提取的内容 const partialResult = this.extractPartialData(this.buffer); return { complete: false, partial: partialResult, error: e.message }; } } private extractPartialData(buffer: string): any { // 尝试提取完整的键值对 const result: any = {}; const keyValuePattern = /\"(\\w+)\":\\s*(\"([^\"\\\\]*(\\\\.[^\"\\\\]*)*)\"|true|false|null|\\d+)/g; let match; while ((match = keyValuePattern.exec(buffer)) !== null) { const [, key, value] = match; try { result[key] = JSON.parse(value); } catch { result[key] = value; // 如果解析失败则存储为字符串 } } return Object.keys(result).length \u003e 0 ? result : null; } } 为什么这是创新的：\n传统的 JSON 解析器在不完整的输入上会失败 这个解析器提供渐进式解析，并产生有意义的部分结果 恢复策略处理常见的 LLM 流式问题 使响应式 UI 能够在工具输入流式传输时显示它们 性能特征：\n输入大小 解析时间 内存 成功率 \u003c1KB \u003c0.1ms O(n) 100% 1-10KB 0.1-1ms O(n) 99.9% 10-100KB 1-10ms O(n) 99.5% \u003e100KB 10-50ms O(n) 98%（含恢复） normalizeToSize 算法：智能数据截断 当向 LLM 或遥测服务发送数据时，大小限制至关重要。normalizeToSize 算法智能地减少对象大小，同时保留结构：\nclass DataNormalizer { static normalizeToSize( obj: any, maxDepth: number = 3, maxSizeInBytes: number = 100_000 ): any { // 首先尝试完整深度 let normalized = this.normalize(obj, maxDepth); let size = this.estimateSize(normalized); // 迭代减少深度直到大小适合 while (size \u003e maxSizeInBytes \u0026\u0026 maxDepth \u003e 0) { maxDepth--; normalized = this.normalize(obj, maxDepth); size = this.estimateSize(normalized); } return normalized; } private static normalize( obj: any, maxDepth: number, currentDepth: number = 0, visited = new WeakSet() ): any { // 处理原始类型 if (obj === null) return '[null]'; if (obj === undefined) return '[undefined]'; if (typeof obj === 'number' \u0026\u0026 isNaN(obj)) return '[NaN]'; if (typeof obj === 'bigint') return `[BigInt: ${obj}n]`; // 处理函数和符号 if (typeof obj === 'function') { return `[Function: ${obj.name || 'anonymous'}]`; } if (typeof obj === 'symbol') { return `[Symbol: ${obj.description || 'Symbol'}]`; } // 原始类型直接传递 if (['string', 'number', 'boolean'].includes(typeof obj)) { return obj; } // 达到深度限制 if (currentDepth \u003e= maxDepth) { if (Array.isArray(obj)) return `[Array(${obj.length})]`; if (obj.constructor?.name) { return `[${obj.constructor.name}]`; } return '[Object]'; } // 循环引用检测 if (visited.has(obj)) { return '[Circular]'; } visited.add(obj); // 已知类型的特殊处理 if (this.isReactElement(obj)) { return `[React.${obj.type?.name || obj.type || 'Element'}]`; } if (this.isVueComponent(obj)) { return `[Vue.${obj.$options?.name || 'Component'}]`; } if (obj instanceof Error) { return { name: obj.name, message: obj.message, stack: this.truncateStack(obj.stack) }; } if (obj instanceof Date) { return obj.toISOString(); } if (obj instanceof RegExp) { return obj.toString(); } // 处理 DOM 元素 if (this.isDOMElement(obj)) { return `[${obj.tagName}${obj.id ? '#' + obj.id : ''}]`; } // 处理 toJSON 方法 if (typeof obj.toJSON === 'function') { try { return this.normalize( obj.toJSON(), maxDepth, currentDepth, visited ); } catch { return '[Object with toJSON error]'; } } // 数组 if (Array.isArray(obj)) { const result = []; const maxItems = 100; // 限制数组大小 for (let i = 0; i \u003c Math.min(obj.length, maxItems); i++) { result.push( this.normalize(obj[i], maxDepth, currentDepth + 1, visited) ); } if (obj.length \u003e maxItems) { result.push(`... ${obj.length - maxItems} more items`); } return result; } // 对象 const result: any = {}; const keys = Object.keys(obj); const maxProps = 50; // 限制对象属性 // 遵守 Sentry 指令 if (obj.__sentry_skip_normalization__) { return obj; } const effectiveMaxDepth = obj.__sentry_override_normalization_depth__ || maxDepth; for (let i = 0; i \u003c Math.min(keys.length, maxProps); i++) { const key = keys[i]; try { result[key] = this.normalize( obj[key], effectiveMaxDepth, currentDepth + 1, visited ); } catch { result[key] = '[Error accessing property]'; } } if (keys.length \u003e maxProps) { result['...'] = `${keys.length - maxProps} more properties`; } return result; } private static estimateSize(obj: any): number { // 快速估算而不需要完整序列化 const sample = JSON.stringify(obj).substring(0, 1000); const avgCharSize = new Blob([sample]).size / sample.length; const fullLength = this.estimateJsonLength(obj); return Math.ceil(fullLength * avgCharSize); } private static estimateJsonLength(obj: any, visited = new WeakSet()): number { if (obj === null || obj === undefined) return 4; // \"null\" if (typeof obj === 'boolean') return obj ? 4 : 5; // \"true\" : \"false\" if (typeof obj === 'number') return String(obj).length; if (typeof obj === 'string') return obj.length + 2; // 引号 if (visited.has(obj)) return 12; // \"[Circular]\" visited.add(obj); if (Array.isArray(obj)) { let length = 2; // [] for (const item of obj) { length += this.estimateJsonLength(item, visited) + 1; // 逗号 } return length; } if (typeof obj === 'object') { let length = 2; // {} for (const key in obj) { length += key.length + 3; // \"key\": length += this.estimateJsonLength(obj[key], visited) + 1; // 逗号 } return length; } return 10; // 默认估算 } } 为什么这是创新的：\n基于实际字节大小的迭代深度减少 针对特殊对象的类型感知字符串化 尊重框架特定的对象（React、Vue） 使用 WeakSet 进行循环检测的内存高效方案 在约束内尽可能保留信息 使用场景：\n// LLM 上下文准备 const context = normalizeToSize( largeProjectState, 10, // 从深度 10 开始 50_000 // 上下文的 50KB 限制 ); // 遥测错误报告 const errorContext = normalizeToSize( applicationState, 5, // 合理的深度 10_000 // 错误报告的 10KB ); AgentTool 合成：编排多个视角 AgentTool 不仅仅是运行子代理——它智能地组合它们的结果：\nclass AgentToolSynthesizer { static async synthesizeResults( results: SubAgentResult[], originalTask: string, context: ToolUseContext ): Promise\u003cstring\u003e { // 单个结果 - 不需要合成 if (results.length === 1) { return results[0].content; } // 准备合成上下文 const synthesisData = this.prepareSynthesisData(results); // 计算合成的 token 预算 const tokenBudget = this.calculateSynthesisTokenBudget( results, originalTask ); // 构建合成提示 const synthesisPrompt = this.buildSynthesisPrompt( originalTask, synthesisData, tokenBudget ); // 使用快速模型进行合成 const synthesizer = new SubAgentExecutor({ prompt: synthesisPrompt, model: 'claude-3-haiku-20240307', maxTokens: tokenBudget.output, isSynthesis: true, temperature: 0.3 // 较低的温度用于事实合成 }); return synthesizer.execute(); } private static prepareSynthesisData( results: SubAgentResult[] ): SynthesisData { // 从每个结果中提取关键信息 const data = results.map((result, index) =\u003e ({ agentId: index + 1, content: result.content, keyFindings: this.extractKeyFindings(result.content), toolsUsed: result.toolsUsed, confidence: this.assessConfidence(result), tokensUsed: result.usage.total_tokens, uniqueInsights: [] })); // 识别代理之间的独特见解 this.identifyUniqueInsights(data); // 找到共识和分歧 const consensus = this.findConsensus(data); const conflicts = this.findConflicts(data); return { agents: data, consensus, conflicts, coverageMap: this.buildCoverageMap(data) }; } private static buildSynthesisPrompt( originalTask: string, data: SynthesisData, tokenBudget: TokenBudget ): string { return `You are a synthesis agent tasked with combining findings from ${data.agents.length} independent investigations. ## Original Task ${originalTask} ## Investigation Results ${data.agents.map(agent =\u003e ` ### Agent ${agent.agentId} Findings **Tools Used**: ${agent.toolsUsed.join(', ') || 'None'} **Confidence**: ${agent.confidence}/5 **Token Efficiency**: ${agent.tokensUsed} tokens ${agent.content} **Key Points**: ${agent.keyFindings.map(f =\u003e `- ${f}`).join('\\n')} `).join('\\n---\\n')} ## Consensus Points ${data.consensus.map(c =\u003e `- ${c.point} (agreed by ${c.agentIds.join(', ')})`).join('\\n')} ## Conflicting Information ${data.conflicts.map(c =\u003e `- ${c.description}`).join('\\n') || 'No conflicts found.'} ## Coverage Analysis ${this.formatCoverageMap(data.coverageMap)} ## Your Task Synthesize these findings into a single, comprehensive response that: 1. Presents a unified view of the findings 2. Highlights areas of agreement 3. Notes any contradictions or uncertainties 4. Provides the most complete answer to the original task Keep your response under ${tokenBudget.output} tokens. Focus on actionable insights and concrete findings. `; } private static extractKeyFindings(content: string): string[] { // 使用启发式方法提取关键点 const findings: string[] = []; // 查找项目符号点 const bulletPoints = content.match(/^[\\s-*•]+(.+)$/gm) || []; findings.push(...bulletPoints.map(b =\u003e b.trim())); // 查找编号列表 const numberedItems = content.match(/^\\d+\\.\\s+(.+)$/gm) || []; findings.push(...numberedItems.map(n =\u003e n.replace(/^\\d+\\.\\s+/, ''))); // 查找结论标记 const conclusions = content.match( /(?:concluded?|found|discovered|determined):\\s*(.+?)(?:\\.|$)/gi ) || []; findings.push(...conclusions); // 限制并去重 return [...new Set(findings)].slice(0, 5); } private static assessConfidence(result: SubAgentResult): number { let confidence = 3; // 基线 // 更多工具使用提高置信度 if (result.toolsUsed.length \u003e 3) confidence++; if (result.toolsUsed.length \u003e 5) confidence++; // 错误降低置信度 if (result.hadErrors) confidence--; // 基于结果模式的置信度 if (result.content.includes('unable to') || result.content.includes('could not find')) { confidence--; } if (result.content.includes('successfully') || result.content.includes('confirmed')) { confidence++; } return Math.max(1, Math.min(5, confidence)); } private static identifyUniqueInsights(data: AgentData[]): void { // 构建见解的频率映射 const insightFrequency = new Map\u003cstring, number\u003e(); for (const agent of data) { for (const finding of agent.keyFindings) { const normalized = this.normalizeInsight(finding); insightFrequency.set( normalized, (insightFrequency.get(normalized) || 0) + 1 ); } } // 标记独特的见解 for (const agent of data) { agent.uniqueInsights = agent.keyFindings.filter(finding =\u003e { const normalized = this.normalizeInsight(finding); return insightFrequency.get(normalized) === 1; }); } } } 为什么这是创新的：\n超越简单的连接，实现智能合成 跨代理提取和比较关键发现 识别共识和冲突 使用专用的合成模型以提高效率 保留独特见解同时消除冗余 错误格式化管道：使失败可操作 错误需要为 LLM 和人类以不同方式格式化：\nclass ErrorFormatter { static formatToolErrorContent( error: any, tool: ToolDefinition, context?: ErrorContext ): ContentBlock[] { const errorType = this.classifyError(error); const formatter = this.formatters[errorType] || this.defaultFormatter; return formatter(error, tool, context); } private static formatters = { shell: (error: ShellError, tool: ToolDefinition): ContentBlock[] =\u003e { const blocks: ContentBlock[] = []; // 主要错误消息 blocks.push({ type: 'text', text: `Tool '${tool.name}' failed with exit code ${error.exitCode}` }); // 如果存在，包含 stdout if (error.stdout \u0026\u0026 error.stdout.trim()) { blocks.push({ type: 'text', text: `stdout:\\n\\`\\`\\`\\n${this.truncateOutput(error.stdout)}\\n\\`\\`\\`` }); } // 如果存在，包含 stderr if (error.stderr \u0026\u0026 error.stderr.trim()) { blocks.push({ type: 'text', text: `stderr:\\n\\`\\`\\`\\n${this.truncateOutput(error.stderr)}\\n\\`\\`\\`` }); } // 添加上下文提示 const hints = this.generateShellErrorHints(error); if (hints.length \u003e 0) { blocks.push({ type: 'text', text: `\\nPossible issues:\\n${hints.map(h =\u003e `- ${h}`).join('\\n')}` }); } // 建议替代方案 const suggestions = this.generateShellSuggestions(error); if (suggestions.length \u003e 0) { blocks.push({ type: 'text', text: `\\nSuggestions:\\n${suggestions.map(s =\u003e `- ${s}`).join('\\n')}` }); } return blocks; }, validation: (error: ZodError, tool: ToolDefinition): ContentBlock[] =\u003e { const issues = error.issues.map(issue =\u003e { const path = issue.path.join('.'); const fieldName = path || 'input'; // 基于错误类型的格式化 switch (issue.code) { case 'invalid_type': return `- ${fieldName}: Expected ${issue.expected}, received ${issue.received}`; case 'too_small': if (issue.type === 'string') { return `- ${fieldName}: Must be at least ${issue.minimum} characters`; } else if (issue.type === 'array') { return `- ${fieldName}: Must have at least ${issue.minimum} items`; } return `- ${fieldName}: Value too small`; case 'too_big': if (issue.type === 'string') { return `- ${fieldName}: Must be at most ${issue.maximum} characters`; } return `- ${fieldName}: Value too large`; case 'invalid_enum_value': return `- ${fieldName}: Must be one of: ${issue.options.join(', ')}`; case 'custom': return `- ${fieldName}: ${issue.message}`; default: return `- ${fieldName}: ${issue.message}`; } }); return [{ type: 'text', text: `Tool '${tool.name}' input validation failed:\\n${issues.join('\\n')}\\n\\nPlease check your input parameters and try again.` }]; }, permission: (error: PermissionError, tool: ToolDefinition): ContentBlock[] =\u003e { const blocks: ContentBlock[] = []; blocks.push({ type: 'text', text: `Permission denied for ${tool.name}` }); if (error.reason) { blocks.push({ type: 'text', text: `Reason: ${error.reason}` }); } if (error.rule) { blocks.push({ type: 'text', text: `Denied by rule: ${error.rule.scope}:${error.rule.pattern}` }); } // 提供可操作的指导 if (error.suggestions \u0026\u0026 error.suggestions.length \u003e 0) { blocks.push({ type: 'text', text: `\\nTo proceed, you could:\\n${error.suggestions.map(s =\u003e `- ${s}`).join('\\n')}` }); } else { blocks.push({ type: 'text', text: '\\nThis operation requires explicit user permission. Please ask the user if they want to proceed.' }); } return blocks; }, filesystem: (error: FileSystemError, tool: ToolDefinition): ContentBlock[] =\u003e { const blocks: ContentBlock[] = []; blocks.push({ type: 'text', text: `File system error in ${tool.name}: ${error.code}` }); // 基于错误代码的具体指导 const guidance = { 'ENOENT': 'File or directory not found. Check the path exists.', 'EACCES': 'Permission denied. The file may be read-only or require elevated permissions.', 'EEXIST': 'File already exists. Consider using a different name or checking before creating.', 'EISDIR': 'Expected a file but found a directory.', 'ENOTDIR': 'Expected a directory but found a file.', 'EMFILE': 'Too many open files. Some file handles may need to be closed.', 'ENOSPC': 'No space left on device.', 'EROFS': 'Read-only file system.' }; if (guidance[error.code]) { blocks.push({ type: 'text', text: guidance[error.code] }); } if (error.path) { blocks.push({ type: 'text', text: `Path: ${error.path}` }); } return blocks; } }; private static generateShellErrorHints(error: ShellError): string[] { const hints: string[] = []; // 命令未找到 if (error.stderr?.includes('command not found') || error.stderr?.includes('not found')) { hints.push('The command may not be installed or not in PATH'); // 建议常见的替代方案 const command = error.command.split(' ')[0]; const alternatives = { 'python': 'Try python3 instead', 'pip': 'Try pip3 instead', 'node': 'Node.js may not be installed', 'npm': 'npm may not be installed' }; if (alternatives[command]) { hints.push(alternatives[command]); } } // 权限被拒绝 if (error.stderr?.includes('Permission denied') || error.stderr?.includes('Operation not permitted')) { hints.push('Try running with different permissions or in a different directory'); hints.push('Check if the file/directory has the correct ownership'); } // 网络错误 if (error.stderr?.includes('Could not resolve host') || error.stderr?.includes('Connection refused')) { hints.push('Network connectivity issue detected'); hints.push('Check if you need to set sandbox=false for network access'); } return hints; } private static truncateOutput(output: string, maxLength: number = 1000): string { if (output.length \u003c= maxLength) return output; // 尝试在换行符处截断 const truncatePoint = output.lastIndexOf('\\n', maxLength); const actualTruncate = truncatePoint \u003e maxLength * 0.8 ? truncatePoint : maxLength; return output.substring(0, actualTruncate) + `\\n... (${output.length - actualTruncate} characters truncated)`; } } 为什么这是创新的：\n为 LLM 理解定制的错误消息 包含可操作的建议 保留关键的调试信息（stdout/stderr） 提供上下文感知的提示 将 Zod 验证错误格式化为自然语言 动态上下文组装：智能优先级排序 上下文组装系统超越了简单的连接：\nclass DynamicContextAssembler { private static readonly CONTEXT_PRIORITIES = { baseInstructions: 1, modelAdaptations: 2, claudeMdContent: 3, gitContext: 4, directoryStructure: 5, toolSpecifications: 6, activeSelections: 3.5, // 在 CLAUDE.md 和 git 之间 recentErrors: 2.5 // 错误上下文的高优先级 }; static async assembleSystemPrompt( components: ContextComponents, tokenBudget: number, model: string ): Promise\u003cstring | ContentBlock[]\u003e { // 阶段 1：收集所有带有元数据的组件 const sections = await this.gatherSections(components, model); // 阶段 2：计算 token 成本 const tokenizedSections = await this.tokenizeSections(sections); // 阶段 3：智能截断 const selectedSections = this.selectSections( tokenizedSections, tokenBudget ); // 阶段 4：格式化并组合 return this.formatSystemPrompt(selectedSections); } private static async gatherSections( components: ContextComponents, model: string ): Promise\u003cContextSection[]\u003e { const sections: ContextSection[] = []; // 基础说明（始终包含） sections.push({ priority: this.CONTEXT_PRIORITIES.baseInstructions, content: components.baseInstructions, required: true, type: 'base' }); // 模型特定的适配 const modelAdaptations = await this.getModelAdaptations(model); sections.push({ priority: this.CONTEXT_PRIORITIES.modelAdaptations, content: modelAdaptations, required: true, type: 'model' }); // 具有分层加载的 CLAUDE.md const claudeMdContent = await this.loadClaudeMdHierarchy(); sections.push({ priority: this.CONTEXT_PRIORITIES.claudeMdContent, content: this.formatClaudeMd(claudeMdContent), required: false, type: 'claudemd', metadata: { sources: claudeMdContent.map(c =\u003e c.source), totalSize: claudeMdContent.reduce((sum, c) =\u003e sum + c.content.length, 0) } }); // 带有智能摘要的 Git 上下文 const gitContext = await this.getGitContext(); sections.push({ priority: this.CONTEXT_PRIORITIES.gitContext, content: this.formatGitContext(gitContext), required: false, type: 'git', canSummarize: true, summarizer: () =\u003e this.summarizeGitContext(gitContext) }); // 带有深度控制的目录结构 const dirStructure = await this.getDirectoryStructure(); sections.push({ priority: this.CONTEXT_PRIORITIES.directoryStructure, content: dirStructure.full, required: false, type: 'directory', alternatives: [ { depth: 3, content: dirStructure.depth3 }, { depth: 2, content: dirStructure.depth2 }, { depth: 1, content: dirStructure.depth1 } ] }); // 工具规范 const toolSpecs = await this.formatToolSpecifications(components.tools); sections.push({ priority: this.CONTEXT_PRIORITIES.toolSpecifications, content: toolSpecs.full, required: true, // 工具必须包含 type: 'tools', alternatives: [ { level: 'minimal', content: toolSpecs.minimal }, { level: 'names-only', content: toolSpecs.namesOnly } ] }); return sections; } private static async loadClaudeMdHierarchy(): Promise\u003cClaudeMdContent[]\u003e { const sources = [ { path: '/etc/claude-code/CLAUDE.md', scope: 'managed' }, { path: '~/.claude/CLAUDE.md', scope: 'user' }, { path: '.claude/CLAUDE.md', scope: 'project' }, { path: '.claude/CLAUDE.local.md', scope: 'local' } ]; const contents: ClaudeMdContent[] = []; for (const source of sources) { try { const content = await fs.readFile(source.path, 'utf8'); const processed = await this.processClaudeMd(content, source.scope); contents.push(processed); } catch { // 文件不存在，跳过 } } return this.mergeClaudeMdContents(contents); } private static async processClaudeMd( content: string, scope: string ): Promise\u003cClaudeMdContent\u003e { // 处理 @mentions 以进行包含 const processed = await this.resolveMentions(content); // 提取指令 const directives = this.extractDirectives(processed); return { scope, content: processed, directives, source: scope }; } private static mergeClaudeMdContents( contents: ClaudeMdContent[] ): ClaudeMdContent[] { const merged: ClaudeMdContent[] = []; const overrides = new Map\u003cstring, string\u003e(); // 以相反的顺序处理（本地覆盖受管理的） for (let i = contents.length - 1; i \u003e= 0; i--) { const content = contents[i]; // 处理 @override 指令 for (const directive of content.directives) { if (directive.type === 'override') { overrides.set(directive.key, content.scope); } } // 如果未被覆盖，包含内容 const isOverridden = Array.from(overrides.entries()).some( ([key, scope]) =\u003e content.content.includes(key) \u0026\u0026 scope !== content.scope ); if (!isOverridden) { merged.unshift(content); } } return merged; } private static selectSections( sections: TokenizedSection[], budget: number ): TokenizedSection[] { // 按优先级排序 const sorted = [...sections].sort((a, b) =\u003e a.priority - b.priority); const selected: TokenizedSection[] = []; let usedTokens = 0; // 第一遍：包含所有必需的部分 for (const section of sorted) { if (section.required) { selected.push(section); usedTokens += section.tokenCount; } } // 第二遍：按优先级包含可选部分 for (const section of sorted) { if (!section.required \u0026\u0026 usedTokens + section.tokenCount \u003c= budget) { selected.push(section); usedTokens += section.tokenCount; } else if (!section.required \u0026\u0026 section.alternatives) { // 尝试替代方案 for (const alt of section.alternatives) { if (usedTokens + alt.tokenCount \u003c= budget) { selected.push({ ...section, content: alt.content, tokenCount: alt.tokenCount }); usedTokens += alt.tokenCount; break; } } } } return selected; } } 为什么这是创新的：\n基于优先级的截断保留最重要的上下文 具有覆盖语义的分层 CLAUDE.md 加载 动态替代方案（例如，目录深度减少） 模型特定的提示适配 智能摘要回退 内存管理模式：保持精简 Claude Code 实现了复杂的内存管理：\nclass MemoryManager { // 模式 1：大对象的弱引用 private static fileCache = new Map\u003cstring, WeakRef\u003cFileContent\u003e\u003e(); private static registry = new FinalizationRegistry((key: string) =\u003e { console.debug(`Garbage collected: ${key}`); this.fileCache.delete(key); }); static cacheFile(path: string, content: FileContent) { // 存储弱引用 const ref = new WeakRef(content); this.fileCache.set(path, ref); // 注册清理通知 this.registry.register(content, path); } static getFile(path: string): FileContent | null { const ref = this.fileCache.get(path); if (!ref) return null; const content = ref.deref(); if (!content) { // 已被垃圾回收 this.fileCache.delete(path); return null; } return content; } // 模式 2：带反压的流式处理 static async *streamLargeFile( path: string, options: StreamOptions = {} ): AsyncGenerator\u003cBuffer\u003e { const highWaterMark = options.chunkSize || 64 * 1024; // 64KB 块 const stream = createReadStream(path, { highWaterMark }); let totalRead = 0; let isPaused = false; for await (const chunk of stream) { totalRead += chunk.length; // 检查内存压力 const memUsage = process.memoryUsage(); if (memUsage.heapUsed / memUsage.heapTotal \u003e 0.9) { if (!isPaused) { console.warn('High memory pressure, pausing stream'); stream.pause(); isPaused = true; // 如果可用，强制垃圾回收 if (global.gc) { global.gc(); } // 等待内存释放 await new Promise(resolve =\u003e setTimeout(resolve, 100)); } } else if (isPaused) { stream.resume(); isPaused = false; } yield chunk; // 定期让步给事件循环 if (totalRead % (1024 * 1024) === 0) { // 每 MB await new Promise(resolve =\u003e setImmediate(resolve)); } } } // 模式 3：频繁分配的对象池 static bufferPool = new BufferPool({ size: 100, bufferSize: 64 * 1024 }); // 模式 4：内存压力检测 static monitorMemoryPressure() { setInterval(() =\u003e { const usage = process.memoryUsage(); const heapPercent = usage.heapUsed / usage.heapTotal; const rssGB = usage.rss / 1024 / 1024 / 1024; if (heapPercent \u003e 0.85) { console.warn(`High heap usage: ${(heapPercent * 100).toFixed(1)}%`); // 触发清理操作 this.performMemoryCleanup(); } if (rssGB \u003e 2) { console.warn(`High RSS memory: ${rssGB.toFixed(2)}GB`); } }, 5000); } private static performMemoryCleanup() { // 清除非必要的缓存 if (this.patternCache) { this.patternCache.clear(); } // 如果需要，压缩对话 if (ConversationManager.shouldCompact()) { ConversationManager.triggerCompaction(); } // 如果可用，强制 GC if (global.gc) { const before = process.memoryUsage().heapUsed; global.gc(); const after = process.memoryUsage().heapUsed; console.debug(`GC freed ${((before - after) / 1024 / 1024).toFixed(1)}MB`); } } } // 缓冲池实现 class BufferPool { private available: Buffer[] = []; private inUse = new WeakMap\u003cBuffer, boolean\u003e(); constructor(private config: BufferPoolConfig) { // 预分配缓冲区 for (let i = 0; i \u003c config.size; i++) { this.available.push(Buffer.allocUnsafe(config.bufferSize)); } } acquire(): Buffer { let buffer = this.available.pop(); if (!buffer) { // 池耗尽，分配新的 console.warn('Buffer pool exhausted, allocating new buffer'); buffer = Buffer.allocUnsafe(this.config.bufferSize); } this.inUse.set(buffer, true); return buffer; } release(buffer: Buffer) { if (!this.inUse.has(buffer)) { throw new Error('Buffer not from this pool'); } this.inUse.delete(buffer); // 为安全起见清除缓冲区内容 buffer.fill(0); if (this.available.length \u003c this.config.size) { this.available.push(buffer); } } } 为什么这是创新的：\n弱引用允许大型缓存文件的自动清理 带反压的流式处理防止内存耗尽 缓冲池减少分配开销 主动的内存压力监控和响应 权限规则编译：快速安全决策 权限系统编译规则以进行高效评估：\nclass PermissionRuleCompiler { private compiledRules = new Map\u003cstring, CompiledRule\u003e(); compile(rule: string): CompiledRule { // 检查缓存 if (this.compiledRules.has(rule)) { return this.compiledRules.get(rule)!; } // 解析规则语法 const parsed = this.parseRule(rule); const compiled = this.compileRule(parsed); this.compiledRules.set(rule, compiled); return compiled; } private parseRule(rule: string): ParsedRule { // 规则格式： // - ToolName // - ToolName(path/pattern) // - ToolName(path/pattern, condition) // - @tag:ToolName const patterns = { simple: /^(\\w+)$/, withPath: /^(\\w+)\\(([^,)]+)\\)$/, withCondition: /^(\\w+)\\(([^,]+),\\s*(.+)\\)$/, tagged: /^@(\\w+):(.+)$/ }; // 首先尝试标记格式 const taggedMatch = rule.match(patterns.tagged); if (taggedMatch) { const [, tag, rest] = taggedMatch; const innerRule = this.parseRule(rest); return { ...innerRule, tags: [tag] }; } // 尝试带条件 const conditionMatch = rule.match(patterns.withCondition); if (conditionMatch) { const [, tool, path, condition] = conditionMatch; return { tool, path, condition: this.parseCondition(condition), tags: [] }; } // 尝试带路径 const pathMatch = rule.match(patterns.withPath); if (pathMatch) { const [, tool, path] = pathMatch; return { tool, path, tags: [] }; } // 简单的工具名称 const simpleMatch = rule.match(patterns.simple); if (simpleMatch) { return { tool: simpleMatch[1], tags: [] }; } throw new Error(`Invalid rule syntax: ${rule}`); } private compileRule(parsed: ParsedRule): CompiledRule { const compiled: CompiledRule = { original: parsed, matchers: {}, evaluate: null as any // 将在下面设置 }; // 编译工具匹配器 if (parsed.tool.includes('*')) { // 工具名称中的通配符 const regex = new RegExp( '^' + parsed.tool.replace(/\\*/g, '.*') + '$' ); compiled.matchers.tool = (tool: string) =\u003e regex.test(tool); } else { // 精确匹配 compiled.matchers.tool = (tool: string) =\u003e tool === parsed.tool; } // 编译路径匹配器 if (parsed.path) { if (parsed.path.includes('*') || parsed.path.includes('?')) { // Glob 模式 const matcher = picomatch(parsed.path); compiled.matchers.path = (path: string) =\u003e matcher(path); } else { // 精确或前缀匹配 compiled.matchers.path = (path: string) =\u003e { const normalizedRule = path.resolve(parsed.path); const normalizedInput = path.resolve(path); if (normalizedRule.endsWith('/')) { // 目录前缀 return normalizedInput.startsWith(normalizedRule); } else { // 精确匹配 return normalizedInput === normalizedRule; } }; } } // 编译条件 if (parsed.condition) { compiled.matchers.condition = this.compileCondition(parsed.condition); } // 创建优化的评估器 compiled.evaluate = this.createEvaluator(compiled); return compiled; } private createEvaluator(rule: CompiledRule): RuleEvaluator { // 生成优化的评估函数 const checks: string[] = []; if (rule.matchers.tool) { checks.push('if (!matchers.tool(input.tool)) return false;'); } if (rule.matchers.path) { checks.push('if (input.path \u0026\u0026 !matchers.path(input.path)) return false;'); } if (rule.matchers.condition) { checks.push('if (!matchers.condition(input, context)) return false;'); } checks.push('return true;'); // 创建具有最小开销的函数 const fn = new Function( 'matchers', 'input', 'context', checks.join('\\n') ); return (input: RuleInput, context: RuleContext) =\u003e { return fn(rule.matchers, input, context); }; } evaluateRules( rules: string[], input: RuleInput, context: RuleContext ): RuleMatch | null { // 按顺序编译和评估规则 for (const ruleStr of rules) { const rule = this.compile(ruleStr); if (rule.evaluate(input, context)) { return { matched: true, rule: ruleStr, compiled: rule }; } } return null; } } 为什么这是创新的：\n规则的 JIT 编译以提高性能 支持带条件的复杂规则语法 编译规则的缓存 优化的评估器生成 进度聚合：协调并行操作 当多个工具并行运行时，它们的进度需要协调：\nclass ProgressAggregator { private streams = new Map\u003cstring, ProgressStream\u003e(); private subscribers = new Set\u003cProgressSubscriber\u003e(); private buffer = new RingBuffer\u003cAggregatedProgress\u003e(1000); async *aggregate( operations: ToolOperation[] ): AsyncGenerator\u003cAggregatedProgress\u003e { // 启动所有操作 const startTime = Date.now(); for (const op of operations) { const stream = this.createProgressStream(op); this.streams.set(op.id, stream); // 在后台启动操作 this.runOperation(op, stream); } // 产生聚合的进度 while (this.streams.size \u003e 0) { const event = await this.getNextEvent(); if (!event) continue; const aggregated: AggregatedProgress = { type: 'aggregated_progress', timestamp: Date.now(), elapsed: Date.now() - startTime, source: event.source, event: event, // 总体统计 statistics: { total: operations.length, completed: this.countCompleted(), failed: this.countFailed(), inProgress: this.streams.size, // 按工具分解 byTool: this.getToolStatistics(), // 性能指标 avgDuration: this.getAverageDuration(), throughput: this.getThroughput() }, // 可视化进度表示 visualization: this.createVisualization() }; // 用于 UI 节流的缓冲 this.buffer.push(aggregated); // 基于节流策略的产出 if (this.shouldYield(aggregated)) { yield aggregated; } } // 最终摘要 yield this.createFinalSummary(operations, startTime); } private async getNextEvent(): Promise\u003cProgressEvent | null\u003e { if (this.streams.size === 0) return null; // 创建所有活动流的竞争 const promises = Array.from(this.streams.entries()).map( async ([id, stream]) =\u003e { const event = await stream.next(); return { id, event }; } ); try { // 与超时竞争以防止挂起 const result = await Promise.race([ ...promises, this.timeout(100).then(() =\u003e ({ id: 'timeout', event: null })) ]); if (result.id === 'timeout') { return null; } if (result.event?.done) { this.streams.delete(result.id); } return result.event?.value || null; } catch (error) { // 优雅地处理流错误 console.error('Progress stream error:', error); return null; } } private shouldYield(event: AggregatedProgress): boolean { // 节流逻辑 const now = Date.now(); // 总是产出完成事件 if (event.event.type === 'complete' || event.event.type === 'error') { return true; } // 节流进度更新 const lastYield = this.lastYieldTime.get(event.source) || 0; const timeSinceLastYield = now - lastYield; // 基于操作数量的动态节流 const throttleMs = Math.min(50 * this.streams.size, 500); if (timeSinceLastYield \u003e= throttleMs) { this.lastYieldTime.set(event.source, now); return true; } return false; } private createVisualization(): ProgressVisualization { const bars = Array.from(this.streams.entries()).map(([id, stream]) =\u003e { const state = stream.getState(); const percentage = state.progress || 0; const barLength = 20; const filled = Math.floor(percentage * barLength / 100); return { id, tool: state.tool, bar: '█'.repeat(filled) + '░'.repeat(barLength - filled), percentage, status: state.status, eta: state.eta }; }); return { type: 'bars', bars, summary: this.createSummaryLine() }; } } 为什么这是创新的：\n协调多个并发操作的进度 基于操作计数的动态节流 丰富的统计和可视化 优雅地处理流错误 用于 UI 节流的环形缓冲区 这项分析展示了使 Claude Code 卓越的创新组件。这些不仅仅是优化——它们是专门为 LLM 集成开发环境的挑战而设计的基本架构创新。\n",
  "wordCount" : "4034",
  "inLanguage": "en",
  "image": "http://localhost:1313/images/og-default.avif","datePublished": "2025-11-14T14:00:00+01:00",
  "dateModified": "2025-11-14T14:00:00+01:00",
  "author":{
    "@type": "Person",
    "name": "Starslayerx"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-06%E6%96%B0%E9%A2%96%E7%BB%84%E4%BB%B6/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Starslayerx' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.svg"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Starslayerx&#39; Blog (Alt + H)">
                <img src="http://localhost:1313/favicon.svg" alt="" aria-label="logo"
                    height="35">Starslayerx&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                    <ul class="lang-switch"><li>|</li>
                        <li>
                            <a href="http://localhost:1313/zh-cn/" title="简体中文"
                                aria-label="简体中文">Zh-Cn</a>
                        </li>
                    </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Claude Code 分析 06：新颖组件
    </h1>
    <div class="post-meta"><span title='2025-11-14 14:00:00 +0100 +0100'>November 14, 2025</span>&nbsp;·&nbsp;<span>19 min</span>&nbsp;·&nbsp;<span>4034 words</span>&nbsp;·&nbsp;<span>Starslayerx</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#流式-json-解析器处理-llm-的部分思考">流式 JSON 解析器：处理 LLM 的部分思考</a></li>
    <li><a href="#normalizetosize-算法智能数据截断"><code>normalizeToSize</code> 算法：智能数据截断</a></li>
    <li><a href="#agenttool-合成编排多个视角">AgentTool 合成：编排多个视角</a></li>
    <li><a href="#错误格式化管道使失败可操作">错误格式化管道：使失败可操作</a></li>
    <li><a href="#动态上下文组装智能优先级排序">动态上下文组装：智能优先级排序</a></li>
    <li><a href="#内存管理模式保持精简">内存管理模式：保持精简</a></li>
    <li><a href="#权限规则编译快速安全决策">权限规则编译：快速安全决策</a></li>
    <li><a href="#进度聚合协调并行操作">进度聚合：协调并行操作</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="-新颖组件定义-claude-code-的创新">✨ 新颖组件：定义 Claude Code 的创新<a hidden class="anchor" aria-hidden="true" href="#-新颖组件定义-claude-code-的创新">#</a></h1>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph TB
    subgraph &#34;流式处理挑战&#34;
        PartialJSON[部分 JSON 流]
        PartialXML[部分 XML 流]
        Progress[并发进度]

        PartialJSON --&gt; Parser1[流式 JSON 解析器]
        PartialXML --&gt; Parser2[自定义 XML 解析器]
        Progress --&gt; Aggregator[进度聚合器]
    end

    subgraph &#34;数据挑战&#34;
        LargeObjects[大型对象]
        Circular[循环引用]
        TypedData[特殊类型]

        LargeObjects --&gt; Normalizer[normalizeToSize]
        Circular --&gt; Normalizer
        TypedData --&gt; Normalizer
    end

    subgraph &#34;LLM 挑战&#34;
        Errors[工具错误]
        Context[动态上下文]
        Synthesis[多结果合成]

        Errors --&gt; Formatter[错误格式化器]
        Context --&gt; Assembler[上下文组装器]
        Synthesis --&gt; Synthesizer[AgentTool 合成器]
    end
</code></pre><h2 id="流式-json-解析器处理-llm-的部分思考">流式 JSON 解析器：处理 LLM 的部分思考<a hidden class="anchor" aria-hidden="true" href="#流式-json-解析器处理-llm-的部分思考">#</a></h2>
<p>当 LLM 流式传输工具使用请求时，它不会一次性发送完整的 JSON。相反，你可能会收到这样的片段：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">{&#34;file_path&#34;: &#34;/src/
</span></span><span class="line"><span class="cl">{&#34;file_path&#34;: &#34;/src/main.
</span></span><span class="line"><span class="cl">{&#34;file_path&#34;: &#34;/src/main.ts&#34;, &#34;old_str
</span></span><span class="line"><span class="cl">{&#34;file_path&#34;: &#34;/src/main.ts&#34;, &#34;old_string&#34;: &#34;console.log(&#39;hell
</span></span></code></pre></div><p>流式 JSON 解析器优雅地解决了这个问题：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">StreamingToolInputParser</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">buffer</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">depth</span>: <span class="kt">0</span><span class="p">,</span>           <span class="c1">// {} 或 [] 的嵌套层级
</span></span></span><span class="line"><span class="cl">    <span class="nx">inString</span>: <span class="kt">boolean</span><span class="p">,</span>  <span class="c1">// 当前是否在字符串内？
</span></span></span><span class="line"><span class="cl">    <span class="nx">escape</span>: <span class="kt">boolean</span><span class="p">,</span>    <span class="c1">// 前一个字符是反斜杠？
</span></span></span><span class="line"><span class="cl">    <span class="nx">stringChar</span><span class="o">:</span> <span class="s1">&#39;&#34;&#39;</span> <span class="o">|</span> <span class="s2">&#34;&#39;&#34;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span>  <span class="c1">// 哪个引号开始了当前字符串
</span></span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">addChunk</span><span class="p">(</span><span class="nx">chunk</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">ParseResult</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 逐字符更新解析器状态
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">char</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">prevChar</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">chunk</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 处理转义序列
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">escape</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">escape</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">char</span> <span class="o">===</span> <span class="s1">&#39;\\\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">escape</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 字符串边界检测
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">char</span> <span class="o">===</span> <span class="s1">&#39;&#34;&#39;</span> <span class="o">||</span> <span class="nx">char</span> <span class="o">===</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">stringChar</span> <span class="o">=</span> <span class="nx">char</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span> <span class="o">&amp;&amp;</span> <span class="nx">char</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">stringChar</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">stringChar</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 在字符串外跟踪嵌套深度
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">char</span> <span class="o">===</span> <span class="s1">&#39;{&#39;</span> <span class="o">||</span> <span class="nx">char</span> <span class="o">===</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">depth</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">char</span> <span class="o">===</span> <span class="s1">&#39;}&#39;</span> <span class="o">||</span> <span class="nx">char</span> <span class="o">===</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">depth</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// 当我们返回到深度 0 时尝试解析
</span></span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">depth</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tryParse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 即使没有达到深度 0 也可能是完整的（格式错误的 JSON）
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 安全限制
</span></span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tryParseWithRecovery</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span> <span class="nx">complete</span>: <span class="kt">false</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">tryParse</span><span class="p">()</span><span class="o">:</span> <span class="nx">ParseResult</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span> <span class="nx">complete</span>: <span class="kt">true</span><span class="p">,</span> <span class="nx">value</span>: <span class="kt">parsed</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span> <span class="nx">complete</span>: <span class="kt">false</span><span class="p">,</span> <span class="nx">partial</span>: <span class="kt">this.buffer</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">tryParseWithRecovery</span><span class="p">()</span><span class="o">:</span> <span class="nx">ParseResult</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">attemptBuffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 恢复策略 1：关闭未闭合的字符串
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">inString</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">stringChar</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">attemptBuffer</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">stringChar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 尝试关闭所有未闭合的结构
</span></span></span><span class="line"><span class="cl">      <span class="nx">attemptBuffer</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">depth</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="nx">attemptBuffer</span> <span class="o">+=</span> <span class="s1">&#39;]&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\[/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\]/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 恢复策略 2：基于结构分析自动关闭
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">braceBalance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/{/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">                        <span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/}/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">bracketBalance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\[/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl">                          <span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\]/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">attemptBuffer</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">braceBalance</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">attemptBuffer</span> <span class="o">+=</span> <span class="s1">&#39;]&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">bracketBalance</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">attemptBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">complete</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span>: <span class="kt">parsed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wasRepaired</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">repairs</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">closedStrings</span>: <span class="kt">this.state.inString</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">addedBraces</span>: <span class="kt">braceBalance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">addedBrackets</span>: <span class="kt">bracketBalance</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 恢复策略 3：提取我们能提取的内容
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">partialResult</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">extractPartialData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">complete</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">partial</span>: <span class="kt">partialResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span>: <span class="kt">e.message</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">extractPartialData</span><span class="p">(</span><span class="nx">buffer</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试提取完整的键值对
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">result</span>: <span class="kt">any</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">keyValuePattern</span> <span class="o">=</span> <span class="sr">/&#34;(\w+)&#34;:\s*(&#34;([^&#34;\\]*(\\.[^&#34;\\]*)*)&#34;|true|false|null|\d+)/g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">match</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">keyValuePattern</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">buffer</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">[,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="c1">// 如果解析失败则存储为字符串
</span></span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">result</span> : <span class="kt">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>传统的 JSON 解析器在不完整的输入上会失败</li>
<li>这个解析器提供渐进式解析，并产生有意义的部分结果</li>
<li>恢复策略处理常见的 LLM 流式问题</li>
<li>使响应式 UI 能够在工具输入流式传输时显示它们</li>
</ul>
<p><strong>性能特征</strong>：</p>
<table>
  <thead>
      <tr>
          <th>输入大小</th>
          <th>解析时间</th>
          <th>内存</th>
          <th>成功率</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>&lt;1KB</td>
          <td>&lt;0.1ms</td>
          <td>O(n)</td>
          <td>100%</td>
      </tr>
      <tr>
          <td>1-10KB</td>
          <td>0.1-1ms</td>
          <td>O(n)</td>
          <td>99.9%</td>
      </tr>
      <tr>
          <td>10-100KB</td>
          <td>1-10ms</td>
          <td>O(n)</td>
          <td>99.5%</td>
      </tr>
      <tr>
          <td>&gt;100KB</td>
          <td>10-50ms</td>
          <td>O(n)</td>
          <td>98%（含恢复）</td>
      </tr>
  </tbody>
</table>
<h2 id="normalizetosize-算法智能数据截断"><code>normalizeToSize</code> 算法：智能数据截断<a hidden class="anchor" aria-hidden="true" href="#normalizetosize-算法智能数据截断">#</a></h2>
<p>当向 LLM 或遥测服务发送数据时，大小限制至关重要。<code>normalizeToSize</code> 算法智能地减少对象大小，同时保留结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">DataNormalizer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">normalizeToSize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">obj</span>: <span class="kt">any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxDepth</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxSizeInBytes</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">100</span><span class="nx">_000</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 首先尝试完整深度
</span></span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">estimateSize</span><span class="p">(</span><span class="nx">normalized</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 迭代减少深度直到大小适合
</span></span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="nx">maxSizeInBytes</span> <span class="o">&amp;&amp;</span> <span class="nx">maxDepth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">maxDepth</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">normalized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">estimateSize</span><span class="p">(</span><span class="nx">normalized</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">normalized</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">normalize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">obj</span>: <span class="kt">any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxDepth</span>: <span class="kt">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">currentDepth</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">visited</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakSet</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="kt">any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 处理原始类型
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;[null]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;[undefined]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;[NaN]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;bigint&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="sb">`[BigInt: </span><span class="si">${</span><span class="nx">obj</span><span class="si">}</span><span class="sb">n]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 处理函数和符号
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="sb">`[Function: </span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;anonymous&#39;</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;symbol&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="sb">`[Symbol: </span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">description</span> <span class="o">||</span> <span class="s1">&#39;Symbol&#39;</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 原始类型直接传递
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 达到深度限制
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">currentDepth</span> <span class="o">&gt;=</span> <span class="nx">maxDepth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="sb">`[Array(</span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb">)]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="kr">constructor</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sb">`[</span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="s1">&#39;[Object]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 循环引用检测
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">visited</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="s1">&#39;[Circular]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">visited</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 已知类型的特殊处理
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isReactElement</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="sb">`[React.</span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="kr">type</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">obj</span><span class="p">.</span><span class="kr">type</span> <span class="o">||</span> <span class="s1">&#39;Element&#39;</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isVueComponent</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="sb">`[Vue.</span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">$options</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;Component&#39;</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span>: <span class="kt">obj.name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message</span>: <span class="kt">obj.message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stack</span>: <span class="kt">this.truncateStack</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Date</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">RegExp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 处理 DOM 元素
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isDOMElement</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="sb">`[</span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">tagName</span><span class="si">}${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">?</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">]`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 处理 toJSON 方法
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">          <span class="nx">maxDepth</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">currentDepth</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">visited</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;[Object with toJSON error]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 数组
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">maxItems</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// 限制数组大小
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">maxItems</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">maxDepth</span><span class="p">,</span> <span class="nx">currentDepth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">visited</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxItems</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`... </span><span class="si">${</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">maxItems</span><span class="si">}</span><span class="sb"> more items`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 对象
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">result</span>: <span class="kt">any</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">maxProps</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// 限制对象属性
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 遵守 Sentry 指令
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">__sentry_skip_normalization__</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">effectiveMaxDepth</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">obj</span><span class="p">.</span><span class="nx">__sentry_override_normalization_depth__</span> <span class="o">||</span> <span class="nx">maxDepth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">maxProps</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nx">effectiveMaxDepth</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">currentDepth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">visited</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[Error accessing property]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">maxProps</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">maxProps</span><span class="si">}</span><span class="sb"> more properties`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">estimateSize</span><span class="p">(</span><span class="nx">obj</span>: <span class="kt">any</span><span class="p">)</span><span class="o">:</span> <span class="kt">number</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 快速估算而不需要完整序列化
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sample</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">avgCharSize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">sample</span><span class="p">]).</span><span class="nx">size</span> <span class="o">/</span> <span class="nx">sample</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">fullLength</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">estimateJsonLength</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">fullLength</span> <span class="o">*</span> <span class="nx">avgCharSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">estimateJsonLength</span><span class="p">(</span><span class="nx">obj</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">visited</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakSet</span><span class="p">())</span><span class="o">:</span> <span class="kt">number</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">return</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// &#34;null&#34;
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span> <span class="o">?</span> <span class="nx">4</span> : <span class="kt">5</span><span class="p">;</span> <span class="c1">// &#34;true&#34; : &#34;false&#34;
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// 引号
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">visited</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// &#34;[Circular]&#34;
</span></span></span><span class="line"><span class="cl">    <span class="nx">visited</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// []
</span></span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">item</span> <span class="k">of</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">length</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">estimateJsonLength</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">visited</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 逗号
</span></span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">let</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// {}
</span></span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">length</span> <span class="o">+=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// &#34;key&#34;:
</span></span></span><span class="line"><span class="cl">        <span class="nx">length</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">estimateJsonLength</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">visited</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 逗号
</span></span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 默认估算
</span></span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>基于实际字节大小的迭代深度减少</li>
<li>针对特殊对象的类型感知字符串化</li>
<li>尊重框架特定的对象（React、Vue）</li>
<li>使用 WeakSet 进行循环检测的内存高效方案</li>
<li>在约束内尽可能保留信息</li>
</ul>
<p><strong>使用场景</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="c1">// LLM 上下文准备
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">normalizeToSize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">largeProjectState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mi">10</span><span class="p">,</span>     <span class="c1">// 从深度 10 开始
</span></span></span><span class="line"><span class="cl">  <span class="mi">50</span><span class="nx">_000</span>  <span class="c1">// 上下文的 50KB 限制
</span></span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 遥测错误报告
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">errorContext</span> <span class="o">=</span> <span class="nx">normalizeToSize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">applicationState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mi">5</span><span class="p">,</span>       <span class="c1">// 合理的深度
</span></span></span><span class="line"><span class="cl">  <span class="mi">10</span><span class="nx">_000</span>   <span class="c1">// 错误报告的 10KB
</span></span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><h2 id="agenttool-合成编排多个视角">AgentTool 合成：编排多个视角<a hidden class="anchor" aria-hidden="true" href="#agenttool-合成编排多个视角">#</a></h2>
<p>AgentTool 不仅仅是运行子代理——它智能地组合它们的结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">AgentToolSynthesizer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="kr">async</span> <span class="nx">synthesizeResults</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">results</span>: <span class="kt">SubAgentResult</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">originalTask</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">context</span>: <span class="kt">ToolUseContext</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 单个结果 - 不需要合成
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 准备合成上下文
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">synthesisData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prepareSynthesisData</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 计算合成的 token 预算
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">tokenBudget</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateSynthesisTokenBudget</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">results</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">originalTask</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 构建合成提示
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">synthesisPrompt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildSynthesisPrompt</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">originalTask</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">synthesisData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tokenBudget</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用快速模型进行合成
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">synthesizer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SubAgentExecutor</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">prompt</span>: <span class="kt">synthesisPrompt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">model</span><span class="o">:</span> <span class="s1">&#39;claude-3-haiku-20240307&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">maxTokens</span>: <span class="kt">tokenBudget.output</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">isSynthesis</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">temperature</span>: <span class="kt">0.3</span> <span class="c1">// 较低的温度用于事实合成
</span></span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">synthesizer</span><span class="p">.</span><span class="nx">execute</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">prepareSynthesisData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">results</span>: <span class="kt">SubAgentResult</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">SynthesisData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从每个结果中提取关键信息
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">result</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">agentId</span>: <span class="kt">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">result.content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">keyFindings</span>: <span class="kt">this.extractKeyFindings</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">content</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">toolsUsed</span>: <span class="kt">result.toolsUsed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">confidence</span>: <span class="kt">this.assessConfidence</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tokensUsed</span>: <span class="kt">result.usage.total_tokens</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">uniqueInsights</span><span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 识别代理之间的独特见解
</span></span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">identifyUniqueInsights</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 找到共识和分歧
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">consensus</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findConsensus</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">conflicts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findConflicts</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">agents</span>: <span class="kt">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">consensus</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">conflicts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">coverageMap</span>: <span class="kt">this.buildCoverageMap</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">buildSynthesisPrompt</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">originalTask</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span>: <span class="kt">SynthesisData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tokenBudget</span>: <span class="kt">TokenBudget</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sb">`You are a synthesis agent tasked with combining findings from </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> independent investigations.
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">## Original Task
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nx">originalTask</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">## Investigation Results
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">agent</span> <span class="o">=&gt;</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">### Agent </span><span class="si">${</span><span class="nx">agent</span><span class="p">.</span><span class="nx">agentId</span><span class="si">}</span><span class="sb"> Findings
</span></span></span><span class="line"><span class="cl"><span class="sb">**Tools Used**: </span><span class="si">${</span><span class="nx">agent</span><span class="p">.</span><span class="nx">toolsUsed</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">**Confidence**: </span><span class="si">${</span><span class="nx">agent</span><span class="p">.</span><span class="nx">confidence</span><span class="si">}</span><span class="sb">/5
</span></span></span><span class="line"><span class="cl"><span class="sb">**Token Efficiency**: </span><span class="si">${</span><span class="nx">agent</span><span class="p">.</span><span class="nx">tokensUsed</span><span class="si">}</span><span class="sb"> tokens
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nx">agent</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">**Key Points**:
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nx">agent</span><span class="p">.</span><span class="nx">keyFindings</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span> <span class="o">=&gt;</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">f</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n---\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">## Consensus Points
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">consensus</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">point</span><span class="si">}</span><span class="sb"> (agreed by </span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">agentIds</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">)`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">## Conflicting Information
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">conflicts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">c</span><span class="p">.</span><span class="nx">description</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;No conflicts found.&#39;</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">## Coverage Analysis
</span></span></span><span class="line"><span class="cl"><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">formatCoverageMap</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">coverageMap</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">## Your Task
</span></span></span><span class="line"><span class="cl"><span class="sb">Synthesize these findings into a single, comprehensive response that:
</span></span></span><span class="line"><span class="cl"><span class="sb">1. Presents a unified view of the findings
</span></span></span><span class="line"><span class="cl"><span class="sb">2. Highlights areas of agreement
</span></span></span><span class="line"><span class="cl"><span class="sb">3. Notes any contradictions or uncertainties
</span></span></span><span class="line"><span class="cl"><span class="sb">4. Provides the most complete answer to the original task
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">Keep your response under </span><span class="si">${</span><span class="nx">tokenBudget</span><span class="p">.</span><span class="nx">output</span><span class="si">}</span><span class="sb"> tokens.
</span></span></span><span class="line"><span class="cl"><span class="sb">Focus on actionable insights and concrete findings.
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">extractKeyFindings</span><span class="p">(</span><span class="nx">content</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用启发式方法提取关键点
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">findings</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 查找项目符号点
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">bulletPoints</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[\s-*•]+(.+)$/gm</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">findings</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">bulletPoints</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">b</span> <span class="o">=&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">trim</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 查找编号列表
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">numberedItems</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\d+\.\s+(.+)$/gm</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">findings</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">numberedItems</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\d+\.\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 查找结论标记
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">conclusions</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="sr">/(?:concluded?|found|discovered|determined):\s*(.+?)(?:\.|$)/gi</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">findings</span><span class="p">.</span><span class="nx">push</span><span class="p">(...</span><span class="nx">conclusions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 限制并去重
</span></span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[...</span><span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">findings</span><span class="p">)].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">assessConfidence</span><span class="p">(</span><span class="nx">result</span>: <span class="kt">SubAgentResult</span><span class="p">)</span><span class="o">:</span> <span class="kt">number</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">confidence</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// 基线
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 更多工具使用提高置信度
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">toolsUsed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">confidence</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">toolsUsed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="nx">confidence</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 错误降低置信度
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hadErrors</span><span class="p">)</span> <span class="nx">confidence</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 基于结果模式的置信度
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;unable to&#39;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;could not find&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">confidence</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;successfully&#39;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;confirmed&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">confidence</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">confidence</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">identifyUniqueInsights</span><span class="p">(</span><span class="nx">data</span>: <span class="kt">AgentData</span><span class="p">[])</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构建见解的频率映射
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">insightFrequency</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">number</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">agent</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">finding</span> <span class="k">of</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">keyFindings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normalizeInsight</span><span class="p">(</span><span class="nx">finding</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">insightFrequency</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">normalized</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="nx">insightFrequency</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">normalized</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 标记独特的见解
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">agent</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">agent</span><span class="p">.</span><span class="nx">uniqueInsights</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">keyFindings</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">finding</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">normalized</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">normalizeInsight</span><span class="p">(</span><span class="nx">finding</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">insightFrequency</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">normalized</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>超越简单的连接，实现智能合成</li>
<li>跨代理提取和比较关键发现</li>
<li>识别共识和冲突</li>
<li>使用专用的合成模型以提高效率</li>
<li>保留独特见解同时消除冗余</li>
</ul>
<h2 id="错误格式化管道使失败可操作">错误格式化管道：使失败可操作<a hidden class="anchor" aria-hidden="true" href="#错误格式化管道使失败可操作">#</a></h2>
<p>错误需要为 LLM 和人类以不同方式格式化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">ErrorFormatter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">formatToolErrorContent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">error</span>: <span class="kt">any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tool</span>: <span class="kt">ToolDefinition</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">context?</span>: <span class="kt">ErrorContext</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">ContentBlock</span><span class="p">[]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">errorType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">classifyError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">formatter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">formatters</span><span class="p">[</span><span class="nx">errorType</span><span class="p">]</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultFormatter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">formatter</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">tool</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">formatters</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shell</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">ShellError</span><span class="p">,</span> <span class="nx">tool</span>: <span class="kt">ToolDefinition</span><span class="p">)</span><span class="o">:</span> <span class="nx">ContentBlock</span><span class="p">[]</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">blocks</span>: <span class="kt">ContentBlock</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 主要错误消息
</span></span></span><span class="line"><span class="cl">      <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">text</span><span class="o">:</span> <span class="sb">`Tool &#39;</span><span class="si">${</span><span class="nx">tool</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#39; failed with exit code </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">exitCode</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果存在，包含 stdout
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stdout</span> <span class="o">&amp;&amp;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`stdout:</span><span class="err">\</span><span class="sb">n\`\`\`</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">truncateOutput</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span><span class="si">}</span><span class="err">\</span><span class="sb">n\`\`\``</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果存在，包含 stderr
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span> <span class="o">&amp;&amp;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`stderr:</span><span class="err">\</span><span class="sb">n\`\`\`</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">truncateOutput</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="p">)</span><span class="si">}</span><span class="err">\</span><span class="sb">n\`\`\``</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 添加上下文提示
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hints</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateShellErrorHints</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">hints</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nPossible issues:</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="nx">hints</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">h</span> <span class="o">=&gt;</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">h</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 建议替代方案
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">suggestions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateShellSuggestions</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">suggestions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nSuggestions:</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="nx">suggestions</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">s</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">blocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">validation</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">ZodError</span><span class="p">,</span> <span class="nx">tool</span>: <span class="kt">ToolDefinition</span><span class="p">)</span><span class="o">:</span> <span class="nx">ContentBlock</span><span class="p">[]</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">issues</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">issues</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">issue</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">fieldName</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;input&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 基于错误类型的格式化
</span></span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s1">&#39;invalid_type&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Expected </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">expected</span><span class="si">}</span><span class="sb">, received </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">received</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s1">&#39;too_small&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Must be at least </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">minimum</span><span class="si">}</span><span class="sb"> characters`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Must have at least </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">minimum</span><span class="si">}</span><span class="sb"> items`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Value too small`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s1">&#39;too_big&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Must be at most </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">maximum</span><span class="si">}</span><span class="sb"> characters`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Value too large`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s1">&#39;invalid_enum_value&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: Must be one of: </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s1">&#39;custom&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">fieldName</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">issue</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">text</span><span class="o">:</span> <span class="sb">`Tool &#39;</span><span class="si">${</span><span class="nx">tool</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">&#39; input validation failed:</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="nx">issues</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="err">\</span><span class="sb">n</span><span class="err">\</span><span class="sb">nPlease check your input parameters and try again.`</span>
</span></span><span class="line"><span class="cl">      <span class="p">}];</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">permission</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">PermissionError</span><span class="p">,</span> <span class="nx">tool</span>: <span class="kt">ToolDefinition</span><span class="p">)</span><span class="o">:</span> <span class="nx">ContentBlock</span><span class="p">[]</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">blocks</span>: <span class="kt">ContentBlock</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">text</span><span class="o">:</span> <span class="sb">`Permission denied for </span><span class="si">${</span><span class="nx">tool</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`Reason: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">reason</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">rule</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`Denied by rule: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">rule</span><span class="p">.</span><span class="nx">scope</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">rule</span><span class="p">.</span><span class="nx">pattern</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 提供可操作的指导
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">suggestions</span> <span class="o">&amp;&amp;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">suggestions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`</span><span class="err">\</span><span class="sb">nTo proceed, you could:</span><span class="err">\</span><span class="sb">n</span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">suggestions</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="sb">`- </span><span class="si">${</span><span class="nx">s</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;\nThis operation requires explicit user permission. Please ask the user if they want to proceed.&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">blocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">filesystem</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">FileSystemError</span><span class="p">,</span> <span class="nx">tool</span>: <span class="kt">ToolDefinition</span><span class="p">)</span><span class="o">:</span> <span class="nx">ContentBlock</span><span class="p">[]</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">blocks</span>: <span class="kt">ContentBlock</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">text</span><span class="o">:</span> <span class="sb">`File system error in </span><span class="si">${</span><span class="nx">tool</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 基于错误代码的具体指导
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">guidance</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;ENOENT&#39;</span><span class="o">:</span> <span class="s1">&#39;File or directory not found. Check the path exists.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;EACCES&#39;</span><span class="o">:</span> <span class="s1">&#39;Permission denied. The file may be read-only or require elevated permissions.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;EEXIST&#39;</span><span class="o">:</span> <span class="s1">&#39;File already exists. Consider using a different name or checking before creating.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;EISDIR&#39;</span><span class="o">:</span> <span class="s1">&#39;Expected a file but found a directory.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;ENOTDIR&#39;</span><span class="o">:</span> <span class="s1">&#39;Expected a directory but found a file.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;EMFILE&#39;</span><span class="o">:</span> <span class="s1">&#39;Too many open files. Some file handles may need to be closed.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;ENOSPC&#39;</span><span class="o">:</span> <span class="s1">&#39;No space left on device.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;EROFS&#39;</span><span class="o">:</span> <span class="s1">&#39;Read-only file system.&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">guidance</span><span class="p">[</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span>: <span class="kt">guidance</span><span class="p">[</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">blocks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">text</span><span class="o">:</span> <span class="sb">`Path: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">blocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">generateShellErrorHints</span><span class="p">(</span><span class="nx">error</span>: <span class="kt">ShellError</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">hints</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 命令未找到
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;command not found&#39;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;not found&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">hints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;The command may not be installed or not in PATH&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 建议常见的替代方案
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">command</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">command</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">alternatives</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;python&#39;</span><span class="o">:</span> <span class="s1">&#39;Try python3 instead&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;pip&#39;</span><span class="o">:</span> <span class="s1">&#39;Try pip3 instead&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;node&#39;</span><span class="o">:</span> <span class="s1">&#39;Node.js may not be installed&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;npm&#39;</span><span class="o">:</span> <span class="s1">&#39;npm may not be installed&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">alternatives</span><span class="p">[</span><span class="nx">command</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">hints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">alternatives</span><span class="p">[</span><span class="nx">command</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 权限被拒绝
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Permission denied&#39;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Operation not permitted&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">hints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Try running with different permissions or in a different directory&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">hints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Check if the file/directory has the correct ownership&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 网络错误
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Could not resolve host&#39;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span><span class="p">.</span><span class="nx">stderr</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Connection refused&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">hints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Network connectivity issue detected&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">hints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Check if you need to set sandbox=false for network access&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">hints</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">truncateOutput</span><span class="p">(</span><span class="nx">output</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">maxLength</span>: <span class="kt">number</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">maxLength</span><span class="p">)</span> <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试在换行符处截断
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">truncatePoint</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="nx">maxLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">actualTruncate</span> <span class="o">=</span> <span class="nx">truncatePoint</span> <span class="o">&gt;</span> <span class="nx">maxLength</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="o">?</span> <span class="nx">truncatePoint</span> : <span class="kt">maxLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">actualTruncate</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">           <span class="sb">`</span><span class="err">\</span><span class="sb">n... (</span><span class="si">${</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">actualTruncate</span><span class="si">}</span><span class="sb"> characters truncated)`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>为 LLM 理解定制的错误消息</li>
<li>包含可操作的建议</li>
<li>保留关键的调试信息（stdout/stderr）</li>
<li>提供上下文感知的提示</li>
<li>将 Zod 验证错误格式化为自然语言</li>
</ul>
<h2 id="动态上下文组装智能优先级排序">动态上下文组装：智能优先级排序<a hidden class="anchor" aria-hidden="true" href="#动态上下文组装智能优先级排序">#</a></h2>
<p>上下文组装系统超越了简单的连接：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">DynamicContextAssembler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="kr">readonly</span> <span class="nx">CONTEXT_PRIORITIES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">baseInstructions</span>: <span class="kt">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">modelAdaptations</span>: <span class="kt">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">claudeMdContent</span>: <span class="kt">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gitContext</span>: <span class="kt">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">directoryStructure</span>: <span class="kt">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">toolSpecifications</span>: <span class="kt">6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">activeSelections</span>: <span class="kt">3.5</span><span class="p">,</span> <span class="c1">// 在 CLAUDE.md 和 git 之间
</span></span></span><span class="line"><span class="cl">    <span class="nx">recentErrors</span>: <span class="kt">2.5</span>      <span class="c1">// 错误上下文的高优先级
</span></span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="kr">async</span> <span class="nx">assembleSystemPrompt</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">components</span>: <span class="kt">ContextComponents</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tokenBudget</span>: <span class="kt">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">model</span>: <span class="kt">string</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">string</span> <span class="err">|</span> <span class="na">ContentBlock</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 阶段 1：收集所有带有元数据的组件
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sections</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">gatherSections</span><span class="p">(</span><span class="nx">components</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 阶段 2：计算 token 成本
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">tokenizedSections</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokenizeSections</span><span class="p">(</span><span class="nx">sections</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 阶段 3：智能截断
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">selectedSections</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectSections</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tokenizedSections</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tokenBudget</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 阶段 4：格式化并组合
</span></span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">formatSystemPrompt</span><span class="p">(</span><span class="nx">selectedSections</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="kr">async</span> <span class="nx">gatherSections</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">components</span>: <span class="kt">ContextComponents</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">model</span>: <span class="kt">string</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">ContextSection</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sections</span>: <span class="kt">ContextSection</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 基础说明（始终包含）
</span></span></span><span class="line"><span class="cl">    <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">priority</span>: <span class="kt">this.CONTEXT_PRIORITIES.baseInstructions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">components.baseInstructions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;base&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 模型特定的适配
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">modelAdaptations</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getModelAdaptations</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">priority</span>: <span class="kt">this.CONTEXT_PRIORITIES.modelAdaptations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">modelAdaptations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;model&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 具有分层加载的 CLAUDE.md
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">claudeMdContent</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadClaudeMdHierarchy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">priority</span>: <span class="kt">this.CONTEXT_PRIORITIES.claudeMdContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">this.formatClaudeMd</span><span class="p">(</span><span class="nx">claudeMdContent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;claudemd&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sources</span>: <span class="kt">claudeMdContent.map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">source</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">totalSize</span>: <span class="kt">claudeMdContent.reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 带有智能摘要的 Git 上下文
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">gitContext</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getGitContext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">priority</span>: <span class="kt">this.CONTEXT_PRIORITIES.gitContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">this.formatGitContext</span><span class="p">(</span><span class="nx">gitContext</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;git&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">canSummarize</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">summarizer</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">summarizeGitContext</span><span class="p">(</span><span class="nx">gitContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 带有深度控制的目录结构
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">dirStructure</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDirectoryStructure</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">priority</span>: <span class="kt">this.CONTEXT_PRIORITIES.directoryStructure</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">dirStructure.full</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">alternatives</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">depth</span>: <span class="kt">3</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">dirStructure.depth3</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">depth</span>: <span class="kt">2</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">dirStructure.depth2</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">depth</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">dirStructure.depth1</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 工具规范
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">toolSpecs</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">formatToolSpecifications</span><span class="p">(</span><span class="nx">components</span><span class="p">.</span><span class="nx">tools</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">priority</span>: <span class="kt">this.CONTEXT_PRIORITIES.toolSpecifications</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">toolSpecs.full</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">true</span><span class="p">,</span> <span class="c1">// 工具必须包含
</span></span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;tools&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">alternatives</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">level</span><span class="o">:</span> <span class="s1">&#39;minimal&#39;</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">toolSpecs.minimal</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">level</span><span class="o">:</span> <span class="s1">&#39;names-only&#39;</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">toolSpecs.namesOnly</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="kr">async</span> <span class="nx">loadClaudeMdHierarchy</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">ClaudeMdContent</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sources</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/etc/claude-code/CLAUDE.md&#39;</span><span class="p">,</span> <span class="nx">scope</span><span class="o">:</span> <span class="s1">&#39;managed&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;~/.claude/CLAUDE.md&#39;</span><span class="p">,</span> <span class="nx">scope</span><span class="o">:</span> <span class="s1">&#39;user&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;.claude/CLAUDE.md&#39;</span><span class="p">,</span> <span class="nx">scope</span><span class="o">:</span> <span class="s1">&#39;project&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;.claude/CLAUDE.local.md&#39;</span><span class="p">,</span> <span class="nx">scope</span><span class="o">:</span> <span class="s1">&#39;local&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">contents</span>: <span class="kt">ClaudeMdContent</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">source</span> <span class="k">of</span> <span class="nx">sources</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">processed</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">processClaudeMd</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">source</span><span class="p">.</span><span class="nx">scope</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">contents</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 文件不存在，跳过
</span></span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mergeClaudeMdContents</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="kr">async</span> <span class="nx">processClaudeMd</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">content</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scope</span>: <span class="kt">string</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">ClaudeMdContent</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 处理 @mentions 以进行包含
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">processed</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveMentions</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 提取指令
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">directives</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">extractDirectives</span><span class="p">(</span><span class="nx">processed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">scope</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">processed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">directives</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">source</span>: <span class="kt">scope</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">mergeClaudeMdContents</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">contents</span>: <span class="kt">ClaudeMdContent</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">ClaudeMdContent</span><span class="p">[]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">merged</span>: <span class="kt">ClaudeMdContent</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">overrides</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">string</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 以相反的顺序处理（本地覆盖受管理的）
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">contents</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 处理 @override 指令
</span></span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">directive</span> <span class="k">of</span> <span class="nx">content</span><span class="p">.</span><span class="nx">directives</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">directive</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;override&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">overrides</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">directive</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">scope</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果未被覆盖，包含内容
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">isOverridden</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">overrides</span><span class="p">.</span><span class="nx">entries</span><span class="p">()).</span><span class="nx">some</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">scope</span><span class="p">])</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">content</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">scope</span> <span class="o">!==</span> <span class="nx">content</span><span class="p">.</span><span class="nx">scope</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isOverridden</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">merged</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">merged</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">selectSections</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sections</span>: <span class="kt">TokenizedSection</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">budget</span>: <span class="kt">number</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">TokenizedSection</span><span class="p">[]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 按优先级排序
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sorted</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">sections</span><span class="p">].</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">priority</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">priority</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">selected</span>: <span class="kt">TokenizedSection</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">usedTokens</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 第一遍：包含所有必需的部分
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">section</span> <span class="k">of</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">section</span><span class="p">.</span><span class="nx">required</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selected</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">usedTokens</span> <span class="o">+=</span> <span class="nx">section</span><span class="p">.</span><span class="nx">tokenCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 第二遍：按优先级包含可选部分
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">section</span> <span class="k">of</span> <span class="nx">sorted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">section</span><span class="p">.</span><span class="nx">required</span> <span class="o">&amp;&amp;</span> <span class="nx">usedTokens</span> <span class="o">+</span> <span class="nx">section</span><span class="p">.</span><span class="nx">tokenCount</span> <span class="o">&lt;=</span> <span class="nx">budget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selected</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">usedTokens</span> <span class="o">+=</span> <span class="nx">section</span><span class="p">.</span><span class="nx">tokenCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">section</span><span class="p">.</span><span class="nx">required</span> <span class="o">&amp;&amp;</span> <span class="nx">section</span><span class="p">.</span><span class="nx">alternatives</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 尝试替代方案
</span></span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">alt</span> <span class="k">of</span> <span class="nx">section</span><span class="p">.</span><span class="nx">alternatives</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">usedTokens</span> <span class="o">+</span> <span class="nx">alt</span><span class="p">.</span><span class="nx">tokenCount</span> <span class="o">&lt;=</span> <span class="nx">budget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">selected</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="p">...</span><span class="nx">section</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">content</span>: <span class="kt">alt.content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">tokenCount</span>: <span class="kt">alt.tokenCount</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="nx">usedTokens</span> <span class="o">+=</span> <span class="nx">alt</span><span class="p">.</span><span class="nx">tokenCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">selected</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>基于优先级的截断保留最重要的上下文</li>
<li>具有覆盖语义的分层 CLAUDE.md 加载</li>
<li>动态替代方案（例如，目录深度减少）</li>
<li>模型特定的提示适配</li>
<li>智能摘要回退</li>
</ul>
<h2 id="内存管理模式保持精简">内存管理模式：保持精简<a hidden class="anchor" aria-hidden="true" href="#内存管理模式保持精简">#</a></h2>
<p>Claude Code 实现了复杂的内存管理：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">MemoryManager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 模式 1：大对象的弱引用
</span></span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">fileCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">WeakRef</span><span class="p">&lt;</span><span class="nt">FileContent</span><span class="p">&gt;&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FinalizationRegistry</span><span class="p">((</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="sb">`Garbage collected: </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">fileCache</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">cacheFile</span><span class="p">(</span><span class="nx">path</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">FileContent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 存储弱引用
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakRef</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">fileCache</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ref</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 注册清理通知
</span></span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">getFile</span><span class="p">(</span><span class="nx">path</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">FileContent</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fileCache</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ref</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">deref</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 已被垃圾回收
</span></span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">fileCache</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 模式 2：带反压的流式处理
</span></span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="kr">async</span> <span class="o">*</span><span class="nx">streamLargeFile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">options</span>: <span class="kt">StreamOptions</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">AsyncGenerator</span><span class="p">&lt;</span><span class="nt">Buffer</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">highWaterMark</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chunkSize</span> <span class="o">||</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span> <span class="c1">// 64KB 块
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">createReadStream</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">{</span> <span class="nx">highWaterMark</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">totalRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">isPaused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">chunk</span> <span class="k">of</span> <span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">totalRead</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 检查内存压力
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">memUsage</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">memUsage</span><span class="p">.</span><span class="nx">heapUsed</span> <span class="o">/</span> <span class="nx">memUsage</span><span class="p">.</span><span class="nx">heapTotal</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isPaused</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;High memory pressure, pausing stream&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nx">stream</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="nx">isPaused</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// 如果可用，强制垃圾回收
</span></span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="kr">global</span><span class="p">.</span><span class="nx">gc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">global</span><span class="p">.</span><span class="nx">gc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// 等待内存释放
</span></span></span><span class="line"><span class="cl">          <span class="k">await</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isPaused</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stream</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isPaused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">yield</span> <span class="nx">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 定期让步给事件循环
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">totalRead</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 每 MB
</span></span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setImmediate</span><span class="p">(</span><span class="nx">resolve</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 模式 3：频繁分配的对象池
</span></span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">bufferPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BufferPool</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">size</span>: <span class="kt">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bufferSize</span>: <span class="kt">64</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 模式 4：内存压力检测
</span></span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">monitorMemoryPressure() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">usage</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">heapPercent</span> <span class="o">=</span> <span class="nx">usage</span><span class="p">.</span><span class="nx">heapUsed</span> <span class="o">/</span> <span class="nx">usage</span><span class="p">.</span><span class="nx">heapTotal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">rssGB</span> <span class="o">=</span> <span class="nx">usage</span><span class="p">.</span><span class="nx">rss</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">heapPercent</span> <span class="o">&gt;</span> <span class="mf">0.85</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`High heap usage: </span><span class="si">${</span><span class="p">(</span><span class="nx">heapPercent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 触发清理操作
</span></span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">performMemoryCleanup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">rssGB</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`High RSS memory: </span><span class="si">${</span><span class="nx">rssGB</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">GB`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">performMemoryCleanup() {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 清除非必要的缓存
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">patternCache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">patternCache</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果需要，压缩对话
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">ConversationManager</span><span class="p">.</span><span class="nx">shouldCompact</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ConversationManager</span><span class="p">.</span><span class="nx">triggerCompaction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果可用，强制 GC
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="kr">global</span><span class="p">.</span><span class="nx">gc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">before</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">().</span><span class="nx">heapUsed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">global</span><span class="p">.</span><span class="nx">gc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">after</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">().</span><span class="nx">heapUsed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="sb">`GC freed </span><span class="si">${</span><span class="p">((</span><span class="nx">before</span> <span class="o">-</span> <span class="nx">after</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="sb">MB`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 缓冲池实现
</span></span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">BufferPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">available</span>: <span class="kt">Buffer</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">inUse</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WeakMap</span><span class="p">&lt;</span><span class="nt">Buffer</span><span class="p">,</span> <span class="na">boolean</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">config</span>: <span class="kt">BufferPoolConfig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 预分配缓冲区
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">available</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">allocUnsafe</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">bufferSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">acquire</span><span class="p">()</span><span class="o">:</span> <span class="nx">Buffer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">available</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 池耗尽，分配新的
</span></span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Buffer pool exhausted, allocating new buffer&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">allocUnsafe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">bufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">inUse</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">release</span><span class="p">(</span><span class="nx">buffer</span>: <span class="kt">Buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inUse</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">buffer</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Buffer not from this pool&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">inUse</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 为安全起见清除缓冲区内容
</span></span></span><span class="line"><span class="cl">    <span class="nx">buffer</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">available</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">available</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>弱引用允许大型缓存文件的自动清理</li>
<li>带反压的流式处理防止内存耗尽</li>
<li>缓冲池减少分配开销</li>
<li>主动的内存压力监控和响应</li>
</ul>
<h2 id="权限规则编译快速安全决策">权限规则编译：快速安全决策<a hidden class="anchor" aria-hidden="true" href="#权限规则编译快速安全决策">#</a></h2>
<p>权限系统编译规则以进行高效评估：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">PermissionRuleCompiler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">compiledRules</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">CompiledRule</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">compile</span><span class="p">(</span><span class="nx">rule</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">CompiledRule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 检查缓存
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">compiledRules</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">rule</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">compiledRules</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">rule</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 解析规则语法
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseRule</span><span class="p">(</span><span class="nx">rule</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">compiled</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">compileRule</span><span class="p">(</span><span class="nx">parsed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">compiledRules</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">rule</span><span class="p">,</span> <span class="nx">compiled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">compiled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">parseRule</span><span class="p">(</span><span class="nx">rule</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">ParsedRule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 规则格式：
</span></span></span><span class="line"><span class="cl">    <span class="c1">// - ToolName
</span></span></span><span class="line"><span class="cl">    <span class="c1">// - ToolName(path/pattern)
</span></span></span><span class="line"><span class="cl">    <span class="c1">// - ToolName(path/pattern, condition)
</span></span></span><span class="line"><span class="cl">    <span class="c1">// - @tag:ToolName
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">patterns</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">simple</span><span class="o">:</span> <span class="sr">/^(\w+)$/</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">withPath</span><span class="o">:</span> <span class="sr">/^(\w+)\(([^,)]+)\)$/</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">withCondition</span><span class="o">:</span> <span class="sr">/^(\w+)\(([^,]+),\s*(.+)\)$/</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tagged</span><span class="o">:</span> <span class="sr">/^@(\w+):(.+)$/</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 首先尝试标记格式
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">taggedMatch</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">tagged</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">taggedMatch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">[,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">taggedMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">innerRule</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parseRule</span><span class="p">(</span><span class="nx">rest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">innerRule</span><span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="nx">tag</span><span class="p">]</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试带条件
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">conditionMatch</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">withCondition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">conditionMatch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">[,</span> <span class="nx">tool</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">condition</span><span class="p">]</span> <span class="o">=</span> <span class="nx">conditionMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">condition</span>: <span class="kt">this.parseCondition</span><span class="p">(</span><span class="nx">condition</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tags</span><span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试带路径
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">pathMatch</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">withPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">pathMatch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">[,</span> <span class="nx">tool</span><span class="p">,</span> <span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pathMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span> <span class="nx">tool</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 简单的工具名称
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">simpleMatch</span> <span class="o">=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">simple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">simpleMatch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span> <span class="nx">tool</span>: <span class="kt">simpleMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`Invalid rule syntax: </span><span class="si">${</span><span class="nx">rule</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">compileRule</span><span class="p">(</span><span class="nx">parsed</span>: <span class="kt">ParsedRule</span><span class="p">)</span><span class="o">:</span> <span class="nx">CompiledRule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">compiled</span>: <span class="kt">CompiledRule</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">original</span>: <span class="kt">parsed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">matchers</span><span class="o">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">evaluate</span>: <span class="kt">null</span> <span class="kr">as</span> <span class="kt">any</span> <span class="c1">// 将在下面设置
</span></span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 编译工具匹配器
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">tool</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 工具名称中的通配符
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">tool</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">compiled</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">tool</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tool</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 精确匹配
</span></span></span><span class="line"><span class="cl">      <span class="nx">compiled</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">tool</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tool</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">tool</span> <span class="o">===</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">tool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 编译路径匹配器
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Glob 模式
</span></span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">matcher</span> <span class="o">=</span> <span class="nx">picomatch</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">compiled</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">path</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">matcher</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 精确或前缀匹配
</span></span></span><span class="line"><span class="cl">        <span class="nx">compiled</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">path</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">normalizedRule</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">normalizedInput</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">normalizedRule</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 目录前缀
</span></span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">normalizedInput</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">normalizedRule</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 精确匹配
</span></span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">normalizedInput</span> <span class="o">===</span> <span class="nx">normalizedRule</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 编译条件
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">condition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">compiled</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">condition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">compileCondition</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">condition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建优化的评估器
</span></span></span><span class="line"><span class="cl">    <span class="nx">compiled</span><span class="p">.</span><span class="nx">evaluate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createEvaluator</span><span class="p">(</span><span class="nx">compiled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">compiled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">createEvaluator</span><span class="p">(</span><span class="nx">rule</span>: <span class="kt">CompiledRule</span><span class="p">)</span><span class="o">:</span> <span class="nx">RuleEvaluator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 生成优化的评估函数
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">checks</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">tool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;if (!matchers.tool(input.tool)) return false;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;if (input.path &amp;&amp; !matchers.path(input.path)) return false;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">matchers</span><span class="p">.</span><span class="nx">condition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;if (!matchers.condition(input, context)) return false;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;return true;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建具有最小开销的函数
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;matchers&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;input&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;context&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">checks</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">input</span>: <span class="kt">RuleInput</span><span class="p">,</span> <span class="nx">context</span>: <span class="kt">RuleContext</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">matchers</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">evaluateRules</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rules</span>: <span class="kt">string</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">input</span>: <span class="kt">RuleInput</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">context</span>: <span class="kt">RuleContext</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">RuleMatch</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 按顺序编译和评估规则
</span></span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">ruleStr</span> <span class="k">of</span> <span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">rule</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">ruleStr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">context</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">matched</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">rule</span>: <span class="kt">ruleStr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">compiled</span>: <span class="kt">rule</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>规则的 JIT 编译以提高性能</li>
<li>支持带条件的复杂规则语法</li>
<li>编译规则的缓存</li>
<li>优化的评估器生成</li>
</ul>
<h2 id="进度聚合协调并行操作">进度聚合：协调并行操作<a hidden class="anchor" aria-hidden="true" href="#进度聚合协调并行操作">#</a></h2>
<p>当多个工具并行运行时，它们的进度需要协调：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">ProgressAggregator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">streams</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">ProgressStream</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">subscribers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">ProgressSubscriber</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RingBuffer</span><span class="p">&lt;</span><span class="nt">AggregatedProgress</span><span class="p">&gt;(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="o">*</span><span class="nx">aggregate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">operations</span>: <span class="kt">ToolOperation</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">AsyncGenerator</span><span class="p">&lt;</span><span class="nt">AggregatedProgress</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动所有操作
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">operations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createProgressStream</span><span class="p">(</span><span class="nx">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 在后台启动操作
</span></span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">runOperation</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 产生聚合的进度
</span></span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">event</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getNextEvent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">aggregated</span>: <span class="kt">AggregatedProgress</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;aggregated_progress&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">timestamp</span>: <span class="kt">Date.now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">elapsed</span>: <span class="kt">Date.now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">source</span>: <span class="kt">event.source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">event</span>: <span class="kt">event</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 总体统计
</span></span></span><span class="line"><span class="cl">        <span class="nx">statistics</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">total</span>: <span class="kt">operations.length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">completed</span>: <span class="kt">this.countCompleted</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">          <span class="nx">failed</span>: <span class="kt">this.countFailed</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">          <span class="nx">inProgress</span>: <span class="kt">this.streams.size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// 按工具分解
</span></span></span><span class="line"><span class="cl">          <span class="nx">byTool</span>: <span class="kt">this.getToolStatistics</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1">// 性能指标
</span></span></span><span class="line"><span class="cl">          <span class="nx">avgDuration</span>: <span class="kt">this.getAverageDuration</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">          <span class="nx">throughput</span>: <span class="kt">this.getThroughput</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 可视化进度表示
</span></span></span><span class="line"><span class="cl">        <span class="nx">visualization</span>: <span class="kt">this.createVisualization</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 用于 UI 节流的缓冲
</span></span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">aggregated</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 基于节流策略的产出
</span></span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shouldYield</span><span class="p">(</span><span class="nx">aggregated</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="nx">aggregated</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 最终摘要
</span></span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="k">this</span><span class="p">.</span><span class="nx">createFinalSummary</span><span class="p">(</span><span class="nx">operations</span><span class="p">,</span> <span class="nx">startTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">getNextEvent</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">ProgressEvent</span> <span class="err">|</span> <span class="na">null</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建所有活动流的竞争
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">promises</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="nx">entries</span><span class="p">()).</span><span class="nx">map</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="kr">async</span> <span class="p">([</span><span class="nx">id</span><span class="p">,</span> <span class="nx">stream</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">event</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">event</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 与超时竞争以防止挂起
</span></span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span><span class="nx">promises</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="nx">event</span>: <span class="kt">null</span> <span class="p">}))</span>
</span></span><span class="line"><span class="cl">      <span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;timeout&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">event</span><span class="o">?</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">event</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 优雅地处理流错误
</span></span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Progress stream error:&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">shouldYield</span><span class="p">(</span><span class="nx">event</span>: <span class="kt">AggregatedProgress</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 节流逻辑
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 总是产出完成事件
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span> <span class="o">||</span> <span class="nx">event</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="kr">type</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 节流进度更新
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">lastYield</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastYieldTime</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">timeSinceLastYield</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">lastYield</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 基于操作数量的动态节流
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">throttleMs</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">timeSinceLastYield</span> <span class="o">&gt;=</span> <span class="nx">throttleMs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">lastYieldTime</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">now</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">createVisualization</span><span class="p">()</span><span class="o">:</span> <span class="nx">ProgressVisualization</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">bars</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">.</span><span class="nx">entries</span><span class="p">()).</span><span class="nx">map</span><span class="p">(([</span><span class="nx">id</span><span class="p">,</span> <span class="nx">stream</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">getState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">percentage</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">progress</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">barLength</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">filled</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">percentage</span> <span class="o">*</span> <span class="nx">barLength</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tool</span>: <span class="kt">state.tool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bar</span><span class="o">:</span> <span class="s1">&#39;█&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">filled</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;░&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">barLength</span> <span class="o">-</span> <span class="nx">filled</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">percentage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">status</span>: <span class="kt">state.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">eta</span>: <span class="kt">state.eta</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">&#39;bars&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bars</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">summary</span>: <span class="kt">this.createSummaryLine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>为什么这是创新的</strong>：</p>
<ul>
<li>协调多个并发操作的进度</li>
<li>基于操作计数的动态节流</li>
<li>丰富的统计和可视化</li>
<li>优雅地处理流错误</li>
<li>用于 UI 节流的环形缓冲区</li>
</ul>
<hr>
<p><em>这项分析展示了使 Claude Code 卓越的创新组件。这些不仅仅是优化——它们是专门为 LLM 集成开发环境的挑战而设计的基本架构创新。</em></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/agent/">Agent</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-07%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91/">
    <span class="title">« Prev</span>
    <br>
    <span>Claude Code 分析 07：文件编辑</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/claude-code-%E5%88%86%E6%9E%90-05%E6%9E%B6%E6%9E%84/">
    <span class="title">Next »</span>
    <br>
    <span>Claude Code 分析 05：架构</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on x"
            href="https://x.com/intent/tweet/?text=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f&amp;hashtags=Agent">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f&amp;title=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6&amp;summary=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f&title=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on whatsapp"
            href="https://api.whatsapp.com/send?text=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on telegram"
            href="https://telegram.me/share/url?text=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Claude Code 分析 06：新颖组件 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Claude%20Code%20%e5%88%86%e6%9e%90%2006%ef%bc%9a%e6%96%b0%e9%a2%96%e7%bb%84%e4%bb%b6&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-06%25E6%2596%25B0%25E9%25A2%2596%25E7%25BB%2584%25E4%25BB%25B6%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">Starslayerx&#39; Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
