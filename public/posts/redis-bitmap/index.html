<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Redis Bitmap | Starslayerx&#39; Blog</title>
<meta name="keywords" content="Redis">
<meta name="description" content="Bitmap 位图
Redis 的位图 bitmap 是由多个二进制位组成的数组,
数组中的每个二进制都有与之对应的偏移量(索引),
用户通过这些偏移量可以对位图中指定的一个或多个二进制位进行操作.
Redis 为位图提供了一系列操作命令, 通过这些命令, 用户可以:

设置或获取索引位上的二进制值
统计位图中有多少个二进制位被设置成了1
查找位图中, 第一个被设置为指定值的二进制位, 并返回其偏移量
对一个或多个位图执行逻辑并、逻辑或、逻辑异或以及逻辑非运算
将指定类型的整数存储到位图中

SETBIT: 设置二进制位的值
SETBIT bitmap offset value
为位图指定偏移量上的二进制位设置值, 该命令会返回二进制位被设置之前的旧值作为结果.
当执行 SETBIT 时, 如果位图不存在, 或者位图当前的大小无法满足用户想要执行的设置操作, 那么 Redis 将对被设置的位图进行扩展, 使得位图可以满足用户的设置请求. 由于位图的扩展以字节为单位, 所以扩展后的位图包含的二进制数量可能会比用户要求的稍多一些. 且在扩展的同时, 会将未设置的二进制位初始化为 0.
与一些可以使用负数的 Redis 命令不同, SETBIT 命令只能使用正数偏移量, 尝试输入负数作为偏移量将引发一个错误

复杂度: O(1)

GETBIT: 获取二进制位的值
GETBIT bitmap offset
与 SETBIT 命令一样, GETBIT 命令也只能接受正数作为偏移量.
对于偏移量超过位图索引的命令, GETBIT 命令将返回 0 作为结果.

复杂度: O(1)

BITOCUNT: 统计被设置的二进制数量
BITCOUNT key
对于值为 10010100 的位图 bitmap001, 可以通过执行以下命令来统计有多少个二进制位被设置成了1:">
<meta name="author" content="Starslayerx">
<link rel="canonical" href="http://localhost:1313/posts/redis-bitmap/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css" integrity="sha256-2jIR5e&#43;Ge/K3X9WmUVz&#43;1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.svg">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon.svg">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon.svg">
<link rel="mask-icon" href="http://localhost:1313/favicon.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/redis-bitmap/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/redis-bitmap/">
  <meta property="og:site_name" content="Starslayerx&#39; Blog">
  <meta property="og:title" content="Redis Bitmap">
  <meta property="og:description" content="Bitmap 位图 Redis 的位图 bitmap 是由多个二进制位组成的数组, 数组中的每个二进制都有与之对应的偏移量(索引), 用户通过这些偏移量可以对位图中指定的一个或多个二进制位进行操作.
Redis 为位图提供了一系列操作命令, 通过这些命令, 用户可以:
设置或获取索引位上的二进制值 统计位图中有多少个二进制位被设置成了1 查找位图中, 第一个被设置为指定值的二进制位, 并返回其偏移量 对一个或多个位图执行逻辑并、逻辑或、逻辑异或以及逻辑非运算 将指定类型的整数存储到位图中 SETBIT: 设置二进制位的值 SETBIT bitmap offset value 为位图指定偏移量上的二进制位设置值, 该命令会返回二进制位被设置之前的旧值作为结果.
当执行 SETBIT 时, 如果位图不存在, 或者位图当前的大小无法满足用户想要执行的设置操作, 那么 Redis 将对被设置的位图进行扩展, 使得位图可以满足用户的设置请求. 由于位图的扩展以字节为单位, 所以扩展后的位图包含的二进制数量可能会比用户要求的稍多一些. 且在扩展的同时, 会将未设置的二进制位初始化为 0.
与一些可以使用负数的 Redis 命令不同, SETBIT 命令只能使用正数偏移量, 尝试输入负数作为偏移量将引发一个错误
复杂度: O(1) GETBIT: 获取二进制位的值 GETBIT bitmap offset 与 SETBIT 命令一样, GETBIT 命令也只能接受正数作为偏移量.
对于偏移量超过位图索引的命令, GETBIT 命令将返回 0 作为结果.
复杂度: O(1) BITOCUNT: 统计被设置的二进制数量 BITCOUNT key 对于值为 10010100 的位图 bitmap001, 可以通过执行以下命令来统计有多少个二进制位被设置成了1:">
  <meta property="og:locale" content="en-US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-19T08:00:00+08:00">
    <meta property="article:modified_time" content="2025-09-19T08:00:00+08:00">
    <meta property="article:tag" content="Redis">
      <meta property="og:image" content="http://localhost:1313/images/og-default.avif">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/images/og-default.avif">
<meta name="twitter:title" content="Redis Bitmap">
<meta name="twitter:description" content="Bitmap 位图
Redis 的位图 bitmap 是由多个二进制位组成的数组,
数组中的每个二进制都有与之对应的偏移量(索引),
用户通过这些偏移量可以对位图中指定的一个或多个二进制位进行操作.
Redis 为位图提供了一系列操作命令, 通过这些命令, 用户可以:

设置或获取索引位上的二进制值
统计位图中有多少个二进制位被设置成了1
查找位图中, 第一个被设置为指定值的二进制位, 并返回其偏移量
对一个或多个位图执行逻辑并、逻辑或、逻辑异或以及逻辑非运算
将指定类型的整数存储到位图中

SETBIT: 设置二进制位的值
SETBIT bitmap offset value
为位图指定偏移量上的二进制位设置值, 该命令会返回二进制位被设置之前的旧值作为结果.
当执行 SETBIT 时, 如果位图不存在, 或者位图当前的大小无法满足用户想要执行的设置操作, 那么 Redis 将对被设置的位图进行扩展, 使得位图可以满足用户的设置请求. 由于位图的扩展以字节为单位, 所以扩展后的位图包含的二进制数量可能会比用户要求的稍多一些. 且在扩展的同时, 会将未设置的二进制位初始化为 0.
与一些可以使用负数的 Redis 命令不同, SETBIT 命令只能使用正数偏移量, 尝试输入负数作为偏移量将引发一个错误

复杂度: O(1)

GETBIT: 获取二进制位的值
GETBIT bitmap offset
与 SETBIT 命令一样, GETBIT 命令也只能接受正数作为偏移量.
对于偏移量超过位图索引的命令, GETBIT 命令将返回 0 作为结果.

复杂度: O(1)

BITOCUNT: 统计被设置的二进制数量
BITCOUNT key
对于值为 10010100 的位图 bitmap001, 可以通过执行以下命令来统计有多少个二进制位被设置成了1:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Redis Bitmap",
      "item": "http://localhost:1313/posts/redis-bitmap/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Redis Bitmap",
  "name": "Redis Bitmap",
  "description": "Bitmap 位图 Redis 的位图 bitmap 是由多个二进制位组成的数组, 数组中的每个二进制都有与之对应的偏移量(索引), 用户通过这些偏移量可以对位图中指定的一个或多个二进制位进行操作.\nRedis 为位图提供了一系列操作命令, 通过这些命令, 用户可以:\n设置或获取索引位上的二进制值 统计位图中有多少个二进制位被设置成了1 查找位图中, 第一个被设置为指定值的二进制位, 并返回其偏移量 对一个或多个位图执行逻辑并、逻辑或、逻辑异或以及逻辑非运算 将指定类型的整数存储到位图中 SETBIT: 设置二进制位的值 SETBIT bitmap offset value 为位图指定偏移量上的二进制位设置值, 该命令会返回二进制位被设置之前的旧值作为结果.\n当执行 SETBIT 时, 如果位图不存在, 或者位图当前的大小无法满足用户想要执行的设置操作, 那么 Redis 将对被设置的位图进行扩展, 使得位图可以满足用户的设置请求. 由于位图的扩展以字节为单位, 所以扩展后的位图包含的二进制数量可能会比用户要求的稍多一些. 且在扩展的同时, 会将未设置的二进制位初始化为 0.\n与一些可以使用负数的 Redis 命令不同, SETBIT 命令只能使用正数偏移量, 尝试输入负数作为偏移量将引发一个错误\n复杂度: O(1) GETBIT: 获取二进制位的值 GETBIT bitmap offset 与 SETBIT 命令一样, GETBIT 命令也只能接受正数作为偏移量.\n对于偏移量超过位图索引的命令, GETBIT 命令将返回 0 作为结果.\n复杂度: O(1) BITOCUNT: 统计被设置的二进制数量 BITCOUNT key 对于值为 10010100 的位图 bitmap001, 可以通过执行以下命令来统计有多少个二进制位被设置成了1:\n",
  "keywords": [
    "Redis"
  ],
  "articleBody": "Bitmap 位图 Redis 的位图 bitmap 是由多个二进制位组成的数组, 数组中的每个二进制都有与之对应的偏移量(索引), 用户通过这些偏移量可以对位图中指定的一个或多个二进制位进行操作.\nRedis 为位图提供了一系列操作命令, 通过这些命令, 用户可以:\n设置或获取索引位上的二进制值 统计位图中有多少个二进制位被设置成了1 查找位图中, 第一个被设置为指定值的二进制位, 并返回其偏移量 对一个或多个位图执行逻辑并、逻辑或、逻辑异或以及逻辑非运算 将指定类型的整数存储到位图中 SETBIT: 设置二进制位的值 SETBIT bitmap offset value 为位图指定偏移量上的二进制位设置值, 该命令会返回二进制位被设置之前的旧值作为结果.\n当执行 SETBIT 时, 如果位图不存在, 或者位图当前的大小无法满足用户想要执行的设置操作, 那么 Redis 将对被设置的位图进行扩展, 使得位图可以满足用户的设置请求. 由于位图的扩展以字节为单位, 所以扩展后的位图包含的二进制数量可能会比用户要求的稍多一些. 且在扩展的同时, 会将未设置的二进制位初始化为 0.\n与一些可以使用负数的 Redis 命令不同, SETBIT 命令只能使用正数偏移量, 尝试输入负数作为偏移量将引发一个错误\n复杂度: O(1) GETBIT: 获取二进制位的值 GETBIT bitmap offset 与 SETBIT 命令一样, GETBIT 命令也只能接受正数作为偏移量.\n对于偏移量超过位图索引的命令, GETBIT 命令将返回 0 作为结果.\n复杂度: O(1) BITOCUNT: 统计被设置的二进制数量 BITCOUNT key 对于值为 10010100 的位图 bitmap001, 可以通过执行以下命令来统计有多少个二进制位被设置成了1:\nBITCOUNT bitmap001 (integer) 3 -- 这个位图有 3 个二进制位为 1 此外, 还可以只统计位图指定直接范围内的二进制位\nBITCOUNT bitmap [start end] start 参数和 end 参数与本章之前介绍的 SETBIT 命令和 GETBIT 命令的 offset 参数并不相同, 这两个参数用来指定字节偏移量而不是二进制位偏移量.\n例如通过以下命令计算位图 bitmap003 中第一个字节中 有多少个 1:\nBITCOUNT bitmap003 0 0 BITCOUNT 命令的 start 参数和 end 参数的值不久可以是正数, 还可以是负数:\nBITCOUNT bitmap003 -1 -1 上面命令统计位图 bitmap003 最后一个字节中 1 的数量.\n复杂度: O(N) 示例: 用户行为记录器 为了分析用户行为并借此改善服务质量, 很多网站都会记录用户在网站的一举一动. 为此, 可以使用集和 Set 或者 HyperLogLog 来记录所有执行了指定行为的用户, 但这种做法有两种缺陷:\n如果使用集和来记录执行了指定行为的用户, 那么集和体积会随着用户数量的增大而变大, 从而消耗大量内存 如果使用 HyperLogLog 可以节约大量内存, 但由于其只是一个概率算法, 因此只能给出一个估算值. 并无法准确判断某个用户是否执行了这些指定行为, 这对精确分析算法带来了麻烦. 为了尽可能节约内存, 并精确记录每个用户是否执行了指定行为, 可以使用以下方法:\n对于每项行为, 一个用户要么执行了该行为, 要么没有执行该行为. 因此可以通过一个二进制位来记录. 通过将用户 ID 与位图中的二进制偏移量一一映射, 可以使用一个位图来记录所有执行了指定行为的用户: 比如偏移量为 10086 的二进制位就负责记录 ID 位 10086 的用户信息, 而偏移量位 12345 的二进制位则负责记录 ID 位 12345 的用户信息. 每当用户执行指定行为时, 调用 SETBIT 命令, 将用户在位图中对应的二进制位的值设置为 1 通过调用 GETBIT 命令并判断用户对应的二进制的值是否位1, 可以知道用户是否执行了指定行为 通过对位图执行 BITCOUNT 命令, 可以知道多少用户执行了指定行为 from redis import Redis def make_action_key(action): return \"action_reorder::\" + action class ActionRecorder: def __init__(self, client, action): self.client= client self.bitmap = make_action_key(action) def perform_by(self, user_id): \"\"\"记录执行了指定行为的用户\"\"\" self.client.setbit(self.bitmap, user_id) def is_performed_by(self, user_id): \"\"\"检查用户是否执行了指定行为\"\"\" return self.client.getbit(self.bitmap, user_id) def count_performed(self): \"\"\"返回执行了指定行为的用户人数\"\"\" return self.client.bitcount(self.bitmap) client = Redis() login_action = ActionRecorder(client, \"login\") # 对以登陆用户进行记录 login_action.perform_by(10086) login_action.perform_by(255255) login_action.perform_by(987654321) # ID 为 10086 的用户登陆了 print(login_action.is_performed_by(10086)) # ID 为 555 的用户没有登陆 print(login_action.is_performed_by(555)) # 统计用户执行了登陆操作 print(login_action.count_performed()) BITPOS: 查找第一个指定的二进制值 BITPOS bitmap value 例如, 通过下面命令, 可以知道位图 bitmap003 第一个被设置为 1 的二进制位所在的偏移量(索引):\nBITPOS bitmap003 1 (integer) 0 -- 位图第一个被设置位 1 的二进制位的偏移量是 0 默认情况下, BITPOS 会查找所有二进制位, 在有需要的情况下, 用户也可以通过可选的 start 参数和 end 参数, 让 BITPOS 命令只在指定字节范围内的二进制位中进行查找:\nBITPOS bitmap value [start end] 返回结果为查找到位的整体偏移量, 而不是在 start 和 end 内的偏移量.\n和 BITCOUNT 命令以, BITPOS 命令的 start 和 end 参数也可以是负数.\n比如, 下面代码就展示了如何在位图 bitmap003 的倒数第一个字节中, 查找第一个值位 0 的二进制位:\nBITPOS bitmap003 0 -1 -1 (integer) 17 当用户尝试对一个不存在的位图或者一个唯有位都位 0 的位图, 执行查找值位 1 的二进制位时, BITPOS 命令将返回 -1 作为结果:\nBITPOS not-exists-bitmap 1 -- 在不存在的位图中查找 (integer) -1 BITPOS all-0-bitmap 1 -- 在一个所有位都被设置为 0 的位图查找 (integer) -1 复杂度: O(N), 其中 N 为查找涉及的字节数量 BITOP: 执行二进制位运算 用户可以通过 BITOP 命令, 对一个或多个位图执行指定的二进制位运算, 并将运算结果存储到指定的键中\nBITOP operation result_key bitmap [bitmap ...] 其中, operation 参数值可以是 AND, OR, XOR, NOT 中的任意一个, 这 4 个值分别对应逻辑并、逻辑或、逻辑异或和逻辑非4种运算, 其中 AND, OR, XOR 这 3 种运算允许用户使用任意数量的位图作为输入, 而 NOT 只允许一个位图作为输入. BITOP 命令这将计算结果存储到指定键中后, 会返回被存储位图的字节长度.\n例如, 通过以下命令, 对位图 bitmap001, bitmap002, bitmap003 执行逻辑并运算, 然后将结果存储到键 and_result 中:\nBITOP ADD and_result bitmap001 bitmap002 bitmap003 (integer) 3 -- 运算结果 and_result 位图的长度为 3 字节 当 BITOP 命令在对两个长度不同的位图执行运算时, 会将长度较短的那个位图中不存在的二进制位看作 0.\n复杂度: O(N), 其中 N 位计算涉及的字节总数量 BITFIELD: 在位图中存储整数值 BITFIELD 命令允许用户在位图中的任意区域 field 存储指定长度的整数值, 并对这些整数值执行加法或减法操作.\nBITFIELD 命令支持 SET, GET, INCRBY, OVERFLOW 这 4 个子命令, 接下来将分别介绍这些子命令.\n根据偏移量对区域进行设置\nBITFIELD bitmap SET type offset value 通过 SET 子命令, 在位图的指定偏移量 offset 上设置一个 type 类型的整数值 value. 其中:\noffset 参数用于指定设置的起始偏移量. 这个偏移量从 0 开始计算, 偏移量为 0 表示设置从位图的第 1 个二进制开始 type 参数用于指定被设置值的类型, 这个参数需要以 i 或 u 为前缀, 后跟被设置值的位长度 value 参数用于指定被设置的整数值, 这个值的类型应该和 type 参数指定的类型一致. 如果给定值的长度超过了 type 指定的类型, 那么将根据 type 参数指定的类型阶段给定值 举个例子, 下面命令, 从偏移量 0 开始, 这只一个8位长的无符号整数值 198\nBITFIELD bitmap SET u8 0 198 (integer) 0 从结果可以知道, 该位图之前存储的结果为 0.\nBITFIELD 命令允许用户在一次调用中执行多个子命令\nBITFIELD bitmap SET u8 0 123 SET i23 20 10086 1) (integer) 198 2) (integer) 0 根据索引对区域进行设置\n除了根据偏移量设置位图, 还可以根据给定类型的位长度, 对位图在指定索引上存储的整数进行设置.\nBITFIELD bitmap SET type #index value 假如现在有一个位图, 其存储着多个 8 位长的无符号整数, 想要将其第 133 个 8 位无符号整数的值设置为 22.\n如果使用偏移量, 就要手动计算 (133 - 1) * 8 的起始偏移量\nBITFIELD bitmap SET u8 1056 22 这样很不方便, 因此可以使用类型直接设置 (SET 字命令索引从 0 开始)\nBITFIELD bitmap SET u8 #132 22 获取区域存储的值\n通过使用 BITFIELD 命令的 GET 子命令, 可以从给定的偏移量或索引取出指定类型整数值\nBITFIELD bitmap GET type offset BITFIELD bitmap GET type #index 执行加法或减法操作\n除了设置于获取整数值, BITFIELD 命令还可以对位图的整数值执行加法或减法操作, 通过 INCRBY 子命令实现\nBITFIELD bitmap INCRBY type offset increment BITFIELD bitmap INCRBY type #index increment 如果要实现加法, 仍然使用 INCRBY 命令, 但 increment 使用负数, 从而得到减法的效果\nBITFIELD numbers SET u8 #0 10 -- 将区域的值设置未整数 10 1) (integer) 0 BITFIELD numbers GET u8 #0 1) (integer) 10 BITFIELD numbers INCRBY u8 #0 15 -- 将整数的值加上 15 1) (integer) 25 BITFIELD numbers INCRBY u8 #0 30 -- 将整数值加上 30 1) (integer) 55 BITFIELD numbers INCRBY u8 #0 -25 -- 将整数值减去 25 1) (integer) 30 处理溢出\nBITFIELD 命令还可以使用 OVERFLOW 子命令去控制 INCRBY 子命令在发生计算溢出时的行为\nBITFIELD bitmap [...] OVERFLOW WRAP|SAT|FAIL [...] OVERFLOW 参数有 WRAP, SAT 和 FAIL\nWRAP 表示回绕 (wrap around) 方式处理溢出, 也就是 C 语言默认的溢出处理方式. SAT 表示使用饱合运算 (saturation arithmetic) 方式处理溢出. 向上溢出的整数设置位最大值, 向下溢出的整数值则被设置位最小值 FAIL 表示让 INCRBY 子命令在检测到计算会引发溢出时, 拒绝执行计算, 并返回空值表示计算失败 但 OVERFLOW 命令执行后不会产生任何返回, 此外, 如果没有设置溢出处理方式, 默认是 WRAP\n需要注意的是, 由于 OVERFLOW 子命令只会对同一个 BITFIELD 调用中在其后面的 INCRBY 命令产生效果\nBITFIELD bitmap INCRBY ... INCRBY OVERFLOW SAT INCRBY ... 上面命令中, 前两个就使用 WRAP 方法处理溢出, 第三个使用 SAT 方法处理溢出\n使用位图存储整数的原因\n一般情况下, 用户使用字符串或者散列存储整数, Redis 都会为被存储的整数分配一个 long 类型的值, 并使用对象去包裹这个值, 然后再吧对象关联到数据库中\n而 BITFIELD 命令运行用户自行指定存储整数的类型, 并且不会使用对象去包裹这些整数, 因此当想要存储长度比 long 类型短的整数, 并且希望尽可能减少对象包括带来的内存消耗, 就可以考虑使用 BITFIELD 存储整数\n复杂度: O(N), N 为用户给定的子命令数量\n示例: 紧凑计数器 与之间实现的计数器不同, 这个计数器允许用户自行指定计数器值的位长以及类型, 而不是使用 Redis 默认的 long 类型来存储计数器值 与字符串或者散列实现的计数器不同, 这个计数器只能使用整数作为索引, 因此只适合存储一些与数字 ID 想关联的计数器数据 from redis import Redis def get_bitmap_index(index): return \"#\" + str(index) class CompactCounter: def __init__(self, client, key, bit_length, signed): \"\"\"初始化紧凑计数器 Args: - client 指定客户端 - key 参数指定计数器键名 - bit_length 参数指定计数器存储的整数位 - signed 参数用于指定计数器存储的符号 \"\"\" self.client = client self.key = key if signed: self.type = \"i\" + str(bit_length) else: self.type = \"u\" + str(bit_length) def increase(self, index, n=1): \"\"\"对索引 index 的计数器执行加法操作, 然后返回计数器的当前值\"\"\" bitmap_index = get_bitmap_index(index) result = self.client.execute_command( \"BITFIELD\", self.key, \"OVERFLOW\", \"SAT\", \"INCRBY\", self.type, bitmap_index, n, ) return result[0] def decrease(self, index, n=1): \"\"\"对索引 index 上的计数器执行减法操作, 然后返回计数器的当前值\"\"\" bitmap_index = get_bitmap_index(index) decrement = -n result = self.client.execute_command( \"BITFIELD\", self.key, \"OVERFLOW\", \"SAT\", \"INCRBY\", self.type, bitmap_index, decrement, ) return result[0] def get(self, index): \"\"\"获取索引 index 上的计数器的当前值\"\"\" bitmap_index = get_bitmap_index(index) result = self.client.execute_command( \"BITfIELD\", self.key, \"GET\", self.type, bitmap_index, ) 假如要为一家游戏公司创建一个记录每个玩家每月登陆数的计数器, 按照一个月 30 天, 一天登陆 2~3 次的频率来计算, 一个普通玩家一个月的登陆次数通常不会超过 100 次. 对于这么小的数值, 使用 long 类型进行存储将浪费大量空间, 因此可以使用紧凑计数器来存储用户登陆次数:\n每个玩家都又一个整数类型的用户 ID, 可以使用 ID 作为计数器索引 对于每个玩家, 使用一个 16 位长的无符号整数来存储其一个月内的登陆次数 16 位无符号整数计数器能存储的最大值位 65536, 对于该功能来说, 已经足够大 client = Redis() counter = CompactCounter(client, \"login_count\", 16, False) # 建立计数器 print(counter.increase(10086)) # 记录第 1 次登陆 print(counter.increase(10086)) # 再记录第 1 次登陆 print(counter.get(10086)) # 获取登陆次数 使用字符串命令对位图进行操作\n由于 Redis 位图在字符串的基础上实现, 所以它会将位图键看作一个字符串键\nSETBIT bitmap 0 1 \u003e (integer) 0 TYPE bitmap \u003e string 因此, 还可以使用字符串命令对位图进行操作\nGET 8bit-int \u003e \"\\x04\" GET 32bit-ints \u003e \"\\x00\\x00\\x00{\\x00\\x00\\x01\\x00\\x00\\x00\\x00 ...}\" 也可以使用 STRLEN 命令获取位图的字节长度\nSTRLEN 8bit-int -- 1 字节 \u003e (integer) 1 STRLEN 32bit-ints -- 这个位图 16 字节 \u003e (integerf 16) 还可以使用 GETRANGE 命令获取位图的其中一部分字节:\nGETRANGE 32bit-ints 0 3 诸如此类\n",
  "wordCount" : "1009",
  "inLanguage": "en",
  "image": "http://localhost:1313/images/og-default.avif","datePublished": "2025-09-19T08:00:00+08:00",
  "dateModified": "2025-09-19T08:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Starslayerx"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/redis-bitmap/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Starslayerx' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.svg"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Starslayerx&#39; Blog (Alt + H)">
                <img src="http://localhost:1313/favicon.svg" alt="" aria-label="logo"
                    height="35">Starslayerx&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                    <ul class="lang-switch"><li>|</li>
                        <li>
                            <a href="http://localhost:1313/zh-cn/" title="简体中文"
                                aria-label="简体中文">Zh-Cn</a>
                        </li>
                    </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Redis Bitmap
    </h1>
    <div class="post-meta"><span title='2025-09-19 08:00:00 +0800 CST'>September 19, 2025</span>&nbsp;·&nbsp;<span>5 min</span>&nbsp;·&nbsp;<span>1009 words</span>&nbsp;·&nbsp;<span>Starslayerx</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#bitmap-位图">Bitmap 位图</a>
      <ul>
        <li><a href="#setbit-设置二进制位的值">SETBIT: 设置二进制位的值</a></li>
        <li><a href="#getbit-获取二进制位的值">GETBIT: 获取二进制位的值</a></li>
        <li><a href="#bitocunt-统计被设置的二进制数量">BITOCUNT: 统计被设置的二进制数量</a></li>
        <li><a href="#示例-用户行为记录器">示例: 用户行为记录器</a></li>
        <li><a href="#bitpos-查找第一个指定的二进制值">BITPOS: 查找第一个指定的二进制值</a></li>
        <li><a href="#bitop-执行二进制位运算">BITOP: 执行二进制位运算</a></li>
        <li><a href="#bitfield-在位图中存储整数值">BITFIELD: 在位图中存储整数值</a></li>
        <li><a href="#示例-紧凑计数器">示例: 紧凑计数器</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="bitmap-位图">Bitmap 位图<a hidden class="anchor" aria-hidden="true" href="#bitmap-位图">#</a></h2>
<p>Redis 的位图 bitmap 是由多个二进制位组成的数组,
数组中的每个二进制都有与之对应的偏移量(索引),
用户通过这些偏移量可以对位图中指定的一个或多个二进制位进行操作.</p>
<p>Redis 为位图提供了一系列操作命令, 通过这些命令, 用户可以:</p>
<ul>
<li>设置或获取索引位上的二进制值</li>
<li>统计位图中有多少个二进制位被设置成了1</li>
<li>查找位图中, 第一个被设置为指定值的二进制位, 并返回其偏移量</li>
<li>对一个或多个位图执行逻辑并、逻辑或、逻辑异或以及逻辑非运算</li>
<li>将指定类型的整数存储到位图中</li>
</ul>
<h3 id="setbit-设置二进制位的值">SETBIT: 设置二进制位的值<a hidden class="anchor" aria-hidden="true" href="#setbit-设置二进制位的值">#</a></h3>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">SETBIT bitmap offset value
</code></pre><p>为位图指定偏移量上的二进制位设置值, 该命令会返回二进制位被设置之前的旧值作为结果.</p>
<p>当执行 SETBIT 时, 如果位图不存在, 或者位图当前的大小无法满足用户想要执行的设置操作, 那么 Redis 将对被设置的位图进行扩展, 使得位图可以满足用户的设置请求. 由于位图的扩展以字节为单位, 所以扩展后的位图包含的二进制数量可能会比用户要求的稍多一些. 且在扩展的同时, 会将未设置的二进制位初始化为 0.</p>
<p>与一些可以使用负数的 Redis 命令不同, SETBIT 命令只能使用正数偏移量, 尝试输入负数作为偏移量将引发一个错误</p>
<ul>
<li>复杂度: O(1)</li>
</ul>
<h3 id="getbit-获取二进制位的值">GETBIT: 获取二进制位的值<a hidden class="anchor" aria-hidden="true" href="#getbit-获取二进制位的值">#</a></h3>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">GETBIT bitmap offset
</code></pre><p>与 SETBIT 命令一样, GETBIT 命令也只能接受正数作为偏移量.<br>
对于偏移量超过位图索引的命令, GETBIT 命令将返回 0 作为结果.</p>
<ul>
<li>复杂度: O(1)</li>
</ul>
<h3 id="bitocunt-统计被设置的二进制数量">BITOCUNT: 统计被设置的二进制数量<a hidden class="anchor" aria-hidden="true" href="#bitocunt-统计被设置的二进制数量">#</a></h3>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITCOUNT key
</code></pre><p>对于值为 10010100 的位图 bitmap001, 可以通过执行以下命令来统计有多少个二进制位被设置成了1:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITCOUNT bitmap001
(integer) 3 -- 这个位图有 3 个二进制位为 1
</code></pre><p>此外, 还可以只统计位图指定直接范围内的二进制位</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITCOUNT bitmap [start end]
</code></pre><p>start 参数和 end 参数与本章之前介绍的 SETBIT 命令和 GETBIT 命令的 offset 参数并不相同,
这两个参数用来指定<strong>字节</strong>偏移量而不是二进制位偏移量.</p>
<p>例如通过以下命令计算位图 bitmap003 中第一个字节中 有多少个 1:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITCOUNT bitmap003 0 0
</code></pre><p>BITCOUNT 命令的 start 参数和 end 参数的值不久可以是正数, 还可以是负数:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITCOUNT bitmap003 -1 -1
</code></pre><p>上面命令统计位图 bitmap003 最后一个字节中 1 的数量.</p>
<ul>
<li>复杂度: O(N)</li>
</ul>
<h3 id="示例-用户行为记录器">示例: 用户行为记录器<a hidden class="anchor" aria-hidden="true" href="#示例-用户行为记录器">#</a></h3>
<p>为了分析用户行为并借此改善服务质量, 很多网站都会记录用户在网站的一举一动.
为此, 可以使用集和 Set 或者 HyperLogLog 来记录所有执行了指定行为的用户, 但这种做法有两种缺陷:</p>
<ul>
<li>如果使用集和来记录执行了指定行为的用户, 那么集和体积会随着用户数量的增大而变大, 从而消耗大量内存</li>
<li>如果使用 HyperLogLog 可以节约大量内存, 但由于其只是一个概率算法, 因此只能给出一个估算值. 并无法准确判断某个用户是否执行了这些指定行为, 这对精确分析算法带来了麻烦.</li>
</ul>
<p>为了尽可能节约内存, 并精确记录每个用户是否执行了指定行为, 可以使用以下方法:</p>
<ul>
<li>对于每项行为, 一个用户要么执行了该行为, 要么没有执行该行为. 因此可以通过一个二进制位来记录.</li>
<li>通过将用户 ID 与位图中的二进制偏移量一一映射, 可以使用一个位图来记录所有执行了指定行为的用户: 比如偏移量为 10086 的二进制位就负责记录 ID 位 10086 的用户信息, 而偏移量位 12345 的二进制位则负责记录 ID 位 12345 的用户信息.</li>
<li>每当用户执行指定行为时, 调用 SETBIT 命令, 将用户在位图中对应的二进制位的值设置为 1</li>
<li>通过调用 GETBIT 命令并判断用户对应的二进制的值是否位1, 可以知道用户是否执行了指定行为</li>
<li>通过对位图执行 BITCOUNT 命令, 可以知道多少用户执行了指定行为</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_action_key</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;action_reorder::&#34;</span> <span class="o">+</span> <span class="n">action</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ActionRecorder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">=</span> <span class="n">client</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">make_action_key</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">perform_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;记录执行了指定行为的用户&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">setbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_performed_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;检查用户是否执行了指定行为&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">getbit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">count_performed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;返回执行了指定行为的用户人数&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bitcount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">login_action</span> <span class="o">=</span> <span class="n">ActionRecorder</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&#34;login&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 对以登陆用户进行记录</span>
</span></span><span class="line"><span class="cl"><span class="n">login_action</span><span class="o">.</span><span class="n">perform_by</span><span class="p">(</span><span class="mi">10086</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">login_action</span><span class="o">.</span><span class="n">perform_by</span><span class="p">(</span><span class="mi">255255</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">login_action</span><span class="o">.</span><span class="n">perform_by</span><span class="p">(</span><span class="mi">987654321</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ID 为 10086 的用户登陆了</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">login_action</span><span class="o">.</span><span class="n">is_performed_by</span><span class="p">(</span><span class="mi">10086</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID 为 555 的用户没有登陆</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">login_action</span><span class="o">.</span><span class="n">is_performed_by</span><span class="p">(</span><span class="mi">555</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 统计用户执行了登陆操作</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">login_action</span><span class="o">.</span><span class="n">count_performed</span><span class="p">())</span>
</span></span></code></pre></div><h3 id="bitpos-查找第一个指定的二进制值">BITPOS: 查找第一个指定的二进制值<a hidden class="anchor" aria-hidden="true" href="#bitpos-查找第一个指定的二进制值">#</a></h3>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITPOS bitmap value
</code></pre><p>例如, 通过下面命令, 可以知道位图 bitmap003 第一个被设置为 1 的二进制位所在的偏移量(索引):</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITPOS bitmap003 1
(integer) 0 -- 位图第一个被设置位 1 的二进制位的偏移量是 0
</code></pre><p>默认情况下, BITPOS 会查找所有二进制位, 在有需要的情况下, 用户也可以通过可选的 start 参数和 end 参数, 让 BITPOS 命令只在指定<strong>字节</strong>范围内的二进制位中进行查找:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITPOS bitmap value [start end]
</code></pre><p>返回结果为查找到位的整体偏移量, 而不是在 start 和 end 内的偏移量.</p>
<p>和 BITCOUNT 命令以, BITPOS 命令的 start 和 end 参数也可以是负数.</p>
<p>比如, 下面代码就展示了如何在位图 bitmap003 的倒数第一个字节中, 查找第一个值位 0 的二进制位:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITPOS bitmap003 0 -1 -1
(integer) 17
</code></pre><p>当用户尝试对一个不存在的位图或者一个唯有位都位 0 的位图, 执行查找值位 1 的二进制位时, BITPOS 命令将返回 -1 作为结果:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITPOS not-exists-bitmap 1 -- 在不存在的位图中查找
(integer) -1

BITPOS all-0-bitmap 1 -- 在一个所有位都被设置为 0 的位图查找
(integer) -1
</code></pre><ul>
<li>复杂度: O(N), 其中 N 为查找涉及的字节数量</li>
</ul>
<h3 id="bitop-执行二进制位运算">BITOP: 执行二进制位运算<a hidden class="anchor" aria-hidden="true" href="#bitop-执行二进制位运算">#</a></h3>
<p>用户可以通过 BITOP 命令, 对一个或多个位图执行指定的二进制位运算, 并将运算结果存储到指定的键中</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITOP operation result_key bitmap [bitmap ...]
</code></pre><p>其中, operation 参数值可以是 AND, OR, XOR, NOT 中的任意一个,
这 4 个值分别对应逻辑并、逻辑或、逻辑异或和逻辑非4种运算,
其中 AND, OR, XOR 这 3 种运算允许用户使用任意数量的位图作为输入, 而 NOT 只允许一个位图作为输入.
BITOP 命令这将计算结果存储到指定键中后, 会返回被存储位图的字节长度.</p>
<p>例如, 通过以下命令, 对位图 bitmap001, bitmap002, bitmap003 执行逻辑并运算, 然后将结果存储到键 and_result 中:</p>
<pre tabindex="0"><code>BITOP ADD and_result bitmap001 bitmap002 bitmap003
(integer) 3 -- 运算结果 and_result 位图的长度为 3 字节
</code></pre><p>当 BITOP 命令在对两个长度不同的位图执行运算时, 会将长度较短的那个位图中不存在的二进制位看作 0.</p>
<ul>
<li>复杂度: O(N), 其中 N 位计算涉及的字节总数量</li>
</ul>
<h3 id="bitfield-在位图中存储整数值">BITFIELD: 在位图中存储整数值<a hidden class="anchor" aria-hidden="true" href="#bitfield-在位图中存储整数值">#</a></h3>
<p>BITFIELD 命令允许用户在位图中的任意区域 field 存储指定长度的整数值, 并对这些整数值执行加法或减法操作.<br>
BITFIELD 命令支持 SET, GET, INCRBY, OVERFLOW 这 4 个子命令, 接下来将分别介绍这些子命令.</p>
<ul>
<li>
<p>根据偏移量对区域进行设置</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap SET type offset value
</code></pre><p>通过 SET 子命令, 在位图的指定偏移量 offset 上设置一个 type 类型的整数值 value. 其中:</p>
<ul>
<li>offset 参数用于指定设置的起始偏移量. 这个偏移量从 0 开始计算, 偏移量为 0 表示设置从位图的第 1 个二进制开始</li>
<li>type 参数用于指定被设置值的类型, 这个参数需要以 i 或 u 为前缀, 后跟被设置值的位长度</li>
<li>value 参数用于指定被设置的整数值, 这个值的类型应该和 type 参数指定的类型一致. 如果给定值的长度超过了 type 指定的类型, 那么将根据 type 参数指定的类型阶段给定值</li>
</ul>
<p>举个例子, 下面命令, 从偏移量 0 开始, 这只一个8位长的无符号整数值 198</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap SET u8 0 198
(integer) 0
</code></pre><p>从结果可以知道, 该位图之前存储的结果为 0.<br>
BITFIELD 命令允许用户在一次调用中执行多个子命令</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap SET u8 0 123 SET i23 20 10086

1) (integer) 198

2) (integer) 0
</code></pre></li>
<li>
<p>根据索引对区域进行设置<br>
除了根据偏移量设置位图, 还可以根据给定类型的位长度, 对位图在指定索引上存储的整数进行设置.</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap SET type #index value
</code></pre><p>假如现在有一个位图, 其存储着多个 8 位长的无符号整数, 想要将其第 133 个 8 位无符号整数的值设置为 22.<br>
如果使用偏移量, 就要手动计算 (133 - 1) * 8 的起始偏移量</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap SET u8 1056 22
</code></pre><p>这样很不方便, 因此可以使用类型直接设置 (SET 字命令索引从 0 开始)</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap SET u8 #132 22
</code></pre></li>
<li>
<p>获取区域存储的值<br>
通过使用 BITFIELD 命令的 GET 子命令, 可以从给定的偏移量或索引取出指定类型整数值</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap GET type offset
BITFIELD bitmap GET type #index
</code></pre></li>
<li>
<p>执行加法或减法操作<br>
除了设置于获取整数值, BITFIELD 命令还可以对位图的整数值执行加法或减法操作, 通过 INCRBY 子命令实现</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap INCRBY type offset increment
BITFIELD bitmap INCRBY type #index increment
</code></pre><p>如果要实现加法, 仍然使用 INCRBY 命令, 但 increment 使用负数, 从而得到减法的效果</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD numbers SET u8 #0 10 -- 将区域的值设置未整数 10
1) (integer) 0

BITFIELD numbers GET u8 #0
1) (integer) 10

BITFIELD numbers INCRBY u8 #0 15 -- 将整数的值加上 15
1) (integer) 25

BITFIELD numbers INCRBY u8 #0 30 -- 将整数值加上 30
1) (integer) 55

BITFIELD numbers INCRBY u8 #0 -25 -- 将整数值减去 25
1) (integer) 30
</code></pre></li>
<li>
<p>处理溢出<br>
BITFIELD 命令还可以使用 OVERFLOW 子命令去控制 INCRBY 子命令在发生计算溢出时的行为</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap [...] OVERFLOW WRAP|SAT|FAIL [...]
</code></pre><p>OVERFLOW 参数有 WRAP, SAT 和 FAIL</p>
<ul>
<li>WRAP 表示回绕 (wrap around) 方式处理溢出, 也就是 C 语言默认的溢出处理方式.</li>
<li>SAT 表示使用饱合运算 (saturation arithmetic) 方式处理溢出. 向上溢出的整数设置位最大值, 向下溢出的整数值则被设置位最小值</li>
<li>FAIL 表示让 INCRBY 子命令在检测到计算会引发溢出时, 拒绝执行计算, 并返回空值表示计算失败</li>
</ul>
<p>但 OVERFLOW 命令执行后不会产生任何返回, 此外, 如果没有设置溢出处理方式, 默认是 WRAP</p>
<p>需要注意的是, 由于 OVERFLOW 子命令只会对同一个 BITFIELD 调用中在其后面的 INCRBY 命令产生效果</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">BITFIELD bitmap INCRBY ... INCRBY OVERFLOW SAT INCRBY ...
</code></pre><p>上面命令中, 前两个就使用 WRAP 方法处理溢出, 第三个使用 SAT 方法处理溢出</p>
</li>
<li>
<p>使用位图存储整数的原因<br>
一般情况下, 用户使用字符串或者散列存储整数, Redis 都会为被存储的整数分配一个 long 类型的值, 并使用对象去包裹这个值, 然后再吧对象关联到数据库中</p>
<p>而 BITFIELD 命令运行用户自行指定存储整数的类型, 并且不会使用对象去包裹这些整数, 因此当想要存储长度比 long 类型短的整数, 并且希望尽可能减少对象包括带来的内存消耗, 就可以考虑使用 BITFIELD 存储整数</p>
</li>
<li>
<p>复杂度: O(N), N 为用户给定的子命令数量</p>
</li>
</ul>
<h3 id="示例-紧凑计数器">示例: 紧凑计数器<a hidden class="anchor" aria-hidden="true" href="#示例-紧凑计数器">#</a></h3>
<ul>
<li>与之间实现的计数器不同, 这个计数器允许用户自行指定计数器值的位长以及类型, 而不是使用 Redis 默认的 long 类型来存储计数器值</li>
<li>与字符串或者散列实现的计数器不同, 这个计数器只能使用整数作为索引, 因此只适合存储一些与数字 ID 想关联的计数器数据</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_bitmap_index</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;#&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CompactCounter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">bit_length</span><span class="p">,</span> <span class="n">signed</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;初始化紧凑计数器
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - client 指定客户端
</span></span></span><span class="line"><span class="cl"><span class="s2">        - key 参数指定计数器键名
</span></span></span><span class="line"><span class="cl"><span class="s2">        - bit_length 参数指定计数器存储的整数位
</span></span></span><span class="line"><span class="cl"><span class="s2">        - signed 参数用于指定计数器存储的符号
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;i&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bit_length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&#34;u&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bit_length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;对索引 index 的计数器执行加法操作, 然后返回计数器的当前值&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bitmap_index</span> <span class="o">=</span> <span class="n">get_bitmap_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BITFIELD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;OVERFLOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;INCRBY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">bitmap_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decrease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;对索引 index 上的计数器执行减法操作, 然后返回计数器的当前值&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bitmap_index</span> <span class="o">=</span> <span class="n">get_bitmap_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">decrement</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BITFIELD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;OVERFLOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;INCRBY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">bitmap_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">decrement</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;获取索引 index 上的计数器的当前值&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bitmap_index</span> <span class="o">=</span> <span class="n">get_bitmap_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BITfIELD&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">bitmap_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></div><p>假如要为一家游戏公司创建一个记录每个玩家每月登陆数的计数器, 按照一个月 30 天, 一天登陆 2~3 次的频率来计算, 一个普通玩家一个月的登陆次数通常不会超过 100 次. 对于这么小的数值, 使用 long 类型进行存储将浪费大量空间, 因此可以使用紧凑计数器来存储用户登陆次数:</p>
<ul>
<li>每个玩家都又一个整数类型的用户 ID, 可以使用 ID 作为计数器索引</li>
<li>对于每个玩家, 使用一个 16 位长的无符号整数来存储其一个月内的登陆次数</li>
<li>16 位无符号整数计数器能存储的最大值位 65536, 对于该功能来说, 已经足够大</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">counter</span> <span class="o">=</span> <span class="n">CompactCounter</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&#34;login_count&#34;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># 建立计数器</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">increase</span><span class="p">(</span><span class="mi">10086</span><span class="p">))</span> <span class="c1"># 记录第 1 次登陆</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">increase</span><span class="p">(</span><span class="mi">10086</span><span class="p">))</span> <span class="c1"># 再记录第 1 次登陆</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">10086</span><span class="p">))</span> <span class="c1"># 获取登陆次数</span>
</span></span></code></pre></div><ul>
<li>
<p>使用字符串命令对位图进行操作<br>
由于 Redis 位图在字符串的基础上实现, 所以它会将位图键看作一个字符串键</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">SETBIT bitmap 0 1
&gt; (integer) 0

TYPE bitmap
&gt; string
</code></pre><p>因此, 还可以使用字符串命令对位图进行操作</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">GET 8bit-int
&gt; &#34;\x04&#34;

GET 32bit-ints
&gt; &#34;\x00\x00\x00{\x00\x00\x01\x00\x00\x00\x00 ...}&#34;
</code></pre><p>也可以使用 STRLEN 命令获取位图的字节长度</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">STRLEN 8bit-int -- 1 字节
&gt; (integer) 1

STRLEN 32bit-ints -- 这个位图 16 字节
&gt; (integerf 16)
</code></pre><p>还可以使用 GETRANGE 命令获取位图的其中一部分字节:</p>
<pre tabindex="0"><code class="language-Redis" data-lang="Redis">GETRANGE 32bit-ints 0 3
</code></pre><p>诸如此类</p>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/redis/">Redis</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/english-for-programmers-03/">
    <span class="title">« Prev</span>
    <br>
    <span>English for Programmers - 03</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/redis-hyperloglog/">
    <span class="title">Next »</span>
    <br>
    <span>Redis HyperLogLog</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on x"
            href="https://x.com/intent/tweet/?text=Redis%20Bitmap&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f&amp;hashtags=Redis">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f&amp;title=Redis%20Bitmap&amp;summary=Redis%20Bitmap&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f&title=Redis%20Bitmap">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on whatsapp"
            href="https://api.whatsapp.com/send?text=Redis%20Bitmap%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on telegram"
            href="https://telegram.me/share/url?text=Redis%20Bitmap&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Redis Bitmap on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Redis%20Bitmap&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fredis-bitmap%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">Starslayerx&#39; Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
