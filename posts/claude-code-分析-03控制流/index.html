<!doctype html><html lang=en-US data-theme=nord><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ | Starslayerx' Blog</title><meta name=description content="ğŸ”„ æ§åˆ¶æµä¸ç¼–æ’å¼•æ“ sequenceDiagram participant User participant MainLoop as Main Loop (tt) participant LLM as LLM API participant ToolBatch as Tool Batcher..."><meta name=keywords content="Agent"><meta name=author content="Starlsayerx"><meta name=language content="en-US"><meta name=robots content="index, follow"><link rel=canonical href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-03%E6%8E%A7%E5%88%B6%E6%B5%81/><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-03%E6%8E%A7%E5%88%B6%E6%B5%81/"><meta property="og:site_name" content="Starslayerx' Blog"><meta property="og:title" content="Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ"><meta property="og:description" content='ğŸ”„ æ§åˆ¶æµä¸ç¼–æ’å¼•æ“ sequenceDiagram participant User participant MainLoop as Main Loop (tt) participant LLM as LLM API participant ToolBatch as Tool Batcher participant Tool1 as ReadTool participant Tool2 as GrepTool participant Tool3 as EditTool participant UI as UI Renderer User->>MainLoop: "Search for TODO comments and update them" MainLoop->>LLM: Stream request with context LLM-->>MainLoop: text_delta: "I&#39;ll search for TODOs..." MainLoop-->>UI: Update display LLM-->>MainLoop: tool_use: GrepTool LLM-->>MainLoop: tool_use: ReadTool (multiple files) LLM-->>MainLoop: message_stop MainLoop->>ToolBatch: Execute tool batch par Parallel Execution ToolBatch->>Tool1: ReadTool.call() [Read-only] ToolBatch->>Tool2: GrepTool.call() [Read-only] Tool1-->>UI: Progress: "Reading file1.js" Tool2-->>UI: Progress: "Searching *.js" Tool1-->>ToolBatch: Result: File contents Tool2-->>ToolBatch: Result: 5 matches end ToolBatch->>MainLoop: Tool results MainLoop->>LLM: Continue with results LLM-->>MainLoop: tool_use: EditTool MainLoop->>ToolBatch: Execute write tool Note over ToolBatch, Tool3: Sequential Execution ToolBatch->>Tool3: EditTool.call() [Write] Tool3-->>UI: Progress: "Editing file1.js" Tool3-->>ToolBatch: Result: Success ToolBatch->>MainLoop: Edit complete MainLoop->>LLM: Continue with result LLM-->>MainLoop: text_delta: "Updated 5 TODOs..." MainLoop-->>UI: Final response ä¸»å¯¹è¯å¾ªç¯ï¼šä¸€ä¸ªæµå¼çŠ¶æ€æœº Claude Code çš„æ ¸å¿ƒæ˜¯ tt å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°â€”â€”ä¸€ä¸ªç¼–æ’æ•´ä¸ªå¯¹è¯æµç¨‹çš„å¤æ‚çŠ¶æ€æœºã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®é™…ç»“æ„ï¼š'><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-14T11:00:00+01:00"><meta property="article:modified_time" content="2025-11-14T11:00:00+01:00"><meta property="article:tag" content="Agent"><meta property="og:image" content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:title content="Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ"><meta name=twitter:description content='ğŸ”„ æ§åˆ¶æµä¸ç¼–æ’å¼•æ“ sequenceDiagram participant User participant MainLoop as Main Loop (tt) participant LLM as LLM API participant ToolBatch as Tool Batcher participant Tool1 as ReadTool participant Tool2 as GrepTool participant Tool3 as EditTool participant UI as UI Renderer User->>MainLoop: "Search for TODO comments and update them" MainLoop->>LLM: Stream request with context LLM-->>MainLoop: text_delta: "I&#39;ll search for TODOs..." MainLoop-->>UI: Update display LLM-->>MainLoop: tool_use: GrepTool LLM-->>MainLoop: tool_use: ReadTool (multiple files) LLM-->>MainLoop: message_stop MainLoop->>ToolBatch: Execute tool batch par Parallel Execution ToolBatch->>Tool1: ReadTool.call() [Read-only] ToolBatch->>Tool2: GrepTool.call() [Read-only] Tool1-->>UI: Progress: "Reading file1.js" Tool2-->>UI: Progress: "Searching *.js" Tool1-->>ToolBatch: Result: File contents Tool2-->>ToolBatch: Result: 5 matches end ToolBatch->>MainLoop: Tool results MainLoop->>LLM: Continue with results LLM-->>MainLoop: tool_use: EditTool MainLoop->>ToolBatch: Execute write tool Note over ToolBatch, Tool3: Sequential Execution ToolBatch->>Tool3: EditTool.call() [Write] Tool3-->>UI: Progress: "Editing file1.js" Tool3-->>ToolBatch: Result: Success ToolBatch->>MainLoop: Edit complete MainLoop->>LLM: Continue with result LLM-->>MainLoop: text_delta: "Updated 5 TODOs..." MainLoop-->>UI: Final response ä¸»å¯¹è¯å¾ªç¯ï¼šä¸€ä¸ªæµå¼çŠ¶æ€æœº Claude Code çš„æ ¸å¿ƒæ˜¯ tt å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°â€”â€”ä¸€ä¸ªç¼–æ’æ•´ä¸ªå¯¹è¯æµç¨‹çš„å¤æ‚çŠ¶æ€æœºã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®é™…ç»“æ„ï¼š'><meta itemprop=name content="Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ"><meta itemprop=description content='ğŸ”„ æ§åˆ¶æµä¸ç¼–æ’å¼•æ“ sequenceDiagram participant User participant MainLoop as Main Loop (tt) participant LLM as LLM API participant ToolBatch as Tool Batcher participant Tool1 as ReadTool participant Tool2 as GrepTool participant Tool3 as EditTool participant UI as UI Renderer User->>MainLoop: "Search for TODO comments and update them" MainLoop->>LLM: Stream request with context LLM-->>MainLoop: text_delta: "I&#39;ll search for TODOs..." MainLoop-->>UI: Update display LLM-->>MainLoop: tool_use: GrepTool LLM-->>MainLoop: tool_use: ReadTool (multiple files) LLM-->>MainLoop: message_stop MainLoop->>ToolBatch: Execute tool batch par Parallel Execution ToolBatch->>Tool1: ReadTool.call() [Read-only] ToolBatch->>Tool2: GrepTool.call() [Read-only] Tool1-->>UI: Progress: "Reading file1.js" Tool2-->>UI: Progress: "Searching *.js" Tool1-->>ToolBatch: Result: File contents Tool2-->>ToolBatch: Result: 5 matches end ToolBatch->>MainLoop: Tool results MainLoop->>LLM: Continue with results LLM-->>MainLoop: tool_use: EditTool MainLoop->>ToolBatch: Execute write tool Note over ToolBatch, Tool3: Sequential Execution ToolBatch->>Tool3: EditTool.call() [Write] Tool3-->>UI: Progress: "Editing file1.js" Tool3-->>ToolBatch: Result: Success ToolBatch->>MainLoop: Edit complete MainLoop->>LLM: Continue with result LLM-->>MainLoop: text_delta: "Updated 5 TODOs..." MainLoop-->>UI: Final response ä¸»å¯¹è¯å¾ªç¯ï¼šä¸€ä¸ªæµå¼çŠ¶æ€æœº Claude Code çš„æ ¸å¿ƒæ˜¯ tt å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°â€”â€”ä¸€ä¸ªç¼–æ’æ•´ä¸ªå¯¹è¯æµç¨‹çš„å¤æ‚çŠ¶æ€æœºã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®é™…ç»“æ„ï¼š'><meta itemprop=datePublished content="2025-11-14T11:00:00+01:00"><meta itemprop=dateModified content="2025-11-14T11:00:00+01:00"><meta itemprop=wordCount content="3551"><meta itemprop=image content="https://starslayerx.github.io/images/og-default.avif"><meta itemprop=keywords content="Agent"><script>window.HUGO_SEARCH_CONFIG={searchIndexURL:'"/index.json"'}</script><script>window.HUGO_GALLERY_CONFIG={justified_gallery:!1,lightbox:!1,justified:'{"calculateitemsheight":false,"gutter":30,"lastrow":"center","maxrowscount":999999,"resizedebounce":100,"rowheight":300,"rowheighttolerance":0.25,"transitionduration":"0.3s"}',lightbox_options:'{"descposition":"bottom","draggable":true,"height":"80vh","loop":true,"preload":true,"touchnavigation":true,"width":"80vw","zoomable":true}'}</script><link rel=stylesheet href=/css/compiled.min.338a4488a1a13fb6d418dd89049bdfcf9d0e9f9d92f9603e4eb3f538ef13b169.css integrity="sha256-M4pEiKGhP7bUGN2JBJvfz50On52S+WA+TrP1OO8TsWk=" crossorigin=anonymous><link rel=stylesheet href=/css/chroma.min.491df36221f739b5948a747a0351f100ee7ccaaf466d9f46288bf06de1d59123.css integrity="sha256-SR3zYiH3ObWUinR6A1HxAO58yq9GbZ9GKIvwbeHVkSM=" crossorigin=anonymous><script src=/js/main.ba969e49a7a874e6938fe689a7dcaa00cb64cb4d429c2cf98d09bde512a16c6d.js integrity="sha256-upaeSaeodOaTj+aJp9yqAMtky01CnCz5jQm95RKhbG0=" crossorigin=anonymous></script><script src=/js/gumshoe.polyfills.min.js></script><script src=/js/toc.70654aebf0b738a78ae2df95297cc10ebc6e590f3c942dd1325fa852f50038b2.js integrity="sha256-cGVK6/C3OKeK4t+VKXzBDrxuWQ88lC3RMl+oUvUAOLI=" crossorigin=anonymous defer></script><script src=/js/search.de3eba3540834efb8328121784bff4774e06362412ee41eee665f5b4f987f393.js integrity="sha256-3j66NUCDTvuDKBIXhL/0d04GNiQS7kHu5mX1tPmH85M=" crossorigin=anonymous defer></script><script src=/js/dock.e02f422517e001d9fb6bea1e9e8b0e89e9d2e486ad4641f275bb3e36ce2ae79f.js integrity="sha256-4C9CJRfgAdn7a+oenosOienS5IatRkHydbs+Ns4q558=" crossorigin=anonymous defer></script><script>(function(){const e=localStorage.getItem("theme")||"system",n=localStorage.getItem("colorScheme")||"nord";document.documentElement.setAttribute("data-theme",n);function t(){e==="dark"||e==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}t(),e==="system"&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t)})()</script></head><body class="bg-background text-foreground min-h-screen antialiased"><div id=reading-progress-container class="reading-progress-container pointer-events-none fixed top-0 right-0 left-0 z-50 transition-opacity duration-300 ease-out" data-height=3 data-smooth-scroll=true data-hide-on-complete=false><div class="reading-progress-bg w-full"></div><div id=reading-progress-bar class="from-primary to-primary/80 reading-progress-bar
transition-all duration-150 ease-out
absolute top-0 left-0 w-0 bg-gradient-to-r"></div></div><script>(function(){"use strict";const t=document.getElementById("reading-progress-container"),o=document.getElementById("reading-progress-bar");if(!t||!o)return;const a={smoothScroll:t.dataset.smoothScroll==="true",hideOnComplete:t.dataset.hideOnComplete==="true"};let n=!0,l=null;function r(){const t=window.pageYOffset||document.documentElement.scrollTop,n=document.documentElement.scrollHeight,s=window.innerHeight,e=n-s;return e<=0?0:Math.min(Math.max(t/e*100,0),100)}function c(){const e=r();o.style.width=e+"%",a.hideOnComplete&&e>=99.5?n&&(t.style.opacity="0",n=!1):n||(t.style.opacity="1",n=!0)}let s=!1;function e(){s||(requestAnimationFrame(()=>{c(),s=!1}),s=!0)}function i(){window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("resize",e,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.hidden||e()}),e(),window.addEventListener("beforeunload",()=>{window.removeEventListener("scroll",e),window.removeEventListener("resize",e)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",i):i()})()</script><header class="sticky top-0 z-50 mx-auto max-w-4xl px-4 py-6"><div class="border-border bg-card/80 flex items-center rounded-xl border px-6 py-4 shadow-sm backdrop-blur-sm"><div class="hidden w-full items-center md:flex"><div class="flex items-center"><a href=/ class="flex h-10 w-10 items-center justify-center overflow-hidden rounded-full transition-transform duration-200 hover:scale-105" aria-label="Starslayerx' Blog"><img src=/images/logo.svg alt="Starslayerx' Blog" class="h-full w-full object-cover"></a></div><nav class="mx-8 flex flex-1 items-center justify-center"><div class="flex items-center space-x-1"><a href=/posts/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.posts"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
<span>Posts
</span></a><a href=/categories/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.categories"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
<span>Categories
</span></a><a href=/tags/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.tags"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg>
<span>Tags
</span></a><a href=/archives/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.archives"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
<span>Archives</span></a></div></nav><div class="flex items-center space-x-2"><div class=relative><button id=language-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex h-10 w-10 items-center justify-center rounded-lg border transition-all duration-300 ease-out hover:scale-105 focus:ring-2 focus:outline-none active:scale-95" data-dropdown-type=language aria-label="Switch language" aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Switch language"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m5 8 6 6m-7 0 6-6 2-3M2 5h12M7 2h1m14 20-5-10-5 10m2-4h6"/></svg></button><div id=language-dropdown class="dropdown-menu border-border bg-popover/95 absolute top-12 right-0 z-[60] hidden w-40 rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out" data-dropdown-type=language role=menu aria-labelledby=language-toggle><a href=/en/ class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none" role=menuitem aria-current=true><span class=font-medium>English</span></a><a href=/zh-cn/ class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none" role=menuitem><span class=font-medium>ç®€ä½“ä¸­æ–‡</span></a></div></div><div class=relative><button id=color-scheme-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex h-10 w-10 items-center justify-center rounded-lg border transition-all duration-300 ease-out hover:scale-105 focus:ring-2 focus:outline-none active:scale-95" data-dropdown-type=color-scheme aria-label="Toggle theme" aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Toggle theme"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v6a2 2 0 002 2h4a2 2 0 002-2V5z"/></svg></button><div id=color-scheme-dropdown class="dropdown-menu border-border bg-popover/95 absolute top-12 right-0 z-[60] hidden w-44 rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out" data-dropdown-type=color-scheme><button data-color-scheme=default class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Default</span></button><button data-color-scheme=claude class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Claude</span></button><button data-color-scheme=bumblebee class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Bumblebee</span></button><button data-color-scheme=emerald class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Emerald</span></button><button data-color-scheme=nord class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Nord</span></button><button data-color-scheme=sunset class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Sunset</span></button><button data-color-scheme=abyss class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Abyss</span></button><button data-color-scheme=dracula class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Dracula</span></button><button data-color-scheme=amethyst class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Amethyst</span></button><button data-color-scheme=slate class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Slate</span></button><button data-color-scheme=twitter class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Twitter</span></button></div></div><div class=relative><button id=theme-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex h-10 w-10 items-center justify-center rounded-lg border transition-all duration-300 ease-out hover:scale-105 focus:ring-2 focus:outline-none active:scale-95" data-dropdown-type=theme aria-label="Toggle theme" aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5 sun-icon hidden relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Light"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
<svg class="h-5 w-5 moon-icon hidden relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Dark"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg>
<svg class="h-5 w-5 system-icon hidden relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="System"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17 9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5A2 2 0 003 5v10a2 2 0 002 2z"/></svg></button><div id=theme-dropdown class="dropdown-menu border-border bg-popover/95 absolute top-12 right-0 z-[60] hidden w-40 rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out" data-dropdown-type=theme><button data-theme=light class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none">
<svg class="h-5 w-5 mr-3 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Light"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span>Light</span></button><button data-theme=dark class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none">
<svg class="h-5 w-5 mr-3 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Dark"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg><span>Dark</span></button><button data-theme=system class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none">
<svg class="h-5 w-5 mr-3 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="System"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17 9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5A2 2 0 003 5v10a2 2 0 002 2z"/></svg><span>System</span></button></div></div></div></div><div class="flex w-full items-center justify-between md:hidden"><div class=relative><button id=mobile-menu-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:bg-accent hover:text-foreground flex h-10 w-10 items-center justify-center rounded-lg border transition-colors duration-200" data-dropdown-type=mobile-menu aria-label=Menu aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Menu"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><div id=mobile-menu class="mobile-menu dropdown-menu border-border bg-popover/95 absolute top-12 left-0 z-[60] hidden w-80 max-w-[calc(100vw-2rem)] rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out md:hidden" data-dropdown-type=mobile-menu role=menu aria-labelledby=mobile-menu-toggle><nav class="flex flex-col"><a href=/posts/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-3 rounded-md px-4 py-3 text-sm font-medium transition-all duration-200 ease-out hover:translate-x-1 focus:ring-2 focus:outline-none" role=menuitem><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.posts"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
<span>Posts
</span></a><a href=/categories/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-3 rounded-md px-4 py-3 text-sm font-medium transition-all duration-200 ease-out hover:translate-x-1 focus:ring-2 focus:outline-none" role=menuitem><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.categories"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
<span>Categories
</span></a><a href=/tags/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-3 rounded-md px-4 py-3 text-sm font-medium transition-all duration-200 ease-out hover:translate-x-1 focus:ring-2 focus:outline-none" role=menuitem><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.tags"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512.0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828.0l-7-7A1.994 1.994.0 013 12V7a4 4 0 014-4z"/></svg>
<span>Tags
</span></a><a href=/archives/ class="nav-link
text-muted-foreground hover:text-primary hover:bg-primary/10
focus:ring-primary/20 relative flex items-center gap-3 rounded-md px-4 py-3 text-sm font-medium transition-all duration-200 ease-out hover:translate-x-1 focus:ring-2 focus:outline-none" role=menuitem><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="nav.archives"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
<span>Archives</span></a></nav></div></div><div class="flex items-center space-x-2"><div class=relative><button id=language-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex h-10 w-10 items-center justify-center rounded-lg border transition-all duration-300 ease-out hover:scale-105 focus:ring-2 focus:outline-none active:scale-95" data-dropdown-type=language aria-label="Switch language" aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Switch language"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m5 8 6 6m-7 0 6-6 2-3M2 5h12M7 2h1m14 20-5-10-5 10m2-4h6"/></svg></button><div id=language-dropdown class="dropdown-menu border-border bg-popover/95 absolute top-12 right-0 z-[60] hidden w-40 rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out" data-dropdown-type=language role=menu aria-labelledby=language-toggle><a href=/en/ class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none" role=menuitem aria-current=true><span class=font-medium>English</span></a><a href=/zh-cn/ class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none" role=menuitem><span class=font-medium>ç®€ä½“ä¸­æ–‡</span></a></div></div><div class=relative><button id=color-scheme-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex h-10 w-10 items-center justify-center rounded-lg border transition-all duration-300 ease-out hover:scale-105 focus:ring-2 focus:outline-none active:scale-95" data-dropdown-type=color-scheme aria-label="Toggle theme" aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Toggle theme"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v6a2 2 0 002 2h4a2 2 0 002-2V5z"/></svg></button><div id=color-scheme-dropdown class="dropdown-menu border-border bg-popover/95 absolute top-12 right-0 z-[60] hidden w-44 rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out" data-dropdown-type=color-scheme><button data-color-scheme=default class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Default</span></button><button data-color-scheme=claude class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Claude</span></button><button data-color-scheme=bumblebee class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Bumblebee</span></button><button data-color-scheme=emerald class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Emerald</span></button><button data-color-scheme=nord class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Nord</span></button><button data-color-scheme=sunset class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Sunset</span></button><button data-color-scheme=abyss class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Abyss</span></button><button data-color-scheme=dracula class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Dracula</span></button><button data-color-scheme=amethyst class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Amethyst</span></button><button data-color-scheme=slate class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Slate</span></button><button data-color-scheme=twitter class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none"><span>Twitter</span></button></div></div><div class=relative><button id=theme-toggle class="dropdown-toggle border-border bg-background text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex h-10 w-10 items-center justify-center rounded-lg border transition-all duration-300 ease-out hover:scale-105 focus:ring-2 focus:outline-none active:scale-95" data-dropdown-type=theme aria-label="Toggle theme" aria-expanded=false aria-haspopup=true>
<svg class="h-5 w-5 sun-icon hidden relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Light"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
<svg class="h-5 w-5 moon-icon hidden relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Dark"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg>
<svg class="h-5 w-5 system-icon hidden relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="System"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17 9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5A2 2 0 003 5v10a2 2 0 002 2z"/></svg></button><div id=theme-dropdown class="dropdown-menu border-border bg-popover/95 absolute top-12 right-0 z-[60] hidden w-40 rounded-lg border p-1 shadow-lg backdrop-blur-sm transition-all duration-200 ease-out" data-dropdown-type=theme><button data-theme=light class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none">
<svg class="h-5 w-5 mr-3 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Light"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span>Light</span></button><button data-theme=dark class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none">
<svg class="h-5 w-5 mr-3 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Dark"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg><span>Dark</span></button><button data-theme=system class="text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground flex w-full items-center rounded-md px-4 py-2 text-sm transition-all duration-200 ease-out focus:outline-none">
<svg class="h-5 w-5 mr-3 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="System"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17 9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5A2 2 0 003 5v10a2 2 0 002 2z"/></svg><span>System</span></button></div></div></div></div></div></header><main class="mx-auto max-w-4xl px-4 py-6"><nav class="breadcrumb mb-4 md:mb-6 py-1" aria-label="Breadcrumb navigation"><ol class="text-muted-foreground flex items-center space-x-1 md:space-x-2 text-sm overflow-x-auto whitespace-nowrap scrollbar-hide py-1"><li class=flex-shrink-0><a href=/ class="text-muted-foreground hover:text-primary hover:bg-primary/10 flex items-center gap-0.5 md:gap-1 rounded-lg px-1 md:px-3 py-0.5 md:py-1.5 transition-all duration-200 ease-out hover:-translate-y-0.5 hover:scale-[1.02]"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Home"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11 2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
<span class="max-w-[4rem] md:max-w-none truncate">Home</span></a></li><li class="flex items-center gap-1 md:gap-2 min-w-0"><span class="text-muted-foreground/50 flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></span><div class="flex items-center gap-1 md:gap-2 min-w-0"><a href=/posts class="text-muted-foreground hover:text-primary hover:bg-primary/10 flex items-center gap-0.5 md:gap-1 rounded-lg px-1 md:px-3 py-0.5 md:py-1.5 transition-all duration-200 ease-out hover:-translate-y-0.5 hover:scale-[1.02] flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
<span class="max-w-[3rem] md:max-w-none truncate">Posts</span>
</a><span class="text-muted-foreground/50 flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></span>
<span class="text-foreground flex items-center gap-0.5 md:gap-1 font-medium min-w-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
<span class="max-w-[8rem] md:max-w-[16rem] lg:max-w-none truncate">Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ</span></span></div></li></ol></nav><header class=mb-8><div class=post-meta><h1 class="text-foreground mb-6 text-3xl leading-tight font-bold md:text-4xl">Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ</h1><div class="bg-card border-border flex flex-col gap-4 rounded-xl border p-6"><div class="text-muted-foreground flex flex-wrap items-center gap-4 text-sm"><div class="flex items-center gap-2"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Published on"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-11-14>November 14, 2025</time></div><div class="flex items-center gap-2"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Reading time"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>
<span>8 minute</span></div><div class="flex items-center gap-2"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Word count"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/></svg>
<span>3551 words</span></div></div><div class="flex flex-wrap items-center gap-4"><div class="flex items-center gap-2"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Tags"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M12.586 2.586A2 2 0 0011.172 2H4A2 2 0 002 4v7.172a2 2 0 00.586 1.414l8.704 8.704a2.426 2.426.0 003.42.0l6.58-6.58a2.426 2.426.0 000-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></g></svg>
<span class="text-muted-foreground mr-2 text-sm">Tags:</span><div class="flex flex-wrap gap-2"><a href=/tags/agent/ class="bg-muted/50 text-muted-foreground hover:bg-primary/10 hover:text-primary focus:ring-primary/20 inline-flex items-center rounded px-2 py-1 text-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none">#Agent</a></div></div></div></div></div></header><article class="prose prose-neutral dark:prose-invert mb-12 max-w-none"><h1 id=-æ§åˆ¶æµä¸ç¼–æ’å¼•æ“>ğŸ”„ æ§åˆ¶æµä¸ç¼–æ’å¼•æ“</h1><pre class=mermaid>
  sequenceDiagram
    participant User
    participant MainLoop as Main Loop (tt)
    participant LLM as LLM API
    participant ToolBatch as Tool Batcher
    participant Tool1 as ReadTool
    participant Tool2 as GrepTool
    participant Tool3 as EditTool
    participant UI as UI Renderer
    User-&gt;&gt;MainLoop: &#34;Search for TODO comments and update them&#34;
    MainLoop-&gt;&gt;LLM: Stream request with context
    LLM--&gt;&gt;MainLoop: text_delta: &#34;I&#39;ll search for TODOs...&#34;
    MainLoop--&gt;&gt;UI: Update display
    LLM--&gt;&gt;MainLoop: tool_use: GrepTool
    LLM--&gt;&gt;MainLoop: tool_use: ReadTool (multiple files)
    LLM--&gt;&gt;MainLoop: message_stop
    MainLoop-&gt;&gt;ToolBatch: Execute tool batch
    par Parallel Execution
        ToolBatch-&gt;&gt;Tool1: ReadTool.call() [Read-only]
        ToolBatch-&gt;&gt;Tool2: GrepTool.call() [Read-only]
        Tool1--&gt;&gt;UI: Progress: &#34;Reading file1.js&#34;
        Tool2--&gt;&gt;UI: Progress: &#34;Searching *.js&#34;
        Tool1--&gt;&gt;ToolBatch: Result: File contents
        Tool2--&gt;&gt;ToolBatch: Result: 5 matches
    end
    ToolBatch-&gt;&gt;MainLoop: Tool results
    MainLoop-&gt;&gt;LLM: Continue with results
    LLM--&gt;&gt;MainLoop: tool_use: EditTool
    MainLoop-&gt;&gt;ToolBatch: Execute write tool
    Note over ToolBatch, Tool3: Sequential Execution
    ToolBatch-&gt;&gt;Tool3: EditTool.call() [Write]
    Tool3--&gt;&gt;UI: Progress: &#34;Editing file1.js&#34;
    Tool3--&gt;&gt;ToolBatch: Result: Success
    ToolBatch-&gt;&gt;MainLoop: Edit complete
    MainLoop-&gt;&gt;LLM: Continue with result
    LLM--&gt;&gt;MainLoop: text_delta: &#34;Updated 5 TODOs...&#34;
    MainLoop--&gt;&gt;UI: Final response
</pre><h2 id=ä¸»å¯¹è¯å¾ªç¯ä¸€ä¸ªæµå¼çŠ¶æ€æœº>ä¸»å¯¹è¯å¾ªç¯ï¼šä¸€ä¸ªæµå¼çŠ¶æ€æœº</h2><p>Claude Code çš„æ ¸å¿ƒæ˜¯ <code>tt</code> å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°â€”â€”ä¸€ä¸ªç¼–æ’æ•´ä¸ªå¯¹è¯æµç¨‹çš„å¤æ‚çŠ¶æ€æœºã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®é™…ç»“æ„ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-1 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-1 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-1><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// é‡æ„çš„ä¸»å¾ªç¯ç­¾åï¼Œå¸¦æœ‰æ—¶é—´æ³¨è§£
</span></span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span><span class=o>*</span> <span class=nx>tt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>currentMessages</span>: <span class=kt>CliMessage</span><span class=p>[],</span>         <span class=c1>// å®Œæ•´å†å² - å†…å­˜: O(conversation_length)
</span></span></span><span class=line><span class=cl>  <span class=nx>baseSystemPromptString</span>: <span class=kt>string</span><span class=p>,</span>        <span class=c1>// é™æ€æç¤ºè¯ - ~2KB
</span></span></span><span class=line><span class=cl>  <span class=nx>currentGitContext</span>: <span class=kt>GitContext</span><span class=p>,</span>         <span class=c1>// Git çŠ¶æ€ - é€šå¸¸ ~1-5KB
</span></span></span><span class=line><span class=cl>  <span class=nx>currentClaudeMdContents</span>: <span class=kt>ClaudeMdContent</span><span class=p>[],</span> <span class=c1>// é¡¹ç›®ä¸Šä¸‹æ–‡ - ~5-50KB
</span></span></span><span class=line><span class=cl>  <span class=nx>permissionGranterFn</span>: <span class=kt>PermissionGranter</span><span class=p>,</span> <span class=c1>// æƒé™å›è°ƒ
</span></span></span><span class=line><span class=cl>  <span class=nx>toolUseContext</span>: <span class=kt>ToolUseContext</span><span class=p>,</span>         <span class=c1>// å…±äº«ä¸Šä¸‹æ–‡ - ~10KB
</span></span></span><span class=line><span class=cl>  <span class=nx>activeStreamingToolUse?</span>: <span class=kt>ToolUseBlock</span><span class=p>,</span>  <span class=c1>// æ¢å¤çŠ¶æ€
</span></span></span><span class=line><span class=cl>  <span class=nx>loopState</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>turnId</span>: <span class=kt>string</span><span class=p>,</span>        <span class=c1>// æœ¬è½®çš„ UUID
</span></span></span><span class=line><span class=cl>    <span class=nx>turnCounter</span>: <span class=kt>number</span><span class=p>,</span>   <span class=c1>// é€’å½’æ·±åº¦
</span></span></span><span class=line><span class=cl>    <span class=nx>compacted?</span>: <span class=kt>boolean</span><span class=p>,</span>   <span class=c1>// å†å²æ˜¯å¦è¢«å‹ç¼©
</span></span></span><span class=line><span class=cl>    <span class=nx>isResuming?</span>: <span class=kt>boolean</span>   <span class=c1>// æ˜¯å¦ä»ä¿å­˜ä¸­æ¢å¤
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>,</span> <span class=na>void</span><span class=p>,</span> <span class=na>void</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// â”Œâ”€ é˜¶æ®µ 1: ä¸Šä¸‹æ–‡å‡†å¤‡ [~50-200ms]
</span></span></span><span class=line><span class=cl>  <span class=c1>// â”œâ”€ é˜¶æ®µ 2: è‡ªåŠ¨å‹ç¼©æ£€æŸ¥ [è§¦å‘æ—¶ ~0-3000ms]
</span></span></span><span class=line><span class=cl>  <span class=c1>// â”œâ”€ é˜¶æ®µ 3: ç³»ç»Ÿæç¤ºè¯ç»„è£… [~10-50ms]
</span></span></span><span class=line><span class=cl>  <span class=c1>// â”œâ”€ é˜¶æ®µ 4: LLM æµå¤„ç† [~2000-10000ms]
</span></span></span><span class=line><span class=cl>  <span class=c1>// â”œâ”€ é˜¶æ®µ 5: å·¥å…·æ‰§è¡Œ [æ¯ä¸ªå·¥å…· ~100-30000ms]
</span></span></span><span class=line><span class=cl>  <span class=c1>// â””â”€ é˜¶æ®µ 6: é€’å½’æˆ–å®Œæˆ [~0ms]
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-1",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=é˜¶æ®µ-1ä¸Šä¸‹æ–‡çª—å£ç®¡ç†>é˜¶æ®µ 1ï¼šä¸Šä¸‹æ–‡çª—å£ç®¡ç†</h3><p>æ§åˆ¶æµä¸­çš„ç¬¬ä¸€ä¸ªå…³é”®å†³ç­–æ˜¯åˆ¤æ–­å¯¹è¯æ˜¯å¦éœ€è¦å‹ç¼©ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-2 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-2 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-2><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// è‡ªåŠ¨å‹ç¼©é€»è¾‘ï¼ˆæ¨æ–­å®ç°ï¼‰
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ContextCompactionController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=kr>readonly</span> <span class=nx>COMPACTION_THRESHOLDS</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokenCount</span>: <span class=kt>100_000</span><span class=p>,</span>      <span class=c1>// æ¿€è¿›çš„ token é™åˆ¶
</span></span></span><span class=line><span class=cl>    <span class=nx>messageCount</span>: <span class=kt>200</span><span class=p>,</span>        <span class=c1>// æ¶ˆæ¯æ•°é‡å¤‡é€‰
</span></span></span><span class=line><span class=cl>    <span class=nx>costThreshold</span>: <span class=kt>5.00</span>       <span class=c1>// åŸºäºæˆæœ¬çš„è§¦å‘å™¨
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>shouldCompact</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>messages</span>: <span class=kt>CliMessage</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>model</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¿«é€Ÿè·¯å¾„ï¼šé¦–å…ˆæ£€æŸ¥æ¶ˆæ¯æ•°é‡
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>messages</span><span class=p>.</span><span class=nx>length</span> <span class=o>&lt;</span> <span class=mi>50</span><span class=p>)</span> <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ˜‚è´µè·¯å¾„ï¼šè®¡ç®— token
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>tokenCount</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>estimateTokens</span><span class=p>(</span><span class=nx>messages</span><span class=p>,</span> <span class=nx>model</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>tokenCount</span> <span class=o>&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>COMPACTION_THRESHOLDS</span><span class=p>.</span><span class=nx>tokenCount</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=nx>messages</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>COMPACTION_THRESHOLDS</span><span class=p>.</span><span class=nx>messageCount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>compact</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>messages</span>: <span class=kt>CliMessage</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolUseContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>CompactionResult</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 1ï¼šè¯†åˆ«éœ€è¦ä¿ç•™çš„æ¶ˆæ¯
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>preserve</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>identifyPreservedMessages</span><span class=p>(</span><span class=nx>messages</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 2ï¼šé€šè¿‡ LLM ç”Ÿæˆæ‘˜è¦
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>summary</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>generateSummary</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>messages</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>m</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=nx>preserve</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>uuid</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 3ï¼šé‡å»ºæ¶ˆæ¯å†å²
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>messages</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>createSummaryMessage</span><span class=p>(</span><span class=nx>summary</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>messages</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>m</span> <span class=o>=&gt;</span> <span class=nx>preserve</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>uuid</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>tokensaved</span>: <span class=kt>this.calculateSavings</span><span class=p>(</span><span class=nx>messages</span><span class=p>,</span> <span class=nx>summary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-2",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><p><strong>æ€§èƒ½ç‰¹å¾</strong>ï¼š</p><ul><li>Token è®¡æ•°ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯æ¶ˆæ¯å†…å®¹æ€»é•¿åº¦</li><li>æ‘˜è¦ç”Ÿæˆï¼šé¢å¤–ä¸€æ¬¡ LLM è°ƒç”¨ï¼ˆ~2-3sï¼‰</li><li>å†…å­˜å½±å“ï¼šå‹ç¼©æœŸé—´ä¸´æ—¶åŒå€æ¶ˆæ¯å­˜å‚¨</li></ul><h3 id=é˜¶æ®µ-2åŠ¨æ€ç³»ç»Ÿæç¤ºè¯ç»„è£…>é˜¶æ®µ 2ï¼šåŠ¨æ€ç³»ç»Ÿæç¤ºè¯ç»„è£…</h3><p>ç³»ç»Ÿæç¤ºè¯ç»„è£…å±•ç°äº†ä¸€ä¸ªå¤æ‚çš„ç¼“å­˜å’Œç»„åˆç­–ç•¥ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-3 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-3 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// ç³»ç»Ÿæç¤ºè¯ç»„åˆæµæ°´çº¿
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>SystemPromptAssembler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>content</span><span class=err>:</span> <span class=na>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=na>hash</span><span class=err>:</span> <span class=na>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=na>expiry</span><span class=err>:</span> <span class=na>number</span>
</span></span><span class=line><span class=cl>  <span class=p>}&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>assemble</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>basePrompt</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>claudeMd</span>: <span class=kt>ClaudeMdContent</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>gitContext</span>: <span class=kt>GitContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>tools</span>: <span class=kt>ToolDefinition</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>model</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>string</span> <span class=err>|</span> <span class=na>ContentBlock</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¹¶è¡Œè·å–åŠ¨æ€ç»„ä»¶
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=nx>claudeMdSection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>gitSection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>directorySection</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolSection</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>formatClaudeMd</span><span class=p>(</span><span class=nx>claudeMd</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>formatGitContext</span><span class=p>(</span><span class=nx>gitContext</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getDirectoryStructure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>formatToolDefinitions</span><span class=p>(</span><span class=nx>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ¨¡å‹ç‰¹å®šé€‚é…
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>modelSection</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getModelAdaptations</span><span class=p>(</span><span class=nx>model</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä½¿ç”¨æ™ºèƒ½æˆªæ–­è¿›è¡Œç»„åˆ
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>compose</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>base</span>: <span class=kt>basePrompt</span><span class=p>,</span>           <span class=c1>// ä¼˜å…ˆçº§ 1
</span></span></span><span class=line><span class=cl>      <span class=nx>model</span>: <span class=kt>modelSection</span><span class=p>,</span>        <span class=c1>// ä¼˜å…ˆçº§ 2
</span></span></span><span class=line><span class=cl>      <span class=nx>claudeMd</span>: <span class=kt>claudeMdSection</span><span class=p>,</span>  <span class=c1>// ä¼˜å…ˆçº§ 3
</span></span></span><span class=line><span class=cl>      <span class=nx>git</span>: <span class=kt>gitSection</span><span class=p>,</span>           <span class=c1>// ä¼˜å…ˆçº§ 4
</span></span></span><span class=line><span class=cl>      <span class=nx>directory</span>: <span class=kt>directorySection</span><span class=p>,</span> <span class=c1>// ä¼˜å…ˆçº§ 5
</span></span></span><span class=line><span class=cl>      <span class=nx>tools</span>: <span class=kt>toolSection</span>         <span class=c1>// ä¼˜å…ˆçº§ 6
</span></span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>getModelAdaptations</span><span class=p>(</span><span class=nx>model</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ¨¡å‹ç‰¹å®šçš„æç¤ºå·¥ç¨‹
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>adaptations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;claude-3-opus&#39;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>style</span><span class=o>:</span> <span class=s1>&#39;detailed&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>instructions</span><span class=o>:</span> <span class=s1>&#39;Think step by step. Show your reasoning.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>tokenBudget</span>: <span class=kt>0.3</span>  <span class=c1>// ä¸Šä¸‹æ–‡çš„ 30% ç”¨äºæ¨ç†
</span></span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;claude-3-sonnet&#39;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>style</span><span class=o>:</span> <span class=s1>&#39;balanced&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>instructions</span><span class=o>:</span> <span class=s1>&#39;Be concise but thorough.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>tokenBudget</span>: <span class=kt>0.2</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;claude-3-haiku&#39;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>style</span><span class=o>:</span> <span class=s1>&#39;brief&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>instructions</span><span class=o>:</span> <span class=s1>&#39;Get to the point quickly.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>tokenBudget</span>: <span class=kt>0.1</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=nx>adaptations</span><span class=p>[</span><span class=nx>model</span><span class=p>]</span> <span class=o>||</span> <span class=nx>adaptations</span><span class=p>[</span><span class=s1>&#39;claude-3-sonnet&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>formatModelInstructions</span><span class=p>(</span><span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-3",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=é˜¶æ®µ-3æµå¼çŠ¶æ€æœº>é˜¶æ®µ 3ï¼šæµå¼çŠ¶æ€æœº</h3><p>LLM æµå¼å¤„ç†é˜¶æ®µå®ç°äº†ä¸€ä¸ªå¤æ‚çš„äº‹ä»¶é©±åŠ¨çŠ¶æ€æœºï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-4 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-4 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-4><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æµäº‹ä»¶å¤„ç†çŠ¶æ€æœº
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>StreamEventProcessor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>state</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>phase</span><span class=o>:</span> <span class=s1>&#39;idle&#39;</span> <span class=o>|</span> <span class=s1>&#39;message_start&#39;</span> <span class=o>|</span> <span class=s1>&#39;content&#39;</span> <span class=o>|</span> <span class=s1>&#39;tool_input&#39;</span> <span class=o>|</span> <span class=s1>&#39;complete&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentMessage</span>: <span class=kt>Partial</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>    <span class=nx>contentBlocks</span>: <span class=kt>ContentBlock</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=nx>activeToolInput</span><span class=o>?:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolId</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>buffer</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>parser</span>: <span class=kt>StreamingToolInputParser</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>metrics</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>firstTokenLatency?</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>tokensPerSecond</span>: <span class=kt>number</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=o>*</span><span class=nx>processStream</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>stream</span>: <span class=kt>AsyncIterable</span><span class=p>&lt;</span><span class=nt>StreamEvent</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>UIEvent</span> <span class=err>|</span> <span class=na>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>event</span> <span class=k>of</span> <span class=nx>stream</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>switch</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;message_start&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>phase</span> <span class=o>=</span> <span class=s1>&#39;message_start&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>firstTokenLatency</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>-</span> <span class=nx>startTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span> <span class=p>{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;ui_state&#39;</span><span class=p>,</span> <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;assistant_responding&#39;</span> <span class=p>}</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;content_block_start&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleContentBlockStart</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;content_block_delta&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleContentBlockDelta</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;content_block_stop&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleContentBlockStop</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;message_stop&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>finalizeMessage</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;error&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleError</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>handleContentBlockDelta</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>event</span>: <span class=kt>ContentBlockDeltaEvent</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>UIEvent</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>block</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>contentBlocks</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;text_delta&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ–‡æœ¬çš„ç›´æ¥ UI æ›´æ–°
</span></span></span><span class=line><span class=cl>        <span class=nx>block</span><span class=p>.</span><span class=nx>text</span> <span class=o>+=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;ui_text_delta&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>text</span>: <span class=kt>event.delta.text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>blockIndex</span>: <span class=kt>event.index</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;input_json_delta&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ç´¯ç§¯å·¥å…·è¾“å…¥çš„ JSON
</span></span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>activeToolInput</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>activeToolInput</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>+=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>partial_json</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1>// åœ¨å…³é”®ç‚¹å°è¯•è§£æ
</span></span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>partial_json</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;}&#39;</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>              <span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>partial_json</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;]&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>activeToolInput</span><span class=p>.</span><span class=nx>parser</span><span class=p>.</span><span class=nx>addChunk</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>partial_json</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>complete</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>block</span><span class=p>.</span><span class=nx>input</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;ui_tool_preview&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>toolId</span>: <span class=kt>this.state.activeToolInput.toolId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>input</span>: <span class=kt>result.value</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=p>};</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-4",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=é˜¶æ®µ-4å·¥å…·æ‰§è¡Œæµæ°´çº¿>é˜¶æ®µ 4ï¼šå·¥å…·æ‰§è¡Œæµæ°´çº¿</h3><p>å·¥å…·æ‰§è¡Œç³»ç»Ÿå®ç°äº†ä¸€ä¸ªå¤æ‚çš„å¹¶è¡Œ/é¡ºåºæ‰§è¡Œç­–ç•¥ï¼š</p><pre class=mermaid>
  graph TB
    subgraph &#34;å·¥å…·è¯·æ±‚åˆ†æ&#34;
        ToolRequests[Tool Use Blocks] --&gt; Categorize{æŒ‰ç±»å‹åˆ†ç±»}
        Categorize --&gt;|åªè¯»| ReadQueue[è¯»å–é˜Ÿåˆ—]
        Categorize --&gt;|å†™å…¥/å‰¯ä½œç”¨| WriteQueue[å†™å…¥é˜Ÿåˆ—]
    end

    subgraph &#34;å¹¶è¡Œæ‰§è¡Œæ± &#34;
        ReadQueue --&gt; ParallelPool[å¹¶è¡Œæ‰§è¡Œå™¨]
        ParallelPool --&gt; Worker1[Worker 1]
        ParallelPool --&gt; Worker2[Worker 2]
        ParallelPool --&gt; WorkerN[Worker N]

        Worker1 --&gt; Results1[Result 1]
        Worker2 --&gt; Results2[Result 2]
        WorkerN --&gt; ResultsN[Result N]
    end

    subgraph &#34;é¡ºåºæ‰§è¡Œ&#34;
        WriteQueue --&gt; SeqExecutor[é¡ºåºæ‰§è¡Œå™¨]
        Results1 --&gt; SeqExecutor
        Results2 --&gt; SeqExecutor
        ResultsN --&gt; SeqExecutor

        SeqExecutor --&gt; WriteTool1[Write Tool 1]
        WriteTool1 --&gt; WriteTool2[Write Tool 2]
        WriteTool2 --&gt; FinalResults[æ‰€æœ‰ç»“æœ]
    end
</pre><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-6 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-6 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-6><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// å¹¶è¡Œæ‰§è¡Œç¼–æ’å™¨
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ToolExecutionOrchestrator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=kr>readonly</span> <span class=nx>CONCURRENCY_LIMIT</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>executeToolBatch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolUses</span>: <span class=kt>ToolUseBlock</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolUseContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>permissionFn</span>: <span class=kt>PermissionGranter</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 1ï¼šå·¥å…·åˆ†ç±»
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>readOnly</span><span class=p>,</span> <span class=nx>writeTools</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>categorizeTools</span><span class=p>(</span><span class=nx>toolUses</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 2ï¼šå¹¶è¡Œæ‰§è¡Œåªè¯»å·¥å…·
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>readOnly</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>executeParallel</span><span class=p>(</span><span class=nx>readOnly</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>permissionFn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 3ï¼šé¡ºåºæ‰§è¡Œå†™å…¥å·¥å…·
</span></span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>tool</span> <span class=k>of</span> <span class=nx>writeTools</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>executeSequential</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>permissionFn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>executeParallel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tools</span>: <span class=kt>ToolUseBlock</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolUseContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>permissionFn</span>: <span class=kt>PermissionGranter</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>executions</span> <span class=o>=</span> <span class=nx>tools</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>tool</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>createToolExecution</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>permissionFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è‡ªå®šä¹‰å¹¶è¡Œæ˜ å°„ï¼Œå¸¦èƒŒå‹æ§åˆ¶
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span><span class=o>*</span> <span class=nx>parallelMap</span><span class=p>(</span><span class=nx>executions</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>CONCURRENCY_LIMIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// parallelMap å®ç°
</span></span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span><span class=o>*</span> <span class=nx>parallelMap</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>  <span class=nx>generators</span>: <span class=kt>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;[],</span>
</span></span><span class=line><span class=cl>  <span class=nx>concurrency</span>: <span class=kt>number</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>executing</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>Promise</span><span class=p>&lt;</span><span class=nt>IteratorResult</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;&gt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pending</span> <span class=o>=</span> <span class=p>[...</span><span class=nx>generators</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¡«å……åˆå§‹æ’æ§½
</span></span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>executing</span><span class=p>.</span><span class=nx>size</span> <span class=o>&lt;</span> <span class=nx>concurrency</span> <span class=o>&amp;&amp;</span> <span class=nx>pending</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>gen</span> <span class=o>=</span> <span class=nx>pending</span><span class=p>.</span><span class=nx>shift</span><span class=p>()</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>executing</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>gen</span><span class=p>.</span><span class=nx>next</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>executing</span><span class=p>.</span><span class=nx>size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç«èµ›ä¸‹ä¸€ä¸ªå®Œæˆ
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>race</span><span class=p>(</span><span class=nx>executing</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>executing</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>result</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>result</span><span class=p>.</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// äº§å‡ºå€¼
</span></span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>result</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// ç»§ç»­è¿™ä¸ªç”Ÿæˆå™¨
</span></span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>nextPromise</span> <span class=o>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>generator</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>executing</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>nextPromise</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœå¯ç”¨ï¼Œå¡«å……ç©ºæ’æ§½
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>executing</span><span class=p>.</span><span class=nx>size</span> <span class=o>&lt;</span> <span class=nx>concurrency</span> <span class=o>&amp;&amp;</span> <span class=nx>pending</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>gen</span> <span class=o>=</span> <span class=nx>pending</span><span class=p>.</span><span class=nx>shift</span><span class=p>()</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>executing</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>gen</span><span class=p>.</span><span class=nx>next</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-6",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><p><strong>æ‰§è¡Œæ—¶é—´åˆ†æ</strong>ï¼š</p><table><thead><tr><th>å·¥å…·ç±»å‹</th><th>å¹¶å‘æ€§</th><th>å…¸å‹å»¶è¿Ÿ</th><th>ç“¶é¢ˆ</th></tr></thead><tbody><tr><td>ReadTool</td><td>å¹¶è¡Œ (10)</td><td>10-50ms</td><td>ç£ç›˜ I/O</td></tr><tr><td>GrepTool</td><td>å¹¶è¡Œ (10)</td><td>100-500ms</td><td>CPU æ­£åˆ™è¡¨è¾¾å¼</td></tr><tr><td>WebFetchTool</td><td>å¹¶è¡Œ (3)</td><td>500-3000ms</td><td>ç½‘ç»œ</td></tr><tr><td>EditTool</td><td>é¡ºåº</td><td>20-100ms</td><td>éªŒè¯</td></tr><tr><td>BashTool</td><td>é¡ºåº</td><td>50-10000ms</td><td>è¿›ç¨‹æ‰§è¡Œ</td></tr><tr><td>AgentTool</td><td>å¹¶è¡Œ (5)</td><td>2000-20000ms</td><td>å­ LLM è°ƒç”¨</td></tr></tbody></table><h3 id=é˜¶æ®µ-5æƒé™æ§åˆ¶æµ>é˜¶æ®µ 5ï¼šæƒé™æ§åˆ¶æµ</h3><p>æƒé™ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªå¤šçº§å†³ç­–æ ‘ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-7 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-7 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-7><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æƒé™å†³ç­–æµç¨‹
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>PermissionController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>checkPermission</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tool</span>: <span class=kt>ToolDefinition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolPermissionContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PermissionDecision</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// çº§åˆ« 1ï¼šæ£€æŸ¥æ˜ç¡®æ‹’ç»è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>denyRule</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>findMatchingRule</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>input</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>alwaysDenyRules</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>denyRule</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span> <span class=nx>behavior</span><span class=o>:</span> <span class=s1>&#39;deny&#39;</span><span class=p>,</span> <span class=nx>reason</span>: <span class=kt>denyRule</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// çº§åˆ« 2ï¼šæ£€æŸ¥æ¨¡å¼è¦†ç›–
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>mode</span> <span class=o>===</span> <span class=s1>&#39;bypassPermissions&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span> <span class=nx>behavior</span><span class=o>:</span> <span class=s1>&#39;allow&#39;</span><span class=p>,</span> <span class=nx>reason</span><span class=o>:</span> <span class=s1>&#39;bypass_mode&#39;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>mode</span> <span class=o>===</span> <span class=s1>&#39;acceptEdits&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>isEditTool</span><span class=p>(</span><span class=nx>tool</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>isPathSafe</span><span class=p>(</span><span class=nx>input</span><span class=p>.</span><span class=nx>path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span> <span class=nx>behavior</span><span class=o>:</span> <span class=s1>&#39;allow&#39;</span><span class=p>,</span> <span class=nx>reason</span><span class=o>:</span> <span class=s1>&#39;accept_edits_mode&#39;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// çº§åˆ« 3ï¼šæ£€æŸ¥æ˜ç¡®å…è®¸è§„åˆ™
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>allowRule</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>findMatchingRule</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>input</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>alwaysAllowRules</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>allowRule</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span> <span class=nx>behavior</span><span class=o>:</span> <span class=s1>&#39;allow&#39;</span><span class=p>,</span> <span class=nx>reason</span>: <span class=kt>allowRule</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// çº§åˆ« 4ï¼šäº¤äº’å¼æç¤º
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>behavior</span><span class=o>:</span> <span class=s1>&#39;ask&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>suggestions</span>: <span class=kt>this.generateRuleSuggestions</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>findMatchingRule</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tool</span>: <span class=kt>ToolDefinition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>rules</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>PermissionRuleScope</span><span class=p>,</span> <span class=na>string</span><span class=err>[]</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=o>|</span> <span class=kc>null</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¼˜å…ˆçº§é¡ºåºï¼šcliArg &gt; localSettings &gt; projectSettings &gt; ...
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>scopes</span>: <span class=kt>PermissionRuleScope</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;cliArg&#39;</span><span class=p>,</span> <span class=s1>&#39;localSettings&#39;</span><span class=p>,</span> <span class=s1>&#39;projectSettings&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;policySettings&#39;</span><span class=p>,</span> <span class=s1>&#39;userSettings&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>scope</span> <span class=k>of</span> <span class=nx>scopes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>scopeRules</span> <span class=o>=</span> <span class=nx>rules</span><span class=p>[</span><span class=nx>scope</span><span class=p>]</span> <span class=o>||</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>rule</span> <span class=k>of</span> <span class=nx>scopeRules</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>matchesRule</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>input</span><span class=p>,</span> <span class=nx>rule</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=sb>`</span><span class=si>${</span><span class=nx>scope</span><span class=si>}</span><span class=sb>:</span><span class=si>${</span><span class=nx>rule</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-7",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=é˜¶æ®µ-6é€’å½’å›åˆç®¡ç†>é˜¶æ®µ 6ï¼šé€’å½’å›åˆç®¡ç†</h3><p>æ§åˆ¶æµä¸ºå¤šè½®äº¤äº’å®ç°äº†å°¾é€’å½’ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-8 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-8 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-8><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// é€’å½’æ§åˆ¶å’ŒçŠ¶æ€ç®¡ç†
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>TurnController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>manageTurn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>messages</span>: <span class=kt>CliMessage</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolResults</span>: <span class=kt>CliMessage</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>FullContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>loopState</span>: <span class=kt>LoopState</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥é€’å½’æ·±åº¦
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>loopState</span><span class=p>.</span><span class=nx>turnCounter</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>createSystemMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Maximum conversation depth reached. Please start a new query.&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å‡†å¤‡ä¸‹ä¸€è½®çŠ¶æ€
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>nextState</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>loopState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>turnCounter</span>: <span class=kt>loopState.turnCounter</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>compacted</span>: <span class=kt>false</span>  <span class=c1>// é‡ç½®å‹ç¼©æ ‡å¿—
</span></span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆå¹¶æ¶ˆæ¯ä»¥è¿›è¡Œä¸‹ä¸€è½®
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>nextMessages</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>messages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>toolResults</span><span class=p>.</span><span class=nx>sort</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sortByToolRequestOrder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å°¾é€’å½’
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span><span class=o>*</span> <span class=nx>tt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>nextMessages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>basePrompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>gitContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>claudeMd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>permissionFn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>toolContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kc>undefined</span><span class=p>,</span>  <span class=c1>// æ²¡æœ‰æ´»åŠ¨çš„æµå¼å·¥å…·
</span></span></span><span class=line><span class=cl>      <span class=nx>nextState</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-8",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h2 id=é«˜çº§æ§åˆ¶æµæ¨¡å¼>é«˜çº§æ§åˆ¶æµæ¨¡å¼</h2><h3 id=1-è¾“å…¥è·¯ç”±çŠ¶æ€æœº>1. è¾“å…¥è·¯ç”±çŠ¶æ€æœº</h3><p>è¾“å…¥å¤„ç†å®ç°äº†ä¸€ä¸ªå¤æ‚çš„è·¯ç”±ç³»ç»Ÿï¼š</p><pre class=mermaid>
  stateDiagram-v2
    [*] --&gt; InputReceived
    InputReceived --&gt; CommandDetection

    CommandDetection --&gt; SlashCommand: starts with /
    CommandDetection --&gt; BashMode: starts with !
    CommandDetection --&gt; MemoryMode: starts with #
    CommandDetection --&gt; PasteDetection: paste event
    CommandDetection --&gt; NormalPrompt: default

    SlashCommand --&gt; ExecuteCommand
    ExecuteCommand --&gt; UpdateState
    UpdateState --&gt; [*]

    BashMode --&gt; CreateSyntheticTool
    CreateSyntheticTool --&gt; MainLoop

    MemoryMode --&gt; UpdateClaudeMd
    UpdateClaudeMd --&gt; [*]

    PasteDetection --&gt; DetectContent
    DetectContent --&gt; ProcessImage: image detected
    DetectContent --&gt; ProcessText: text only
    ProcessImage --&gt; MainLoop
    ProcessText --&gt; MainLoop

    NormalPrompt --&gt; MainLoop
    MainLoop --&gt; [*]
</pre><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-10 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-10 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-10><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// è¾“å…¥è·¯ç”±å™¨å®ç°
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>InputRouter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>routeInput</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>AppContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>RouterAction</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¸¦ä¼˜å…ˆçº§çš„å‘½ä»¤æ£€æµ‹
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>matchers</span><span class=o>:</span> <span class=p>[</span><span class=nb>RegExp</span><span class=p>,</span> <span class=nx>InputHandler</span><span class=p>][]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=sr>/^\/(\w+)(.*)/</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleSlashCommand</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=sr>/^!(.+)/</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleBashMode</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=sr>/^#(.+)/</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleMemoryMode</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=sr>/^```[\s\S]+```$/</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleCodeBlock</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=p>[</span><span class=nx>pattern</span><span class=p>,</span> <span class=nx>handler</span><span class=p>]</span> <span class=k>of</span> <span class=nx>matchers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>match</span> <span class=o>=</span> <span class=nx>input</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>pattern</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>match</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>handler</span><span class=p>(</span><span class=nx>match</span><span class=p>,</span> <span class=nx>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é»˜è®¤ï¼šæ­£å¸¸æç¤º
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;prompt&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>message</span>: <span class=kt>this.createUserMessage</span><span class=p>(</span><span class=nx>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>handleBashMode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>match</span>: <span class=kt>RegExpMatchArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>AppContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>RouterAction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>command</span> <span class=o>=</span> <span class=nx>match</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆ›å»ºå¸¦å·¥å…·ä½¿ç”¨çš„åˆæˆåŠ©æ‰‹æ¶ˆæ¯
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>syntheticMessages</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>content</span><span class=o>:</span> <span class=sb>`Run this command: </span><span class=si>${</span><span class=nx>command</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;assistant&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;assistant&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>content</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;text&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>text</span><span class=o>:</span> <span class=s1>&#39;I\&#39;ll run that command for you.&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;tool_use&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>id</span><span class=o>:</span> <span class=sb>`bash_</span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;BashTool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>input</span><span class=o>:</span> <span class=p>{</span> <span class=nx>command</span><span class=p>,</span> <span class=nx>sandbox</span>: <span class=kt>false</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;synthetic_conversation&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>messages</span>: <span class=kt>syntheticMessages</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-10",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=2-æµèƒŒå‹ç®¡ç†>2. æµèƒŒå‹ç®¡ç†</h3><p>æµå¼ç³»ç»Ÿå®ç°äº†å¤æ‚çš„èƒŒå‹å¤„ç†ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-11 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-11 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-11><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æµçš„èƒŒå‹æ§åˆ¶
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>StreamBackpressureController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>buffer</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>StreamEvent</span><span class=p>&gt;</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>pressure</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>current</span>: <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>threshold</span>: <span class=kt>1000</span><span class=p>,</span>  <span class=c1>// æœ€å¤§ç¼“å†²äº‹ä»¶æ•°
</span></span></span><span class=line><span class=cl>    <span class=nx>paused</span>: <span class=kt>false</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=o>*</span><span class=nx>controlledStream</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>source</span>: <span class=kt>AsyncIterable</span><span class=p>&lt;</span><span class=nt>StreamEvent</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>StreamEvent</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>iterator</span> <span class=o>=</span> <span class=nx>source</span><span class=p>[</span><span class=nx>Symbol</span><span class=p>.</span><span class=nx>asyncIterator</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// æ£€æŸ¥å‹åŠ›
</span></span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>current</span> <span class=o>&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>threshold</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>paused</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>waitForDrain</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>done</span><span class=p>,</span> <span class=nx>value</span> <span class=p>}</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>iterator</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// ç¼“å†²åŒºç®¡ç†
</span></span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>shouldBuffer</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>current</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// é«˜ä¼˜å…ˆçº§äº‹ä»¶ç«‹å³äº§å‡º
</span></span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// å®šæœŸæ’ç©ºç¼“å†²åŒº
</span></span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>buffer</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>paused</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>drainBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æœ€åæ’ç©º
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>drainBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>shouldBuffer</span><span class=p>(</span><span class=nx>event</span>: <span class=kt>StreamEvent</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸ç¼“å†²å·¥å…·ç»“æœæˆ–é”™è¯¯
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>event</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s1>&#39;content_block_delta&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=nx>event</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s1>&#39;text_delta&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-11",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=3-agenttool-åˆ†å±‚æ§åˆ¶æµ>3. AgentTool åˆ†å±‚æ§åˆ¶æµ</h3><p>AgentTool å®ç°äº†ä¸€ä¸ªæœ‰è¶£çš„çˆ¶å­æ§åˆ¶ç»“æ„ï¼š</p><pre class=mermaid>
  graph TB
    subgraph &#34;ä¸»ä»£ç†&#34;
        MainTT[Main tt Loop]
        MainContext[Main Context]
        MainTools[All Tools]
    end

    subgraph &#34;AgentTool è°ƒç”¨&#34;
        AgentRequest[AgentTool Request]
        TaskSplitter[Task Splitter]

        TaskSplitter --&gt; SubTask1[Sub-task 1]
        TaskSplitter --&gt; SubTask2[Sub-task 2]
        TaskSplitter --&gt; SubTaskN[Sub-task N]
    end

    subgraph &#34;å­ä»£ç† 1&#34;
        SubLoop1[Sub tt Loop]
        SubContext1[Filtered Context]
        SubTools1[Tools - AgentTool]
    end

    subgraph &#34;å­ä»£ç† 2&#34;
        SubLoop2[Sub tt Loop]
        SubContext2[Filtered Context]
        SubTools2[Tools - AgentTool]
    end

    subgraph &#34;ç»¼åˆ&#34;
        Collector[Result Collector]
        Synthesizer[LLM Synthesizer]
        FinalResult[Synthesized Result]
    end

    MainTT --&gt; AgentRequest
    AgentRequest --&gt; TaskSplitter

    SubTask1 --&gt; SubLoop1
    SubTask2 --&gt; SubLoop2

    SubLoop1 --&gt; Collector
    SubLoop2 --&gt; Collector

    Collector --&gt; Synthesizer
    Synthesizer --&gt; FinalResult
    FinalResult --&gt; MainTT
</pre><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-13 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-13 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-13><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// AgentTool åˆ†å±‚æ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>AgentToolExecutor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>AgentToolInput</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolUseContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentMessage</span>: <span class=kt>CliMessage</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>ToolProgress</span> <span class=err>|</span> <span class=na>ToolResult</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 1ï¼šä»»åŠ¡åˆ†æ
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>subtasks</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>analyzeTask</span><span class=p>(</span><span class=nx>input</span><span class=p>.</span><span class=nx>prompt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 2ï¼šç”Ÿæˆå­ä»£ç†
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>subAgentPromises</span> <span class=o>=</span> <span class=nx>subtasks</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>task</span><span class=p>,</span> <span class=nx>index</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// åˆ›å»ºéš”ç¦»çš„ä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>subContext</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>tools</span>: <span class=kt>context.tools.filter</span><span class=p>(</span><span class=nx>t</span> <span class=o>=&gt;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>name</span> <span class=o>!==</span> <span class=s1>&#39;AgentTool&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>abortController</span>: <span class=kt>this.createLinkedAbort</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>abortController</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=p>...</span><span class=nx>context</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>maxThinkingTokens</span>: <span class=kt>this.calculateTokenBudget</span><span class=p>(</span><span class=nx>input</span><span class=p>.</span><span class=nx>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// è¿è¡Œå­ä»£ç†
</span></span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>runSubAgent</span><span class=p>(</span><span class=nx>task</span><span class=p>,</span> <span class=nx>subContext</span><span class=p>,</span> <span class=nx>index</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 3ï¼šå¸¦è¿›åº¦çš„å¹¶è¡Œæ‰§è¡Œ
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>results</span>: <span class=kt>SubAgentResult</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>update</span> <span class=k>of</span> <span class=k>this</span><span class=p>.</span><span class=nx>trackProgress</span><span class=p>(</span><span class=nx>subAgentPromises</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s1>&#39;progress&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;progress&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>toolUseID</span>: <span class=kt>parentMessage.id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>data</span>: <span class=kt>update</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>results</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>update</span><span class=p>.</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 4ï¼šç»¼åˆ
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>synthesized</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>synthesizeResults</span><span class=p>(</span><span class=nx>results</span><span class=p>,</span> <span class=nx>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;result&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span>: <span class=kt>synthesized</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=kr>async</span> <span class=nx>synthesizeResults</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>results</span>: <span class=kt>SubAgentResult</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>AgentToolInput</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>results</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>results</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é€šè¿‡ LLM è¿›è¡Œå¤šç»“æœç»¼åˆ
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>synthesisPrompt</span> <span class=o>=</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>      Synthesize these </span><span class=si>${</span><span class=nx>results</span><span class=p>.</span><span class=nx>length</span><span class=si>}</span><span class=sb> findings into a cohesive response:
</span></span></span><span class=line><span class=cl><span class=sb>      </span><span class=si>${</span><span class=nx>results</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>r</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=sb>`Finding </span><span class=si>${</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=sb>:</span><span class=err>\</span><span class=sb>n</span><span class=si>${</span><span class=nx>r</span><span class=p>.</span><span class=nx>content</span><span class=si>}</span><span class=sb>`</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;\n\n&#39;</span><span class=p>)</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>      Original task: </span><span class=si>${</span><span class=nx>input</span><span class=p>.</span><span class=nx>prompt</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>    `</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>synthesizer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SubAgentExecutor</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>prompt</span>: <span class=kt>synthesisPrompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span>: <span class=kt>input.model</span> <span class=o>||</span> <span class=s1>&#39;claude-3-haiku&#39;</span><span class=p>,</span>  <span class=c1>// ä½¿ç”¨å¿«é€Ÿæ¨¡å‹è¿›è¡Œç»¼åˆ
</span></span></span><span class=line><span class=cl>      <span class=nx>isSynthesis</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>synthesizer</span><span class=p>.</span><span class=nx>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-13",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h3 id=4-é”™è¯¯æ¢å¤æ§åˆ¶æµ>4. é”™è¯¯æ¢å¤æ§åˆ¶æµ</h3><p>ç³»ç»Ÿå®ç°äº†å¤æ‚çš„é”™è¯¯æ¢å¤ç­–ç•¥ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-14 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-14 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-14><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// é”™è¯¯æ¢å¤çŠ¶æ€æœº
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ErrorRecoveryController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>recoveryStrategies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;rate_limit&#39;</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleRateLimit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;context_overflow&#39;</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleContextOverflow</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;tool_error&#39;</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleToolError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;network_error&#39;</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleNetworkError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;permission_denied&#39;</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>handlePermissionDenied</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>handleError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ErrorContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>errorType</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>classifyError</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>strategy</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>recoveryStrategies</span><span class=p>[</span><span class=nx>errorType</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>strategy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span><span class=o>*</span> <span class=nx>strategy</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// é€šç”¨é”™è¯¯å¤„ç†
</span></span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>createErrorMessage</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>handleContextOverflow</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span>: <span class=kt>ContextOverflowError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ErrorContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç­–ç•¥ 1ï¼šå°è¯•å‡å°‘ max_tokens
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>details</span><span class=p>.</span><span class=nx>requested_tokens</span> <span class=o>&gt;</span> <span class=mi>4096</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>createSystemMessage</span><span class=p>(</span><span class=s2>&#34;Reducing response size...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>retry</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>retryWithReducedTokens</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span><span class=p>.</span><span class=nx>request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>details</span><span class=p>.</span><span class=nx>requested_tokens</span> <span class=o>*</span> <span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>retry</span><span class=p>.</span><span class=nx>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span><span class=o>*</span> <span class=nx>retry</span><span class=p>.</span><span class=nx>response</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç­–ç•¥ 2ï¼šå¼ºåˆ¶å‹ç¼©
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>createSystemMessage</span><span class=p>(</span><span class=s2>&#34;Compacting conversation history...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>compacted</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>forceCompaction</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>messages</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä½¿ç”¨å‹ç¼©çš„å†å²é‡è¯•
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span><span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>retryWithMessages</span><span class=p>(</span><span class=nx>compacted</span><span class=p>,</span> <span class=nx>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=kr>async</span> <span class=o>*</span><span class=nx>handleRateLimit</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span>: <span class=kt>RateLimitError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ErrorContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¤šæä¾›å•†å›é€€
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>providers</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;anthropic&#39;</span><span class=p>,</span> <span class=s1>&#39;bedrock&#39;</span><span class=p>,</span> <span class=s1>&#39;vertex&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>provider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>alternatives</span> <span class=o>=</span> <span class=nx>providers</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>p</span> <span class=o>=&gt;</span> <span class=nx>p</span> <span class=o>!==</span> <span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>provider</span> <span class=k>of</span> <span class=nx>alternatives</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>createSystemMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`Rate limited on </span><span class=si>${</span><span class=nx>current</span><span class=si>}</span><span class=sb>, trying </span><span class=si>${</span><span class=nx>provider</span><span class=si>}</span><span class=sb>...`</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>retryWithProvider</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>context</span><span class=p>.</span><span class=nx>request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>provider</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span><span class=o>*</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ‰€æœ‰æä¾›å•†éƒ½è€—å°½
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>createErrorMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;All providers are rate limited. Please try again later.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-14",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script><h2 id=æ€§èƒ½åˆ†æç‚¹>æ€§èƒ½åˆ†æç‚¹</h2><p>æ§åˆ¶æµåŒ…å«äº†æˆ˜ç•¥æ€§çš„åˆ†æç‚¹ï¼š</p><div class="code-block-container border-border bg-card my-6 overflow-hidden rounded-xl border shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:shadow-md"><div class="code-block-header bg-muted/30 border-border flex items-center justify-between border-b px-4 py-3"><div class="flex items-center gap-2"><div class="text-muted-foreground flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4 4 4-4 4M6 16l-4-4 4-4"/></svg></div><span class="text-muted-foreground text-sm font-medium">TYPESCRIPT</span></div><div class="flex items-center gap-2"><button class="collapse-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-15 data-default-state=expanded data-collapsed=false data-auto-collapse-lines=30 data-auto-collapse-height=400 data-collapsed-height=120 title=Collapse aria-label=Collapse>
<span class=collapse-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
</span><span class="collapse-text hidden sm:inline">Collapse</span>
</button>
<button class="copy-code-btn text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 flex items-center gap-1.5 rounded-md px-2 py-1 text-xs font-medium transition-all duration-200 ease-out focus:ring-2 focus:outline-none" data-code-id=code-15 title=Copy aria-label=Copy>
<span class=copy-icon><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</span><span class="copy-text hidden sm:inline">Copy</span></button></div></div><div class="code-block-content relative" id=code-15><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æ€§èƒ½æµ‹é‡é›†æˆ
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>PerformanceProfiler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>spans</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>PerformanceSpan</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>instrument</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>AsyncGenerator</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>generator</span>: <span class=kt>T</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=kr>async</span> <span class=kd>function</span><span class=o>*</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>start</span> <span class=o>=</span> <span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>itemCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>item</span> <span class=k>of</span> <span class=nx>generator</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>itemCount</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1>// æµ‹é‡äº§å‡ºé—´éš”æ—¶é—´
</span></span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>itemCount</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>span</span><span class=p>.</span><span class=nx>addEvent</span><span class=p>(</span><span class=s1>&#39;yield&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=s1>&#39;yield.latency&#39;</span><span class=o>:</span> <span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>-</span> <span class=nx>lastYield</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>yield</span> <span class=nx>item</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>lastYield</span> <span class=o>=</span> <span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttributes</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;generator.yield_count&#39;</span><span class=o>:</span> <span class=nx>itemCount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;generator.total_time&#39;</span><span class=o>:</span> <span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>-</span> <span class=nx>start</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})()</span> <span class=kr>as</span> <span class=nx>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="collapse-overlay to-card/90 pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent via-transparent opacity-0 transition-opacity duration-300"><div class="text-muted-foreground bg-card/80 border-border/50 hover:bg-primary/10 hover:text-primary hover:border-primary/30 absolute bottom-4 left-1/2 -translate-x-1/2 cursor-pointer rounded-full border px-3 py-1.5 text-xs backdrop-blur-sm transition-all duration-200">Click to expand and view more</div></div></div></div><script>(function(){const s="code-15",n=document.querySelector('.copy-code-btn[data-code-id="'+s+'"]'),t=document.querySelector('.collapse-code-btn[data-code-id="'+s+'"]'),e=document.getElementById(s);if(!e)return;if(n){const s=n.querySelector(".copy-icon"),t=n.querySelector(".copy-text");n.addEventListener("click",async function(){try{let o="";const i=e.querySelector(".lntd:last-child code");if(i)o=i.textContent||i.innerText;else{const t=e.querySelector("code");if(t){const e=t.querySelector(".ln");if(e){const e=t.querySelectorAll(".cl");if(e.length>0)o=Array.from(e).map(e=>{const t=e.textContent||e.innerText;return t.replace(/\n+$/,"")}).join(`
`).replace(/\n+$/,"");else{const e=t.textContent||t.innerText;o=e.replace(/^\d+/gm,"").replace(/^\s+/gm,"")}}else o=t.textContent||t.innerText}else o=e.textContent||e.innerText}o=o.trim(),await navigator.clipboard.writeText(o),s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>`,t&&(t.textContent="Copied"),n.classList.add("text-green-600"),setTimeout(()=>{s.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>`,t&&(t.textContent="Copy"),n.classList.remove("text-green-600")},2e3)}catch(o){console.error("å¤åˆ¶å¤±è´¥:",o);const s=document.createRange(),i=e.querySelector("code")||e;s.selectNodeContents(i);const n=window.getSelection();n.removeAllRanges(),n.addRange(s),t&&(t.textContent="Selected"),setTimeout(()=>{t&&(t.textContent="Copy"),n.removeAllRanges()},2e3)}})}if(t){const d=t.querySelector(".collapse-icon"),c=t.querySelector(".collapse-text"),n=e.querySelector(".collapse-overlay");let s=e.querySelector("pre.chroma");s||(s=e.querySelector("pre"));const m=t.dataset.defaultState||"expanded",f=t.dataset.collapsed==="true",u=parseInt(t.dataset.autoCollapseLines)||30,h=parseInt(t.dataset.autoCollapseHeight)||400,p=parseInt(t.dataset.collapsedHeight)||120;let l=!1;function i(){const e=f||m==="collapsed"||a();e&&o(!0,!1)}function a(){if(s){const e=s.querySelectorAll(".line, .cl"),t=s.offsetHeight;return e.length>u||t>h}const t=e.offsetHeight;if(t>h)return!0;const n=e.textContent||e.innerText||"",o=n.split(`
`).length;return o>u}function o(s,o=!0){if(!n)return;l=s,s?(e.style.maxHeight=p+"px",e.style.overflow="hidden",n.style.opacity="1",n.style.pointerEvents="auto",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>`,c&&(c.textContent="Expand"),t.title="Expand"):(e.style.maxHeight="",e.style.overflow="",n.style.opacity="0",n.style.pointerEvents="none",d.innerHTML=`
  <svg class="h-3 w-3"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6l-6 6z"/></svg>`,c&&(c.textContent="Collapse"),t.title="Collapse"),o&&(e.style.transition="max-height 0.3s ease-out",setTimeout(()=>{e.style.transition=""},300))}function r(){o(!l,!0)}t.addEventListener("click",r),n&&n.addEventListener("click",()=>{l&&o(!1,!0)}),i()}})()</script></article><nav class="post-navigation mb-12" aria-label="Post navigation"><div class="grid grid-cols-1 gap-4 md:grid-cols-2"><div class=nav-item><a href=/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class="group bg-card border-border hover:bg-primary/5 hover:border-primary/20 focus:ring-primary/20 flex min-h-[120px] flex-col justify-between rounded-xl border p-6 transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg focus:ring-2 focus:outline-none"><div><div class="mb-3 flex items-center gap-3"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
<span class="text-muted-foreground text-sm font-medium">Previous</span></div><h3 class="text-foreground group-hover:text-primary mb-3 line-clamp-2 text-lg leading-tight font-semibold transition-colors duration-200">Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„</h3></div><div class="text-muted-foreground mt-auto flex items-center gap-2 text-xs"><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<time datetime=2025-11-14>Nov 14</time></div></a></div><div class=nav-item><a href=/posts/claude-code-%E5%88%86%E6%9E%90-04%E5%B7%A5%E5%85%B7%E4%B8%8E%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/ class="group bg-card border-border hover:bg-primary/5 hover:border-primary/20 focus:ring-primary/20 flex min-h-[120px] flex-col justify-between rounded-xl border p-6 transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg focus:ring-2 focus:outline-none"><div><div class="mb-3 flex items-center justify-end gap-3"><span class="text-muted-foreground text-sm font-medium">Next
</span><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div><h3 class="text-foreground group-hover:text-primary mb-3 line-clamp-2 text-right text-lg leading-tight font-semibold transition-colors duration-200">Claude Code åˆ†æ 04ï¼šå·¥å…·ä¸æ‰§è¡Œå¼•æ“</h3></div><div class="text-muted-foreground mt-auto flex items-center justify-end gap-2 text-xs"><time datetime=2025-11-14>Nov 14
</time><svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg></div></a></div></div></nav><section class="related-posts mb-12"><div class="mb-6 flex items-center gap-3"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656.0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656.0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg><h2 class="text-foreground text-2xl font-bold">Related Posts</h2></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full"><article class=group><a href=/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class=block><div class="bg-card border-border hover:bg-primary/5 hover:border-primary/20 focus:ring-primary/20 flex items-center rounded-xl border p-5 transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg focus:ring-2 focus:outline-none min-h-[120px]"><h3 class="text-foreground group-hover:text-primary text-lg font-semibold leading-snug line-clamp-3 w-full">Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„</h3></div></a></article><article class=group><a href=/posts/claude-code-%E5%88%86%E6%9E%90-01%E4%BE%9D%E8%B5%96%E9%A1%B9/ class=block><div class="bg-card border-border hover:bg-primary/5 hover:border-primary/20 focus:ring-primary/20 flex items-center rounded-xl border p-5 transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg focus:ring-2 focus:outline-none min-h-[120px]"><h3 class="text-foreground group-hover:text-primary text-lg font-semibold leading-snug line-clamp-3 w-full">Claude Code åˆ†æ 01ï¼šä¾èµ–é¡¹</h3></div></a></article><article class=group><a href=/posts/claude-code-%E5%88%86%E6%9E%90-00%E4%B8%BB%E6%96%87%E7%AB%A0/ class=block><div class="bg-card border-border hover:bg-primary/5 hover:border-primary/20 focus:ring-primary/20 flex items-center rounded-xl border p-5 transition-all duration-300 ease-out hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg focus:ring-2 focus:outline-none min-h-[120px]"><h3 class="text-foreground group-hover:text-primary text-lg font-semibold leading-snug line-clamp-3 w-full">Claude Code åˆ†æ 00ï¼šä¸»æ–‡ç« </h3></div></a></article></div></section></main><footer class="mx-auto max-w-4xl px-4 py-8"><div class="px-6 py-6"><nav class=mb-6><div class="flex flex-wrap items-center justify-center gap-1"><a href=/ class="nav-link hover:text-primary hover:bg-primary/10 text-muted-foreground flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 hover:scale-105"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="About"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7A4 4 0 118 7a4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
<span>About
</span></a><a href=https://google.com target=_blank rel="noopener noreferrer" class="nav-link hover:text-primary hover:bg-primary/10 text-muted-foreground flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 hover:scale-105"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Contact"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22.0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v10a2 2 0 002 2z"/></svg>
<span>Contact
</span></a><a href=/index.xml class="nav-link hover:text-primary hover:bg-primary/10 text-muted-foreground flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 hover:scale-105"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="RSS Feed"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18.0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"/></svg>
<span>RSS Feed</span></a></div></nav><div class="border-border mb-6 border-t"></div><div class="flex flex-col items-center justify-between gap-4 md:flex-row"><div class="text-muted-foreground text-sm"><p>&copy; 2026 Starslayerx' Blog.
All rights reserved.</p></div><div class="flex items-center gap-3"><a href=https://github.com/Starslayerx target=_blank rel="noopener noreferrer" class="text-muted-foreground hover:text-primary focus:ring-primary/20 rounded-lg p-1 transition-all duration-300 ease-out hover:scale-110 focus:ring-2 focus:outline-none" title=GitHub aria-label=GitHub><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="GitHub"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M15 22v-4a4.8 4.8.0 00-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35.0-3.5.0.0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35.0 3.5A5.4 5.4.0 004 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65S8.93 17.38 9 18v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></g></svg>
</a><a href=mailto:starslayerxleo@gmail.com class="text-muted-foreground hover:text-primary focus:ring-primary/20 rounded-lg p-1 transition-all duration-300 ease-out hover:scale-110 focus:ring-2 focus:outline-none" title=Email aria-label=Email><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-label="Email"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22.0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v10a2 2 0 002 2z"/></svg></a></div></div></div></footer><div id=dock class="pointer-events-none fixed bottom-4 left-1/2 z-[9999] w-fit -translate-x-1/2 translate-y-24 opacity-0 transition-all duration-300 ease-out sm:right-0 sm:left-0 sm:mx-auto sm:translate-x-0" role=toolbar aria-label="Quick action toolbar"><nav class="border-border bg-card/80 scrollbar-hide xs:px-3 xs:py-2 mx-auto flex max-w-[calc(100vw-2rem)] min-w-fit items-center justify-center overflow-x-auto rounded-2xl border px-4 py-3 shadow-lg backdrop-blur-sm sm:px-4 sm:py-3"><button id=dock-back class="text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 xs:px-2 xs:py-1.5 flex flex-shrink-0 items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none sm:px-3 sm:py-2" title=Back aria-label=Back>
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
<span class="hidden sm:inline">Back</span></button><div class="bg-border xs:mx-1 mx-2 h-6 w-px sm:mx-2"></div><button id=dock-toc class="text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 xs:px-2 xs:py-1.5 flex flex-shrink-0 items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none sm:px-3 sm:py-2" title="Table of Contents" aria-label="Table of Contents">
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
<span class="hidden sm:inline">Table of Contents</span></button><div class="bg-border xs:mx-1 mx-2 h-6 w-px sm:mx-2"></div><button id=dock-search class="text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 xs:px-3 xs:py-1.5 flex flex-shrink-0 items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none sm:px-4 sm:py-2" title=Search aria-label=Search>
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5A7 7 0 113 10a7 7 0 0114 0z"/></svg>
<span class="hidden md:inline">Search</span></button><div class="bg-border xs:mx-1 mx-2 h-6 w-px sm:mx-2"></div><button id=dock-top class="text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 xs:px-2 xs:py-1.5 flex flex-shrink-0 items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-all duration-300 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none sm:px-3 sm:py-2" title="Back to Top" aria-label="Back to Top">
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m18 15-6-6-6 6"/></svg>
<span class="hidden sm:inline">Top</span></button></nav></div><div id=toc-overlay class="pointer-events-none fixed inset-0 z-40 bg-black/50 opacity-0 backdrop-blur-sm transition-all duration-300" role=dialog aria-modal=true aria-labelledby=toc-title></div><div id=toc-card class="pointer-events-none fixed inset-4 z-50 flex w-auto scale-95 items-center justify-center opacity-0 transition-all duration-300 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:block sm:w-full sm:max-w-md sm:-translate-x-1/2 sm:-translate-y-1/2" role=dialog aria-modal=true aria-labelledby=toc-title><div class="bg-card border-border w-full max-w-sm overflow-hidden rounded-xl border shadow-xl sm:max-w-md"><div class="border-border bg-muted/30 flex items-center justify-between border-b p-4"><div class="flex items-center gap-3"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg><h2 id=toc-title class="text-foreground text-lg font-semibold">Table of Contents</h2></div><button id=toc-close class="text-muted-foreground hover:text-primary hover:bg-primary/10 focus:ring-primary/20 rounded-lg p-2 transition-all duration-200 ease-out hover:-translate-y-0.5 hover:scale-105 focus:ring-2 focus:outline-none" title=Close aria-label=Close>
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><div class="max-h-96 overflow-y-auto p-4"><nav id=toc-nav class=toc-scrollbar aria-label="Table of Contents Navigation"><div id=toc-content><nav id=TableOfContents><ul><li><a href=#ä¸»å¯¹è¯å¾ªç¯ä¸€ä¸ªæµå¼çŠ¶æ€æœº>ä¸»å¯¹è¯å¾ªç¯ï¼šä¸€ä¸ªæµå¼çŠ¶æ€æœº</a><ul><li><a href=#é˜¶æ®µ-1ä¸Šä¸‹æ–‡çª—å£ç®¡ç†>é˜¶æ®µ 1ï¼šä¸Šä¸‹æ–‡çª—å£ç®¡ç†</a></li><li><a href=#é˜¶æ®µ-2åŠ¨æ€ç³»ç»Ÿæç¤ºè¯ç»„è£…>é˜¶æ®µ 2ï¼šåŠ¨æ€ç³»ç»Ÿæç¤ºè¯ç»„è£…</a></li><li><a href=#é˜¶æ®µ-3æµå¼çŠ¶æ€æœº>é˜¶æ®µ 3ï¼šæµå¼çŠ¶æ€æœº</a></li><li><a href=#é˜¶æ®µ-4å·¥å…·æ‰§è¡Œæµæ°´çº¿>é˜¶æ®µ 4ï¼šå·¥å…·æ‰§è¡Œæµæ°´çº¿</a></li><li><a href=#é˜¶æ®µ-5æƒé™æ§åˆ¶æµ>é˜¶æ®µ 5ï¼šæƒé™æ§åˆ¶æµ</a></li><li><a href=#é˜¶æ®µ-6é€’å½’å›åˆç®¡ç†>é˜¶æ®µ 6ï¼šé€’å½’å›åˆç®¡ç†</a></li></ul></li><li><a href=#é«˜çº§æ§åˆ¶æµæ¨¡å¼>é«˜çº§æ§åˆ¶æµæ¨¡å¼</a><ul><li><a href=#1-è¾“å…¥è·¯ç”±çŠ¶æ€æœº>1. è¾“å…¥è·¯ç”±çŠ¶æ€æœº</a></li><li><a href=#2-æµèƒŒå‹ç®¡ç†>2. æµèƒŒå‹ç®¡ç†</a></li><li><a href=#3-agenttool-åˆ†å±‚æ§åˆ¶æµ>3. AgentTool åˆ†å±‚æ§åˆ¶æµ</a></li><li><a href=#4-é”™è¯¯æ¢å¤æ§åˆ¶æµ>4. é”™è¯¯æ¢å¤æ§åˆ¶æµ</a></li></ul></li><li><a href=#æ€§èƒ½åˆ†æç‚¹>æ€§èƒ½åˆ†æç‚¹</a></li></ul></nav></div></nav></div><div class="border-border bg-muted/20 border-t px-4 py-3"><div class="text-muted-foreground text-center text-xs"><span>Click to jump to the section</span></div></div></div></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css integrity=sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js integrity=sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous></script><script>function initKaTeX(){if(typeof renderMathInElement=="undefined"){setTimeout(initKaTeX,100);return}var e=[{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!0,left:"\\[",right:"\\]"}];renderMathInElement(document.body,{delimiters:e,throwOnError:!1,errorColor:"#cc0000",fleqn:!1,leqno:!1,trust:!1})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initKaTeX):initKaTeX()</script><div id=search-overlay class="pointer-events-none fixed inset-0 z-40 bg-black/50 opacity-0 transition-opacity duration-300"></div><div id=search-modal class="bg-card border-border pointer-events-none fixed top-1/2 left-1/2 z-50 max-h-[80vh] w-full max-w-2xl -translate-x-1/2 -translate-y-1/2 scale-95 transform overflow-hidden rounded-xl border opacity-0 shadow-xl transition-all duration-300"><div class="border-border flex items-center gap-3 border-b p-4"><div class="text-muted-foreground h-5 w-5 flex-shrink-0"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5A7 7 0 113 10a7 7 0 0114 0z"/></svg></div><div class="relative flex-1"><button id=search-clear class="text-muted-foreground hover:text-foreground hover:bg-muted/50 pointer-events-none absolute top-1/2 left-0 z-10 h-5 w-5 -translate-y-1/2 rounded opacity-0 transition-all duration-200" title=Clear aria-label=Clear>
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg>
</button>
<input id=search-input type=text placeholder="Search posts..." class="text-foreground placeholder:text-muted-foreground w-full border-none bg-transparent pl-8 text-lg outline-none" autocomplete=off spellcheck=false></div><button id=search-close class="text-muted-foreground hover:text-foreground hover:bg-muted/50 flex h-6 w-6 items-center justify-center rounded-md p-0.5 transition-all duration-200" title=Close aria-label=Close>
<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><div id=search-results class="max-h-96 overflow-y-auto"><div id=search-empty class="flex flex-col items-center justify-center py-12 text-center"><div class="bg-muted/50 mb-4 flex h-16 w-16 items-center justify-center rounded-full"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5A7 7 0 113 10a7 7 0 0114 0z"/></svg></div><h3 class="text-foreground mb-2 text-lg font-semibold">Start searching</h3><p class="text-muted-foreground text-sm">Enter keywords to search articles</p></div><div id=search-loading class="flex hidden items-center justify-center py-8"><div class="mr-3 h-6 w-6 animate-spin rounded-full border-2 border-current border-t-transparent"></div><span class=text-muted-foreground>Searching...</span></div><div id=search-no-results class="flex hidden flex-col items-center justify-center py-12 text-center"><div class="bg-muted/50 mb-4 flex h-16 w-16 items-center justify-center rounded-full"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/></svg></div><h3 class="text-foreground mb-2 text-lg font-semibold">No results found</h3><p class="text-muted-foreground text-sm">Try using different keywords</p></div><div id=search-results-list class=hidden><div id=search-stats class="text-muted-foreground border-border border-b px-4 py-3 text-sm" data-template="Found %d results"></div><div id=search-items class="divide-border divide-y"></div></div></div><div class="border-border bg-muted/20 border-t px-4 py-3"><div class="text-muted-foreground flex items-center justify-between text-xs"><div class="flex items-center gap-2 md:gap-4"><div class="flex items-center gap-1"><kbd class="bg-muted border-border rounded border px-1.5 py-0.5 text-xs">â†‘â†“</kbd>
<span class="hidden sm:inline">Navigate</span></div><div class="flex items-center gap-1"><kbd class="bg-muted border-border rounded border px-1.5 py-0.5 text-xs">â†µ</kbd>
<span class="hidden sm:inline">Select</span></div><div class="flex items-center gap-1"><kbd class="bg-muted border-border rounded border px-1.5 py-0.5 text-xs">ESC</kbd>
<span class="hidden sm:inline">Close</span></div></div><div class="search-hint-desktop flex items-center gap-1"><kbd class="bg-muted border-border rounded border px-1.5 py-0.5 text-xs">âŒ˜K</kbd>
<span>Shortcut</span></div></div></div></div></body></html>