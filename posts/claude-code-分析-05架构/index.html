<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Claude Code åˆ†æ 05ï¼šæ¶æ„ | Starslayerx' Blog</title><meta name=keywords content="Agent"><meta name=description content='ğŸ—ï¸ æ¶æ„ï¼šå¼•æ“å®¤
graph TB
    subgraph "æ ¸å¿ƒï¼štt æ§åˆ¶å¾ªç¯"
        Start([ç”¨æˆ·è¾“å…¥]) --> Init[åˆå§‹åŒ–å›åˆ]
        Init --> Compact{éœ€è¦å‹ç¼©?}
        Compact -->|æ˜¯| CompactLLM[LLM æ‘˜è¦]
        CompactLLM --> Assembly
        Compact -->|å¦| Assembly[ç»„è£…ä¸Šä¸‹æ–‡]

        Assembly --> Stream[æµå¼ä¼ è¾“åˆ° LLM]
        Stream --> Process[å¤„ç†äº‹ä»¶]
        Process --> Tools{å·¥å…·è¯·æ±‚?}

        Tools -->|æ˜¯| Execute[æ‰§è¡Œå·¥å…·]
        Execute --> Recurse[é€’å½’ tt]
        Recurse --> Init

        Tools -->|å¦| End([å®Œæˆ])
    end

    style Init fill:#e1f5fe
    style Stream fill:#fff3e0
    style Execute fill:#e8f5e9
    style Recurse fill:#fce4ec
tt æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„
æ•´ä¸ª Claude Code ç³»ç»Ÿå›´ç»•ç€ä¸€ä¸ªåä¸º tt çš„å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°å±•å¼€ã€‚è¿™ä¸ªå‡½æ•°åè°ƒç€æ¯ä¸€æ¬¡äº¤äº’ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ° LLM é€šä¿¡å†åˆ°å·¥å…·æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ¥å‰–æè¿™ä¸ªå“è¶Šçš„å·¥ç¨‹è®¾è®¡ï¼š
// ä»£ç åº“ä¸­å®é™…çš„ tt å‡½æ•°ç­¾å
async function* tt(
  currentMessages: CliMessage[],         // å®Œæ•´çš„å¯¹è¯å†å²
  baseSystemPromptString: string,        // é™æ€ç³»ç»ŸæŒ‡ä»¤
  currentGitContext: GitContext,         // å®æ—¶ git çŠ¶æ€
  currentClaudeMdContents: ClaudeMdContent[], // é¡¹ç›®ä¸Šä¸‹æ–‡
  permissionGranterFn: PermissionGranter, // æƒé™å›è°ƒ
  toolUseContext: ToolUseContext,         // å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡
  activeStreamingToolUse?: ToolUseBlock,  // æ¢å¤æµå¼ä¼ è¾“çŠ¶æ€
  loopState: {
    turnId: string,        // æ­¤å›åˆçš„ UUID
    turnCounter: number,   // é€’å½’æ·±åº¦è¿½è¸ªå™¨
    compacted?: boolean,   // å†å²å‹ç¼©æ ‡å¿—
    isResuming?: boolean   // ä»ä¿å­˜çŠ¶æ€æ¢å¤
  }
): AsyncGenerator<CliMessage, void, void>
è¿™ä¸ªç­¾åæ­ç¤ºäº†å…¶å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚è¯¥å‡½æ•°äº§å‡º CliMessage å¯¹è±¡æ¥é©±åŠ¨ UI æ›´æ–°ï¼ŒåŒæ—¶ç»´æŠ¤å¯¹è¯æµç¨‹ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªé˜¶æ®µï¼š'><meta name=author content="Starslayerx"><link rel=canonical href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-05%E6%9E%B6%E6%9E%84/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://starslayerx.github.io/favicon.svg><link rel=apple-touch-icon href=https://starslayerx.github.io/favicon.svg><link rel=mask-icon href=https://starslayerx.github.io/favicon.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-05%E6%9E%B6%E6%9E%84/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-05%E6%9E%B6%E6%9E%84/"><meta property="og:site_name" content="Starslayerx' Blog"><meta property="og:title" content="Claude Code åˆ†æ 05ï¼šæ¶æ„"><meta property="og:description" content='ğŸ—ï¸ æ¶æ„ï¼šå¼•æ“å®¤ graph TB subgraph "æ ¸å¿ƒï¼štt æ§åˆ¶å¾ªç¯" Start([ç”¨æˆ·è¾“å…¥]) --> Init[åˆå§‹åŒ–å›åˆ] Init --> Compact{éœ€è¦å‹ç¼©?} Compact -->|æ˜¯| CompactLLM[LLM æ‘˜è¦] CompactLLM --> Assembly Compact -->|å¦| Assembly[ç»„è£…ä¸Šä¸‹æ–‡] Assembly --> Stream[æµå¼ä¼ è¾“åˆ° LLM] Stream --> Process[å¤„ç†äº‹ä»¶] Process --> Tools{å·¥å…·è¯·æ±‚?} Tools -->|æ˜¯| Execute[æ‰§è¡Œå·¥å…·] Execute --> Recurse[é€’å½’ tt] Recurse --> Init Tools -->|å¦| End([å®Œæˆ]) end style Init fill:#e1f5fe style Stream fill:#fff3e0 style Execute fill:#e8f5e9 style Recurse fill:#fce4ec tt æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„ æ•´ä¸ª Claude Code ç³»ç»Ÿå›´ç»•ç€ä¸€ä¸ªåä¸º tt çš„å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°å±•å¼€ã€‚è¿™ä¸ªå‡½æ•°åè°ƒç€æ¯ä¸€æ¬¡äº¤äº’ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ° LLM é€šä¿¡å†åˆ°å·¥å…·æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ¥å‰–æè¿™ä¸ªå“è¶Šçš„å·¥ç¨‹è®¾è®¡ï¼š
// ä»£ç åº“ä¸­å®é™…çš„ tt å‡½æ•°ç­¾å async function* tt( currentMessages: CliMessage[], // å®Œæ•´çš„å¯¹è¯å†å² baseSystemPromptString: string, // é™æ€ç³»ç»ŸæŒ‡ä»¤ currentGitContext: GitContext, // å®æ—¶ git çŠ¶æ€ currentClaudeMdContents: ClaudeMdContent[], // é¡¹ç›®ä¸Šä¸‹æ–‡ permissionGranterFn: PermissionGranter, // æƒé™å›è°ƒ toolUseContext: ToolUseContext, // å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡ activeStreamingToolUse?: ToolUseBlock, // æ¢å¤æµå¼ä¼ è¾“çŠ¶æ€ loopState: { turnId: string, // æ­¤å›åˆçš„ UUID turnCounter: number, // é€’å½’æ·±åº¦è¿½è¸ªå™¨ compacted?: boolean, // å†å²å‹ç¼©æ ‡å¿— isResuming?: boolean // ä»ä¿å­˜çŠ¶æ€æ¢å¤ } ): AsyncGenerator<CliMessage, void, void> è¿™ä¸ªç­¾åæ­ç¤ºäº†å…¶å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚è¯¥å‡½æ•°äº§å‡º CliMessage å¯¹è±¡æ¥é©±åŠ¨ UI æ›´æ–°ï¼ŒåŒæ—¶ç»´æŠ¤å¯¹è¯æµç¨‹ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªé˜¶æ®µï¼š'><meta property="og:locale" content="en-US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-14T13:00:00+01:00"><meta property="article:modified_time" content="2025-11-14T13:00:00+01:00"><meta property="article:tag" content="Agent"><meta property="og:image" content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:title content="Claude Code åˆ†æ 05ï¼šæ¶æ„"><meta name=twitter:description content='ğŸ—ï¸ æ¶æ„ï¼šå¼•æ“å®¤
graph TB
    subgraph "æ ¸å¿ƒï¼štt æ§åˆ¶å¾ªç¯"
        Start([ç”¨æˆ·è¾“å…¥]) --> Init[åˆå§‹åŒ–å›åˆ]
        Init --> Compact{éœ€è¦å‹ç¼©?}
        Compact -->|æ˜¯| CompactLLM[LLM æ‘˜è¦]
        CompactLLM --> Assembly
        Compact -->|å¦| Assembly[ç»„è£…ä¸Šä¸‹æ–‡]

        Assembly --> Stream[æµå¼ä¼ è¾“åˆ° LLM]
        Stream --> Process[å¤„ç†äº‹ä»¶]
        Process --> Tools{å·¥å…·è¯·æ±‚?}

        Tools -->|æ˜¯| Execute[æ‰§è¡Œå·¥å…·]
        Execute --> Recurse[é€’å½’ tt]
        Recurse --> Init

        Tools -->|å¦| End([å®Œæˆ])
    end

    style Init fill:#e1f5fe
    style Stream fill:#fff3e0
    style Execute fill:#e8f5e9
    style Recurse fill:#fce4ec
tt æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„
æ•´ä¸ª Claude Code ç³»ç»Ÿå›´ç»•ç€ä¸€ä¸ªåä¸º tt çš„å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°å±•å¼€ã€‚è¿™ä¸ªå‡½æ•°åè°ƒç€æ¯ä¸€æ¬¡äº¤äº’ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ° LLM é€šä¿¡å†åˆ°å·¥å…·æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ¥å‰–æè¿™ä¸ªå“è¶Šçš„å·¥ç¨‹è®¾è®¡ï¼š
// ä»£ç åº“ä¸­å®é™…çš„ tt å‡½æ•°ç­¾å
async function* tt(
  currentMessages: CliMessage[],         // å®Œæ•´çš„å¯¹è¯å†å²
  baseSystemPromptString: string,        // é™æ€ç³»ç»ŸæŒ‡ä»¤
  currentGitContext: GitContext,         // å®æ—¶ git çŠ¶æ€
  currentClaudeMdContents: ClaudeMdContent[], // é¡¹ç›®ä¸Šä¸‹æ–‡
  permissionGranterFn: PermissionGranter, // æƒé™å›è°ƒ
  toolUseContext: ToolUseContext,         // å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡
  activeStreamingToolUse?: ToolUseBlock,  // æ¢å¤æµå¼ä¼ è¾“çŠ¶æ€
  loopState: {
    turnId: string,        // æ­¤å›åˆçš„ UUID
    turnCounter: number,   // é€’å½’æ·±åº¦è¿½è¸ªå™¨
    compacted?: boolean,   // å†å²å‹ç¼©æ ‡å¿—
    isResuming?: boolean   // ä»ä¿å­˜çŠ¶æ€æ¢å¤
  }
): AsyncGenerator<CliMessage, void, void>
è¿™ä¸ªç­¾åæ­ç¤ºäº†å…¶å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚è¯¥å‡½æ•°äº§å‡º CliMessage å¯¹è±¡æ¥é©±åŠ¨ UI æ›´æ–°ï¼ŒåŒæ—¶ç»´æŠ¤å¯¹è¯æµç¨‹ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªé˜¶æ®µï¼š'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://starslayerx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Claude Code åˆ†æ 05ï¼šæ¶æ„","item":"https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-05%E6%9E%B6%E6%9E%84/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Claude Code åˆ†æ 05ï¼šæ¶æ„","name":"Claude Code åˆ†æ 05ï¼šæ¶æ„","description":"ğŸ—ï¸ æ¶æ„ï¼šå¼•æ“å®¤ graph TB subgraph \u0026#34;æ ¸å¿ƒï¼štt æ§åˆ¶å¾ªç¯\u0026#34; Start([ç”¨æˆ·è¾“å…¥]) --\u0026gt; Init[åˆå§‹åŒ–å›åˆ] Init --\u0026gt; Compact{éœ€è¦å‹ç¼©?} Compact --\u0026gt;|æ˜¯| CompactLLM[LLM æ‘˜è¦] CompactLLM --\u0026gt; Assembly Compact --\u0026gt;|å¦| Assembly[ç»„è£…ä¸Šä¸‹æ–‡] Assembly --\u0026gt; Stream[æµå¼ä¼ è¾“åˆ° LLM] Stream --\u0026gt; Process[å¤„ç†äº‹ä»¶] Process --\u0026gt; Tools{å·¥å…·è¯·æ±‚?} Tools --\u0026gt;|æ˜¯| Execute[æ‰§è¡Œå·¥å…·] Execute --\u0026gt; Recurse[é€’å½’ tt] Recurse --\u0026gt; Init Tools --\u0026gt;|å¦| End([å®Œæˆ]) end style Init fill:#e1f5fe style Stream fill:#fff3e0 style Execute fill:#e8f5e9 style Recurse fill:#fce4ec tt æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„ æ•´ä¸ª Claude Code ç³»ç»Ÿå›´ç»•ç€ä¸€ä¸ªåä¸º tt çš„å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°å±•å¼€ã€‚è¿™ä¸ªå‡½æ•°åè°ƒç€æ¯ä¸€æ¬¡äº¤äº’ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ° LLM é€šä¿¡å†åˆ°å·¥å…·æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ¥å‰–æè¿™ä¸ªå“è¶Šçš„å·¥ç¨‹è®¾è®¡ï¼š\n// ä»£ç åº“ä¸­å®é™…çš„ tt å‡½æ•°ç­¾å async function* tt( currentMessages: CliMessage[], // å®Œæ•´çš„å¯¹è¯å†å² baseSystemPromptString: string, // é™æ€ç³»ç»ŸæŒ‡ä»¤ currentGitContext: GitContext, // å®æ—¶ git çŠ¶æ€ currentClaudeMdContents: ClaudeMdContent[], // é¡¹ç›®ä¸Šä¸‹æ–‡ permissionGranterFn: PermissionGranter, // æƒé™å›è°ƒ toolUseContext: ToolUseContext, // å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡ activeStreamingToolUse?: ToolUseBlock, // æ¢å¤æµå¼ä¼ è¾“çŠ¶æ€ loopState: { turnId: string, // æ­¤å›åˆçš„ UUID turnCounter: number, // é€’å½’æ·±åº¦è¿½è¸ªå™¨ compacted?: boolean, // å†å²å‹ç¼©æ ‡å¿— isResuming?: boolean // ä»ä¿å­˜çŠ¶æ€æ¢å¤ } ): AsyncGenerator\u0026lt;CliMessage, void, void\u0026gt; è¿™ä¸ªç­¾åæ­ç¤ºäº†å…¶å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚è¯¥å‡½æ•°äº§å‡º CliMessage å¯¹è±¡æ¥é©±åŠ¨ UI æ›´æ–°ï¼ŒåŒæ—¶ç»´æŠ¤å¯¹è¯æµç¨‹ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªé˜¶æ®µï¼š\n","keywords":["Agent"],"articleBody":"ğŸ—ï¸ æ¶æ„ï¼šå¼•æ“å®¤ graph TB subgraph \"æ ¸å¿ƒï¼štt æ§åˆ¶å¾ªç¯\" Start([ç”¨æˆ·è¾“å…¥]) --\u003e Init[åˆå§‹åŒ–å›åˆ] Init --\u003e Compact{éœ€è¦å‹ç¼©?} Compact --\u003e|æ˜¯| CompactLLM[LLM æ‘˜è¦] CompactLLM --\u003e Assembly Compact --\u003e|å¦| Assembly[ç»„è£…ä¸Šä¸‹æ–‡] Assembly --\u003e Stream[æµå¼ä¼ è¾“åˆ° LLM] Stream --\u003e Process[å¤„ç†äº‹ä»¶] Process --\u003e Tools{å·¥å…·è¯·æ±‚?} Tools --\u003e|æ˜¯| Execute[æ‰§è¡Œå·¥å…·] Execute --\u003e Recurse[é€’å½’ tt] Recurse --\u003e Init Tools --\u003e|å¦| End([å®Œæˆ]) end style Init fill:#e1f5fe style Stream fill:#fff3e0 style Execute fill:#e8f5e9 style Recurse fill:#fce4ec tt æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„ æ•´ä¸ª Claude Code ç³»ç»Ÿå›´ç»•ç€ä¸€ä¸ªåä¸º tt çš„å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°å±•å¼€ã€‚è¿™ä¸ªå‡½æ•°åè°ƒç€æ¯ä¸€æ¬¡äº¤äº’ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ° LLM é€šä¿¡å†åˆ°å·¥å…·æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ¥å‰–æè¿™ä¸ªå“è¶Šçš„å·¥ç¨‹è®¾è®¡ï¼š\n// ä»£ç åº“ä¸­å®é™…çš„ tt å‡½æ•°ç­¾å async function* tt( currentMessages: CliMessage[], // å®Œæ•´çš„å¯¹è¯å†å² baseSystemPromptString: string, // é™æ€ç³»ç»ŸæŒ‡ä»¤ currentGitContext: GitContext, // å®æ—¶ git çŠ¶æ€ currentClaudeMdContents: ClaudeMdContent[], // é¡¹ç›®ä¸Šä¸‹æ–‡ permissionGranterFn: PermissionGranter, // æƒé™å›è°ƒ toolUseContext: ToolUseContext, // å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡ activeStreamingToolUse?: ToolUseBlock, // æ¢å¤æµå¼ä¼ è¾“çŠ¶æ€ loopState: { turnId: string, // æ­¤å›åˆçš„ UUID turnCounter: number, // é€’å½’æ·±åº¦è¿½è¸ªå™¨ compacted?: boolean, // å†å²å‹ç¼©æ ‡å¿— isResuming?: boolean // ä»ä¿å­˜çŠ¶æ€æ¢å¤ } ): AsyncGenerator\u003cCliMessage, void, void\u003e è¿™ä¸ªç­¾åæ­ç¤ºäº†å…¶å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚è¯¥å‡½æ•°äº§å‡º CliMessage å¯¹è±¡æ¥é©±åŠ¨ UI æ›´æ–°ï¼ŒåŒæ—¶ç»´æŠ¤å¯¹è¯æµç¨‹ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªé˜¶æ®µï¼š\né˜¶æ®µ 1ï¼šå›åˆåˆå§‹åŒ–ä¸ä¸Šä¸‹æ–‡å‡†å¤‡ { // å‘ UI å‘å‡ºä¿¡å·è¡¨ç¤ºå¤„ç†å·²å¼€å§‹ yield { type: \"ui_state_update\", uuid: `uistate-${loopState.turnId}-${Date.now()}`, timestamp: new Date().toISOString(), data: { status: \"thinking\", turnId: loopState.turnId } }; // æ£€æŸ¥ä¸Šä¸‹æ–‡çª—å£å‹åŠ› let messagesForLlm = currentMessages; let wasCompactedThisIteration = false; if (await shouldAutoCompact(currentMessages)) { yield { type: \"ui_notification\", data: { message: \"Context is large, attempting to compact...\" } }; try { const compactionResult = await compactAndStoreConversation( currentMessages, toolUseContext, true ); messagesForLlm = compactionResult.messagesAfterCompacting; wasCompactedThisIteration = true; loopState.compacted = true; yield createSystemNotificationMessage( `Conversation history automatically compacted. Summary: ${ compactionResult.summaryMessage.message.content[0].text }` ); } catch (compactionError) { yield createSystemErrorMessage( `Failed to compact conversation: ${compactionError.message}` ); } } } é˜¶æ®µ 1 çš„æ€§èƒ½æ¦‚å†µï¼š\næ“ä½œ å…¸å‹æŒç»­æ—¶é—´ å¤æ‚åº¦ Token è®¡æ•° 10-50ms O(n) æ¶ˆæ¯æ•° å‹ç¼©å†³ç­– \u003c1ms O(1) LLM æ‘˜è¦ 2000-3000ms ä¸€æ¬¡ LLM è°ƒç”¨ æ¶ˆæ¯é‡å»º 5-10ms O(n) æ¶ˆæ¯æ•° é˜¶æ®µ 2ï¼šåŠ¨æ€ç³»ç»Ÿæç¤ºç»„è£… ç³»ç»Ÿæç¤ºä¸æ˜¯é™æ€çš„â€”â€”å®ƒåœ¨æ¯ä¸ªå›åˆéƒ½ä¼šé‡æ–°ç»„è£…ï¼š\n{ // å¹¶è¡Œè·å–æ‰€æœ‰ä¸Šä¸‹æ–‡æº const [toolSpecs, dirStructure] = await Promise.all([ // å°†å·¥å…·å®šä¹‰è½¬æ¢ä¸º LLM å…¼å®¹çš„è§„æ ¼ Promise.all( toolUseContext.options.tools .filter((tool) =\u003e (tool.isEnabled ? tool.isEnabled() : true)) .map(async (tool) =\u003e convertToolDefinitionToToolSpecification(tool, toolUseContext), ), ), // è·å–å½“å‰ç›®å½•ç»“æ„ getDirectoryStructureSnapshot(toolUseContext), ]); // ç»„è£…å®Œæ•´çš„ç³»ç»Ÿæç¤º const systemPromptForLlm = assembleSystemPrompt( baseSystemPromptString, // æ ¸å¿ƒæŒ‡ä»¤ currentClaudeMdContents, // é¡¹ç›®ç‰¹å®šä¸Šä¸‹æ–‡ currentGitContext, // Git çŠ¶æ€/åˆ†æ”¯/æäº¤ dirStructure, // æ–‡ä»¶æ ‘ toolSpecs, // å¯ç”¨å·¥å…· ); // å‡†å¤‡å¸¦ç¼“å­˜æ§åˆ¶çš„æ¶ˆæ¯ const apiMessages = prepareMessagesForApi( messagesForLlm, true, // applyEphemeralCacheControl ); } ç»„è£…è¿‡ç¨‹éµå¾ªä¸¥æ ¼çš„ä¼˜å…ˆçº§é¡ºåºï¼š\nä¼˜å…ˆçº§ 1: åŸºç¡€æŒ‡ä»¤ (~2KB) â†“ ä¼˜å…ˆçº§ 2: æ¨¡å‹ç‰¹å®šé€‚é… (~500B) â†“ ä¼˜å…ˆçº§ 3: CLAUDE.md å†…å®¹ (å¯å˜ï¼Œé€šå¸¸ 5-50KB) â†“ ä¼˜å…ˆçº§ 4: Git ä¸Šä¸‹æ–‡ (~1-5KB) â†“ ä¼˜å…ˆçº§ 5: ç›®å½•ç»“æ„ (æˆªæ–­ä»¥é€‚é…) â†“ ä¼˜å…ˆçº§ 6: å·¥å…·è§„æ ¼ (~10-20KB) é˜¶æ®µ 3ï¼šLLM æµå¼ä¼ è¾“åˆå§‹åŒ– { // åˆå§‹åŒ–æµå¼è°ƒç”¨ const llmStream = callLlmStreamApi( apiMessages, systemPromptForLlm, toolSpecificationsForLlm, toolUseContext.options.mainLoopModel, toolUseContext.abortController.signal, ); // åˆå§‹åŒ–æµå¼å“åº”çš„ç´¯åŠ å™¨ let accumulatedAssistantMessage: Partial\u003cCliMessage\u003e \u0026 { message: Partial\u003cApiMessage\u003e \u0026 { content: ContentBlock[] }; } = { type: \"assistant\", uuid: `assistant-${loopState.turnId}-${loopState.turnCounter}-${Date.now()}`, timestamp: new Date().toISOString(), message: { role: \"assistant\", content: [] }, }; let currentToolUsesFromLlm: ToolUseBlock[] = []; let currentThinkingContent: string = \"\"; let currentToolInputJsonBuffer: string = \"\"; } é˜¶æ®µ 4ï¼šæµå¼äº‹ä»¶å¤„ç†çŠ¶æ€æœº è¿™æ˜¯é­”æ³•å‘ç”Ÿçš„åœ°æ–¹â€”â€”å®æ—¶å¤„ç†æµå¼äº‹ä»¶ï¼š\n{ for await (const streamEvent of llmStream) { // ä¸­æ­¢æ£€æŸ¥ if (toolUseContext.abortController.signal.aborted) { yield createSystemNotificationMessage(\"LLM stream processing aborted by user.\"); return; } switch (streamEvent.type) { case \"message_start\": accumulatedAssistantMessage.message.id = streamEvent.message.id; accumulatedAssistantMessage.message.model = streamEvent.message.model; accumulatedAssistantMessage.message.usage = streamEvent.message.usage; yield { type: \"ui_state_update\", data: { status: \"assistant_responding\", model: streamEvent.message.model } }; break; case \"content_block_start\": const newBlockPlaceholder = { ...streamEvent.content_block }; // æ ¹æ®å—ç±»å‹åˆå§‹åŒ–ç©ºå†…å®¹ if (streamEvent.content_block.type === \"thinking\") { currentThinkingContent = \"\"; newBlockPlaceholder.thinking = \"\"; } else if (streamEvent.content_block.type === \"tool_use\") { currentToolInputJsonBuffer = \"\"; newBlockPlaceholder.input = \"\"; } else if (streamEvent.content_block.type === \"text\") { newBlockPlaceholder.text = \"\"; } accumulatedAssistantMessage.message.content.push(newBlockPlaceholder); break; case \"content_block_delta\": const lastBlockIndex = accumulatedAssistantMessage.message.content.length - 1; if (lastBlockIndex \u003c 0) continue; const currentBlock = accumulatedAssistantMessage.message.content[lastBlockIndex]; if (streamEvent.delta.type === \"text_delta\" \u0026\u0026 currentBlock.type === \"text\") { currentBlock.text += streamEvent.delta.text; yield { type: \"ui_text_delta\", data: { textDelta: streamEvent.delta.text, blockIndex: lastBlockIndex } }; } else if (streamEvent.delta.type === \"input_json_delta\" \u0026\u0026 currentBlock.type === \"tool_use\") { currentToolInputJsonBuffer += streamEvent.delta.partial_json; currentBlock.input = currentToolInputJsonBuffer; // å°è¯•è§£æä¸å®Œæ•´çš„ JSON è¿›è¡Œé¢„è§ˆ const parseAttempt = tryParsePartialJson(currentToolInputJsonBuffer); if (parseAttempt.complete) { yield { type: \"ui_tool_preview\", data: { toolId: currentBlock.id, preview: parseAttempt.value } }; } } break; case \"content_block_stop\": const completedBlock = accumulatedAssistantMessage.message.content[streamEvent.index]; if (completedBlock.type === \"tool_use\") { try { const parsedInput = JSON.parse(currentToolInputJsonBuffer); completedBlock.input = parsedInput; currentToolUsesFromLlm.push({ type: \"tool_use\", id: completedBlock.id, name: completedBlock.name, input: parsedInput }); } catch (e) { // å¤„ç†æ¥è‡ª LLM çš„æ ¼å¼é”™è¯¯çš„ JSON completedBlock.input = { error: \"Invalid JSON input from LLM\", raw_json_string: currentToolInputJsonBuffer, parse_error: e.message }; } currentToolInputJsonBuffer = \"\"; } yield { type: \"ui_content_block_complete\", data: { block: completedBlock, blockIndex: streamEvent.index } }; break; case \"message_stop\": // LLM ç”Ÿæˆå®Œæˆ const finalAssistantMessage = finalizeCliMessage( accumulatedAssistantMessage, loopState.turnId, loopState.turnCounter ); yield finalAssistantMessage; // ç§»åŠ¨åˆ°é˜¶æ®µ 5 æˆ– 6... break; } } } æµå¼å¤„ç†æ€§èƒ½ï¼š\né¦–ä¸ª token å»¶è¿Ÿï¼š300-800msï¼ˆå› æ¨¡å‹è€Œå¼‚ï¼‰ Token ååé‡ï¼š50-100 tokens/ç§’ UI æ›´æ–°é¢‘ç‡ï¼šæ–‡æœ¬æ¯ä¸ª token æ›´æ–°ï¼Œå·¥å…·è¾“å…¥æ‰¹é‡æ›´æ–° å†…å­˜ä½¿ç”¨ï¼šæ— è®ºå“åº”é•¿åº¦å¦‚ä½•ä¿æŒæ’å®š é˜¶æ®µ 5ï¼šå·¥å…·æ‰§è¡Œç¼–æ’ å½“ LLM è¯·æ±‚ä½¿ç”¨å·¥å…·æ—¶ï¼Œæ¶æ„è½¬å…¥æ‰§è¡Œæ¨¡å¼ï¼š\n{ if (finalAssistantMessage.message.stop_reason === \"tool_use\" \u0026\u0026 currentToolUsesFromLlm.length \u003e 0) { yield { type: \"ui_state_update\", data: { status: \"executing_tools\" } }; let toolResultMessages: CliMessage[] = []; // ä½¿ç”¨æ™ºèƒ½æ‰¹å¤„ç†å¤„ç†å·¥å…· for await (const toolOutcomeMessage of processToolCallsInParallelBatches( currentToolUsesFromLlm, finalAssistantMessage, permissionGranterFn, toolUseContext )) { yield toolOutcomeMessage; if (toolOutcomeMessage.type === 'user' \u0026\u0026 toolOutcomeMessage.isMeta) { toolResultMessages.push(toolOutcomeMessage); } } // æ£€æŸ¥å·¥å…·æ‰§è¡ŒæœŸé—´æ˜¯å¦ä¸­æ­¢ if (toolUseContext.abortController.signal.aborted) { yield createSystemNotificationMessage(\"Tool execution aborted by user.\"); return; } // å¯¹ç»“æœæ’åºä»¥åŒ¹é… LLM çš„è¯·æ±‚é¡ºåº const sortedToolResultMessages = sortToolResultsByOriginalRequestOrder( toolResultMessages, currentToolUsesFromLlm ); // é˜¶æ®µ 6ï¼šä½¿ç”¨ç»“æœé€’å½’ yield* tt( [...messagesForLlm, finalAssistantMessage, ...sortedToolResultMessages], baseSystemPromptString, currentGitContext, currentClaudeMdContents, permissionGranterFn, toolUseContext, undefined, { ...loopState, turnCounter: loopState.turnCounter + 1 } ); return; } } é˜¶æ®µ 6ï¼šé€’å½’æ§åˆ¶ tt å‡½æ•°æ˜¯å°¾é€’å½’çš„ï¼Œå…è®¸æ— é™çš„å¯¹è¯æ·±åº¦ï¼ˆå—å®‰å…¨æªæ–½é™åˆ¶ï¼‰ï¼š\n// é€’å½’å®‰å…¨æªæ–½ if (loopState.turnCounter \u003e= 10) { yield createSystemMessage( \"Maximum conversation depth reached. Please start a new query.\", ); return; } // é€’å½’å‰çš„å†…å­˜å‹åŠ›æ£€æŸ¥ const estimatedMemory = estimateConversationMemory(messagesForLlm); if (estimatedMemory \u003e MEMORY_THRESHOLD) { // ç»§ç»­å‰å¼ºåˆ¶å‹ç¼© const compacted = await forceCompaction(messagesForLlm); messagesForLlm = compacted; } åˆ†å±‚æ¶æ„ Claude Code å®ç°äº†ä¸€ä¸ªæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œå…¶ä¸­æ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼š\ngraph TD subgraph \"å±‚ 1: ç”¨æˆ·ç•Œé¢\" React[React ç»„ä»¶] Ink[Ink æ¸²æŸ“å™¨] Yoga[Yoga å¸ƒå±€å¼•æ“] React --\u003e Ink Ink --\u003e Yoga end subgraph \"å±‚ 2: Agent æ ¸å¿ƒ\" TT[tt æ§åˆ¶å¾ªç¯] Context[ä¸Šä¸‹æ–‡ç»„è£…] Permission[æƒé™ç³»ç»Ÿ] State[ä¼šè¯çŠ¶æ€] TT --\u003e Context TT --\u003e Permission TT --\u003e State end subgraph \"å±‚ 3: LLM äº¤äº’\" Stream[æµå¤„ç†å™¨] Retry[é‡è¯•é€»è¾‘] Token[Token è®¡æ•°å™¨] Stream --\u003e Retry Stream --\u003e Token end subgraph \"å±‚ 4: å·¥å…·ç³»ç»Ÿ\" Executor[å·¥å…·æ‰§è¡Œå™¨] Validator[è¾“å…¥éªŒè¯å™¨] Sandbox[æ²™ç®±ç®¡ç†å™¨] Executor --\u003e Validator Executor --\u003e Sandbox end subgraph \"å±‚ 5: åŸºç¡€è®¾æ–½\" FS[æ–‡ä»¶ç³»ç»Ÿ] Process[è¿›ç¨‹ç®¡ç†å™¨] Network[ç½‘ç»œå®¢æˆ·ç«¯] Telemetry[é¥æµ‹] end React -.-\u003e TT TT -.-\u003e Stream TT -.-\u003e Executor Executor -.-\u003e FS Executor -.-\u003e Process Stream -.-\u003e Network TT -.-\u003e Telemetry å±‚é—´é€šä¿¡æ¨¡å¼ å±‚ä¹‹é—´çš„é€šä¿¡éµå¾ªä¸¥æ ¼çš„æ¨¡å¼ï¼š\nå‘ä¸‹é€šä¿¡ï¼šç›´æ¥å‡½æ•°è°ƒç”¨ å‘ä¸Šé€šä¿¡ï¼šäº‹ä»¶å’Œå›è°ƒ è·¨å±‚é€šä¿¡ï¼šå…±äº«ä¸Šä¸‹æ–‡å¯¹è±¡ // ç¤ºä¾‹ï¼šUI åˆ° Agent æ ¸å¿ƒé€šä¿¡ class UIToAgentBridge { async handleUserInput(input: string) { // å‘ä¸‹ï¼šç›´æ¥è°ƒç”¨ const action = await pd(input, this.context); // æ ¹æ®æ“ä½œç±»å‹å¤„ç† switch (action.type) { case 'normal_prompt': // å¯åŠ¨æ–°çš„ tt å¾ªç¯è¿­ä»£ for await (const message of tt(...)) { // å‘ä¸Šï¼šäº§å‡ºäº‹ä»¶ this.uiRenderer.handleMessage(message); } break; } } } // ç¤ºä¾‹ï¼šå·¥å…·é€šè¿‡è¿›åº¦å‘ UI é€šä¿¡ class ToolToUIBridge { async *executeWithProgress(tool: ToolDefinition, input: any) { // å·¥å…·äº§å‡ºè¿›åº¦ for await (const event of tool.call(input, this.context)) { if (event.type === 'progress') { // è½¬æ¢ä¸º UI äº‹ä»¶ yield { type: 'ui_progress', toolName: tool.name, progress: event.data }; } } } } äº‹ä»¶é©±åŠ¨ä¸æµå¼æ¶æ„ æ•´ä¸ªç³»ç»Ÿå»ºç«‹åœ¨æµå¼åŸè¯­ä¹‹ä¸Šï¼š\næµå¼åå‹ç®¡ç† class StreamBackpressureController { private queue: StreamEvent[] = []; private processing = false; private pressure = { high: 1000, // å¼€å§‹ä¸¢å¼ƒéå…³é”®äº‹ä»¶ critical: 5000, // é™¤é”™è¯¯å¤–ä¸¢å¼ƒæ‰€æœ‰å†…å®¹ }; async handleEvent(event: StreamEvent) { this.queue.push(event); // åº”ç”¨åå‹ç­–ç•¥ if (this.queue.length \u003e this.pressure.critical) { // åªä¿ç•™å…³é”®äº‹ä»¶ this.queue = this.queue.filter( (e) =\u003e e.type === \"error\" || e.type === \"message_stop\", ); } else if (this.queue.length \u003e this.pressure.high) { // ä¸¢å¼ƒæ–‡æœ¬å¢é‡ï¼Œä¿ç•™ç»“æ„ this.queue = this.queue.filter( (e) =\u003e e.type !== \"content_block_delta\" || e.delta.type !== \"text_delta\", ); } if (!this.processing) { await this.processQueue(); } } private async processQueue() { this.processing = true; while (this.queue.length \u003e 0) { const batch = this.queue.splice(0, 100); // æ‰¹é‡å¤„ç† await this.processBatch(batch); // è®©å‡ºç»™äº‹ä»¶å¾ªç¯ await new Promise((resolve) =\u003e setImmediate(resolve)); } this.processing = false; } } è¿›åº¦äº‹ä»¶èšåˆ å¤šä¸ªå¹¶å‘æ“ä½œéœ€è¦åè°ƒçš„è¿›åº¦æŠ¥å‘Šï¼š\nclass ProgressAggregator { private progressStreams = new Map\u003cstring, AsyncIterator\u003cProgressEvent\u003e\u003e(); async *aggregateProgress( operations: Array\u003c{ id: string; operation: AsyncIterator\u003cany\u003e }\u003e, ): AsyncGenerator\u003cAggregatedProgress\u003e { // å¯åŠ¨æ‰€æœ‰æ“ä½œ for (const { id, operation } of operations) { this.progressStreams.set(id, operation); } // è½®è¯¢æ‰€æœ‰æµ while (this.progressStreams.size \u003e 0) { const promises = Array.from(this.progressStreams.entries()).map( async ([id, stream]) =\u003e { const { value, done } = await stream.next(); return { id, value, done }; }, ); // ç«äº‰ä¸‹ä¸€ä¸ªäº‹ä»¶ const result = await Promise.race(promises); if (result.done) { this.progressStreams.delete(result.id); } else if (result.value.type === \"progress\") { yield { type: \"aggregated_progress\", source: result.id, progress: result.value, }; } } } } çŠ¶æ€ç®¡ç†æ¶æ„ Claude Code ä½¿ç”¨å®ç”¨çš„çŠ¶æ€ç®¡ç†æ–¹æ³•ï¼š\nå…¨å±€ä¼šè¯çŠ¶æ€ // å¸¦ç›´æ¥å˜æ›´çš„å•ä¾‹ä¼šè¯çŠ¶æ€ class SessionState { private static instance: SessionState; // æ ¸å¿ƒçŠ¶æ€ sessionId: string = crypto.randomUUID(); cwd: string = process.cwd(); totalCostUSD: number = 0; totalAPIDuration: number = 0; // æ¨¡å‹ä½¿ç”¨è¿½è¸ª modelTokens: Record\u003c string, { inputTokens: number; outputTokens: number; cacheReadInputTokens: number; cacheCreationInputTokens: number; } \u003e = {}; // ç›´æ¥å˜æ›´æ–¹æ³• incrementCost(amount: number) { this.totalCostUSD += amount; this.persistToDisk(); // å¼‚æ­¥ï¼Œéé˜»å¡ } updateTokenUsage(model: string, usage: TokenUsage) { if (!this.modelTokens[model]) { this.modelTokens[model] = { inputTokens: 0, outputTokens: 0, cacheReadInputTokens: 0, cacheCreationInputTokens: 0, }; } const tokens = this.modelTokens[model]; tokens.inputTokens += usage.input_tokens || 0; tokens.outputTokens += usage.output_tokens || 0; tokens.cacheReadInputTokens += usage.cache_read_input_tokens || 0; tokens.cacheCreationInputTokens += usage.cache_creation_input_tokens || 0; } private async persistToDisk() { // é˜²æŠ–å†™å…¥ä»¥é¿å…è¿‡å¤š I/O clearTimeout(this.persistTimer); this.persistTimer = setTimeout(async () =\u003e { await fs.writeFile(\".claude/session.json\", JSON.stringify(this, null, 2)); }, 1000); } } ä½¿ç”¨å¼±å¼•ç”¨çš„æ–‡ä»¶çŠ¶æ€ class ReadFileState { private cache = new Map\u003cstring, WeakRef\u003cFileContent\u003e\u003e(); private registry = new FinalizationRegistry((path: string) =\u003e { // å½“ FileContent è¢«åƒåœ¾å›æ”¶æ—¶æ¸…ç† this.cache.delete(path); }); set(path: string, content: FileContent) { const ref = new WeakRef(content); this.cache.set(path, ref); this.registry.register(content, path); } get(path: string): FileContent | undefined { const ref = this.cache.get(path); if (ref) { const content = ref.deref(); if (!content) { // å†…å®¹å·²è¢«åƒåœ¾å›æ”¶ this.cache.delete(path); return undefined; } return content; } } checkFreshness(path: string): \"fresh\" | \"stale\" | \"unknown\" { const cached = this.get(path); if (!cached) return \"unknown\"; const stats = fs.statSync(path); if (stats.mtimeMs !== cached.timestamp) { return \"stale\"; } return \"fresh\"; } } å®‰å…¨æ¶æ„ å®‰å…¨æ€§é€šè¿‡å¤šä¸ªç‹¬ç«‹å±‚å®ç°ï¼š\nç¬¬ 1 å±‚ï¼šæƒé™ç³»ç»Ÿ class PermissionEvaluator { private ruleCache = new Map\u003cstring, CompiledRule\u003e(); async evaluate( tool: ToolDefinition, input: any, context: ToolPermissionContext, ): Promise\u003cPermissionDecision\u003e { // ä¼˜å…ˆçº§é¡ºåºè¯„ä¼° const scopes: PermissionRuleScope[] = [ \"cliArg\", // æœ€é«˜ï¼šå‘½ä»¤è¡Œ \"localSettings\", // é¡¹ç›®ç‰¹å®šè¦†ç›– \"projectSettings\", // å…±äº«é¡¹ç›®è§„åˆ™ \"policySettings\", // ç»„ç»‡ç­–ç•¥ \"userSettings\", // æœ€ä½ï¼šç”¨æˆ·åå¥½ ]; for (const scope of scopes) { const decision = await this.evaluateScope(tool, input, context, scope); if (decision.behavior !== \"continue\") { return decision; } } // æ— åŒ¹é…è§„åˆ™ - è¯¢é—®ç”¨æˆ· return { behavior: \"ask\", suggestions: this.generateSuggestions(tool, input), }; } private compileRule(rule: string): CompiledRule { if (this.ruleCache.has(rule)) { return this.ruleCache.get(rule)!; } // è§£æè§„åˆ™è¯­æ³•ï¼šToolName(glob/pattern) const match = rule.match(/^(\\w+)(?:\\((.+)\\))?$/); if (!match) throw new Error(`Invalid rule: ${rule}`); const [, toolPattern, pathPattern] = match; const compiled = { toolMatcher: new RegExp(`^${toolPattern.replace(\"*\", \".*\")}$`), pathMatcher: pathPattern ? picomatch(pathPattern) : null, }; this.ruleCache.set(rule, compiled); return compiled; } } ç¬¬ 2 å±‚ï¼šæ²™ç®±æ¶æ„ // macOS æ²™ç®±å®ç° class MacOSSandboxManager { generateProfile(command: string, restrictions: SandboxRestrictions): string { const profile = ` (version 1) (deny default) ; Base permissions (allow process-exec (literal \"/bin/bash\")) (allow process-exec (literal \"/usr/bin/env\")) ; File system access ${restrictions.allowRead ? \"(allow file-read*)\" : \"(deny file-read*)\"} ${restrictions.allowWrite ? \"(allow file-write*)\" : \"(deny file-write*)\"} ; Network access ${ restrictions.allowNetwork ? ` (allow network-outbound) (allow network-inbound) ` : ` (deny network*) ` } ; System operations (allow sysctl-read) (allow mach-lookup) ; Temporary files (allow file-write* (subpath \"/tmp\")) (allow file-write* (subpath \"/var/tmp\")) `.trim(); return profile; } async executeSandboxed( command: string, profile: string, ): Promise\u003cExecutionResult\u003e { // å°†é…ç½®æ–‡ä»¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ const profilePath = await this.writeTemporaryProfile(profile); try { // ä½¿ç”¨ sandbox-exec æ‰§è¡Œ const result = await exec(`sandbox-exec -p '${profilePath}' ${command}`); return result; } finally { // æ¸…ç† await fs.unlink(profilePath); } } } ç¬¬ 3 å±‚ï¼šè·¯å¾„éªŒè¯ class PathValidator { private boundaries: Set\u003cstring\u003e; private deniedPatterns: RegExp[]; constructor(context: SecurityContext) { this.boundaries = new Set([ context.projectRoot, ...context.additionalWorkingDirectories, ]); this.deniedPatterns = [ /\\/\\.(ssh|gnupg)\\//, // SSH/GPG å¯†é’¥ /\\/(etc|sys|proc)\\//, // ç³»ç»Ÿç›®å½• /\\.pem$|\\.key$/, // ç§é’¥ /\\.(env|envrc)$/, // ç¯å¢ƒæ–‡ä»¶ ]; } validate(requestedPath: string): ValidationResult { const absolute = path.resolve(requestedPath); // æ£€æŸ¥è¾¹ç•Œ const inBoundary = Array.from(this.boundaries).some((boundary) =\u003e absolute.startsWith(boundary), ); if (!inBoundary) { return { allowed: false, reason: \"Path outside allowed directories\", }; } // æ£€æŸ¥æ‹’ç»æ¨¡å¼ for (const pattern of this.deniedPatterns) { if (pattern.test(absolute)) { return { allowed: false, reason: `Path matches denied pattern: ${pattern}`, }; } } return { allowed: true }; } } æ€§èƒ½æ¶æ„ ANRï¼ˆåº”ç”¨ç¨‹åºæ— å“åº”ï¼‰æ£€æµ‹ ANR ç³»ç»Ÿä½¿ç”¨å·¥ä½œçº¿ç¨‹æ¥ç›‘æ§ä¸»äº‹ä»¶å¾ªç¯ï¼š\n// å·¥ä½œçº¿ç¨‹è„šæœ¬ï¼ˆåµŒå…¥ä¸º base64ï¼‰ const anrWorkerScript = ` const { parentPort } = require('worker_threads'); let config = { anrThreshold: 5000, captureStackTrace: false }; let lastPing = Date.now(); let anrTimer = null; function checkANR() { const elapsed = Date.now() - lastPing; if (elapsed \u003e config.anrThreshold) { // ä¸»çº¿ç¨‹æ— å“åº” parentPort.postMessage({ type: 'anr', payload: { elapsed, stackTrace: config.captureStackTrace ? captureMainThreadStack() : null } }); } // å®‰æ’ä¸‹æ¬¡æ£€æŸ¥ anrTimer = setTimeout(checkANR, 100); } async function captureMainThreadStack() { // å¦‚æœå¯ç”¨ï¼Œä½¿ç”¨æ£€æŸ¥å™¨åè®® try { const { Session } = require('inspector'); const session = new Session(); session.connect(); const { result } = await session.post('Debugger.enable'); const stack = await session.post('Debugger.getStackTrace'); session.disconnect(); return stack; } catch (e) { return null; } } parentPort.on('message', (msg) =\u003e { if (msg.type === 'config') { config = msg.payload; lastPing = Date.now(); checkANR(); // å¼€å§‹ç›‘æ§ } else if (msg.type === 'ping') { lastPing = Date.now(); } }); `; // ä¸»çº¿ç¨‹ ANR é›†æˆ class ANRMonitor { private worker: Worker; private pingInterval: NodeJS.Timer; constructor(options: ANROptions = {}) { // ä»åµŒå…¥è„šæœ¬åˆ›å»ºå·¥ä½œçº¿ç¨‹ this.worker = new Worker(anrWorkerScript, { eval: true }); // é…ç½®å·¥ä½œçº¿ç¨‹ this.worker.postMessage({ type: \"config\", payload: { anrThreshold: options.threshold || 5000, captureStackTrace: options.captureStackTrace !== false, }, }); // å¯åŠ¨å¿ƒè·³ this.pingInterval = setInterval(() =\u003e { this.worker.postMessage({ type: \"ping\" }); }, options.pollInterval || 50); // å¤„ç† ANR æ£€æµ‹ this.worker.on(\"message\", (msg) =\u003e { if (msg.type === \"anr\") { this.handleANR(msg.payload); } }); } private handleANR(data: ANRData) { // è®°å½•åˆ°é¥æµ‹ Sentry.captureException( new Error(`Application not responding for ${data.elapsed}ms`), { extra: { stackTrace: data.stackTrace, eventLoopDelay: this.getEventLoopDelay(), }, }, ); } } æˆ˜ç•¥ç¼“å­˜å±‚ class CacheArchitecture { // L1: å†…å­˜ç¼“å­˜ private schemaCache = new LRUCache\u003cstring, JSONSchema\u003e(100); private patternCache = new LRUCache\u003cstring, CompiledPattern\u003e(500); private gitContextCache = new TTLCache\u003cstring, GitContext\u003e(30_000); // 30s TTL // L2: å¼±å¼•ç”¨ç¼“å­˜ private fileContentCache = new WeakRefCache\u003cFileContent\u003e(); // L3: ç£ç›˜ç¼“å­˜ private diskCache = new DiskCache(\".claude/cache\"); async get\u003cT\u003e( key: string, generator: () =\u003e Promise\u003cT\u003e, options: CacheOptions = {}, ): Promise\u003cT\u003e { // æ£€æŸ¥ L1 if (this.schemaCache.has(key)) { return this.schemaCache.get(key) as T; } // æ£€æŸ¥ L2 const weakRef = this.fileContentCache.get(key); if (weakRef) { return weakRef as T; } // æ£€æŸ¥ L3 if (options.persistent) { const diskValue = await this.diskCache.get(key); if (diskValue) { return diskValue; } } // ç”Ÿæˆå¹¶ç¼“å­˜ const value = await generator(); // å­˜å‚¨åœ¨é€‚å½“çš„ç¼“å­˜ä¸­ if (options.weak) { this.fileContentCache.set(key, value); } else if (options.persistent) { await this.diskCache.set(key, value, options.ttl); } else { this.schemaCache.set(key, value as any); } return value; } } é¥æµ‹ä¸å¯è§‚æµ‹æ€§è®¾è®¡ ä¸‰æ”¯æŸ±æ–¹æ³•æä¾›å…¨é¢çš„å¯è§æ€§ï¼š\næ”¯æŸ± 1ï¼šé”™è¯¯è¿½è¸ªï¼ˆSentryï¼‰ class ErrorBoundary { static wrap\u003cT extends (...args: any[]) =\u003e any\u003e( fn: T, context: ErrorContext ): T { return (async (...args: Parameters\u003cT\u003e) =\u003e { const span = Sentry.startTransaction({ name: context.operation, op: context.category }); try { const result = await fn(...args); span.setStatus('ok'); return result; } catch (error) { span.setStatus('internal_error'); Sentry.captureException(error, { contexts: { operation: context, state: this.captureState() }, fingerprint: this.generateFingerprint(error, context) }); throw error; } finally { span.finish(); } }) as T; } private static captureState() { return { sessionId: SessionState.instance.sessionId, conversationDepth: /* current depth */, activeTools: /* currently executing */, memoryUsage: process.memoryUsage(), eventLoopDelay: this.getEventLoopDelay() }; } } æ”¯æŸ± 2ï¼šæŒ‡æ ‡ï¼ˆOpenTelemetryï¼‰ class MetricsCollector { private meters = { api: meter.createCounter('api_calls_total'), tokens: meter.createHistogram('token_usage'), tools: meter.createHistogram('tool_execution_duration'), streaming: meter.createHistogram('streaming_latency') }; recordApiCall(result: ApiCallResult) { this.meters.api.add(1, { model: result.model, status: result.status, provider: result.provider }); this.meters.tokens.record(result.totalTokens, { model: result.model, type: 'total' }); } recordToolExecution(tool: string, duration: number, success: boolean) { this.meters.tools.record(duration, { tool, success: String(success), concurrent: /* was parallel? */ }); } } æ”¯æŸ± 3ï¼šåŠŸèƒ½æ ‡å¿—ï¼ˆStatsigï¼‰ class FeatureManager { async checkGate(gate: string, context?: FeatureContext): Promise\u003cboolean\u003e { return statsig.checkGate(gate, { userID: SessionState.instance.sessionId, custom: { model: context?.model, toolsEnabled: context?.tools, platform: process.platform, }, }); } async getConfig\u003cT\u003e(config: string, defaultValue: T): Promise\u003cT\u003e { const dynamicConfig = statsig.getConfig(config); return dynamicConfig.get(\"value\", defaultValue); } } èµ„æºç®¡ç† è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç† class ProcessManager { private processes = new Map\u003cstring, ChildProcess\u003e(); private limits = { maxProcesses: 10, maxMemoryPerProcess: 512 * 1024 * 1024, // 512MB maxTotalMemory: 2 * 1024 * 1024 * 1024, // 2GB }; async spawn( id: string, command: string, options: SpawnOptions, ): Promise\u003cManagedProcess\u003e { // æ£€æŸ¥é™åˆ¶ if (this.processes.size \u003e= this.limits.maxProcesses) { await this.killOldestProcess(); } const child = spawn(\"bash\", [\"-c\", command], { ...options, // èµ„æºé™åˆ¶ env: { ...options.env, NODE_OPTIONS: `--max-old-space-size=${this.limits.maxMemoryPerProcess / 1024 / 1024}`, }, }); // ç›‘æ§èµ„æº const monitor = setInterval(() =\u003e { this.checkProcessHealth(id, child); }, 1000); this.processes.set(id, child); return new ManagedProcess(child, monitor); } private async checkProcessHealth(id: string, proc: ChildProcess) { try { const usage = await pidusage(proc.pid); if (usage.memory \u003e this.limits.maxMemoryPerProcess) { console.warn(`Process ${id} exceeding memory limit`); proc.kill(\"SIGTERM\"); } } catch (e) { // è¿›ç¨‹å¯èƒ½å·²é€€å‡º this.processes.delete(id); } } } ç½‘ç»œè¿æ¥æ±  class NetworkPool { private pools = new Map\u003cstring, ConnectionPool\u003e(); getPool(provider: string): ConnectionPool { if (!this.pools.has(provider)) { this.pools.set( provider, new ConnectionPool({ maxConnections: provider === \"anthropic\" ? 10 : 5, maxIdleTime: 30_000, keepAlive: true, }), ); } return this.pools.get(provider)!; } async request(provider: string, options: RequestOptions): Promise\u003cResponse\u003e { const pool = this.getPool(provider); const connection = await pool.acquire(); try { return await connection.request(options); } finally { pool.release(connection); } } } æ­¤æ¶æ„åˆ†æåŸºäºé€†å‘å·¥ç¨‹å’Œåç¼–è¯‘ã€‚å®é™…å®ç°å¯èƒ½æœ‰æ‰€ä¸åŒã€‚æ‰€å‘ˆç°çš„æ¨¡å¼ä»£è¡¨åŸºäºå¯è§‚å¯Ÿè¡Œä¸ºå’Œé«˜æ€§èƒ½ Node.js åº”ç”¨ç¨‹åºå¸¸è§å®è·µæ¨æ–­çš„æ¶æ„å†³ç­–ã€‚\n","wordCount":"2680","inLanguage":"en","image":"https://starslayerx.github.io/images/og-default.avif","datePublished":"2025-11-14T13:00:00+01:00","dateModified":"2025-11-14T13:00:00+01:00","author":{"@type":"Person","name":"Starslayerx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-05%E6%9E%B6%E6%9E%84/"},"publisher":{"@type":"Organization","name":"Starslayerx' Blog","logo":{"@type":"ImageObject","url":"https://starslayerx.github.io/favicon.svg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://starslayerx.github.io/ accesskey=h title="Starslayerx' Blog (Alt + H)"><img src=https://starslayerx.github.io/favicon.svg alt aria-label=logo height=35>Starslayerx' Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://starslayerx.github.io/zh-cn/ title=ç®€ä½“ä¸­æ–‡ aria-label=ç®€ä½“ä¸­æ–‡>Zh-Cn</a></li></ul></div></div><ul id=menu><li><a href=https://starslayerx.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://starslayerx.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://starslayerx.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://starslayerx.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://starslayerx.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://starslayerx.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://starslayerx.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Claude Code åˆ†æ 05ï¼šæ¶æ„</h1><div class=post-meta><span title='2025-11-14 13:00:00 +0100 +0100'>November 14, 2025</span>&nbsp;Â·&nbsp;<span>13 min</span>&nbsp;Â·&nbsp;<span>2680 words</span>&nbsp;Â·&nbsp;<span>Starslayerx</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#tt-æ§åˆ¶å¾ªç¯è·³åŠ¨çš„å¿ƒè„><code>tt</code> æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„</a><ul><li><a href=#é˜¶æ®µ-1å›åˆåˆå§‹åŒ–ä¸ä¸Šä¸‹æ–‡å‡†å¤‡>é˜¶æ®µ 1ï¼šå›åˆåˆå§‹åŒ–ä¸ä¸Šä¸‹æ–‡å‡†å¤‡</a></li><li><a href=#é˜¶æ®µ-2åŠ¨æ€ç³»ç»Ÿæç¤ºç»„è£…>é˜¶æ®µ 2ï¼šåŠ¨æ€ç³»ç»Ÿæç¤ºç»„è£…</a></li><li><a href=#é˜¶æ®µ-3llm-æµå¼ä¼ è¾“åˆå§‹åŒ–>é˜¶æ®µ 3ï¼šLLM æµå¼ä¼ è¾“åˆå§‹åŒ–</a></li><li><a href=#é˜¶æ®µ-4æµå¼äº‹ä»¶å¤„ç†çŠ¶æ€æœº>é˜¶æ®µ 4ï¼šæµå¼äº‹ä»¶å¤„ç†çŠ¶æ€æœº</a></li><li><a href=#é˜¶æ®µ-5å·¥å…·æ‰§è¡Œç¼–æ’>é˜¶æ®µ 5ï¼šå·¥å…·æ‰§è¡Œç¼–æ’</a></li><li><a href=#é˜¶æ®µ-6é€’å½’æ§åˆ¶>é˜¶æ®µ 6ï¼šé€’å½’æ§åˆ¶</a></li></ul></li><li><a href=#åˆ†å±‚æ¶æ„>åˆ†å±‚æ¶æ„</a><ul><li><a href=#å±‚é—´é€šä¿¡æ¨¡å¼>å±‚é—´é€šä¿¡æ¨¡å¼</a></li></ul></li><li><a href=#äº‹ä»¶é©±åŠ¨ä¸æµå¼æ¶æ„>äº‹ä»¶é©±åŠ¨ä¸æµå¼æ¶æ„</a><ul><li><a href=#æµå¼åå‹ç®¡ç†>æµå¼åå‹ç®¡ç†</a></li><li><a href=#è¿›åº¦äº‹ä»¶èšåˆ>è¿›åº¦äº‹ä»¶èšåˆ</a></li></ul></li><li><a href=#çŠ¶æ€ç®¡ç†æ¶æ„>çŠ¶æ€ç®¡ç†æ¶æ„</a><ul><li><a href=#å…¨å±€ä¼šè¯çŠ¶æ€>å…¨å±€ä¼šè¯çŠ¶æ€</a></li><li><a href=#ä½¿ç”¨å¼±å¼•ç”¨çš„æ–‡ä»¶çŠ¶æ€>ä½¿ç”¨å¼±å¼•ç”¨çš„æ–‡ä»¶çŠ¶æ€</a></li></ul></li><li><a href=#å®‰å…¨æ¶æ„>å®‰å…¨æ¶æ„</a><ul><li><a href=#ç¬¬-1-å±‚æƒé™ç³»ç»Ÿ>ç¬¬ 1 å±‚ï¼šæƒé™ç³»ç»Ÿ</a></li><li><a href=#ç¬¬-2-å±‚æ²™ç®±æ¶æ„>ç¬¬ 2 å±‚ï¼šæ²™ç®±æ¶æ„</a></li><li><a href=#ç¬¬-3-å±‚è·¯å¾„éªŒè¯>ç¬¬ 3 å±‚ï¼šè·¯å¾„éªŒè¯</a></li></ul></li><li><a href=#æ€§èƒ½æ¶æ„>æ€§èƒ½æ¶æ„</a><ul><li><a href=#anråº”ç”¨ç¨‹åºæ— å“åº”æ£€æµ‹>ANRï¼ˆåº”ç”¨ç¨‹åºæ— å“åº”ï¼‰æ£€æµ‹</a></li><li><a href=#æˆ˜ç•¥ç¼“å­˜å±‚>æˆ˜ç•¥ç¼“å­˜å±‚</a></li></ul></li><li><a href=#é¥æµ‹ä¸å¯è§‚æµ‹æ€§è®¾è®¡>é¥æµ‹ä¸å¯è§‚æµ‹æ€§è®¾è®¡</a><ul><li><a href=#æ”¯æŸ±-1é”™è¯¯è¿½è¸ªsentry>æ”¯æŸ± 1ï¼šé”™è¯¯è¿½è¸ªï¼ˆSentryï¼‰</a></li><li><a href=#æ”¯æŸ±-2æŒ‡æ ‡opentelemetry>æ”¯æŸ± 2ï¼šæŒ‡æ ‡ï¼ˆOpenTelemetryï¼‰</a></li><li><a href=#æ”¯æŸ±-3åŠŸèƒ½æ ‡å¿—statsig>æ”¯æŸ± 3ï¼šåŠŸèƒ½æ ‡å¿—ï¼ˆStatsigï¼‰</a></li></ul></li><li><a href=#èµ„æºç®¡ç†>èµ„æºç®¡ç†</a><ul><li><a href=#è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†>è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†</a></li><li><a href=#ç½‘ç»œè¿æ¥æ± >ç½‘ç»œè¿æ¥æ± </a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=-æ¶æ„å¼•æ“å®¤>ğŸ—ï¸ æ¶æ„ï¼šå¼•æ“å®¤<a hidden class=anchor aria-hidden=true href=#-æ¶æ„å¼•æ“å®¤>#</a></h1><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TB
    subgraph &#34;æ ¸å¿ƒï¼štt æ§åˆ¶å¾ªç¯&#34;
        Start([ç”¨æˆ·è¾“å…¥]) --&gt; Init[åˆå§‹åŒ–å›åˆ]
        Init --&gt; Compact{éœ€è¦å‹ç¼©?}
        Compact --&gt;|æ˜¯| CompactLLM[LLM æ‘˜è¦]
        CompactLLM --&gt; Assembly
        Compact --&gt;|å¦| Assembly[ç»„è£…ä¸Šä¸‹æ–‡]

        Assembly --&gt; Stream[æµå¼ä¼ è¾“åˆ° LLM]
        Stream --&gt; Process[å¤„ç†äº‹ä»¶]
        Process --&gt; Tools{å·¥å…·è¯·æ±‚?}

        Tools --&gt;|æ˜¯| Execute[æ‰§è¡Œå·¥å…·]
        Execute --&gt; Recurse[é€’å½’ tt]
        Recurse --&gt; Init

        Tools --&gt;|å¦| End([å®Œæˆ])
    end

    style Init fill:#e1f5fe
    style Stream fill:#fff3e0
    style Execute fill:#e8f5e9
    style Recurse fill:#fce4ec
</code></pre><h2 id=tt-æ§åˆ¶å¾ªç¯è·³åŠ¨çš„å¿ƒè„><code>tt</code> æ§åˆ¶å¾ªç¯ï¼šè·³åŠ¨çš„å¿ƒè„<a hidden class=anchor aria-hidden=true href=#tt-æ§åˆ¶å¾ªç¯è·³åŠ¨çš„å¿ƒè„>#</a></h2><p>æ•´ä¸ª Claude Code ç³»ç»Ÿå›´ç»•ç€ä¸€ä¸ªåä¸º <code>tt</code> çš„å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°å±•å¼€ã€‚è¿™ä¸ªå‡½æ•°åè°ƒç€æ¯ä¸€æ¬¡äº¤äº’ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ° LLM é€šä¿¡å†åˆ°å·¥å…·æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ¥å‰–æè¿™ä¸ªå“è¶Šçš„å·¥ç¨‹è®¾è®¡ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// ä»£ç åº“ä¸­å®é™…çš„ tt å‡½æ•°ç­¾å
</span></span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span><span class=o>*</span> <span class=nx>tt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>currentMessages</span>: <span class=kt>CliMessage</span><span class=p>[],</span>         <span class=c1>// å®Œæ•´çš„å¯¹è¯å†å²
</span></span></span><span class=line><span class=cl>  <span class=nx>baseSystemPromptString</span>: <span class=kt>string</span><span class=p>,</span>        <span class=c1>// é™æ€ç³»ç»ŸæŒ‡ä»¤
</span></span></span><span class=line><span class=cl>  <span class=nx>currentGitContext</span>: <span class=kt>GitContext</span><span class=p>,</span>         <span class=c1>// å®æ—¶ git çŠ¶æ€
</span></span></span><span class=line><span class=cl>  <span class=nx>currentClaudeMdContents</span>: <span class=kt>ClaudeMdContent</span><span class=p>[],</span> <span class=c1>// é¡¹ç›®ä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl>  <span class=nx>permissionGranterFn</span>: <span class=kt>PermissionGranter</span><span class=p>,</span> <span class=c1>// æƒé™å›è°ƒ
</span></span></span><span class=line><span class=cl>  <span class=nx>toolUseContext</span>: <span class=kt>ToolUseContext</span><span class=p>,</span>         <span class=c1>// å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl>  <span class=nx>activeStreamingToolUse?</span>: <span class=kt>ToolUseBlock</span><span class=p>,</span>  <span class=c1>// æ¢å¤æµå¼ä¼ è¾“çŠ¶æ€
</span></span></span><span class=line><span class=cl>  <span class=nx>loopState</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>turnId</span>: <span class=kt>string</span><span class=p>,</span>        <span class=c1>// æ­¤å›åˆçš„ UUID
</span></span></span><span class=line><span class=cl>    <span class=nx>turnCounter</span>: <span class=kt>number</span><span class=p>,</span>   <span class=c1>// é€’å½’æ·±åº¦è¿½è¸ªå™¨
</span></span></span><span class=line><span class=cl>    <span class=nx>compacted?</span>: <span class=kt>boolean</span><span class=p>,</span>   <span class=c1>// å†å²å‹ç¼©æ ‡å¿—
</span></span></span><span class=line><span class=cl>    <span class=nx>isResuming?</span>: <span class=kt>boolean</span>   <span class=c1>// ä»ä¿å­˜çŠ¶æ€æ¢å¤
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>,</span> <span class=na>void</span><span class=p>,</span> <span class=na>void</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>è¿™ä¸ªç­¾åæ­ç¤ºäº†å…¶å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚è¯¥å‡½æ•°äº§å‡º <code>CliMessage</code> å¯¹è±¡æ¥é©±åŠ¨ UI æ›´æ–°ï¼ŒåŒæ—¶ç»´æŠ¤å¯¹è¯æµç¨‹ã€‚è®©æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªé˜¶æ®µï¼š</p><h3 id=é˜¶æ®µ-1å›åˆåˆå§‹åŒ–ä¸ä¸Šä¸‹æ–‡å‡†å¤‡>é˜¶æ®µ 1ï¼šå›åˆåˆå§‹åŒ–ä¸ä¸Šä¸‹æ–‡å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µ-1å›åˆåˆå§‹åŒ–ä¸ä¸Šä¸‹æ–‡å‡†å¤‡>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å‘ UI å‘å‡ºä¿¡å·è¡¨ç¤ºå¤„ç†å·²å¼€å§‹
</span></span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_state_update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span><span class=o>:</span> <span class=sb>`uistate-</span><span class=si>${</span><span class=nx>loopState</span><span class=p>.</span><span class=nx>turnId</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span>: <span class=kt>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;thinking&#34;</span><span class=p>,</span> <span class=nx>turnId</span>: <span class=kt>loopState.turnId</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ£€æŸ¥ä¸Šä¸‹æ–‡çª—å£å‹åŠ›
</span></span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>messagesForLlm</span> <span class=o>=</span> <span class=nx>currentMessages</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>wasCompactedThisIteration</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>await</span> <span class=nx>shouldAutoCompact</span><span class=p>(</span><span class=nx>currentMessages</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_notification&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>message</span><span class=o>:</span> <span class=s2>&#34;Context is large, attempting to compact...&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>compactionResult</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>compactAndStoreConversation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>currentMessages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>toolUseContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>messagesForLlm</span> <span class=o>=</span> <span class=nx>compactionResult</span><span class=p>.</span><span class=nx>messagesAfterCompacting</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>wasCompactedThisIteration</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>loopState</span><span class=p>.</span><span class=nx>compacted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>createSystemNotificationMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`Conversation history automatically compacted. Summary: </span><span class=si>${</span>
</span></span><span class=line><span class=cl>          <span class=nx>compactionResult</span><span class=p>.</span><span class=nx>summaryMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>text</span>
</span></span><span class=line><span class=cl>        <span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>compactionError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>createSystemErrorMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`Failed to compact conversation: </span><span class=si>${</span><span class=nx>compactionError</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>é˜¶æ®µ 1 çš„æ€§èƒ½æ¦‚å†µ</strong>ï¼š</p><table><thead><tr><th>æ“ä½œ</th><th>å…¸å‹æŒç»­æ—¶é—´</th><th>å¤æ‚åº¦</th></tr></thead><tbody><tr><td>Token è®¡æ•°</td><td>10-50ms</td><td>O(n) æ¶ˆæ¯æ•°</td></tr><tr><td>å‹ç¼©å†³ç­–</td><td>&lt;1ms</td><td>O(1)</td></tr><tr><td>LLM æ‘˜è¦</td><td>2000-3000ms</td><td>ä¸€æ¬¡ LLM è°ƒç”¨</td></tr><tr><td>æ¶ˆæ¯é‡å»º</td><td>5-10ms</td><td>O(n) æ¶ˆæ¯æ•°</td></tr></tbody></table><h3 id=é˜¶æ®µ-2åŠ¨æ€ç³»ç»Ÿæç¤ºç»„è£…>é˜¶æ®µ 2ï¼šåŠ¨æ€ç³»ç»Ÿæç¤ºç»„è£…<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µ-2åŠ¨æ€ç³»ç»Ÿæç¤ºç»„è£…>#</a></h3><p>ç³»ç»Ÿæç¤ºä¸æ˜¯é™æ€çš„â€”â€”å®ƒåœ¨æ¯ä¸ªå›åˆéƒ½ä¼šé‡æ–°ç»„è£…ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å¹¶è¡Œè·å–æ‰€æœ‰ä¸Šä¸‹æ–‡æº
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>toolSpecs</span><span class=p>,</span> <span class=nx>dirStructure</span><span class=p>]</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å°†å·¥å…·å®šä¹‰è½¬æ¢ä¸º LLM å…¼å®¹çš„è§„æ ¼
</span></span></span><span class=line><span class=cl>    <span class=nx>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolUseContext</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>tools</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>tool</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>tool</span><span class=p>.</span><span class=nx>isEnabled</span> <span class=o>?</span> <span class=nx>tool</span><span class=p>.</span><span class=nx>isEnabled</span><span class=p>()</span> <span class=o>:</span> <span class=kc>true</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>tool</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nx>convertToolDefinitionToToolSpecification</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>toolUseContext</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–å½“å‰ç›®å½•ç»“æ„
</span></span></span><span class=line><span class=cl>    <span class=nx>getDirectoryStructureSnapshot</span><span class=p>(</span><span class=nx>toolUseContext</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ç»„è£…å®Œæ•´çš„ç³»ç»Ÿæç¤º
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>systemPromptForLlm</span> <span class=o>=</span> <span class=nx>assembleSystemPrompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>baseSystemPromptString</span><span class=p>,</span> <span class=c1>// æ ¸å¿ƒæŒ‡ä»¤
</span></span></span><span class=line><span class=cl>    <span class=nx>currentClaudeMdContents</span><span class=p>,</span> <span class=c1>// é¡¹ç›®ç‰¹å®šä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl>    <span class=nx>currentGitContext</span><span class=p>,</span> <span class=c1>// Git çŠ¶æ€/åˆ†æ”¯/æäº¤
</span></span></span><span class=line><span class=cl>    <span class=nx>dirStructure</span><span class=p>,</span> <span class=c1>// æ–‡ä»¶æ ‘
</span></span></span><span class=line><span class=cl>    <span class=nx>toolSpecs</span><span class=p>,</span> <span class=c1>// å¯ç”¨å·¥å…·
</span></span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å‡†å¤‡å¸¦ç¼“å­˜æ§åˆ¶çš„æ¶ˆæ¯
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>apiMessages</span> <span class=o>=</span> <span class=nx>prepareMessagesForApi</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>messagesForLlm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>true</span><span class=p>,</span> <span class=c1>// applyEphemeralCacheControl
</span></span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ç»„è£…è¿‡ç¨‹éµå¾ªä¸¥æ ¼çš„ä¼˜å…ˆçº§é¡ºåºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>ä¼˜å…ˆçº§ 1: åŸºç¡€æŒ‡ä»¤ (~2KB)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>ä¼˜å…ˆçº§ 2: æ¨¡å‹ç‰¹å®šé€‚é… (~500B)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>ä¼˜å…ˆçº§ 3: CLAUDE.md å†…å®¹ (å¯å˜ï¼Œé€šå¸¸ 5-50KB)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>ä¼˜å…ˆçº§ 4: Git ä¸Šä¸‹æ–‡ (~1-5KB)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>ä¼˜å…ˆçº§ 5: ç›®å½•ç»“æ„ (æˆªæ–­ä»¥é€‚é…)
</span></span><span class=line><span class=cl>    â†“
</span></span><span class=line><span class=cl>ä¼˜å…ˆçº§ 6: å·¥å…·è§„æ ¼ (~10-20KB)
</span></span></code></pre></div><h3 id=é˜¶æ®µ-3llm-æµå¼ä¼ è¾“åˆå§‹åŒ–>é˜¶æ®µ 3ï¼šLLM æµå¼ä¼ è¾“åˆå§‹åŒ–<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µ-3llm-æµå¼ä¼ è¾“åˆå§‹åŒ–>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// åˆå§‹åŒ–æµå¼è°ƒç”¨
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>llmStream</span> <span class=o>=</span> <span class=nx>callLlmStreamApi</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>apiMessages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>systemPromptForLlm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolSpecificationsForLlm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolUseContext</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>mainLoopModel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolUseContext</span><span class=p>.</span><span class=nx>abortController</span><span class=p>.</span><span class=nx>signal</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// åˆå§‹åŒ–æµå¼å“åº”çš„ç´¯åŠ å™¨
</span></span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>accumulatedAssistantMessage</span>: <span class=kt>Partial</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;</span> <span class=o>&amp;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span>: <span class=kt>Partial</span><span class=p>&lt;</span><span class=nt>ApiMessage</span><span class=p>&gt;</span> <span class=o>&amp;</span> <span class=p>{</span> <span class=nx>content</span>: <span class=kt>ContentBlock</span><span class=p>[]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;assistant&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span><span class=o>:</span> <span class=sb>`assistant-</span><span class=si>${</span><span class=nx>loopState</span><span class=p>.</span><span class=nx>turnId</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nx>loopState</span><span class=p>.</span><span class=nx>turnCounter</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span>: <span class=kt>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=o>:</span> <span class=p>{</span> <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;assistant&#34;</span><span class=p>,</span> <span class=nx>content</span><span class=o>:</span> <span class=p>[]</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>currentToolUsesFromLlm</span>: <span class=kt>ToolUseBlock</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>currentThinkingContent</span>: <span class=kt>string</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>currentToolInputJsonBuffer</span>: <span class=kt>string</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=é˜¶æ®µ-4æµå¼äº‹ä»¶å¤„ç†çŠ¶æ€æœº>é˜¶æ®µ 4ï¼šæµå¼äº‹ä»¶å¤„ç†çŠ¶æ€æœº<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µ-4æµå¼äº‹ä»¶å¤„ç†çŠ¶æ€æœº>#</a></h3><p>è¿™æ˜¯é­”æ³•å‘ç”Ÿçš„åœ°æ–¹â€”â€”å®æ—¶å¤„ç†æµå¼äº‹ä»¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>streamEvent</span> <span class=k>of</span> <span class=nx>llmStream</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸­æ­¢æ£€æŸ¥
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>toolUseContext</span><span class=p>.</span><span class=nx>abortController</span><span class=p>.</span><span class=nx>signal</span><span class=p>.</span><span class=nx>aborted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>createSystemNotificationMessage</span><span class=p>(</span><span class=s2>&#34;LLM stream processing aborted by user.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>streamEvent</span><span class=p>.</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;message_start&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>streamEvent</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>model</span> <span class=o>=</span> <span class=nx>streamEvent</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>usage</span> <span class=o>=</span> <span class=nx>streamEvent</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>usage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_state_update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;assistant_responding&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>model</span>: <span class=kt>streamEvent.message.model</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;content_block_start&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>newBlockPlaceholder</span> <span class=o>=</span> <span class=p>{</span> <span class=p>...</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>content_block</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// æ ¹æ®å—ç±»å‹åˆå§‹åŒ–ç©ºå†…å®¹
</span></span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>content_block</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;thinking&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>currentThinkingContent</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>newBlockPlaceholder</span><span class=p>.</span><span class=nx>thinking</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>content_block</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>currentToolInputJsonBuffer</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>newBlockPlaceholder</span><span class=p>.</span><span class=nx>input</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>content_block</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;text&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>newBlockPlaceholder</span><span class=p>.</span><span class=nx>text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>newBlockPlaceholder</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;content_block_delta&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>lastBlockIndex</span> <span class=o>=</span> <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>lastBlockIndex</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>currentBlock</span> <span class=o>=</span> <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>[</span><span class=nx>lastBlockIndex</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;text_delta&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>currentBlock</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;text&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>currentBlock</span><span class=p>.</span><span class=nx>text</span> <span class=o>+=</span> <span class=nx>streamEvent</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_text_delta&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>textDelta</span>: <span class=kt>streamEvent.delta.text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>blockIndex</span>: <span class=kt>lastBlockIndex</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;input_json_delta&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>currentBlock</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>currentToolInputJsonBuffer</span> <span class=o>+=</span> <span class=nx>streamEvent</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=nx>partial_json</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>currentBlock</span><span class=p>.</span><span class=nx>input</span> <span class=o>=</span> <span class=nx>currentToolInputJsonBuffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1>// å°è¯•è§£æä¸å®Œæ•´çš„ JSON è¿›è¡Œé¢„è§ˆ
</span></span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>parseAttempt</span> <span class=o>=</span> <span class=nx>tryParsePartialJson</span><span class=p>(</span><span class=nx>currentToolInputJsonBuffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>parseAttempt</span><span class=p>.</span><span class=nx>complete</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_tool_preview&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>toolId</span>: <span class=kt>currentBlock.id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>preview</span>: <span class=kt>parseAttempt.value</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>};</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;content_block_stop&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>completedBlock</span> <span class=o>=</span> <span class=nx>accumulatedAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>[</span><span class=nx>streamEvent</span><span class=p>.</span><span class=nx>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>completedBlock</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>parsedInput</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>currentToolInputJsonBuffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>completedBlock</span><span class=p>.</span><span class=nx>input</span> <span class=o>=</span> <span class=nx>parsedInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>currentToolUsesFromLlm</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>id</span>: <span class=kt>completedBlock.id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>name</span>: <span class=kt>completedBlock.name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>input</span>: <span class=kt>parsedInput</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// å¤„ç†æ¥è‡ª LLM çš„æ ¼å¼é”™è¯¯çš„ JSON
</span></span></span><span class=line><span class=cl>            <span class=nx>completedBlock</span><span class=p>.</span><span class=nx>input</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>error</span><span class=o>:</span> <span class=s2>&#34;Invalid JSON input from LLM&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>raw_json_string</span>: <span class=kt>currentToolInputJsonBuffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>parse_error</span>: <span class=kt>e.message</span>
</span></span><span class=line><span class=cl>            <span class=p>};</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=nx>currentToolInputJsonBuffer</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_content_block_complete&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>block</span>: <span class=kt>completedBlock</span><span class=p>,</span> <span class=nx>blockIndex</span>: <span class=kt>streamEvent.index</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s2>&#34;message_stop&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// LLM ç”Ÿæˆå®Œæˆ
</span></span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>finalAssistantMessage</span> <span class=o>=</span> <span class=nx>finalizeCliMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>accumulatedAssistantMessage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>loopState</span><span class=p>.</span><span class=nx>turnId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>loopState</span><span class=p>.</span><span class=nx>turnCounter</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=nx>finalAssistantMessage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// ç§»åŠ¨åˆ°é˜¶æ®µ 5 æˆ– 6...
</span></span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>æµå¼å¤„ç†æ€§èƒ½</strong>ï¼š</p><ul><li>é¦–ä¸ª token å»¶è¿Ÿï¼š300-800msï¼ˆå› æ¨¡å‹è€Œå¼‚ï¼‰</li><li>Token ååé‡ï¼š50-100 tokens/ç§’</li><li>UI æ›´æ–°é¢‘ç‡ï¼šæ–‡æœ¬æ¯ä¸ª token æ›´æ–°ï¼Œå·¥å…·è¾“å…¥æ‰¹é‡æ›´æ–°</li><li>å†…å­˜ä½¿ç”¨ï¼šæ— è®ºå“åº”é•¿åº¦å¦‚ä½•ä¿æŒæ’å®š</li></ul><h3 id=é˜¶æ®µ-5å·¥å…·æ‰§è¡Œç¼–æ’>é˜¶æ®µ 5ï¼šå·¥å…·æ‰§è¡Œç¼–æ’<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µ-5å·¥å…·æ‰§è¡Œç¼–æ’>#</a></h3><p>å½“ LLM è¯·æ±‚ä½¿ç”¨å·¥å…·æ—¶ï¼Œæ¶æ„è½¬å…¥æ‰§è¡Œæ¨¡å¼ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>finalAssistantMessage</span><span class=p>.</span><span class=nx>message</span><span class=p>.</span><span class=nx>stop_reason</span> <span class=o>===</span> <span class=s2>&#34;tool_use&#34;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentToolUsesFromLlm</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=p>{</span> <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ui_state_update&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;executing_tools&#34;</span> <span class=p>}</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>toolResultMessages</span>: <span class=kt>CliMessage</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä½¿ç”¨æ™ºèƒ½æ‰¹å¤„ç†å¤„ç†å·¥å…·
</span></span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>toolOutcomeMessage</span> <span class=k>of</span> <span class=nx>processToolCallsInParallelBatches</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentToolUsesFromLlm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>finalAssistantMessage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>permissionGranterFn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolUseContext</span>
</span></span><span class=line><span class=cl>    <span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>toolOutcomeMessage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>toolOutcomeMessage</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s1>&#39;user&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>toolOutcomeMessage</span><span class=p>.</span><span class=nx>isMeta</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toolResultMessages</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>toolOutcomeMessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥å·¥å…·æ‰§è¡ŒæœŸé—´æ˜¯å¦ä¸­æ­¢
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>toolUseContext</span><span class=p>.</span><span class=nx>abortController</span><span class=p>.</span><span class=nx>signal</span><span class=p>.</span><span class=nx>aborted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>createSystemNotificationMessage</span><span class=p>(</span><span class=s2>&#34;Tool execution aborted by user.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¯¹ç»“æœæ’åºä»¥åŒ¹é… LLM çš„è¯·æ±‚é¡ºåº
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>sortedToolResultMessages</span> <span class=o>=</span> <span class=nx>sortToolResultsByOriginalRequestOrder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolResultMessages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentToolUsesFromLlm</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜¶æ®µ 6ï¼šä½¿ç”¨ç»“æœé€’å½’
</span></span></span><span class=line><span class=cl>    <span class=k>yield</span><span class=o>*</span> <span class=nx>tt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>[...</span><span class=nx>messagesForLlm</span><span class=p>,</span> <span class=nx>finalAssistantMessage</span><span class=p>,</span> <span class=p>...</span><span class=nx>sortedToolResultMessages</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>baseSystemPromptString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentGitContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentClaudeMdContents</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>permissionGranterFn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolUseContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=p>...</span><span class=nx>loopState</span><span class=p>,</span> <span class=nx>turnCounter</span>: <span class=kt>loopState.turnCounter</span> <span class=o>+</span> <span class=mi>1</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=é˜¶æ®µ-6é€’å½’æ§åˆ¶>é˜¶æ®µ 6ï¼šé€’å½’æ§åˆ¶<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µ-6é€’å½’æ§åˆ¶>#</a></h3><p><code>tt</code> å‡½æ•°æ˜¯å°¾é€’å½’çš„ï¼Œå…è®¸æ— é™çš„å¯¹è¯æ·±åº¦ï¼ˆå—å®‰å…¨æªæ–½é™åˆ¶ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// é€’å½’å®‰å…¨æªæ–½
</span></span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>loopState</span><span class=p>.</span><span class=nx>turnCounter</span> <span class=o>&gt;=</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=nx>createSystemMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Maximum conversation depth reached. Please start a new query.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// é€’å½’å‰çš„å†…å­˜å‹åŠ›æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>estimatedMemory</span> <span class=o>=</span> <span class=nx>estimateConversationMemory</span><span class=p>(</span><span class=nx>messagesForLlm</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>estimatedMemory</span> <span class=o>&gt;</span> <span class=nx>MEMORY_THRESHOLD</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ç»§ç»­å‰å¼ºåˆ¶å‹ç¼©
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>compacted</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>forceCompaction</span><span class=p>(</span><span class=nx>messagesForLlm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>messagesForLlm</span> <span class=o>=</span> <span class=nx>compacted</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=åˆ†å±‚æ¶æ„>åˆ†å±‚æ¶æ„<a hidden class=anchor aria-hidden=true href=#åˆ†å±‚æ¶æ„>#</a></h2><p>Claude Code å®ç°äº†ä¸€ä¸ªæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œå…¶ä¸­æ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼š</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TD
    subgraph &#34;å±‚ 1: ç”¨æˆ·ç•Œé¢&#34;
        React[React ç»„ä»¶]
        Ink[Ink æ¸²æŸ“å™¨]
        Yoga[Yoga å¸ƒå±€å¼•æ“]

        React --&gt; Ink
        Ink --&gt; Yoga
    end

    subgraph &#34;å±‚ 2: Agent æ ¸å¿ƒ&#34;
        TT[tt æ§åˆ¶å¾ªç¯]
        Context[ä¸Šä¸‹æ–‡ç»„è£…]
        Permission[æƒé™ç³»ç»Ÿ]
        State[ä¼šè¯çŠ¶æ€]

        TT --&gt; Context
        TT --&gt; Permission
        TT --&gt; State
    end

    subgraph &#34;å±‚ 3: LLM äº¤äº’&#34;
        Stream[æµå¤„ç†å™¨]
        Retry[é‡è¯•é€»è¾‘]
        Token[Token è®¡æ•°å™¨]

        Stream --&gt; Retry
        Stream --&gt; Token
    end

    subgraph &#34;å±‚ 4: å·¥å…·ç³»ç»Ÿ&#34;
        Executor[å·¥å…·æ‰§è¡Œå™¨]
        Validator[è¾“å…¥éªŒè¯å™¨]
        Sandbox[æ²™ç®±ç®¡ç†å™¨]

        Executor --&gt; Validator
        Executor --&gt; Sandbox
    end

    subgraph &#34;å±‚ 5: åŸºç¡€è®¾æ–½&#34;
        FS[æ–‡ä»¶ç³»ç»Ÿ]
        Process[è¿›ç¨‹ç®¡ç†å™¨]
        Network[ç½‘ç»œå®¢æˆ·ç«¯]
        Telemetry[é¥æµ‹]
    end

    React -.-&gt; TT
    TT -.-&gt; Stream
    TT -.-&gt; Executor
    Executor -.-&gt; FS
    Executor -.-&gt; Process
    Stream -.-&gt; Network
    TT -.-&gt; Telemetry
</code></pre><h3 id=å±‚é—´é€šä¿¡æ¨¡å¼>å±‚é—´é€šä¿¡æ¨¡å¼<a hidden class=anchor aria-hidden=true href=#å±‚é—´é€šä¿¡æ¨¡å¼>#</a></h3><p>å±‚ä¹‹é—´çš„é€šä¿¡éµå¾ªä¸¥æ ¼çš„æ¨¡å¼ï¼š</p><ol><li><strong>å‘ä¸‹é€šä¿¡</strong>ï¼šç›´æ¥å‡½æ•°è°ƒç”¨</li><li><strong>å‘ä¸Šé€šä¿¡</strong>ï¼šäº‹ä»¶å’Œå›è°ƒ</li><li><strong>è·¨å±‚é€šä¿¡</strong>ï¼šå…±äº«ä¸Šä¸‹æ–‡å¯¹è±¡</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// ç¤ºä¾‹ï¼šUI åˆ° Agent æ ¸å¿ƒé€šä¿¡
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>UIToAgentBridge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>handleUserInput</span><span class=p>(</span><span class=nx>input</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å‘ä¸‹ï¼šç›´æ¥è°ƒç”¨
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>action</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>pd</span><span class=p>(</span><span class=nx>input</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ®æ“ä½œç±»å‹å¤„ç†
</span></span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;normal_prompt&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¯åŠ¨æ–°çš„ tt å¾ªç¯è¿­ä»£
</span></span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>message</span> <span class=k>of</span> <span class=nx>tt</span><span class=p>(...))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// å‘ä¸Šï¼šäº§å‡ºäº‹ä»¶
</span></span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>uiRenderer</span><span class=p>.</span><span class=nx>handleMessage</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ç¤ºä¾‹ï¼šå·¥å…·é€šè¿‡è¿›åº¦å‘ UI é€šä¿¡
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ToolToUIBridge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=o>*</span><span class=nx>executeWithProgress</span><span class=p>(</span><span class=nx>tool</span>: <span class=kt>ToolDefinition</span><span class=p>,</span> <span class=nx>input</span>: <span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å·¥å…·äº§å‡ºè¿›åº¦
</span></span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>await</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>event</span> <span class=k>of</span> <span class=nx>tool</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>input</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>context</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s1>&#39;progress&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// è½¬æ¢ä¸º UI äº‹ä»¶
</span></span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;ui_progress&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>toolName</span>: <span class=kt>tool.name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>progress</span>: <span class=kt>event.data</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=äº‹ä»¶é©±åŠ¨ä¸æµå¼æ¶æ„>äº‹ä»¶é©±åŠ¨ä¸æµå¼æ¶æ„<a hidden class=anchor aria-hidden=true href=#äº‹ä»¶é©±åŠ¨ä¸æµå¼æ¶æ„>#</a></h2><p>æ•´ä¸ªç³»ç»Ÿå»ºç«‹åœ¨æµå¼åŸè¯­ä¹‹ä¸Šï¼š</p><h3 id=æµå¼åå‹ç®¡ç†>æµå¼åå‹ç®¡ç†<a hidden class=anchor aria-hidden=true href=#æµå¼åå‹ç®¡ç†>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>StreamBackpressureController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>queue</span>: <span class=kt>StreamEvent</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>processing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>pressure</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>high</span>: <span class=kt>1000</span><span class=p>,</span> <span class=c1>// å¼€å§‹ä¸¢å¼ƒéå…³é”®äº‹ä»¶
</span></span></span><span class=line><span class=cl>    <span class=nx>critical</span>: <span class=kt>5000</span><span class=p>,</span> <span class=c1>// é™¤é”™è¯¯å¤–ä¸¢å¼ƒæ‰€æœ‰å†…å®¹
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>handleEvent</span><span class=p>(</span><span class=nx>event</span>: <span class=kt>StreamEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åº”ç”¨åå‹ç­–ç•¥
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>critical</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// åªä¿ç•™å…³é”®äº‹ä»¶
</span></span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>queue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;error&#34;</span> <span class=o>||</span> <span class=nx>e</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;message_stop&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>pressure</span><span class=p>.</span><span class=nx>high</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ä¸¢å¼ƒæ–‡æœ¬å¢é‡ï¼Œä¿ç•™ç»“æ„
</span></span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>queue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nx>e</span><span class=p>.</span><span class=kr>type</span> <span class=o>!==</span> <span class=s2>&#34;content_block_delta&#34;</span> <span class=o>||</span> <span class=nx>e</span><span class=p>.</span><span class=nx>delta</span><span class=p>.</span><span class=kr>type</span> <span class=o>!==</span> <span class=s2>&#34;text_delta&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>processing</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>processQueue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>async</span> <span class=nx>processQueue() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>batch</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span> <span class=c1>// æ‰¹é‡å¤„ç†
</span></span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>processBatch</span><span class=p>(</span><span class=nx>batch</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// è®©å‡ºç»™äº‹ä»¶å¾ªç¯
</span></span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>setImmediate</span><span class=p>(</span><span class=nx>resolve</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=è¿›åº¦äº‹ä»¶èšåˆ>è¿›åº¦äº‹ä»¶èšåˆ<a hidden class=anchor aria-hidden=true href=#è¿›åº¦äº‹ä»¶èšåˆ>#</a></h3><p>å¤šä¸ªå¹¶å‘æ“ä½œéœ€è¦åè°ƒçš„è¿›åº¦æŠ¥å‘Šï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ProgressAggregator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>progressStreams</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>AsyncIterator</span><span class=p>&lt;</span><span class=nt>ProgressEvent</span><span class=p>&gt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=o>*</span><span class=nx>aggregateProgress</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>operations</span>: <span class=kt>Array</span><span class=o>&lt;</span><span class=p>{</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>;</span> <span class=nx>operation</span>: <span class=kt>AsyncIterator</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=p>}</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>AggregatedProgress</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¯åŠ¨æ‰€æœ‰æ“ä½œ
</span></span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>operation</span> <span class=p>}</span> <span class=k>of</span> <span class=nx>operations</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>progressStreams</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>operation</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è½®è¯¢æ‰€æœ‰æµ
</span></span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>progressStreams</span><span class=p>.</span><span class=nx>size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>promises</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>progressStreams</span><span class=p>.</span><span class=nx>entries</span><span class=p>()).</span><span class=nx>map</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kr>async</span> <span class=p>([</span><span class=nx>id</span><span class=p>,</span> <span class=nx>stream</span><span class=p>])</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=p>{</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>done</span> <span class=p>}</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>done</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// ç«äº‰ä¸‹ä¸€ä¸ªäº‹ä»¶
</span></span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>race</span><span class=p>(</span><span class=nx>promises</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>progressStreams</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;progress&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;aggregated_progress&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>source</span>: <span class=kt>result.id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>progress</span>: <span class=kt>result.value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=çŠ¶æ€ç®¡ç†æ¶æ„>çŠ¶æ€ç®¡ç†æ¶æ„<a hidden class=anchor aria-hidden=true href=#çŠ¶æ€ç®¡ç†æ¶æ„>#</a></h2><p>Claude Code ä½¿ç”¨å®ç”¨çš„çŠ¶æ€ç®¡ç†æ–¹æ³•ï¼š</p><h3 id=å…¨å±€ä¼šè¯çŠ¶æ€>å…¨å±€ä¼šè¯çŠ¶æ€<a hidden class=anchor aria-hidden=true href=#å…¨å±€ä¼šè¯çŠ¶æ€>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// å¸¦ç›´æ¥å˜æ›´çš„å•ä¾‹ä¼šè¯çŠ¶æ€
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>SessionState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>instance</span>: <span class=kt>SessionState</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ ¸å¿ƒçŠ¶æ€
</span></span></span><span class=line><span class=cl>  <span class=nx>sessionId</span>: <span class=kt>string</span> <span class=o>=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>randomUUID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>cwd</span>: <span class=kt>string</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>cwd</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>totalCostUSD</span>: <span class=kt>number</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>totalAPIDuration</span>: <span class=kt>number</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ¨¡å‹ä½¿ç”¨è¿½è¸ª
</span></span></span><span class=line><span class=cl>  <span class=nx>modelTokens</span>: <span class=kt>Record</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>inputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>outputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>cacheReadInputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>cacheCreationInputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>&gt;</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ç›´æ¥å˜æ›´æ–¹æ³•
</span></span></span><span class=line><span class=cl>  <span class=nx>incrementCost</span><span class=p>(</span><span class=nx>amount</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>totalCostUSD</span> <span class=o>+=</span> <span class=nx>amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>persistToDisk</span><span class=p>();</span> <span class=c1>// å¼‚æ­¥ï¼Œéé˜»å¡
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>updateTokenUsage</span><span class=p>(</span><span class=nx>model</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>usage</span>: <span class=kt>TokenUsage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>modelTokens</span><span class=p>[</span><span class=nx>model</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>modelTokens</span><span class=p>[</span><span class=nx>model</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>inputTokens</span>: <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>outputTokens</span>: <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>cacheReadInputTokens</span>: <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>cacheCreationInputTokens</span>: <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>tokens</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>modelTokens</span><span class=p>[</span><span class=nx>model</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokens</span><span class=p>.</span><span class=nx>inputTokens</span> <span class=o>+=</span> <span class=nx>usage</span><span class=p>.</span><span class=nx>input_tokens</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokens</span><span class=p>.</span><span class=nx>outputTokens</span> <span class=o>+=</span> <span class=nx>usage</span><span class=p>.</span><span class=nx>output_tokens</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokens</span><span class=p>.</span><span class=nx>cacheReadInputTokens</span> <span class=o>+=</span> <span class=nx>usage</span><span class=p>.</span><span class=nx>cache_read_input_tokens</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokens</span><span class=p>.</span><span class=nx>cacheCreationInputTokens</span> <span class=o>+=</span> <span class=nx>usage</span><span class=p>.</span><span class=nx>cache_creation_input_tokens</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>async</span> <span class=nx>persistToDisk() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é˜²æŠ–å†™å…¥ä»¥é¿å…è¿‡å¤š I/O
</span></span></span><span class=line><span class=cl>    <span class=nx>clearTimeout</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>persistTimer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>persistTimer</span> <span class=o>=</span> <span class=nx>setTimeout</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>writeFile</span><span class=p>(</span><span class=s2>&#34;.claude/session.json&#34;</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ä½¿ç”¨å¼±å¼•ç”¨çš„æ–‡ä»¶çŠ¶æ€>ä½¿ç”¨å¼±å¼•ç”¨çš„æ–‡ä»¶çŠ¶æ€<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨å¼±å¼•ç”¨çš„æ–‡ä»¶çŠ¶æ€>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ReadFileState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>WeakRef</span><span class=p>&lt;</span><span class=nt>FileContent</span><span class=p>&gt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>registry</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FinalizationRegistry</span><span class=p>((</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å½“ FileContent è¢«åƒåœ¾å›æ”¶æ—¶æ¸…ç†
</span></span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>set</span><span class=p>(</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>content</span>: <span class=kt>FileContent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ref</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakRef</span><span class=p>(</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>ref</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>registry</span><span class=p>.</span><span class=nx>register</span><span class=p>(</span><span class=nx>content</span><span class=p>,</span> <span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>get</span><span class=p>(</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>FileContent</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ref</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>ref</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>content</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>.</span><span class=nx>deref</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å†…å®¹å·²è¢«åƒåœ¾å›æ”¶
</span></span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>checkFreshness</span><span class=p>(</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=s2>&#34;fresh&#34;</span> <span class=o>|</span> <span class=s2>&#34;stale&#34;</span> <span class=o>|</span> <span class=s2>&#34;unknown&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cached</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>cached</span><span class=p>)</span> <span class=k>return</span> <span class=s2>&#34;unknown&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>stats</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>statSync</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>stats</span><span class=p>.</span><span class=nx>mtimeMs</span> <span class=o>!==</span> <span class=nx>cached</span><span class=p>.</span><span class=nx>timestamp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s2>&#34;stale&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;fresh&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=å®‰å…¨æ¶æ„>å®‰å…¨æ¶æ„<a hidden class=anchor aria-hidden=true href=#å®‰å…¨æ¶æ„>#</a></h2><p>å®‰å…¨æ€§é€šè¿‡å¤šä¸ªç‹¬ç«‹å±‚å®ç°ï¼š</p><h3 id=ç¬¬-1-å±‚æƒé™ç³»ç»Ÿ>ç¬¬ 1 å±‚ï¼šæƒé™ç³»ç»Ÿ<a hidden class=anchor aria-hidden=true href=#ç¬¬-1-å±‚æƒé™ç³»ç»Ÿ>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>PermissionEvaluator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>ruleCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>CompiledRule</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tool</span>: <span class=kt>ToolDefinition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolPermissionContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PermissionDecision</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¼˜å…ˆçº§é¡ºåºè¯„ä¼°
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>scopes</span>: <span class=kt>PermissionRuleScope</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;cliArg&#34;</span><span class=p>,</span> <span class=c1>// æœ€é«˜ï¼šå‘½ä»¤è¡Œ
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;localSettings&#34;</span><span class=p>,</span> <span class=c1>// é¡¹ç›®ç‰¹å®šè¦†ç›–
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;projectSettings&#34;</span><span class=p>,</span> <span class=c1>// å…±äº«é¡¹ç›®è§„åˆ™
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;policySettings&#34;</span><span class=p>,</span> <span class=c1>// ç»„ç»‡ç­–ç•¥
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;userSettings&#34;</span><span class=p>,</span> <span class=c1>// æœ€ä½ï¼šç”¨æˆ·åå¥½
</span></span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>scope</span> <span class=k>of</span> <span class=nx>scopes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>decision</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>evaluateScope</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>input</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>scope</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>decision</span><span class=p>.</span><span class=nx>behavior</span> <span class=o>!==</span> <span class=s2>&#34;continue&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>decision</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ— åŒ¹é…è§„åˆ™ - è¯¢é—®ç”¨æˆ·
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>behavior</span><span class=o>:</span> <span class=s2>&#34;ask&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>suggestions</span>: <span class=kt>this.generateSuggestions</span><span class=p>(</span><span class=nx>tool</span><span class=p>,</span> <span class=nx>input</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>compileRule</span><span class=p>(</span><span class=nx>rule</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>CompiledRule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>ruleCache</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>rule</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ruleCache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>rule</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è§£æè§„åˆ™è¯­æ³•ï¼šToolName(glob/pattern)
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>match</span> <span class=o>=</span> <span class=nx>rule</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=sr>/^(\w+)(?:\((.+)\))?$/</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>match</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`Invalid rule: </span><span class=si>${</span><span class=nx>rule</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[,</span> <span class=nx>toolPattern</span><span class=p>,</span> <span class=nx>pathPattern</span><span class=p>]</span> <span class=o>=</span> <span class=nx>match</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>compiled</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>toolMatcher</span>: <span class=kt>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=sb>`^</span><span class=si>${</span><span class=nx>toolPattern</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;*&#34;</span><span class=p>,</span> <span class=s2>&#34;.*&#34;</span><span class=p>)</span><span class=si>}</span><span class=sb>$`</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=nx>pathMatcher</span>: <span class=kt>pathPattern</span> <span class=o>?</span> <span class=nx>picomatch</span><span class=p>(</span><span class=nx>pathPattern</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ruleCache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>rule</span><span class=p>,</span> <span class=nx>compiled</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>compiled</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ç¬¬-2-å±‚æ²™ç®±æ¶æ„>ç¬¬ 2 å±‚ï¼šæ²™ç®±æ¶æ„<a hidden class=anchor aria-hidden=true href=#ç¬¬-2-å±‚æ²™ç®±æ¶æ„>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// macOS æ²™ç®±å®ç°
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MacOSSandboxManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>generateProfile</span><span class=p>(</span><span class=nx>command</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>restrictions</span>: <span class=kt>SandboxRestrictions</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>profile</span> <span class=o>=</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>(version 1)
</span></span></span><span class=line><span class=cl><span class=sb>(deny default)
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>; Base permissions
</span></span></span><span class=line><span class=cl><span class=sb>(allow process-exec (literal &#34;/bin/bash&#34;))
</span></span></span><span class=line><span class=cl><span class=sb>(allow process-exec (literal &#34;/usr/bin/env&#34;))
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>; File system access
</span></span></span><span class=line><span class=cl><span class=si>${</span><span class=nx>restrictions</span><span class=p>.</span><span class=nx>allowRead</span> <span class=o>?</span> <span class=s2>&#34;(allow file-read*)&#34;</span> <span class=o>:</span> <span class=s2>&#34;(deny file-read*)&#34;</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=si>${</span><span class=nx>restrictions</span><span class=p>.</span><span class=nx>allowWrite</span> <span class=o>?</span> <span class=s2>&#34;(allow file-write*)&#34;</span> <span class=o>:</span> <span class=s2>&#34;(deny file-write*)&#34;</span><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>; Network access
</span></span></span><span class=line><span class=cl><span class=si>${</span>
</span></span><span class=line><span class=cl>  <span class=nx>restrictions</span><span class=p>.</span><span class=nx>allowNetwork</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>(allow network-outbound)
</span></span></span><span class=line><span class=cl><span class=sb>(allow network-inbound)
</span></span></span><span class=line><span class=cl><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>(deny network*)
</span></span></span><span class=line><span class=cl><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=si>}</span><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>; System operations
</span></span></span><span class=line><span class=cl><span class=sb>(allow sysctl-read)
</span></span></span><span class=line><span class=cl><span class=sb>(allow mach-lookup)
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>; Temporary files
</span></span></span><span class=line><span class=cl><span class=sb>(allow file-write* (subpath &#34;/tmp&#34;))
</span></span></span><span class=line><span class=cl><span class=sb>(allow file-write* (subpath &#34;/var/tmp&#34;))
</span></span></span><span class=line><span class=cl><span class=sb>    `</span><span class=p>.</span><span class=nx>trim</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>profile</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>executeSandboxed</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>profile</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>ExecutionResult</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å°†é…ç½®æ–‡ä»¶å†™å…¥ä¸´æ—¶æ–‡ä»¶
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>profilePath</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>writeTemporaryProfile</span><span class=p>(</span><span class=nx>profile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ä½¿ç”¨ sandbox-exec æ‰§è¡Œ
</span></span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>exec</span><span class=p>(</span><span class=sb>`sandbox-exec -p &#39;</span><span class=si>${</span><span class=nx>profilePath</span><span class=si>}</span><span class=sb>&#39; </span><span class=si>${</span><span class=nx>command</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// æ¸…ç†
</span></span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>unlink</span><span class=p>(</span><span class=nx>profilePath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ç¬¬-3-å±‚è·¯å¾„éªŒè¯>ç¬¬ 3 å±‚ï¼šè·¯å¾„éªŒè¯<a hidden class=anchor aria-hidden=true href=#ç¬¬-3-å±‚è·¯å¾„éªŒè¯>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>PathValidator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>boundaries</span>: <span class=kt>Set</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>deniedPatterns</span>: <span class=kt>RegExp</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>context</span>: <span class=kt>SecurityContext</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>boundaries</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>([</span>
</span></span><span class=line><span class=cl>      <span class=nx>context</span><span class=p>.</span><span class=nx>projectRoot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>context</span><span class=p>.</span><span class=nx>additionalWorkingDirectories</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>deniedPatterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=sr>/\/\.(ssh|gnupg)\//</span><span class=p>,</span> <span class=c1>// SSH/GPG å¯†é’¥
</span></span></span><span class=line><span class=cl>      <span class=sr>/\/(etc|sys|proc)\//</span><span class=p>,</span> <span class=c1>// ç³»ç»Ÿç›®å½•
</span></span></span><span class=line><span class=cl>      <span class=sr>/\.pem$|\.key$/</span><span class=p>,</span> <span class=c1>// ç§é’¥
</span></span></span><span class=line><span class=cl>      <span class=sr>/\.(env|envrc)$/</span><span class=p>,</span> <span class=c1>// ç¯å¢ƒæ–‡ä»¶
</span></span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>validate</span><span class=p>(</span><span class=nx>requestedPath</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>ValidationResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>absolute</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>requestedPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥è¾¹ç•Œ
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>inBoundary</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>boundaries</span><span class=p>).</span><span class=nx>some</span><span class=p>((</span><span class=nx>boundary</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>absolute</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=nx>boundary</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>inBoundary</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowed</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>reason</span><span class=o>:</span> <span class=s2>&#34;Path outside allowed directories&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥æ‹’ç»æ¨¡å¼
</span></span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>pattern</span> <span class=k>of</span> <span class=k>this</span><span class=p>.</span><span class=nx>deniedPatterns</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>pattern</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>absolute</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>allowed</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>reason</span><span class=o>:</span> <span class=sb>`Path matches denied pattern: </span><span class=si>${</span><span class=nx>pattern</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>allowed</span>: <span class=kt>true</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=æ€§èƒ½æ¶æ„>æ€§èƒ½æ¶æ„<a hidden class=anchor aria-hidden=true href=#æ€§èƒ½æ¶æ„>#</a></h2><h3 id=anråº”ç”¨ç¨‹åºæ— å“åº”æ£€æµ‹>ANRï¼ˆåº”ç”¨ç¨‹åºæ— å“åº”ï¼‰æ£€æµ‹<a hidden class=anchor aria-hidden=true href=#anråº”ç”¨ç¨‹åºæ— å“åº”æ£€æµ‹>#</a></h3><p>ANR ç³»ç»Ÿä½¿ç”¨å·¥ä½œçº¿ç¨‹æ¥ç›‘æ§ä¸»äº‹ä»¶å¾ªç¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// å·¥ä½œçº¿ç¨‹è„šæœ¬ï¼ˆåµŒå…¥ä¸º base64ï¼‰
</span></span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>anrWorkerScript</span> <span class=o>=</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>const { parentPort } = require(&#39;worker_threads&#39;);
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>let config = { anrThreshold: 5000, captureStackTrace: false };
</span></span></span><span class=line><span class=cl><span class=sb>let lastPing = Date.now();
</span></span></span><span class=line><span class=cl><span class=sb>let anrTimer = null;
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>function checkANR() {
</span></span></span><span class=line><span class=cl><span class=sb>  const elapsed = Date.now() - lastPing;
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  if (elapsed &gt; config.anrThreshold) {
</span></span></span><span class=line><span class=cl><span class=sb>    // ä¸»çº¿ç¨‹æ— å“åº”
</span></span></span><span class=line><span class=cl><span class=sb>    parentPort.postMessage({
</span></span></span><span class=line><span class=cl><span class=sb>      type: &#39;anr&#39;,
</span></span></span><span class=line><span class=cl><span class=sb>      payload: {
</span></span></span><span class=line><span class=cl><span class=sb>        elapsed,
</span></span></span><span class=line><span class=cl><span class=sb>        stackTrace: config.captureStackTrace
</span></span></span><span class=line><span class=cl><span class=sb>          ? captureMainThreadStack()
</span></span></span><span class=line><span class=cl><span class=sb>          : null
</span></span></span><span class=line><span class=cl><span class=sb>      }
</span></span></span><span class=line><span class=cl><span class=sb>    });
</span></span></span><span class=line><span class=cl><span class=sb>  }
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>  // å®‰æ’ä¸‹æ¬¡æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=sb>  anrTimer = setTimeout(checkANR, 100);
</span></span></span><span class=line><span class=cl><span class=sb>}
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>async function captureMainThreadStack() {
</span></span></span><span class=line><span class=cl><span class=sb>  // å¦‚æœå¯ç”¨ï¼Œä½¿ç”¨æ£€æŸ¥å™¨åè®®
</span></span></span><span class=line><span class=cl><span class=sb>  try {
</span></span></span><span class=line><span class=cl><span class=sb>    const { Session } = require(&#39;inspector&#39;);
</span></span></span><span class=line><span class=cl><span class=sb>    const session = new Session();
</span></span></span><span class=line><span class=cl><span class=sb>    session.connect();
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>    const { result } = await session.post(&#39;Debugger.enable&#39;);
</span></span></span><span class=line><span class=cl><span class=sb>    const stack = await session.post(&#39;Debugger.getStackTrace&#39;);
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>    session.disconnect();
</span></span></span><span class=line><span class=cl><span class=sb>    return stack;
</span></span></span><span class=line><span class=cl><span class=sb>  } catch (e) {
</span></span></span><span class=line><span class=cl><span class=sb>    return null;
</span></span></span><span class=line><span class=cl><span class=sb>  }
</span></span></span><span class=line><span class=cl><span class=sb>}
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>parentPort.on(&#39;message&#39;, (msg) =&gt; {
</span></span></span><span class=line><span class=cl><span class=sb>  if (msg.type === &#39;config&#39;) {
</span></span></span><span class=line><span class=cl><span class=sb>    config = msg.payload;
</span></span></span><span class=line><span class=cl><span class=sb>    lastPing = Date.now();
</span></span></span><span class=line><span class=cl><span class=sb>    checkANR(); // å¼€å§‹ç›‘æ§
</span></span></span><span class=line><span class=cl><span class=sb>  } else if (msg.type === &#39;ping&#39;) {
</span></span></span><span class=line><span class=cl><span class=sb>    lastPing = Date.now();
</span></span></span><span class=line><span class=cl><span class=sb>  }
</span></span></span><span class=line><span class=cl><span class=sb>});
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ä¸»çº¿ç¨‹ ANR é›†æˆ
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ANRMonitor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>worker</span>: <span class=kt>Worker</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>pingInterval</span>: <span class=kt>NodeJS.Timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>options</span>: <span class=kt>ANROptions</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä»åµŒå…¥è„šæœ¬åˆ›å»ºå·¥ä½œçº¿ç¨‹
</span></span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=nx>anrWorkerScript</span><span class=p>,</span> <span class=p>{</span> <span class=nb>eval</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// é…ç½®å·¥ä½œçº¿ç¨‹
</span></span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;config&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>payload</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>anrThreshold</span>: <span class=kt>options.threshold</span> <span class=o>||</span> <span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>captureStackTrace</span>: <span class=kt>options.captureStackTrace</span> <span class=o>!==</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¯åŠ¨å¿ƒè·³
</span></span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pingInterval</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span> <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;ping&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>options</span><span class=p>.</span><span class=nx>pollInterval</span> <span class=o>||</span> <span class=mi>50</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å¤„ç† ANR æ£€æµ‹
</span></span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>worker</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>msg</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;anr&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>handleANR</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>handleANR</span><span class=p>(</span><span class=nx>data</span>: <span class=kt>ANRData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è®°å½•åˆ°é¥æµ‹
</span></span></span><span class=line><span class=cl>    <span class=nx>Sentry</span><span class=p>.</span><span class=nx>captureException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`Application not responding for </span><span class=si>${</span><span class=nx>data</span><span class=p>.</span><span class=nx>elapsed</span><span class=si>}</span><span class=sb>ms`</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>extra</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>stackTrace</span>: <span class=kt>data.stackTrace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>eventLoopDelay</span>: <span class=kt>this.getEventLoopDelay</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=æˆ˜ç•¥ç¼“å­˜å±‚>æˆ˜ç•¥ç¼“å­˜å±‚<a hidden class=anchor aria-hidden=true href=#æˆ˜ç•¥ç¼“å­˜å±‚>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>CacheArchitecture</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// L1: å†…å­˜ç¼“å­˜
</span></span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>schemaCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>LRUCache</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>JSONSchema</span><span class=p>&gt;(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>patternCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>LRUCache</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>CompiledPattern</span><span class=p>&gt;(</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>gitContextCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TTLCache</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>GitContext</span><span class=p>&gt;(</span><span class=mi>30</span><span class=nx>_000</span><span class=p>);</span> <span class=c1>// 30s TTL
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// L2: å¼±å¼•ç”¨ç¼“å­˜
</span></span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>fileContentCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakRefCache</span><span class=p>&lt;</span><span class=nt>FileContent</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// L3: ç£ç›˜ç¼“å­˜
</span></span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>diskCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DiskCache</span><span class=p>(</span><span class=s2>&#34;.claude/cache&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=kr>get</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>generator</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span>: <span class=kt>CacheOptions</span> <span class=o>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥ L1
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>schemaCache</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>schemaCache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=kr>as</span> <span class=nx>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥ L2
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>weakRef</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>fileContentCache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>weakRef</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>weakRef</span> <span class=kr>as</span> <span class=nx>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥ L3
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>persistent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>diskValue</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>diskCache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>diskValue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>diskValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç”Ÿæˆå¹¶ç¼“å­˜
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>generator</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// å­˜å‚¨åœ¨é€‚å½“çš„ç¼“å­˜ä¸­
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>weak</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>fileContentCache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>persistent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>diskCache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>options</span><span class=p>.</span><span class=nx>ttl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>schemaCache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=é¥æµ‹ä¸å¯è§‚æµ‹æ€§è®¾è®¡>é¥æµ‹ä¸å¯è§‚æµ‹æ€§è®¾è®¡<a hidden class=anchor aria-hidden=true href=#é¥æµ‹ä¸å¯è§‚æµ‹æ€§è®¾è®¡>#</a></h2><p>ä¸‰æ”¯æŸ±æ–¹æ³•æä¾›å…¨é¢çš„å¯è§æ€§ï¼š</p><h3 id=æ”¯æŸ±-1é”™è¯¯è¿½è¸ªsentry>æ”¯æŸ± 1ï¼šé”™è¯¯è¿½è¸ªï¼ˆSentryï¼‰<a hidden class=anchor aria-hidden=true href=#æ”¯æŸ±-1é”™è¯¯è¿½è¸ªsentry>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ErrorBoundary</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>wrap</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=err>(</span><span class=na>...args</span><span class=err>:</span> <span class=na>any</span><span class=err>[])</span> <span class=err>=</span><span class=p>&gt;</span> <span class=kt>any</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>fn</span>: <span class=kt>T</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ErrorContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=kr>async</span> <span class=p>(...</span><span class=nx>args</span>: <span class=kt>Parameters</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>Sentry</span><span class=p>.</span><span class=nx>startTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span>: <span class=kt>context.operation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>op</span>: <span class=kt>context.category</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fn</span><span class=p>(...</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setStatus</span><span class=p>(</span><span class=s1>&#39;ok&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setStatus</span><span class=p>(</span><span class=s1>&#39;internal_error&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>Sentry</span><span class=p>.</span><span class=nx>captureException</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>contexts</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>operation</span>: <span class=kt>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>state</span>: <span class=kt>this.captureState</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>fingerprint</span>: <span class=kt>this.generateFingerprint</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>finish</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span> <span class=kr>as</span> <span class=nx>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>captureState() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>sessionId</span>: <span class=kt>SessionState.instance.sessionId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>conversationDepth</span><span class=o>:</span> <span class=cm>/* current depth */</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>activeTools</span><span class=o>:</span> <span class=cm>/* currently executing */</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>memoryUsage</span>: <span class=kt>process.memoryUsage</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=nx>eventLoopDelay</span>: <span class=kt>this.getEventLoopDelay</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=æ”¯æŸ±-2æŒ‡æ ‡opentelemetry>æ”¯æŸ± 2ï¼šæŒ‡æ ‡ï¼ˆOpenTelemetryï¼‰<a hidden class=anchor aria-hidden=true href=#æ”¯æŸ±-2æŒ‡æ ‡opentelemetry>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MetricsCollector</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>meters</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>api</span>: <span class=kt>meter.createCounter</span><span class=p>(</span><span class=s1>&#39;api_calls_total&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokens</span>: <span class=kt>meter.createHistogram</span><span class=p>(</span><span class=s1>&#39;token_usage&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>tools</span>: <span class=kt>meter.createHistogram</span><span class=p>(</span><span class=s1>&#39;tool_execution_duration&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>streaming</span>: <span class=kt>meter.createHistogram</span><span class=p>(</span><span class=s1>&#39;streaming_latency&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>recordApiCall</span><span class=p>(</span><span class=nx>result</span>: <span class=kt>ApiCallResult</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>meters</span><span class=p>.</span><span class=nx>api</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span>: <span class=kt>result.model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>status</span>: <span class=kt>result.status</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>provider</span>: <span class=kt>result.provider</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>meters</span><span class=p>.</span><span class=nx>tokens</span><span class=p>.</span><span class=nx>record</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>totalTokens</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span>: <span class=kt>result.model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;total&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>recordToolExecution</span><span class=p>(</span><span class=nx>tool</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>duration</span>: <span class=kt>number</span><span class=p>,</span> <span class=nx>success</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>meters</span><span class=p>.</span><span class=nx>tools</span><span class=p>.</span><span class=nx>record</span><span class=p>(</span><span class=nx>duration</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>success</span>: <span class=kt>String</span><span class=p>(</span><span class=nx>success</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=nx>concurrent</span><span class=o>:</span> <span class=cm>/* was parallel? */</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=æ”¯æŸ±-3åŠŸèƒ½æ ‡å¿—statsig>æ”¯æŸ± 3ï¼šåŠŸèƒ½æ ‡å¿—ï¼ˆStatsigï¼‰<a hidden class=anchor aria-hidden=true href=#æ”¯æŸ±-3åŠŸèƒ½æ ‡å¿—statsig>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>FeatureManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>checkGate</span><span class=p>(</span><span class=nx>gate</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>context?</span>: <span class=kt>FeatureContext</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>statsig</span><span class=p>.</span><span class=nx>checkGate</span><span class=p>(</span><span class=nx>gate</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userID</span>: <span class=kt>SessionState.instance.sessionId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>custom</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>model</span>: <span class=kt>context?.model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>toolsEnabled</span>: <span class=kt>context?.tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>platform</span>: <span class=kt>process.platform</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getConfig</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span><span class=nx>config</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>defaultValue</span>: <span class=kt>T</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>dynamicConfig</span> <span class=o>=</span> <span class=nx>statsig</span><span class=p>.</span><span class=nx>getConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>dynamicConfig</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s2>&#34;value&#34;</span><span class=p>,</span> <span class=nx>defaultValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=èµ„æºç®¡ç†>èµ„æºç®¡ç†<a hidden class=anchor aria-hidden=true href=#èµ„æºç®¡ç†>#</a></h2><h3 id=è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†>è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†<a hidden class=anchor aria-hidden=true href=#è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ProcessManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>processes</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>ChildProcess</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>limits</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>maxProcesses</span>: <span class=kt>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>maxMemoryPerProcess</span>: <span class=kt>512</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>,</span> <span class=c1>// 512MB
</span></span></span><span class=line><span class=cl>    <span class=nx>maxTotalMemory</span>: <span class=kt>2</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>,</span> <span class=c1>// 2GB
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>spawn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span>: <span class=kt>SpawnOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>ManagedProcess</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥é™åˆ¶
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>processes</span><span class=p>.</span><span class=nx>size</span> <span class=o>&gt;=</span> <span class=k>this</span><span class=p>.</span><span class=nx>limits</span><span class=p>.</span><span class=nx>maxProcesses</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>killOldestProcess</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=nx>spawn</span><span class=p>(</span><span class=s2>&#34;bash&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=nx>command</span><span class=p>],</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// èµ„æºé™åˆ¶
</span></span></span><span class=line><span class=cl>      <span class=nx>env</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>options</span><span class=p>.</span><span class=nx>env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>NODE_OPTIONS</span><span class=o>:</span> <span class=sb>`--max-old-space-size=</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>limits</span><span class=p>.</span><span class=nx>maxMemoryPerProcess</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç›‘æ§èµ„æº
</span></span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>monitor</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>checkProcessHealth</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>child</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>processes</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>child</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>ManagedProcess</span><span class=p>(</span><span class=nx>child</span><span class=p>,</span> <span class=nx>monitor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>async</span> <span class=nx>checkProcessHealth</span><span class=p>(</span><span class=nx>id</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>proc</span>: <span class=kt>ChildProcess</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>usage</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>pidusage</span><span class=p>(</span><span class=nx>proc</span><span class=p>.</span><span class=nx>pid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>usage</span><span class=p>.</span><span class=nx>memory</span> <span class=o>&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>limits</span><span class=p>.</span><span class=nx>maxMemoryPerProcess</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`Process </span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb> exceeding memory limit`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>proc</span><span class=p>.</span><span class=nx>kill</span><span class=p>(</span><span class=s2>&#34;SIGTERM&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// è¿›ç¨‹å¯èƒ½å·²é€€å‡º
</span></span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>processes</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ç½‘ç»œè¿æ¥æ± >ç½‘ç»œè¿æ¥æ± <a hidden class=anchor aria-hidden=true href=#ç½‘ç»œè¿æ¥æ± >#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>NetworkPool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>pools</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>ConnectionPool</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>getPool</span><span class=p>(</span><span class=nx>provider</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>ConnectionPool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>pools</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>provider</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>pools</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>provider</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>ConnectionPool</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>maxConnections</span>: <span class=kt>provider</span> <span class=o>===</span> <span class=s2>&#34;anthropic&#34;</span> <span class=o>?</span> <span class=nx>10</span> : <span class=kt>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>maxIdleTime</span>: <span class=kt>30_000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>keepAlive</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>pools</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>provider</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>request</span><span class=p>(</span><span class=nx>provider</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>options</span>: <span class=kt>RequestOptions</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Response</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>pool</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getPool</span><span class=p>(</span><span class=nx>provider</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>connection</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>pool</span><span class=p>.</span><span class=nx>acquire</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>await</span> <span class=nx>connection</span><span class=p>.</span><span class=nx>request</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pool</span><span class=p>.</span><span class=nx>release</span><span class=p>(</span><span class=nx>connection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><p><em>æ­¤æ¶æ„åˆ†æåŸºäºé€†å‘å·¥ç¨‹å’Œåç¼–è¯‘ã€‚å®é™…å®ç°å¯èƒ½æœ‰æ‰€ä¸åŒã€‚æ‰€å‘ˆç°çš„æ¨¡å¼ä»£è¡¨åŸºäºå¯è§‚å¯Ÿè¡Œä¸ºå’Œé«˜æ€§èƒ½ Node.js åº”ç”¨ç¨‹åºå¸¸è§å®è·µæ¨æ–­çš„æ¶æ„å†³ç­–ã€‚</em></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://starslayerx.github.io/tags/agent/>Agent</a></li></ul><nav class=paginav><a class=prev href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-06%E6%96%B0%E9%A2%96%E7%BB%84%E4%BB%B6/><span class=title>Â« Prev</span><br><span>Claude Code åˆ†æ 06ï¼šæ–°é¢–ç»„ä»¶</span>
</a><a class=next href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-04%E5%B7%A5%E5%85%B7%E4%B8%8E%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/><span class=title>Next Â»</span><br><span>Claude Code åˆ†æ 04ï¼šå·¥å…·ä¸æ‰§è¡Œå¼•æ“</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on x" href="https://x.com/intent/tweet/?text=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f&amp;hashtags=Agent"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f&amp;title=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84&amp;summary=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84&amp;source=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f&title=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on whatsapp" href="https://api.whatsapp.com/send?text=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84%20-%20https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on telegram" href="https://telegram.me/share/url?text=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 05ï¼šæ¶æ„ on ycombinator" href="https://news.ycombinator.com/submitlink?t=Claude%20Code%20%e5%88%86%e6%9e%90%2005%ef%bc%9a%e6%9e%b6%e6%9e%84&u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-05%25E6%259E%25B6%25E6%259E%2584%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://starslayerx.github.io/>Starslayerx' Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>