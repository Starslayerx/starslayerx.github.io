<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Complete Python Logging Guide | Starslayerx' Blog</title><meta name=keywords content="Python"><meta name=description content='Python logging 基础指南
实际项目中，print() 只能满足基本的输出要求，而 logging 模块提供了更灵活、分级别、可配置的日志系统。
核心概念


Logger 记录器
记录器是拿来写日志的东西
logger = logging.getLogger(__name__)
logger.info("开始执行任务")
接收日志消息，按级别判断是否要输出，并交给 Handler


Handler 处理器
决定日志“去哪里”，有下面常见 Handler

StreamHandler: 输出到控制台
FileHandler: 写入文件
RotatingFileHandler: 自动滚动文件
SMTHandler: 发邮件
SocketHandler: 发送到日志服务器

一个 Logger 可以挂多个 Handler


Formatter 格式器
负责日志的格式
&#39;%(asctime)s - %(levelname)s - %(name)s - %(message)s&#39;
所有 Handler 都可以设置自己的 Formatter，不同输出渠道可以呈现不同格式


LogRecord 日志记录对象
每次调用 logging.info("hello") 内部都会生成一个 LogRecord 对象
LogRecord 是日志系统的“消息载体”，包括全部的元数据，例如：

时间戳
模块名
文件名、行号
日志级别
写入消息 message
线程 ID、进程 ID



Filter 过滤器
Filter 是更细粒度的筛选工具，可以控制某个模块的日志，阻止某些关键字，基于上下文附加标签等。


简单使用
import logging

logging.basicConfig(
  # 输出 INFO 及以上几倍日志
  level=logging.INFO,
  # 时间 - 模块名 - 级别 - 消息内容
  format=&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;
)

logging.info("程序已启动")
logging.warning("磁盘空间将不足")
logging.error("读取文件失败")
使用 Logger 对象：在较大的项目中，不会使用基础配置，而是为每个模块创建自己的 logger'><meta name=author content="Starslayerx"><link rel=canonical href=https://starslayerx.github.io/posts/complete-python-logging-guide/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://starslayerx.github.io/favicon.svg><link rel=apple-touch-icon href=https://starslayerx.github.io/favicon.svg><link rel=mask-icon href=https://starslayerx.github.io/favicon.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://starslayerx.github.io/posts/complete-python-logging-guide/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://starslayerx.github.io/posts/complete-python-logging-guide/"><meta property="og:site_name" content="Starslayerx' Blog"><meta property="og:title" content="Complete Python Logging Guide"><meta property="og:description" content='Python logging 基础指南 实际项目中，print() 只能满足基本的输出要求，而 logging 模块提供了更灵活、分级别、可配置的日志系统。
核心概念 Logger 记录器
记录器是拿来写日志的东西
logger = logging.getLogger(__name__) logger.info("开始执行任务") 接收日志消息，按级别判断是否要输出，并交给 Handler
Handler 处理器
决定日志“去哪里”，有下面常见 Handler
StreamHandler: 输出到控制台 FileHandler: 写入文件 RotatingFileHandler: 自动滚动文件 SMTHandler: 发邮件 SocketHandler: 发送到日志服务器 一个 Logger 可以挂多个 Handler
Formatter 格式器
负责日志的格式
&#39;%(asctime)s - %(levelname)s - %(name)s - %(message)s&#39; 所有 Handler 都可以设置自己的 Formatter，不同输出渠道可以呈现不同格式
LogRecord 日志记录对象
每次调用 logging.info("hello") 内部都会生成一个 LogRecord 对象
LogRecord 是日志系统的“消息载体”，包括全部的元数据，例如：
时间戳 模块名 文件名、行号 日志级别 写入消息 message 线程 ID、进程 ID Filter 过滤器
Filter 是更细粒度的筛选工具，可以控制某个模块的日志，阻止某些关键字，基于上下文附加标签等。
简单使用 import logging logging.basicConfig( # 输出 INFO 及以上几倍日志 level=logging.INFO, # 时间 - 模块名 - 级别 - 消息内容 format=&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39; ) logging.info("程序已启动") logging.warning("磁盘空间将不足") logging.error("读取文件失败") 使用 Logger 对象：在较大的项目中，不会使用基础配置，而是为每个模块创建自己的 logger'><meta property="og:locale" content="en-US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-11T08:00:00+01:00"><meta property="article:modified_time" content="2025-11-11T08:00:00+01:00"><meta property="article:tag" content="Python"><meta property="og:image" content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:title content="Complete Python Logging Guide"><meta name=twitter:description content='Python logging 基础指南
实际项目中，print() 只能满足基本的输出要求，而 logging 模块提供了更灵活、分级别、可配置的日志系统。
核心概念


Logger 记录器
记录器是拿来写日志的东西
logger = logging.getLogger(__name__)
logger.info("开始执行任务")
接收日志消息，按级别判断是否要输出，并交给 Handler


Handler 处理器
决定日志“去哪里”，有下面常见 Handler

StreamHandler: 输出到控制台
FileHandler: 写入文件
RotatingFileHandler: 自动滚动文件
SMTHandler: 发邮件
SocketHandler: 发送到日志服务器

一个 Logger 可以挂多个 Handler


Formatter 格式器
负责日志的格式
&#39;%(asctime)s - %(levelname)s - %(name)s - %(message)s&#39;
所有 Handler 都可以设置自己的 Formatter，不同输出渠道可以呈现不同格式


LogRecord 日志记录对象
每次调用 logging.info("hello") 内部都会生成一个 LogRecord 对象
LogRecord 是日志系统的“消息载体”，包括全部的元数据，例如：

时间戳
模块名
文件名、行号
日志级别
写入消息 message
线程 ID、进程 ID



Filter 过滤器
Filter 是更细粒度的筛选工具，可以控制某个模块的日志，阻止某些关键字，基于上下文附加标签等。


简单使用
import logging

logging.basicConfig(
  # 输出 INFO 及以上几倍日志
  level=logging.INFO,
  # 时间 - 模块名 - 级别 - 消息内容
  format=&#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#39;
)

logging.info("程序已启动")
logging.warning("磁盘空间将不足")
logging.error("读取文件失败")
使用 Logger 对象：在较大的项目中，不会使用基础配置，而是为每个模块创建自己的 logger'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://starslayerx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Complete Python Logging Guide","item":"https://starslayerx.github.io/posts/complete-python-logging-guide/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Complete Python Logging Guide","name":"Complete Python Logging Guide","description":"Python logging 基础指南 实际项目中，print() 只能满足基本的输出要求，而 logging 模块提供了更灵活、分级别、可配置的日志系统。\n核心概念 Logger 记录器\n记录器是拿来写日志的东西\nlogger = logging.getLogger(__name__) logger.info(\u0026#34;开始执行任务\u0026#34;) 接收日志消息，按级别判断是否要输出，并交给 Handler\nHandler 处理器\n决定日志“去哪里”，有下面常见 Handler\nStreamHandler: 输出到控制台 FileHandler: 写入文件 RotatingFileHandler: 自动滚动文件 SMTHandler: 发邮件 SocketHandler: 发送到日志服务器 一个 Logger 可以挂多个 Handler\nFormatter 格式器\n负责日志的格式\n\u0026#39;%(asctime)s - %(levelname)s - %(name)s - %(message)s\u0026#39; 所有 Handler 都可以设置自己的 Formatter，不同输出渠道可以呈现不同格式\nLogRecord 日志记录对象\n每次调用 logging.info(\u0026quot;hello\u0026quot;) 内部都会生成一个 LogRecord 对象\nLogRecord 是日志系统的“消息载体”，包括全部的元数据，例如：\n时间戳 模块名 文件名、行号 日志级别 写入消息 message 线程 ID、进程 ID Filter 过滤器\nFilter 是更细粒度的筛选工具，可以控制某个模块的日志，阻止某些关键字，基于上下文附加标签等。\n简单使用 import logging logging.basicConfig( # 输出 INFO 及以上几倍日志 level=logging.INFO, # 时间 - 模块名 - 级别 - 消息内容 format=\u0026#39;%(asctime)s - %(name)s - %(levelname)s - %(message)s\u0026#39; ) logging.info(\u0026#34;程序已启动\u0026#34;) logging.warning(\u0026#34;磁盘空间将不足\u0026#34;) logging.error(\u0026#34;读取文件失败\u0026#34;) 使用 Logger 对象：在较大的项目中，不会使用基础配置，而是为每个模块创建自己的 logger\n","keywords":["Python"],"articleBody":"Python logging 基础指南 实际项目中，print() 只能满足基本的输出要求，而 logging 模块提供了更灵活、分级别、可配置的日志系统。\n核心概念 Logger 记录器\n记录器是拿来写日志的东西\nlogger = logging.getLogger(__name__) logger.info(\"开始执行任务\") 接收日志消息，按级别判断是否要输出，并交给 Handler\nHandler 处理器\n决定日志“去哪里”，有下面常见 Handler\nStreamHandler: 输出到控制台 FileHandler: 写入文件 RotatingFileHandler: 自动滚动文件 SMTHandler: 发邮件 SocketHandler: 发送到日志服务器 一个 Logger 可以挂多个 Handler\nFormatter 格式器\n负责日志的格式\n'%(asctime)s - %(levelname)s - %(name)s - %(message)s' 所有 Handler 都可以设置自己的 Formatter，不同输出渠道可以呈现不同格式\nLogRecord 日志记录对象\n每次调用 logging.info(\"hello\") 内部都会生成一个 LogRecord 对象\nLogRecord 是日志系统的“消息载体”，包括全部的元数据，例如：\n时间戳 模块名 文件名、行号 日志级别 写入消息 message 线程 ID、进程 ID Filter 过滤器\nFilter 是更细粒度的筛选工具，可以控制某个模块的日志，阻止某些关键字，基于上下文附加标签等。\n简单使用 import logging logging.basicConfig( # 输出 INFO 及以上几倍日志 level=logging.INFO, # 时间 - 模块名 - 级别 - 消息内容 format='%(asctime)s - %(name)s - %(levelname)s - %(message)s' ) logging.info(\"程序已启动\") logging.warning(\"磁盘空间将不足\") logging.error(\"读取文件失败\") 使用 Logger 对象：在较大的项目中，不会使用基础配置，而是为每个模块创建自己的 logger\nimport logging # __name__ 会使日志自动显示当前模块名称，便于定位来源 logger = logging.getLogger(__name__) logger.debug(\"调试信息\") logger.info(\"开始处理任务\") logger.error(\"发生错误\") 写入日志文件 将日志输出到文件，只需要在 basicConfig 中设置 filename\nimport logging logging.basicConfig( level=logging.INFO, filename='app.log', filemode='a', # 写入模式, a 为追加 format='%(asctime)s - %(levelname)s - %(message)s' ) logging.info(\"日志将写入文件\") 同时输出到控制台和文件\nimport logging logger = logging.getLogger(\"app\") logger.setLevel(logging.INFO) # 控制台 console_handler = logging.StreamHandler() console_handler.setLevel(logging.INFO) # 文件 file_handler = logging.FileHandler(\"app.log\") file_handler.setLevel(logging.INFO) # 设置格式 formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s') console_handler.setFormatter(formatter) file_handler.setFormatter(formatter) # 添加处理器 logger.addHandler(console_handler) logger.addHandler(file_handler) logger.info(\"同时输出到控制台和日志文件\") 异步 logging import logging import asyncio logger = logging.getLogger(__name_-) logging.basicConfig(level=logging.INFO) async def task(): logger.info(\"在异步任务中输出日志\") asyncio.run(task()) Advanced Python Logging: Mastering Configuration \u0026 Best Pratices for Production | Python 日志高级使用：掌握配置和生产环境的最佳实践 Python 的 logging 系统提供了监视、调试和维护应用的工具，这篇文章将介绍从基础的配置和高级的实现策略，帮助构建鲁棒性的 logging 解决方案。\nWhy Proper Logging Matters 为什么日志很重要 日志的重要性有以下原因:\n生产环境中的有效调试 为应用行为提供洞察 促进性能观测 帮助追踪安全事件 支持合规要求 提高维护效率 Quick Start with Python Logging 快速开始 下面是一个 logging.basicConfig 的示例\n# Simple python logging example import logging # Basic logger in python logging.basicConfig( level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s' ) # Create a logger logger = logging.getLogger(__name__) # Logger in python example logger.info(\"This is an information message\") logger.warning(\"This is a warning message\") Getting Started with Python’s Logging Module 日志模块基础 Basic Setup 基本设置 来开始一个简单的日志设置\nimport logging # Basic configuration logging.basicConfig( level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s' ) # First logger logger = logging.getLogger(__name__) # Using the logger logger.info(\"Application started\") logger.warning(\"Watch Out!\") logger.error(\"Something went wrong\") Understanding Log Levels 了解日志等级 Python 日志有 5 个标准等级\nLevel Numberic Value When to Use DEBUG 10 细节调试信息 INFO 20 一般操作事件 WARNING 30 意料之外的事件 ERROR 40 更加严重的问题 CRITIAL 50 程序可能将无法运行 Beyond print() Statements 超越打印语句 为什么采用 logging 替代 print 语句呢？\n事件严重等级分类 时间戳信息 源信息（文件、代码行数） 可配置的输出目的地 生产就绪的筛选 线程安全 Configuring Your Logging System 设置你的日志系统 基础日志选项\nlogging.basicConfig( filename='app.log', filemode='w', format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.DEBUG, datefmt='%Y-%m-%d %H:%M:%S', ) 对于更加复杂的配置\nconfig = { 'version': 1, 'formatters': { 'detailed': { 'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s' } }, 'handlers': { 'console': { 'class': 'logging.StreamHandler', 'level': 'INFO', 'formatter': 'detailed' }, 'file': { 'class': 'logging.FileHandler', 'filename': 'app.log', 'level': 'DEBUG', 'formatter': 'detailed' } }, 'loggers': { 'myapp': { 'handlers': ['console', 'file'], 'level': 'DEBUG', 'propagate': True } } } logging.config.dictConfig(config) Working with Advanced Logging 高级日志技巧 结构化日志\n结构化日志提供了一个一致的、机器可读的格式，这对于日志分析和监控十分有必要。\nimport json import logging from datetime import datetime class JSONFormatter(logging.Formatter): def __init__(self): super().__init__() def format(self, record): # Create base log record log_obj = { \"timestamp\": self.formatTime(record, self.detefmt), \"name\": record.name, \"level\": record.levelname, \"message\": record.getMessage(), \"module\": record.module, \"function\": record.funcName, \"line\": record.lineno } # Add exception info if present if record.exc_info: lob_obj[\"exception\"] = self.formatException(record.exc_info) # Add custom fields from extra is hasattr(record, \"extra_fields\"): log_obj.update(record.extra_fields) return json.dumps(log_obj) # Usage Example logger = logging.getLogger(__name__) handler = logging.StreamHandler() handler.setFormatter(JSONFormatter) logger.addHandler(handler) # Log with extra fields logger.info(\"User logged in\", extra={\"extra_fileds\": {\"user_id\": \"123\", \"ip\": \"192.168.1.1\"}}) Error Management 错误管理 完善的错误日志对于调试生产环境的问题十分重要\nimport traceback import sys from contextlib import contextmanager class ErrorLogger: def __init__(self, logger): self.logger = logger @contextmanager def error_context(self, operation_name, **context): \"\"\"Context manager for error logging with additional context\"\"\" try: yield except Exception as e: # Capture the current stack here exc_type, exc_value, exc_trackback = sys.exc_info() # Format error details error_details = { \"operation\": operation_name, \"error_type\": exc_type.__name__, \"error_message\": str(exc_value), \"context\": context, \"stack_trace\": traceback.format_exception(exc_type, exc_value, exc_traceback) } # Log the error with full context self.logge.error( f\"Error in {operation_name}: {str(exc_value)}\", extra={\"error_details\": error_details} ) raise # Use example logger = logging.getLogger(__name__) error_logger = ErrorLogger(logger) with error_logger.error_context(\"user_authentication\", user_id=\"123\", attempt=2): # code might raise an exception authenicate_user(user_id) traceback 模块是专门用于获取、格式化、打印异常堆栈信息的模块，就是解释器出错的时候打印的那一大串东西\nTraceback (most recent call last): File \"app.py\", line 10, in \u003cmodule\u003e ... Concurrent Logging 并发日志 在多线程进程中，需要确保线程安全\nimport threading import logging from queue import Queue from logging.handlers import QueueHandler, QueueListener def setup_thread_safe_logging(): \"\"\"Set up thread-safe logging with a queue\"\"\" # Create the queue log_queue = Queue() # Create queue handler and listener queue_handler = QueueHandler(log_queue) listener = QueueListener( log_queue, console_handler, file_handler, respect_handler_level=True, ) # Configure root logger root_logger = logging.getLogger() root_logger.addHandler(queue_handler) # Start the listener in a sperate thread listener.start() return listener # Usage listener = setup_thread_safe_logging() def worker_function(): logger = logging.getLogger(__name__) logger.info(f\"Wroker thread {threading.current_thread().name} starting\") # Do work... logger.info(f\"Worker thread {threading.current_thread().name} finished\") # Create and start threads threads = [ threading.Thread(target=worker_function) for _ in range(3) ] for thread in threads: thread.start() Logging in Different Environments 不同环境中的日志 不同的应用环境需要不同的 logging 方式。 无论是 web 应用、微服务、或后台任务，每个环境都有独特的 logging 需求和最佳实践。 下面展示如何实现高效的跨部署环境日志系统。\nWeb Application Logging 浏览器应用日志 Django Logging Confiugration 下面是一个 Django logging 配置\n# settings.py LOGGING = { 'version': 1, 'disable_existing_loggers': False, 'formatters': { 'verbose': { 'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}', 'style': '{', }, 'simple': { 'format': '{levelname} {message}', 'style': '{', }, }, 'filters': { 'require_debug_true': { '()': 'django.utils.log.RequireDebugTrue', }, }, 'handlers': { 'console': { 'level': 'INFO', 'filters': ['require_debug_true'], 'class': 'logging.StreamHandler', 'formatter': 'simple' }, 'file': { 'level': 'ERROR', 'class': 'logging.FileHandler', 'filename': 'django-errors.log', 'formatter': 'verbose' }, 'mail_admins': { 'level': 'ERROR', 'class': 'django.utils.log.AdminEmailHandler', 'include_html': True, } }, 'loggers': { 'django': { 'handlers': ['console'], 'propagate': True, }, 'django.request': { 'handlers': ['file', 'mail_admins'], 'level': 'ERROR', 'propagate': False, }, 'myapp': { 'handlers': ['console', 'file'], 'level': 'INFO', } } } Flask Logging Setup Flask 提供可订制的日志系统\nimport logging from logging.handlers import RotatingFileHandler from flask import Flask, request app = Flask(__name__) def setup_logger(): create_formatter = RotatingFileHadnler( 'flask_app.log', maxBytes=10485760, # 10 MB backupCount=10, ) file_handler.setLevel(logging.INFO) file_handler.setFormatter(formatter) # Add request context class RequestFormatter(logging.Formatter): def format(self, record): record.url = request.url record.remote_addr = request.remote_addr return super().format(record) # Configure app logger app.logger.addHandler(file_handler) app.logger.setLevel(logging.INFO) return app.logger # Usage in routes @app.route('/app/endpoint') def api_endpoint(): app.logger.info(f\"Request recieved from {request.remote_addr}\") # coder here return jsonify({'status': 'success'}) Fastapi Logging Pratices FastAPI 可以通过一些中间件增强 middleware enhancements 来记录日志\nfrom fastapi import FastAPI, Request from typing import Callable import logging import time app = FastAPI() # Configure logging logging.basicConfig( level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s' ) logger = logging.getLogger(__name__) # Middleware for request logging @app.middleware(\"http\") async def log_requests(request: Request, call_next: Callable): start_time = time.time() response = await call_next(request) duration = time.time() - start_time log_dict = { \"url\": str(request.url), \"method\": request.method, \"client_ip\": request.client.host, \"duration\": f\"{duration:.2f}s\", \"status_code\": response.status_code, } logger.info(f\"Request processed: {log_dict}\") return response # Example endponit with logging @app.get(\"/items/{item_id}\") async def read_item(item_id: int): logger.info(f\"Retrieving item {item_id}\") # Code here return {\"item_id\": item_id} Microservices Logging 微服务日志 对于微服务而言，分布式追踪和关联性 ID 至关重要。\nimport logging import contextvars from uuid import uuid4 # Create context variable for trace ID trace_id_var = contextvars.ContextVars('trace_id', default=None) class TraceIDFilter(logging.Filter): def filter(self, record): trace_id = trace_id_var.get() record.trace_id = trace_id if trace_id else 'no_trace' return True def setup_microservice_logging(service_name): logger = logging.getLogger(service_name) # Create formatter with trace ID formatter = logging.Formatter('%(asctime)s - %(name)s - [%(trace_id)s] - %(levelname)s - %(message)s') # Add handlers with trace ID filter handler = logging.StreamHandler() handler.setFormatter(formatter) handler.addFilter(TraceIDFilter) logger.addHandler(handler) logger.setLevel(logging.INFO) return logger # Usage in microservice logger = setup_microservice_logging('order_service') def process_order(order_data): # Generate or get trace ID from request trace_id_var.set(str(uuid4())) logger.info(\"Starting order processing\", extra={ 'order_id': order_data['id'], 'custom_id': order_data['custom_id'] }) logger.info(\"Order processed successfully\") Background Task Logging 后台服务日志 对于后台任务而言，需要保持适当的日志处理和轮转\nfrom logging.handlers import RotatingFileHandler import logging import threading from datetime import datetime class BackgroundTaskLogger: def __init__(self, task_name): self.logger = logging.getLogger(f'backgroudn_task.{task_name}') self.setup_logging() def setup_logging(self): # Create logs directory if it doesn't exist import os os.mkdirs('logs', exist_ok=True) # Setup rotating file handler handler = RotatingFileHandler( filename=f'logs/task_{datetime.now():%Y%m%d}.log', maxBytes=5*1024*1024, # 5 MB backupCount=5, ) # Create formatter formatter = logging.Formatter( '%(asctime)s - [%(threadName)s] - %(levelname)s - %(message)s' ) handler.setFormatter(formatter) self.logger.addHandler(handler) self.logger.setLevel(logging.INFO) def log_task_status(self, status, **kwargs): \"\"\"Log task status with additional context\"\"\" extra = { 'thread_id': threading.get_ident(), 'timestamp': datetime.now().iosformat(), **kwargs } self.logger.info(f\"Task status: {status}\", extra=extra) # Usage example def background_job(): logger = BackgroundTaskLogger('data_processing') try: logger.log_task_status('started', job_id=123) # Do some work ... logger.log_task_status('completed', records_processed=1000) except Exception as e: logger.logger.error(f\"Task failed: {str(e)}\", exc_info=True) Common Logging Patterns and Soultions 常见日志模式和解决方案 跟踪请求 ID\nimport logging from contextlib import contextmanager import threading import uuid # Store request ID in thread-local storage _request_id = threading.local() class RequestIDFilter(logging.Filter): def filter(self, record): record.request_id = getattr(_request_id, 'id', 'no_request_id') return True @contextmanager def request_context(request_id=None): \"\"\"Context manager for request tracking\"\"\" if request_id is None: request_id = str(uuid.uuid4()) old_id = getattr(_request_id, 'id', None) _request_id.id = request_id try: yield request_id finally: if old_id is None: del _request_id.id else: _request_id.id = old_id # Setup logging with request ID def setup_request_logging(): logger = logging.getLogger() formatter = logging.Formatter( '%(asctime)s - [%(request_id)s] - %(levelname)s - %(message)s' ) handler = logging.StreamHandler() handler.setFormatter(formatter) handler.addFilter(RequestIDFilter()) logger.addHandler(handler) return logger # Usage example logger = setup_request_logging() def process_request(data): with request_context() as request_id: logger.info(\"Processing request\", extra={ 'data': data, 'operation': 'process_request' }) # Process the request... logger.info(\"Request processed successfully\") 用户活动日志\nimport logging from datetime import datetime from typing import Dict, Any class UserActivityLogger: def __init__(self): self.logger = logging.getLogger('user_activity') self.setup_logger() def setup_logger(self): formatter = logging.Formatter( '%(asctime)s - %(levelname)s - ' '[User: %(user_id)s] %(message)s' ) handler = logging.FileHandler('user_activity.log') handler.setFormatter(formatter) self.logger.addHandler(handler) self.logger.setLevel(logging.INFO) def log_activity( self, user_id: str, action: str, resource: str, details: Dict[str, Any] = None ): \"\"\"Log user activity with context\"\"\" activity_data = { 'timestamp': datetime.utcnow().isoformat(), 'user_id': user_id, 'action': action, 'resource': resource, 'details': details or {} } self.logger.info( f\"User performed {action} on {resource}\", extra={ 'user_id': user_id, 'activity_data': activity_data } ) return activity_data # Usage example activity_logger = UserActivityLogger() def update_user_profile(user_id: str, profile_data: dict): try: # Update profile logic here... activity_logger.log_activity( user_id=user_id, action='update_profile', resource='user_profile', details={ 'updated_fields': list(profile_data.keys()), 'source_ip': '192.168.1.1' } ) except Exception as e: activity_logger.logger.error( f\"Profile update failed for user {user_id}\", extra={'user_id': user_id, 'error': str(e)}, exc_info=True ) Troubleshooting and Debugging 调试和排错 高效的日志排错要求懂得常见的问题和解决方案。\nMissing Log Entries 日志入口缺失 # Common problem: Logs not appearing due to incorrect log level import logging # Wrong way logger = logging.getLogger(__name__) logger.debug(\"This won't appear\") # No handler and wrong level # Correct way def setup_proper_logging(): logger = logging.getLogger(__name__) # Set the base logger level logger.setLevel(logging.DEBUG) # Create the configure level handler = logging.StreamHandler() handler.setLevel(logging.DEBUG) # Add formatter formatter = logging.Formatter( '%(asctime)s - %(name)s - %(levelname)s - %(message)s' ) handler.setFormatter(formatter) # Add handler to logger logger.addHandler(handler) return logger Performance Bottlenecks 性能瓶颈 import logging import time from functools import wraps class PerformanceLoggingHandler(logging.Handler): def __init__(self): super().__init__() self.log_times = [] def emit(self, record): self.log_times.append(time.time()) if len(self.log_times) \u003e 1000: time_diff = self.log_times[-1] - self.log_times[0] if time_diff \u003c 1: # More than 1000 logs per second print(f\"Warning: High logging rate detected: {len(self.log_times)/time_diff} logs/second\") self.log_times = self.log_times[-100:] def log_performance(logger): \"\"\"Decorator to measure and log function performance\"\"\" def decorator(func): @wraps(func) def wrapper(*args, **kwargs): start_time = time.perf_counter() result = func(*args, **kwargs) end_time = time.perf_counter() execution_time = end_time - start_time logger.info( f\"Function {func.__name__} took {execution_time:.4f} seconds\", extra={ 'execution_time': execution_time, 'function_name': func.__name__ } ) return result return wrapper return decorator Common Logging Pitfalls and Soultions 常见日志陷阱和修复 Configuration Issues 配置问题 # Common Mistake 1: Not setting the log level properly logger = logging.getLogger(__name__) logger.debug(\"This won't appera\") # Solution: Configure both logger and handler levels logger = logging.getLogger(__name_-) logger.setLevel(logging.DEBUG) handler = logging.StreamHandler() handler.setLevel(logging.DEBUG) fromatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s') handler.setFormatter(formattere) logger.addHandler(handler) # Common Mistack 2: Incorrect basicConfig usage logging.basicConfig(levle=logging.INFO) # called after handler was add - won't work logger.info(\"message\") # Solution: Configure logging before creating loggers logging.basicConfig(level=logging.INFO) logger = logging.getLogger(__name_-) logger.info(\"message\") Memory and Resource Issues 内存和资源问题 # Common Mistake 3: Creating handlers in loops def process_item(item): # DON'T DO THIS logger = logging.getLogger(__name__) handler = logging.FileHandler('app.log') # Memory leak! logger.addHandler(handler) logger.info(f\"Processing {item}\") # Solution: Create handlers outside loops logger = logging.getLogger(__name__) handler = logging.FileHandler('app.log') logger.addHandler(handler) def process_item(item): logger.info(f\"Processing {item}\") # Common Mistake 4: Not closing file handlers handler = logging.FileHandler('app.log') logger.addHandler(handler) # ... later # handler.close() # Forgotten! # Solution: Use context manager from contextlib import contextmanager @contextmanager def log_file_handler(filename): handler = logging.FileHandler(filename) logger.addHandler(handler) try: yield finally: handler.close() logger.removeHandler(handler) ","wordCount":"1920","inLanguage":"en","image":"https://starslayerx.github.io/images/og-default.avif","datePublished":"2025-11-11T08:00:00+01:00","dateModified":"2025-11-11T08:00:00+01:00","author":{"@type":"Person","name":"Starslayerx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://starslayerx.github.io/posts/complete-python-logging-guide/"},"publisher":{"@type":"Organization","name":"Starslayerx' Blog","logo":{"@type":"ImageObject","url":"https://starslayerx.github.io/favicon.svg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://starslayerx.github.io/ accesskey=h title="Starslayerx' Blog (Alt + H)"><img src=https://starslayerx.github.io/favicon.svg alt aria-label=logo height=35>Starslayerx' Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://starslayerx.github.io/zh-cn/ title=简体中文 aria-label=简体中文>Zh-Cn</a></li></ul></div></div><ul id=menu><li><a href=https://starslayerx.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://starslayerx.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://starslayerx.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://starslayerx.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://starslayerx.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://starslayerx.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://starslayerx.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Complete Python Logging Guide</h1><div class=post-meta><span title='2025-11-11 08:00:00 +0100 +0100'>November 11, 2025</span>&nbsp;·&nbsp;<span>10 min</span>&nbsp;·&nbsp;<span>1920 words</span>&nbsp;·&nbsp;<span>Starslayerx</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#python-logging-基础指南>Python logging 基础指南</a><ul><li><a href=#核心概念>核心概念</a></li><li><a href=#简单使用>简单使用</a></li><li><a href=#写入日志文件>写入日志文件</a></li><li><a href=#异步-logging>异步 logging</a></li></ul></li><li><a href=#advanced-python-logging-mastering-configuration--best-pratices-for-production--python-日志高级使用掌握配置和生产环境的最佳实践>Advanced Python Logging: Mastering Configuration & Best Pratices for Production | Python 日志高级使用：掌握配置和生产环境的最佳实践</a><ul><li><a href=#why-proper-logging-matters-为什么日志很重要>Why Proper Logging Matters 为什么日志很重要</a></li><li><a href=#quick-start-with-python-logging-快速开始>Quick Start with Python Logging 快速开始</a></li><li><a href=#getting-started-with-pythons-logging-module-日志模块基础>Getting Started with Python&rsquo;s Logging Module 日志模块基础</a><ul><li><a href=#basic-setup-基本设置>Basic Setup 基本设置</a></li><li><a href=#understanding-log-levels-了解日志等级>Understanding Log Levels 了解日志等级</a></li><li><a href=#beyond-print-statements-超越打印语句>Beyond print() Statements 超越打印语句</a></li></ul></li><li><a href=#configuring-your-logging-system-设置你的日志系统>Configuring Your Logging System 设置你的日志系统</a></li><li><a href=#working-with-advanced-logging-高级日志技巧>Working with Advanced Logging 高级日志技巧</a><ul><li><a href=#error-management-错误管理>Error Management 错误管理</a></li><li><a href=#concurrent-logging-并发日志>Concurrent Logging 并发日志</a></li></ul></li><li><a href=#logging-in-different-environments-不同环境中的日志>Logging in Different Environments 不同环境中的日志</a><ul><li><a href=#web-application-logging-浏览器应用日志>Web Application Logging 浏览器应用日志</a></li><li><a href=#microservices-logging-微服务日志>Microservices Logging 微服务日志</a></li><li><a href=#background-task-logging-后台服务日志>Background Task Logging 后台服务日志</a></li></ul></li><li><a href=#common-logging-patterns-and-soultions-常见日志模式和解决方案>Common Logging Patterns and Soultions 常见日志模式和解决方案</a></li><li><a href=#troubleshooting-and-debugging-调试和排错>Troubleshooting and Debugging 调试和排错</a></li><li><a href=#common-logging-pitfalls-and-soultions-常见日志陷阱和修复>Common Logging Pitfalls and Soultions 常见日志陷阱和修复</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=python-logging-基础指南>Python logging 基础指南<a hidden class=anchor aria-hidden=true href=#python-logging-基础指南>#</a></h2><p>实际项目中，<code>print()</code> 只能满足基本的输出要求，而 <code>logging</code> 模块提供了更灵活、分级别、可配置的日志系统。</p><h3 id=核心概念>核心概念<a hidden class=anchor aria-hidden=true href=#核心概念>#</a></h3><ul><li><p>Logger 记录器<br>记录器是拿来写日志的东西</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;开始执行任务&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>接收日志消息，按级别判断是否要输出，并交给 Handler</p></li><li><p>Handler 处理器<br>决定日志“去哪里”，有下面常见 Handler</p><ul><li><code>StreamHandler</code>: 输出到控制台</li><li><code>FileHandler</code>: 写入文件</li><li><code>RotatingFileHandler</code>: 自动滚动文件</li><li><code>SMTHandler</code>: 发邮件</li><li><code>SocketHandler</code>: 发送到日志服务器</li></ul><p>一个 Logger 可以挂多个 Handler</p></li><li><p>Formatter 格式器<br>负责日志的格式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span></code></pre></div><p>所有 Handler 都可以设置自己的 Formatter，不同输出渠道可以呈现不同格式</p></li><li><p>LogRecord 日志记录对象<br>每次调用 <code>logging.info("hello")</code> 内部都会生成一个 LogRecord 对象</p><p>LogRecord 是日志系统的“消息载体”，包括全部的元数据，例如：</p><ul><li>时间戳</li><li>模块名</li><li>文件名、行号</li><li>日志级别</li><li>写入消息 message</li><li>线程 ID、进程 ID</li></ul></li><li><p>Filter 过滤器<br>Filter 是更细粒度的筛选工具，可以控制某个模块的日志，阻止某些关键字，基于上下文附加标签等。</p></li></ul><h3 id=简单使用>简单使用<a hidden class=anchor aria-hidden=true href=#简单使用>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1># 输出 INFO 及以上几倍日志</span>
</span></span><span class=line><span class=cl>  <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1># 时间 - 模块名 - 级别 - 消息内容</span>
</span></span><span class=line><span class=cl>  <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;程序已启动&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;磁盘空间将不足&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;读取文件失败&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>使用 <code>Logger</code> 对象：在较大的项目中，不会使用基础配置，而是为每个模块创建自己的 logger</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># __name__ 会使日志自动显示当前模块名称，便于定位来源</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;调试信息&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;开始处理任务&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;发生错误&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=写入日志文件>写入日志文件<a hidden class=anchor aria-hidden=true href=#写入日志文件>#</a></h3><p>将日志输出到文件，只需要在 <code>basicConfig</code> 中设置 <code>filename</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>filename</span><span class=o>=</span><span class=s1>&#39;app.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>filemode</span><span class=o>=</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=c1># 写入模式, a 为追加</span>
</span></span><span class=line><span class=cl>    <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;日志将写入文件&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>同时输出到控制台和文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&#34;app&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 控制台</span>
</span></span><span class=line><span class=cl><span class=n>console_handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>console_handler</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 文件</span>
</span></span><span class=line><span class=cl><span class=n>file_handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s2>&#34;app.log&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>file_handler</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置格式</span>
</span></span><span class=line><span class=cl><span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>console_handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>file_handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加处理器</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>console_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>file_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;同时输出到控制台和日志文件&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=异步-logging>异步 logging<a hidden class=anchor aria-hidden=true href=#异步-logging>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>__name_</span><span class=o>-</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>task</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;在异步任务中输出日志&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>task</span><span class=p>())</span>
</span></span></code></pre></div><h2 id=advanced-python-logging-mastering-configuration--best-pratices-for-production--python-日志高级使用掌握配置和生产环境的最佳实践>Advanced Python Logging: Mastering Configuration & Best Pratices for Production | Python 日志高级使用：掌握配置和生产环境的最佳实践<a hidden class=anchor aria-hidden=true href=#advanced-python-logging-mastering-configuration--best-pratices-for-production--python-日志高级使用掌握配置和生产环境的最佳实践>#</a></h2><p>Python 的 logging 系统提供了监视、调试和维护应用的工具，这篇文章将介绍从基础的配置和高级的实现策略，帮助构建鲁棒性的 logging 解决方案。</p><h3 id=why-proper-logging-matters-为什么日志很重要>Why Proper Logging Matters 为什么日志很重要<a hidden class=anchor aria-hidden=true href=#why-proper-logging-matters-为什么日志很重要>#</a></h3><p>日志的重要性有以下原因:</p><ul><li>生产环境中的有效调试</li><li>为应用行为提供洞察</li><li>促进性能观测</li><li>帮助追踪安全事件</li><li>支持合规要求</li><li>提高维护效率</li></ul><h3 id=quick-start-with-python-logging-快速开始>Quick Start with Python Logging 快速开始<a hidden class=anchor aria-hidden=true href=#quick-start-with-python-logging-快速开始>#</a></h3><p>下面是一个 <code>logging.basicConfig</code> 的示例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Simple python logging example</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Basic logger in python</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a logger</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Logger in python example</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;This is an information message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;This is a warning message&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=getting-started-with-pythons-logging-module-日志模块基础>Getting Started with Python&rsquo;s Logging Module 日志模块基础<a hidden class=anchor aria-hidden=true href=#getting-started-with-pythons-logging-module-日志模块基础>#</a></h3><h4 id=basic-setup-基本设置>Basic Setup 基本设置<a hidden class=anchor aria-hidden=true href=#basic-setup-基本设置>#</a></h4><p>来开始一个简单的日志设置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Basic configuration</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># First logger</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Using the logger</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Application started&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&#34;Watch Out!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Something went wrong&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=understanding-log-levels-了解日志等级>Understanding Log Levels 了解日志等级<a hidden class=anchor aria-hidden=true href=#understanding-log-levels-了解日志等级>#</a></h4><p>Python 日志有 5 个标准等级</p><table><thead><tr><th style=text-align:center>Level</th><th style=text-align:center>Numberic Value</th><th style=text-align:center>When to Use</th></tr></thead><tbody><tr><td style=text-align:center>DEBUG</td><td style=text-align:center>10</td><td style=text-align:center>细节调试信息</td></tr><tr><td style=text-align:center>INFO</td><td style=text-align:center>20</td><td style=text-align:center>一般操作事件</td></tr><tr><td style=text-align:center>WARNING</td><td style=text-align:center>30</td><td style=text-align:center>意料之外的事件</td></tr><tr><td style=text-align:center>ERROR</td><td style=text-align:center>40</td><td style=text-align:center>更加严重的问题</td></tr><tr><td style=text-align:center>CRITIAL</td><td style=text-align:center>50</td><td style=text-align:center>程序可能将无法运行</td></tr></tbody></table><h4 id=beyond-print-statements-超越打印语句>Beyond print() Statements 超越打印语句<a hidden class=anchor aria-hidden=true href=#beyond-print-statements-超越打印语句>#</a></h4><p>为什么采用 logging 替代 print 语句呢？</p><ul><li>事件严重等级分类</li><li>时间戳信息</li><li>源信息（文件、代码行数）</li><li>可配置的输出目的地</li><li>生产就绪的筛选</li><li>线程安全</li></ul><h3 id=configuring-your-logging-system-设置你的日志系统>Configuring Your Logging System 设置你的日志系统<a hidden class=anchor aria-hidden=true href=#configuring-your-logging-system-设置你的日志系统>#</a></h3><p>基础日志选项</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>filename</span><span class=o>=</span><span class=s1>&#39;app.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>filemode</span><span class=o>=</span><span class=s1>&#39;w&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>datefmt</span><span class=o>=</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>对于更加复杂的配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;formatters&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;detailed&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;format&#39;</span><span class=p>:</span> <span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;console&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;logging.StreamHandler&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;INFO&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;formatter&#39;</span><span class=p>:</span> <span class=s1>&#39;detailed&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;file&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;logging.FileHandler&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;filename&#39;</span><span class=p>:</span> <span class=s1>&#39;app.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;DEBUG&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;formatter&#39;</span><span class=p>:</span> <span class=s1>&#39;detailed&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;loggers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;myapp&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;console&#39;</span><span class=p>,</span> <span class=s1>&#39;file&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;DEBUG&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;propagate&#39;</span><span class=p>:</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>dictConfig</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=working-with-advanced-logging-高级日志技巧>Working with Advanced Logging 高级日志技巧<a hidden class=anchor aria-hidden=true href=#working-with-advanced-logging-高级日志技巧>#</a></h3><p>结构化日志</p><p>结构化日志提供了一个一致的、机器可读的格式，这对于日志分析和监控十分有必要。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>JSONFormatter</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>format</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Create base log record</span>
</span></span><span class=line><span class=cl>        <span class=n>log_obj</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>formatTime</span><span class=p>(</span><span class=n>record</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>detefmt</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>record</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;level&#34;</span><span class=p>:</span> <span class=n>record</span><span class=o>.</span><span class=n>levelname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=n>record</span><span class=o>.</span><span class=n>getMessage</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;module&#34;</span><span class=p>:</span> <span class=n>record</span><span class=o>.</span><span class=n>module</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;function&#34;</span><span class=p>:</span> <span class=n>record</span><span class=o>.</span><span class=n>funcName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;line&#34;</span><span class=p>:</span> <span class=n>record</span><span class=o>.</span><span class=n>lineno</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Add exception info if present</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>record</span><span class=o>.</span><span class=n>exc_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>lob_obj</span><span class=p>[</span><span class=s2>&#34;exception&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>formatException</span><span class=p>(</span><span class=n>record</span><span class=o>.</span><span class=n>exc_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Add custom fields from extra</span>
</span></span><span class=line><span class=cl>        <span class=ow>is</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>record</span><span class=p>,</span> <span class=s2>&#34;extra_fields&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>log_obj</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>record</span><span class=o>.</span><span class=n>extra_fields</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>log_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage Example</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>JSONFormatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Log with extra fields</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;User logged in&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;extra_fileds&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;123&#34;</span><span class=p>,</span> <span class=s2>&#34;ip&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.1.1&#34;</span><span class=p>}})</span>
</span></span></code></pre></div><h4 id=error-management-错误管理>Error Management 错误管理<a hidden class=anchor aria-hidden=true href=#error-management-错误管理>#</a></h4><p>完善的错误日志对于调试生产环境的问题十分重要</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>traceback</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorLogger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>logger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>error_context</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation_name</span><span class=p>,</span> <span class=o>**</span><span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Context manager for error logging with additional context&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Capture the current stack here</span>
</span></span><span class=line><span class=cl>            <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_value</span><span class=p>,</span> <span class=n>exc_trackback</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>exc_info</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Format error details</span>
</span></span><span class=line><span class=cl>            <span class=n>error_details</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;operation&#34;</span><span class=p>:</span> <span class=n>operation_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;error_type&#34;</span><span class=p>:</span> <span class=n>exc_type</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;error_message&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>exc_value</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;stack_trace&#34;</span><span class=p>:</span> <span class=n>traceback</span><span class=o>.</span><span class=n>format_exception</span><span class=p>(</span><span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_value</span><span class=p>,</span> <span class=n>exc_traceback</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Log the error with full context</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>logge</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;Error in </span><span class=si>{</span><span class=n>operation_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>exc_value</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>extra</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;error_details&#34;</span><span class=p>:</span> <span class=n>error_details</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Use example</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>error_logger</span> <span class=o>=</span> <span class=n>ErrorLogger</span><span class=p>(</span><span class=n>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>error_logger</span><span class=o>.</span><span class=n>error_context</span><span class=p>(</span><span class=s2>&#34;user_authentication&#34;</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=s2>&#34;123&#34;</span><span class=p>,</span> <span class=n>attempt</span><span class=o>=</span><span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># code might raise an exception</span>
</span></span><span class=line><span class=cl>    <span class=n>authenicate_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span></code></pre></div><p><code>traceback</code> 模块是专门用于获取、格式化、打印异常堆栈信息的模块，就是解释器出错的时候打印的那一大串东西</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-arduino data-lang=arduino><span class=line><span class=cl><span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nc>File</span> <span class=s>&#34;app.py&#34;</span><span class=p>,</span> <span class=nf>line</span> <span class=mi>10</span><span class=p>,</span> <span class=n>in</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span></code></pre></div><h4 id=concurrent-logging-并发日志>Concurrent Logging 并发日志<a hidden class=anchor aria-hidden=true href=#concurrent-logging-并发日志>#</a></h4><p>在多线程进程中，需要确保线程安全</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>queue</span> <span class=kn>import</span> <span class=n>Queue</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>logging.handlers</span> <span class=kn>import</span> <span class=n>QueueHandler</span><span class=p>,</span> <span class=n>QueueListener</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_thread_safe_logging</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Set up thread-safe logging with a queue&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Create the queue</span>
</span></span><span class=line><span class=cl>    <span class=n>log_queue</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create queue handler and listener</span>
</span></span><span class=line><span class=cl>    <span class=n>queue_handler</span> <span class=o>=</span> <span class=n>QueueHandler</span><span class=p>(</span><span class=n>log_queue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span> <span class=o>=</span> <span class=n>QueueListener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>log_queue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>console_handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>file_handler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>respect_handler_level</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Configure root logger</span>
</span></span><span class=line><span class=cl>    <span class=n>root_logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>root_logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>queue_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Start the listener in a sperate thread</span>
</span></span><span class=line><span class=cl>    <span class=n>listener</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>listener</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage</span>
</span></span><span class=line><span class=cl><span class=n>listener</span> <span class=o>=</span> <span class=n>setup_thread_safe_logging</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>worker_function</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Wroker thread </span><span class=si>{</span><span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> starting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Do work...</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Worker thread </span><span class=si>{</span><span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> finished&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create and start threads</span>
</span></span><span class=line><span class=cl><span class=n>threads</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker_function</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>thread</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=logging-in-different-environments-不同环境中的日志>Logging in Different Environments 不同环境中的日志<a hidden class=anchor aria-hidden=true href=#logging-in-different-environments-不同环境中的日志>#</a></h3><p>不同的应用环境需要不同的 logging 方式。
无论是 web 应用、微服务、或后台任务，每个环境都有独特的 logging 需求和最佳实践。
下面展示如何实现高效的跨部署环境日志系统。</p><h4 id=web-application-logging-浏览器应用日志>Web Application Logging 浏览器应用日志<a hidden class=anchor aria-hidden=true href=#web-application-logging-浏览器应用日志>#</a></h4><ul><li><strong>Django Logging Confiugration</strong></li></ul><p>下面是一个 Django logging 配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># settings.py</span>
</span></span><span class=line><span class=cl><span class=n>LOGGING</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;version&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;disable_existing_loggers&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;formatters&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;verbose&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;format&#39;</span><span class=p>:</span> <span class=s1>&#39;</span><span class=si>{levelname}</span><span class=s1> </span><span class=si>{asctime}</span><span class=s1> </span><span class=si>{module}</span><span class=s1> </span><span class=si>{process:d}</span><span class=s1> </span><span class=si>{thread:d}</span><span class=s1> </span><span class=si>{message}</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;style&#39;</span><span class=p>:</span> <span class=s1>&#39;{&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;simple&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;format&#39;</span><span class=p>:</span> <span class=s1>&#39;</span><span class=si>{levelname}</span><span class=s1> </span><span class=si>{message}</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;style&#39;</span><span class=p>:</span> <span class=s1>&#39;{&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;filters&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;require_debug_true&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;()&#39;</span><span class=p>:</span> <span class=s1>&#39;django.utils.log.RequireDebugTrue&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;console&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;INFO&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;filters&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;require_debug_true&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;logging.StreamHandler&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;formatter&#39;</span><span class=p>:</span> <span class=s1>&#39;simple&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;file&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;ERROR&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;logging.FileHandler&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;filename&#39;</span><span class=p>:</span> <span class=s1>&#39;django-errors.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;formatter&#39;</span><span class=p>:</span> <span class=s1>&#39;verbose&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;mail_admins&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;ERROR&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;class&#39;</span><span class=p>:</span> <span class=s1>&#39;django.utils.log.AdminEmailHandler&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;include_html&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;loggers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;django&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;console&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;propagate&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;django.request&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;file&#39;</span><span class=p>,</span> <span class=s1>&#39;mail_admins&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;ERROR&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;propagate&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;myapp&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handlers&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;console&#39;</span><span class=p>,</span> <span class=s1>&#39;file&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;level&#39;</span><span class=p>:</span> <span class=s1>&#39;INFO&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li><strong>Flask Logging Setup</strong></li></ul><p>Flask 提供可订制的日志系统</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>logging.handlers</span> <span class=kn>import</span> <span class=n>RotatingFileHandler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_logger</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>create_formatter</span> <span class=o>=</span> <span class=n>RotatingFileHadnler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;flask_app.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>maxBytes</span><span class=o>=</span><span class=mi>10485760</span><span class=p>,</span> <span class=c1># 10 MB</span>
</span></span><span class=line><span class=cl>        <span class=n>backupCount</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_handler</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add request context</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>RequestFormatter</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>format</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>record</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>url</span>
</span></span><span class=line><span class=cl>            <span class=n>record</span><span class=o>.</span><span class=n>remote_addr</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>remote_addr</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>record</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Configure app logger</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>file_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span><span class=o>.</span><span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage in routes</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/app/endpoint&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>api_endpoint</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Request recieved from </span><span class=si>{</span><span class=n>request</span><span class=o>.</span><span class=n>remote_addr</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># coder here</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;success&#39;</span><span class=p>})</span>
</span></span></code></pre></div><ul><li><strong>Fastapi Logging Pratices</strong></li></ul><p>FastAPI 可以通过一些中间件增强 middleware enhancements 来记录日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Request</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Configure logging</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Middleware for request logging</span>
</span></span><span class=line><span class=cl><span class=nd>@app.middleware</span><span class=p>(</span><span class=s2>&#34;http&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>log_requests</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>call_next</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_next</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>log_dict</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>url</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;method&#34;</span><span class=p>:</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;client_ip&#34;</span><span class=p>:</span> <span class=n>request</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;duration&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>duration</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status_code&#34;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Request processed: </span><span class=si>{</span><span class=n>log_dict</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Example endponit with logging</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/items/</span><span class=si>{item_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_item</span><span class=p>(</span><span class=n>item_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Retrieving item </span><span class=si>{</span><span class=n>item_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Code here</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;item_id&#34;</span><span class=p>:</span> <span class=n>item_id</span><span class=p>}</span>
</span></span></code></pre></div><h4 id=microservices-logging-微服务日志>Microservices Logging 微服务日志<a hidden class=anchor aria-hidden=true href=#microservices-logging-微服务日志>#</a></h4><p>对于微服务而言，分布式追踪和关联性 ID 至关重要。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>contextvars</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>uuid</span> <span class=kn>import</span> <span class=n>uuid4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create context variable for trace ID</span>
</span></span><span class=line><span class=cl><span class=n>trace_id_var</span> <span class=o>=</span> <span class=n>contextvars</span><span class=o>.</span><span class=n>ContextVars</span><span class=p>(</span><span class=s1>&#39;trace_id&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TraceIDFilter</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>Filter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>trace_id</span> <span class=o>=</span> <span class=n>trace_id_var</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>record</span><span class=o>.</span><span class=n>trace_id</span> <span class=o>=</span> <span class=n>trace_id</span> <span class=k>if</span> <span class=n>trace_id</span> <span class=k>else</span> <span class=s1>&#39;no_trace&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_microservice_logging</span><span class=p>(</span><span class=n>service_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>service_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create formatter with trace ID</span>
</span></span><span class=line><span class=cl>    <span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - [</span><span class=si>%(trace_id)s</span><span class=s1>] - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add handlers with trace ID filter</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=o>.</span><span class=n>addFilter</span><span class=p>(</span><span class=n>TraceIDFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage in microservice</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>setup_microservice_logging</span><span class=p>(</span><span class=s1>&#39;order_service&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_order</span><span class=p>(</span><span class=n>order_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Generate or get trace ID from request</span>
</span></span><span class=line><span class=cl>    <span class=n>trace_id_var</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>uuid4</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Starting order processing&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;order_id&#39;</span><span class=p>:</span> <span class=n>order_data</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;custom_id&#39;</span><span class=p>:</span> <span class=n>order_data</span><span class=p>[</span><span class=s1>&#39;custom_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Order processed successfully&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=background-task-logging-后台服务日志>Background Task Logging 后台服务日志<a hidden class=anchor aria-hidden=true href=#background-task-logging-后台服务日志>#</a></h4><p>对于后台任务而言，需要保持适当的日志处理和轮转</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>logging.handlers</span> <span class=kn>import</span> <span class=n>RotatingFileHandler</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BackgroundTaskLogger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;backgroudn_task.</span><span class=si>{</span><span class=n>task_name</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_logging</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_logging</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Create logs directory if it doesn&#39;t exist</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>mkdirs</span><span class=p>(</span><span class=s1>&#39;logs&#39;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Setup rotating file handler</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=n>RotatingFileHandler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span><span class=o>=</span><span class=sa>f</span><span class=s1>&#39;logs/task_</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=si>:</span><span class=s1>%Y%m%d</span><span class=si>}</span><span class=s1>.log&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>maxBytes</span><span class=o>=</span><span class=mi>5</span><span class=o>*</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>,</span> <span class=c1># 5 MB</span>
</span></span><span class=line><span class=cl>            <span class=n>backupCount</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Create formatter</span>
</span></span><span class=line><span class=cl>        <span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - [</span><span class=si>%(threadName)s</span><span class=s1>] - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_task_status</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>status</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Log task status with additional context&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>extra</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;thread_id&#39;</span><span class=p>:</span> <span class=n>threading</span><span class=o>.</span><span class=n>get_ident</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>iosformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=o>**</span><span class=n>kwargs</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Task status: </span><span class=si>{</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=n>extra</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage example</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>background_job</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>BackgroundTaskLogger</span><span class=p>(</span><span class=s1>&#39;data_processing&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>log_task_status</span><span class=p>(</span><span class=s1>&#39;started&#39;</span><span class=p>,</span> <span class=n>job_id</span><span class=o>=</span><span class=mi>123</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Do some work ...</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>log_task_status</span><span class=p>(</span><span class=s1>&#39;completed&#39;</span><span class=p>,</span> <span class=n>records_processed</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Task failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=common-logging-patterns-and-soultions-常见日志模式和解决方案>Common Logging Patterns and Soultions 常见日志模式和解决方案<a hidden class=anchor aria-hidden=true href=#common-logging-patterns-and-soultions-常见日志模式和解决方案>#</a></h3><p>跟踪请求 ID</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Store request ID in thread-local storage</span>
</span></span><span class=line><span class=cl><span class=n>_request_id</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>local</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RequestIDFilter</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>Filter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>record</span><span class=o>.</span><span class=n>request_id</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_request_id</span><span class=p>,</span> <span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;no_request_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_context</span><span class=p>(</span><span class=n>request_id</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Context manager for request tracking&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>old_id</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>_request_id</span><span class=p>,</span> <span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>_request_id</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>request_id</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>request_id</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>old_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>del</span> <span class=n>_request_id</span><span class=o>.</span><span class=n>id</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_request_id</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>old_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Setup logging with request ID</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_request_logging</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - [</span><span class=si>%(request_id)s</span><span class=s1>] - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=o>.</span><span class=n>addFilter</span><span class=p>(</span><span class=n>RequestIDFilter</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage example</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>setup_request_logging</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_request</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>request_context</span><span class=p>()</span> <span class=k>as</span> <span class=n>request_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Processing request&#34;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;operation&#39;</span><span class=p>:</span> <span class=s1>&#39;process_request&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=c1># Process the request...</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Request processed successfully&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>用户活动日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserActivityLogger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s1>&#39;user_activity&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_logger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_logger</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - &#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;[User: </span><span class=si>%(user_id)s</span><span class=s1>] </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s1>&#39;user_activity.log&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_activity</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>resource</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>details</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Log user activity with context&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>activity_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=n>action</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;resource&#39;</span><span class=p>:</span> <span class=n>resource</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;details&#39;</span><span class=p>:</span> <span class=n>details</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;User performed </span><span class=si>{</span><span class=n>action</span><span class=si>}</span><span class=s2> on </span><span class=si>{</span><span class=n>resource</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;activity_data&#39;</span><span class=p>:</span> <span class=n>activity_data</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>activity_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Usage example</span>
</span></span><span class=line><span class=cl><span class=n>activity_logger</span> <span class=o>=</span> <span class=n>UserActivityLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_user_profile</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>profile_data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Update profile logic here...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>activity_logger</span><span class=o>.</span><span class=n>log_activity</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>action</span><span class=o>=</span><span class=s1>&#39;update_profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>resource</span><span class=o>=</span><span class=s1>&#39;user_profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>details</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;updated_fields&#39;</span><span class=p>:</span> <span class=nb>list</span><span class=p>(</span><span class=n>profile_data</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;source_ip&#39;</span><span class=p>:</span> <span class=s1>&#39;192.168.1.1&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>activity_logger</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;Profile update failed for user </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>extra</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>            <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></div><h3 id=troubleshooting-and-debugging-调试和排错>Troubleshooting and Debugging 调试和排错<a hidden class=anchor aria-hidden=true href=#troubleshooting-and-debugging-调试和排错>#</a></h3><p>高效的日志排错要求懂得常见的问题和解决方案。</p><ul><li><strong>Missing Log Entries</strong> 日志入口缺失</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Common problem: Logs not appearing due to incorrect log level</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Wrong way</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;This won&#39;t appear&#34;</span><span class=p>)</span> <span class=c1># No handler and wrong level</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Correct way</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_proper_logging</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Set the base logger level</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create the configure level</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add formatter</span>
</span></span><span class=line><span class=cl>    <span class=n>formatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formatter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add handler to logger</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>logger</span>
</span></span></code></pre></div><ul><li><strong>Performance Bottlenecks</strong> 性能瓶颈</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PerformanceLoggingHandler</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>Handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>log_times</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>emit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>log_times</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>log_times</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>time_diff</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_times</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_times</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>time_diff</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>  <span class=c1># More than 1000 logs per second</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Warning: High logging rate detected: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>log_times</span><span class=p>)</span><span class=o>/</span><span class=n>time_diff</span><span class=si>}</span><span class=s2> logs/second&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>log_times</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_times</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_performance</span><span class=p>(</span><span class=n>logger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Decorator to measure and log function performance&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>execution_time</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;Function </span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2> took </span><span class=si>{</span><span class=n>execution_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2> seconds&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;execution_time&#39;</span><span class=p>:</span> <span class=n>execution_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;function_name&#39;</span><span class=p>:</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorator</span>
</span></span></code></pre></div><h3 id=common-logging-pitfalls-and-soultions-常见日志陷阱和修复>Common Logging Pitfalls and Soultions 常见日志陷阱和修复<a hidden class=anchor aria-hidden=true href=#common-logging-pitfalls-and-soultions-常见日志陷阱和修复>#</a></h3><ul><li><strong>Configuration Issues</strong> 配置问题</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=c1># Common Mistake 1: Not setting the log level properly</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;This won&#39;t appera&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Solution: Configure both logger and handler levels</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>__name_</span><span class=o>-</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>StreamHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>handler</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fromatter</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>Formatter</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> - </span><span class=si>%(name)s</span><span class=s1> - </span><span class=si>%(levelname)s</span><span class=s1> - </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>handler</span><span class=o>.</span><span class=n>setFormatter</span><span class=p>(</span><span class=n>formattere</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Common Mistack 2: Incorrect basicConfig usage</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>levle</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span> <span class=c1># called after handler was add - won&#39;t work</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Solution: Configure logging before creating loggers</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>__name_</span><span class=o>-</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>)</span>
</span></span></code></pre></div><ul><li><strong>Memory and Resource Issues</strong> 内存和资源问题</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=c1># Common Mistake 3: Creating handlers in loops</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_item</span><span class=p>(</span><span class=n>item</span><span class=p>):</span>  <span class=c1># DON&#39;T DO THIS</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s1>&#39;app.log&#39;</span><span class=p>)</span>  <span class=c1># Memory leak!</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Solution: Create handlers outside loops</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s1>&#39;app.log&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_item</span><span class=p>(</span><span class=n>item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Common Mistake 4: Not closing file handlers</span>
</span></span><span class=line><span class=cl><span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s1>&#39;app.log&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># ... later</span>
</span></span><span class=line><span class=cl><span class=c1># handler.close()  # Forgotten!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Solution: Use context manager</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_file_handler</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>addHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>removeHandler</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://starslayerx.github.io/tags/python/>Python</a></li></ul><nav class=paginav><a class=prev href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-00%E4%B8%BB%E6%96%87%E7%AB%A0/><span class=title>« Prev</span><br><span>Claude Code 分析 00：主文章</span>
</a><a class=next href=https://starslayerx.github.io/posts/kimi-challenge/><span class=title>Next »</span><br><span>Kimi Challenge</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on x" href="https://x.com/intent/tweet/?text=Complete%20Python%20Logging%20Guide&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f&amp;hashtags=Python"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f&amp;title=Complete%20Python%20Logging%20Guide&amp;summary=Complete%20Python%20Logging%20Guide&amp;source=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f&title=Complete%20Python%20Logging%20Guide"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on whatsapp" href="https://api.whatsapp.com/send?text=Complete%20Python%20Logging%20Guide%20-%20https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on telegram" href="https://telegram.me/share/url?text=Complete%20Python%20Logging%20Guide&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete Python Logging Guide on ycombinator" href="https://news.ycombinator.com/submitlink?t=Complete%20Python%20Logging%20Guide&u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fcomplete-python-logging-guide%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://starslayerx.github.io/>Starslayerx' Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>