<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ | Starslayerx' Blog</title><meta name=keywords content="Agent"><meta name=description content="ğŸ“Š æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„
stateDiagram-v2
    [*] --> UserInput: ç”¨æˆ·è¾“å…¥/ç²˜è´´
    UserInput --> CliMessage: CLI å¤„ç†è¾“å…¥
    CliMessage --> APIMessage: ä¸º LLM æ ¼å¼åŒ–
    APIMessage --> LLMStream: API è¯·æ±‚

    LLMStream --> StreamEvent: æœåŠ¡å™¨å‘é€æ•°æ®å—
    StreamEvent --> ContentBlockDelta: è§£æå¢é‡
    ContentBlockDelta --> AccumulatedMessage: æ„å»ºæ¶ˆæ¯

    AccumulatedMessage --> ToolUseBlock: åŒ…å«å·¥å…·è¯·æ±‚?
    ToolUseBlock --> ToolExecution: æ‰§è¡Œå·¥å…·
    ToolExecution --> ToolProgress: ç”Ÿæˆè¿›åº¦
    ToolProgress --> CliMessage: è¿›åº¦æ›´æ–°
    ToolExecution --> ToolResult: å®Œæˆæ‰§è¡Œ
    ToolResult --> ToolResultBlock: æ ¼å¼åŒ–ç»“æœ
    ToolResultBlock --> CliMessage: å·¥å…·ç»“æœæ¶ˆæ¯

    AccumulatedMessage --> CliMessage: æœ€ç»ˆåŠ©æ‰‹æ¶ˆæ¯
    CliMessage --> [*]: æ˜¾ç¤ºç»™ç”¨æˆ·

    CliMessage --> APIMessage: å¾ªç¯ç»§ç»­
æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢
Claude Code æ•°æ®æ¶æ„æœ€ä»¤äººç€è¿·çš„æ–¹é¢æ˜¯å®ƒå¦‚ä½•åœ¨ä¿æŒæµå¼æ€§èƒ½çš„åŒæ—¶,ç®¡ç†æ•°æ®åœ¨å¤šä¸ªè¡¨ç¤ºå½¢å¼ä¹‹é—´çš„è½¬æ¢ã€‚è®©æˆ‘ä»¬ä»æ ¸å¿ƒåˆ›æ–°å¼€å§‹:"><meta name=author content="Starslayerx"><link rel=canonical href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://starslayerx.github.io/favicon.svg><link rel=apple-touch-icon href=https://starslayerx.github.io/favicon.svg><link rel=mask-icon href=https://starslayerx.github.io/favicon.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><meta property="og:site_name" content="Starslayerx' Blog"><meta property="og:title" content="Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„"><meta property="og:description" content="ğŸ“Š æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„ stateDiagram-v2 [*] --> UserInput: ç”¨æˆ·è¾“å…¥/ç²˜è´´ UserInput --> CliMessage: CLI å¤„ç†è¾“å…¥ CliMessage --> APIMessage: ä¸º LLM æ ¼å¼åŒ– APIMessage --> LLMStream: API è¯·æ±‚ LLMStream --> StreamEvent: æœåŠ¡å™¨å‘é€æ•°æ®å— StreamEvent --> ContentBlockDelta: è§£æå¢é‡ ContentBlockDelta --> AccumulatedMessage: æ„å»ºæ¶ˆæ¯ AccumulatedMessage --> ToolUseBlock: åŒ…å«å·¥å…·è¯·æ±‚? ToolUseBlock --> ToolExecution: æ‰§è¡Œå·¥å…· ToolExecution --> ToolProgress: ç”Ÿæˆè¿›åº¦ ToolProgress --> CliMessage: è¿›åº¦æ›´æ–° ToolExecution --> ToolResult: å®Œæˆæ‰§è¡Œ ToolResult --> ToolResultBlock: æ ¼å¼åŒ–ç»“æœ ToolResultBlock --> CliMessage: å·¥å…·ç»“æœæ¶ˆæ¯ AccumulatedMessage --> CliMessage: æœ€ç»ˆåŠ©æ‰‹æ¶ˆæ¯ CliMessage --> [*]: æ˜¾ç¤ºç»™ç”¨æˆ· CliMessage --> APIMessage: å¾ªç¯ç»§ç»­ æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢ Claude Code æ•°æ®æ¶æ„æœ€ä»¤äººç€è¿·çš„æ–¹é¢æ˜¯å®ƒå¦‚ä½•åœ¨ä¿æŒæµå¼æ€§èƒ½çš„åŒæ—¶,ç®¡ç†æ•°æ®åœ¨å¤šä¸ªè¡¨ç¤ºå½¢å¼ä¹‹é—´çš„è½¬æ¢ã€‚è®©æˆ‘ä»¬ä»æ ¸å¿ƒåˆ›æ–°å¼€å§‹:"><meta property="og:locale" content="en-US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-14T10:00:00+01:00"><meta property="article:modified_time" content="2025-11-14T10:00:00+01:00"><meta property="article:tag" content="Agent"><meta property="og:image" content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:title content="Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„"><meta name=twitter:description content="ğŸ“Š æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„
stateDiagram-v2
    [*] --> UserInput: ç”¨æˆ·è¾“å…¥/ç²˜è´´
    UserInput --> CliMessage: CLI å¤„ç†è¾“å…¥
    CliMessage --> APIMessage: ä¸º LLM æ ¼å¼åŒ–
    APIMessage --> LLMStream: API è¯·æ±‚

    LLMStream --> StreamEvent: æœåŠ¡å™¨å‘é€æ•°æ®å—
    StreamEvent --> ContentBlockDelta: è§£æå¢é‡
    ContentBlockDelta --> AccumulatedMessage: æ„å»ºæ¶ˆæ¯

    AccumulatedMessage --> ToolUseBlock: åŒ…å«å·¥å…·è¯·æ±‚?
    ToolUseBlock --> ToolExecution: æ‰§è¡Œå·¥å…·
    ToolExecution --> ToolProgress: ç”Ÿæˆè¿›åº¦
    ToolProgress --> CliMessage: è¿›åº¦æ›´æ–°
    ToolExecution --> ToolResult: å®Œæˆæ‰§è¡Œ
    ToolResult --> ToolResultBlock: æ ¼å¼åŒ–ç»“æœ
    ToolResultBlock --> CliMessage: å·¥å…·ç»“æœæ¶ˆæ¯

    AccumulatedMessage --> CliMessage: æœ€ç»ˆåŠ©æ‰‹æ¶ˆæ¯
    CliMessage --> [*]: æ˜¾ç¤ºç»™ç”¨æˆ·

    CliMessage --> APIMessage: å¾ªç¯ç»§ç»­
æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢
Claude Code æ•°æ®æ¶æ„æœ€ä»¤äººç€è¿·çš„æ–¹é¢æ˜¯å®ƒå¦‚ä½•åœ¨ä¿æŒæµå¼æ€§èƒ½çš„åŒæ—¶,ç®¡ç†æ•°æ®åœ¨å¤šä¸ªè¡¨ç¤ºå½¢å¼ä¹‹é—´çš„è½¬æ¢ã€‚è®©æˆ‘ä»¬ä»æ ¸å¿ƒåˆ›æ–°å¼€å§‹:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://starslayerx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„","item":"https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„","name":"Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„","description":"ğŸ“Š æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„ stateDiagram-v2 [*] --\u0026gt; UserInput: ç”¨æˆ·è¾“å…¥/ç²˜è´´ UserInput --\u0026gt; CliMessage: CLI å¤„ç†è¾“å…¥ CliMessage --\u0026gt; APIMessage: ä¸º LLM æ ¼å¼åŒ– APIMessage --\u0026gt; LLMStream: API è¯·æ±‚ LLMStream --\u0026gt; StreamEvent: æœåŠ¡å™¨å‘é€æ•°æ®å— StreamEvent --\u0026gt; ContentBlockDelta: è§£æå¢é‡ ContentBlockDelta --\u0026gt; AccumulatedMessage: æ„å»ºæ¶ˆæ¯ AccumulatedMessage --\u0026gt; ToolUseBlock: åŒ…å«å·¥å…·è¯·æ±‚? ToolUseBlock --\u0026gt; ToolExecution: æ‰§è¡Œå·¥å…· ToolExecution --\u0026gt; ToolProgress: ç”Ÿæˆè¿›åº¦ ToolProgress --\u0026gt; CliMessage: è¿›åº¦æ›´æ–° ToolExecution --\u0026gt; ToolResult: å®Œæˆæ‰§è¡Œ ToolResult --\u0026gt; ToolResultBlock: æ ¼å¼åŒ–ç»“æœ ToolResultBlock --\u0026gt; CliMessage: å·¥å…·ç»“æœæ¶ˆæ¯ AccumulatedMessage --\u0026gt; CliMessage: æœ€ç»ˆåŠ©æ‰‹æ¶ˆæ¯ CliMessage --\u0026gt; [*]: æ˜¾ç¤ºç»™ç”¨æˆ· CliMessage --\u0026gt; APIMessage: å¾ªç¯ç»§ç»­ æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢ Claude Code æ•°æ®æ¶æ„æœ€ä»¤äººç€è¿·çš„æ–¹é¢æ˜¯å®ƒå¦‚ä½•åœ¨ä¿æŒæµå¼æ€§èƒ½çš„åŒæ—¶,ç®¡ç†æ•°æ®åœ¨å¤šä¸ªè¡¨ç¤ºå½¢å¼ä¹‹é—´çš„è½¬æ¢ã€‚è®©æˆ‘ä»¬ä»æ ¸å¿ƒåˆ›æ–°å¼€å§‹:\n","keywords":["Agent"],"articleBody":"ğŸ“Š æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„ stateDiagram-v2 [*] --\u003e UserInput: ç”¨æˆ·è¾“å…¥/ç²˜è´´ UserInput --\u003e CliMessage: CLI å¤„ç†è¾“å…¥ CliMessage --\u003e APIMessage: ä¸º LLM æ ¼å¼åŒ– APIMessage --\u003e LLMStream: API è¯·æ±‚ LLMStream --\u003e StreamEvent: æœåŠ¡å™¨å‘é€æ•°æ®å— StreamEvent --\u003e ContentBlockDelta: è§£æå¢é‡ ContentBlockDelta --\u003e AccumulatedMessage: æ„å»ºæ¶ˆæ¯ AccumulatedMessage --\u003e ToolUseBlock: åŒ…å«å·¥å…·è¯·æ±‚? ToolUseBlock --\u003e ToolExecution: æ‰§è¡Œå·¥å…· ToolExecution --\u003e ToolProgress: ç”Ÿæˆè¿›åº¦ ToolProgress --\u003e CliMessage: è¿›åº¦æ›´æ–° ToolExecution --\u003e ToolResult: å®Œæˆæ‰§è¡Œ ToolResult --\u003e ToolResultBlock: æ ¼å¼åŒ–ç»“æœ ToolResultBlock --\u003e CliMessage: å·¥å…·ç»“æœæ¶ˆæ¯ AccumulatedMessage --\u003e CliMessage: æœ€ç»ˆåŠ©æ‰‹æ¶ˆæ¯ CliMessage --\u003e [*]: æ˜¾ç¤ºç»™ç”¨æˆ· CliMessage --\u003e APIMessage: å¾ªç¯ç»§ç»­ æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢ Claude Code æ•°æ®æ¶æ„æœ€ä»¤äººç€è¿·çš„æ–¹é¢æ˜¯å®ƒå¦‚ä½•åœ¨ä¿æŒæµå¼æ€§èƒ½çš„åŒæ—¶,ç®¡ç†æ•°æ®åœ¨å¤šä¸ªè¡¨ç¤ºå½¢å¼ä¹‹é—´çš„è½¬æ¢ã€‚è®©æˆ‘ä»¬ä»æ ¸å¿ƒåˆ›æ–°å¼€å§‹:\n// åŒé‡è¡¨ç¤ºæ¶ˆæ¯ç³»ç»Ÿ (ä»åˆ†æä¸­æ¨æ–­) interface MessageTransformPipeline { // é˜¶æ®µ 1: CLI å†…éƒ¨è¡¨ç¤º cliMessage: { type: \"user\" | \"assistant\" | \"attachment\" | \"progress\"; uuid: string; // CLI ç‰¹å®šçš„è·Ÿè¸ª timestamp: string; message?: APICompatibleMessage; // ä»…ç”¨äº user/assistant attachment?: AttachmentContent; // ä»…ç”¨äº attachment progress?: ProgressUpdate; // ä»…ç”¨äº progress }; // é˜¶æ®µ 2: API çº¿ä¸Šæ ¼å¼ apiMessage: { role: \"user\" | \"assistant\"; content: string | ContentBlock[]; // æ²¡æœ‰ CLI ç‰¹å®šå­—æ®µ }; // é˜¶æ®µ 3: æµå¼ç´¯åŠ å™¨ streamAccumulator: { partial: Partial\u003cAPIMessage\u003e; deltas: ContentBlockDelta[]; buffers: Map\u003cstring, string\u003e; // tool_use_id â†’ ç´¯ç§¯çš„ JSON }; } ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦: è¿™ç§ä¸‰é˜¶æ®µè¡¨ç¤ºå…è®¸ Claude Code åœ¨å¤„ç†å¤æ‚æµå¼åè®®çš„åŒæ—¶ä¿æŒ UI å“åº”æ€§ã€‚CLI å¯ä»¥ä½¿ç”¨ CliMessage å…ƒæ•°æ®æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨,è€Œå®é™…çš„ LLM é€šä¿¡ä½¿ç”¨ç®€æ´çš„ APIMessage æ ¼å¼ã€‚\nContentBlock: å¤šæ€æ„å»ºå— åŸºäºåç¼–è¯‘åˆ†æ,Claude Code ä¸ºå†…å®¹å®ç°äº†ä¸€ä¸ªå¤æ‚çš„ç±»å‹ç³»ç»Ÿ:\n// ContentBlock å¯è¾¨è¯†è”åˆç±»å‹ (é‡æ„) type ContentBlock = | TextBlock | ImageBlock | ToolUseBlock | ToolResultBlock | ThinkingBlock | DocumentBlock // å¹³å°ç‰¹å®š | VideoBlock // å¹³å°ç‰¹å®š | GuardContentBlock // å¹³å°ç‰¹å®š | ReasoningBlock // å¹³å°ç‰¹å®š | CachePointBlock; // å¹³å°ç‰¹å®š // åŸºäºæ¨æ–­ä½¿ç”¨çš„æ€§èƒ½æ³¨è§£ interface ContentBlockMetrics { TextBlock: { memorySize: \"O(text.length)\"; parseTime: \"O(1)\"; serializeTime: \"O(n)\"; streamable: true; }; ImageBlock: { memorySize: \"O(1) + external\"; // å¼•ç”¨åˆ° base64/S3 parseTime: \"O(1)\"; serializeTime: \"O(size)\" | \"O(1) for S3\"; streamable: false; }; ToolUseBlock: { memorySize: \"O(JSON.stringify(input).length)\"; parseTime: \"O(n) for JSON parse\"; serializeTime: \"O(n)\"; streamable: true; // JSON å¯ä»¥æµå¼ä¼ è¾“ }; } æµå¼ JSON æŒ‘æˆ˜ Claude Code æœ€å·§å¦™çš„åˆ›æ–°ä¹‹ä¸€æ˜¯å¤„ç†å·¥å…·è¾“å…¥çš„æµå¼ JSON:\n// æ¨æ–­çš„æµå¼ JSON è§£æå™¨å®ç° class StreamingToolInputParser { private buffer: string = \"\"; private depth: number = 0; private inString: boolean = false; private escape: boolean = false; addChunk(chunk: string): ParseResult { this.buffer += chunk; // è·Ÿè¸ª JSON ç»“æ„æ·±åº¦ for (const char of chunk) { if (!this.inString) { if (char === \"{\" || char === \"[\") this.depth++; else if (char === \"}\" || char === \"]\") this.depth--; } // è·Ÿè¸ªå­—ç¬¦ä¸²è¾¹ç•Œ if (char === '\"' \u0026\u0026 !this.escape) { this.inString = !this.inString; } this.escape = char === \"\\\\\" \u0026\u0026 !this.escape; } // åœ¨æ·±åº¦ä¸º 0 æ—¶å°è¯•è§£æ if (this.depth === 0 \u0026\u0026 this.buffer.length \u003e 0) { try { return { complete: true, value: JSON.parse(this.buffer) }; } catch (e) { // å°è¯•è‡ªåŠ¨å…³é—­æœªé—­åˆçš„å­—ç¬¦ä¸² if (this.inString) { try { return { complete: true, value: JSON.parse(this.buffer + '\"'), repaired: true, }; } catch {} } return { complete: false, error: e }; } } return { complete: false }; } } è¿™ä¸ªè§£æå™¨å¯ä»¥å¤„ç†æ¥è‡ª LLM çš„å¢é‡ JSON å—,ä¸€æ—¦ç»“æ„çœ‹èµ·æ¥å®Œæ•´å°±å°è¯•è§£æã€‚\næ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ: ä»ç”¨æˆ·è¾“å…¥åˆ° LLM å†è¿”å› graph TB subgraph \"è¾“å…¥å¤„ç†\" UserText[ç”¨æˆ·æ–‡æœ¬è¾“å…¥] SlashCmd[\"/å‘½ä»¤\"] BashCmd[!shell å‘½ä»¤] MemoryCmd[#è®°å¿†ç¬”è®°] PastedContent[ç²˜è´´çš„å›¾ç‰‡/æ–‡æœ¬] UserText --\u003e NormalMessage[åˆ›å»ºç”¨æˆ· CliMessage] SlashCmd --\u003e CommandProcessor[å¤„ç†å‘½ä»¤] BashCmd --\u003e SyntheticTool[åˆæˆ BashTool æ¶ˆæ¯] MemoryCmd --\u003e MemoryUpdate[æ›´æ–° CLAUDE.md] PastedContent --\u003e ContentDetection{æ£€æµ‹ç±»å‹} ContentDetection --\u003e|å›¾ç‰‡| ImageBlock[åˆ›å»º ImageBlock] ContentDetection --\u003e|æ–‡æœ¬| TextBlock[åˆ›å»º TextBlock] end subgraph \"æ¶ˆæ¯è½¬æ¢\" NormalMessage --\u003e StripMetadata[ç§»é™¤ CLI å­—æ®µ] SyntheticTool --\u003e StripMetadata ImageBlock --\u003e StripMetadata TextBlock --\u003e StripMetadata StripMetadata --\u003e APIMessage[æ¸…æ´çš„ API æ¶ˆæ¯] APIMessage --\u003e TokenCount{è®¡æ•° Token} TokenCount --\u003e|è¶…è¿‡é™åˆ¶| Compact[å‹ç¼©è¿‡ç¨‹] TokenCount --\u003e|æœªè¶…é™åˆ¶| Send[å‘é€åˆ° LLM] Compact --\u003e SummaryMessage[æ‘˜è¦æ¶ˆæ¯] SummaryMessage --\u003e Send end CliMessage ç»“æ„: ä¸æ­¢è¡¨é¢æ‰€è§ CliMessage ç±»å‹å……å½“åº”ç”¨ç¨‹åºçš„ä¸­æ¢ç¥ç»ç³»ç»Ÿ:\ninterface CliMessage { type: \"user\" | \"assistant\" | \"attachment\" | \"progress\"; uuid: string; timestamp: string; // ä»…ç”¨äº user/assistant æ¶ˆæ¯ message?: { role: \"user\" | \"assistant\"; id?: string; // LLM æä¾›çš„ ID model?: string; // å“ªä¸ªæ¨¡å‹å“åº” stop_reason?: StopReason; // ä¸ºä»€ä¹ˆåœæ­¢ç”Ÿæˆ stop_sequence?: string; // å‘½ä¸­çš„ç‰¹å®šåœæ­¢åºåˆ— usage?: TokenUsage; // è¯¦ç»†çš„ token è®¡æ•° content: string | ContentBlock[]; }; // CLI ç‰¹å®šçš„å…ƒæ•°æ® costUSD?: number; // è®¡ç®—çš„æˆæœ¬ durationMs?: number; // API è°ƒç”¨æŒç»­æ—¶é—´ requestId?: string; // ç”¨äºè°ƒè¯• isApiErrorMessage?: boolean; // é”™è¯¯æ˜¾ç¤ºæ ‡å¿— isMeta?: boolean; // ç³»ç»Ÿç”Ÿæˆçš„æ¶ˆæ¯ // ç±»å‹ç‰¹å®šå­—æ®µ attachment?: AttachmentContent; progress?: { toolUseID: string; parentToolUseID?: string; // ç”¨äº AgentTool å­å·¥å…· data: any; // å·¥å…·ç‰¹å®šçš„è¿›åº¦ }; } // æ€§èƒ½ç‰¹æ€§ interface CliMessagePerformance { creation: \"O(1)\"; serialization: \"O(content size)\"; memoryRetention: \"å¤§å†…å®¹ä½¿ç”¨å¼±å¼•ç”¨\"; garbageCollection: \"ä»å†å²æ•°ç»„ä¸­ç§»é™¤æ—¶ç¬¦åˆå›æ”¶æ¡ä»¶\"; } å˜å¼‚ç‚¹å’ŒçŠ¶æ€è½¬æ¢ Claude Code ä»”ç»†æ§åˆ¶æ•°æ®ç»“æ„å¯ä»¥è¢«ä¿®æ”¹çš„ä½ç½®:\n// æ¨æ–­çš„å˜å¼‚æ§åˆ¶æ¨¡å¼ class MessageMutationControl { // å˜å¼‚ç‚¹ 1: æµå¼ç´¯ç§¯ static accumulateStreamDelta( message: Partial\u003cCliMessage\u003e, delta: ContentBlockDelta, ): void { if (delta.type === \"text_delta\") { const lastBlock = message.content[message.content.length - 1]; if (lastBlock.type === \"text\") { lastBlock.text += delta.text; // å˜å¼‚ } } } // å˜å¼‚ç‚¹ 2: å·¥å…·ç»“æœæ³¨å…¥ static injectToolResult( history: CliMessage[], toolResult: ToolResultBlock, ): void { const newMessage: CliMessage = { type: \"user\", isMeta: true, // ç³»ç»Ÿç”Ÿæˆ message: { role: \"user\", content: [toolResult], }, // ... å…¶ä»–å­—æ®µ }; history.push(newMessage); // å˜å¼‚ } // å˜å¼‚ç‚¹ 3: æˆæœ¬è®¡ç®— static updateCostMetadata(message: CliMessage, usage: TokenUsage): void { message.costUSD = calculateCost(usage, message.model); // å˜å¼‚ message.durationMs = Date.now() - parseISO(message.timestamp); // å˜å¼‚ } } ç³»ç»Ÿæç¤º: åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£… å¯èƒ½æœ€å¤æ‚çš„æ•°æ®ç»“æ„æ˜¯åŠ¨æ€ç»„è£…çš„ç³»ç»Ÿæç¤º:\n// ç³»ç»Ÿæç¤ºç»„è£…æµæ°´çº¿ (é‡æ„) interface SystemPromptPipeline { sources: { baseInstructions: string; // é™æ€åŸºç¡€ claudeMdContent: ClaudeMdLayer[]; // åˆ†å±‚çš„ gitContext: GitContextData; // å®æ—¶ directoryStructure: TreeData; // ç¼“å­˜/æ–°é²œ toolDefinitions: ToolSpec[]; // å¯ç”¨å·¥å…· modelAdaptations: ModelSpecificPrompt; // æ¯ä¸ªæ¨¡å‹ }; assembly: { order: [\"base\", \"model\", \"claude.md\", \"git\", \"files\", \"tools\"]; separators: Map\u003cstring, string\u003e; // éƒ¨åˆ†åˆ†éš”ç¬¦ sizeLimit: number; // Token é¢„ç®— prioritization: \"recency\" | \"relevance\"; }; } // GitContext ç»“æ„æ­ç¤ºäº†å®æ—¶æ„ŸçŸ¥ interface GitContextData { currentBranch: string; status: { modified: string[]; untracked: string[]; staged: string[]; }; recentCommits: Array\u003c{ hash: string; message: string; author: string; timestamp: string; }\u003e; uncommittedDiff?: string; // æ˜‚è´µ,æœ‰æ¡ä»¶ } å†…å­˜å¸ƒå±€: CLAUDE.md åˆ†å±‚åŠ è½½ é¡¹ç›®æ ¹ç›®å½• â”œâ”€â”€ .claude/ â”‚ â”œâ”€â”€ CLAUDE.md (æœ¬åœ° - æœ€é«˜ä¼˜å…ˆçº§) â”‚ â””â”€â”€ settings.json â”œâ”€â”€ ~/ â”‚ â””â”€â”€ .claude/ â”‚ â””â”€â”€ CLAUDE.md (ç”¨æˆ· - ç¬¬äºŒä¼˜å…ˆçº§) â”œâ”€â”€ / â”‚ â””â”€â”€ .claude/ â”‚ â””â”€â”€ CLAUDE.md (é¡¹ç›® - ç¬¬ä¸‰ä¼˜å…ˆçº§) â””â”€â”€ /etc/claude-code/ â””â”€â”€ CLAUDE.md (æ‰˜ç®¡ - æœ€ä½ä¼˜å…ˆçº§) åŠ è½½æœºåˆ¶å®ç°äº†é«˜æ•ˆçš„åˆå¹¶ç­–ç•¥:\n// æ¨æ–­çš„ CLAUDE.md åŠ è½½ç®—æ³• class ClaudeMdLoader { private cache = new Map\u003cstring, { content: string; mtime: number }\u003e(); async loadMerged(): Promise\u003cstring\u003e { const layers = [ \"/etc/claude-code/CLAUDE.md\", // æ‰˜ç®¡ \"~/.claude/CLAUDE.md\", // ç”¨æˆ· \"/.claude/CLAUDE.md\", // é¡¹ç›® \".claude/CLAUDE.md\", // æœ¬åœ° ]; const contents = await Promise.all( layers.map((path) =\u003e this.loadWithCache(path)), ); // ä½¿ç”¨è¦†ç›–è¯­ä¹‰åˆå¹¶ return this.mergeWithOverrides(contents); } private mergeWithOverrides(contents: string[]): string { // åé¢çš„å±‚è¦†ç›–å‰é¢çš„å±‚ // @override æŒ‡ä»¤ç”¨äºæ˜¾å¼è¦†ç›– // @append æŒ‡ä»¤ç”¨äºæ·»åŠ  // é»˜è®¤: ç”¨åˆ†éš”ç¬¦è¿æ¥ } } å·¥å…·ç›¸å…³çš„æ•°æ®ç»“æ„ ToolDefinition: å®Œæ•´çš„å·¥å…·æ¥å£ interface ToolDefinition { // æ ‡è¯† name: string; description: string; prompt?: string; // é¢å¤–çš„ LLM æŒ‡ä»¤ // æ¨¡å¼ (åŒé‡è¡¨ç¤º) inputSchema: ZodSchema; // è¿è¡Œæ—¶éªŒè¯ inputJSONSchema?: JSONSchema; // LLM é€šä¿¡ // æ‰§è¡Œ call: AsyncGenerator\u003cToolProgress | ToolResult, void, void\u003e; // æƒé™ checkPermissions?: ( input: any, context: ToolUseContext, permContext: ToolPermissionContext, ) =\u003e Promise\u003cPermissionDecision\u003e; // è¾“å‡ºæ ¼å¼åŒ– mapToolResultToToolResultBlockParam: ( result: any, toolUseId: string, ) =\u003e ContentBlock | ContentBlock[]; // å…ƒæ•°æ® isReadOnly: boolean; isMcp?: boolean; isEnabled?: (config: any) =\u003e boolean; getPath?: (input: any) =\u003e string | undefined; // UI renderToolUseMessage?: (input: any) =\u003e ReactElement; } // å·¥å…·å®šä¹‰çš„å†…å­˜ç‰¹æ€§ interface ToolDefinitionMemory { staticSize: \"æ¯ä¸ªå·¥å…·çº¦ 2KB\"; zodSchema: \"å»¶è¿Ÿç¼–è¯‘,å·²ç¼“å­˜\"; jsonSchema: \"ç”Ÿæˆä¸€æ¬¡,è®°å¿†åŒ–\"; closures: \"ä¿ç•™ä¸Šä¸‹æ–‡å¼•ç”¨\"; } æ‰§è¡Œä¸Šä¸‹æ–‡: å·¥å…·éœ€è¦çš„ä¸€åˆ‡ interface ToolUseContext { // å–æ¶ˆ abortController: AbortController; // æ–‡ä»¶çŠ¶æ€è·Ÿè¸ª readFileState: Map\u003c string, { content: string; timestamp: number; // mtime } \u003e; // æƒé™è§£æ getToolPermissionContext: () =\u003e ToolPermissionContext; // é€‰é¡¹åŒ… options: { tools: ToolDefinition[]; mainLoopModel: string; debug?: boolean; verbose?: boolean; isNonInteractiveSession?: boolean; maxThinkingTokens?: number; }; // MCP è¿æ¥ mcpClients?: McpClient[]; } // æƒé™ä¸Šä¸‹æ–‡æ­ç¤ºäº†å¤æ‚çš„å®‰å…¨æ¨¡å‹ interface ToolPermissionContext { mode: \"default\" | \"acceptEdits\" | \"bypassPermissions\"; additionalWorkingDirectories: Set\u003cstring\u003e; // åˆ†å±‚è§„åˆ™ç³»ç»Ÿ alwaysAllowRules: Record\u003cPermissionRuleScope, string[]\u003e; alwaysDenyRules: Record\u003cPermissionRuleScope, string[]\u003e; } type PermissionRuleScope = | \"cliArg\" // æœ€é«˜ä¼˜å…ˆçº§ | \"localSettings\" | \"projectSettings\" | \"policySettings\" | \"userSettings\"; // æœ€ä½ä¼˜å…ˆçº§ MCP åè®®ç»“æ„ å¤šäº‘/è¿›ç¨‹åè®®æ­ç¤ºäº†å¤æ‚çš„ RPC ç³»ç»Ÿ:\n// JSON-RPC 2.0 åŠå…¶æ‰©å±• interface McpMessage { jsonrpc: \"2.0\"; id?: string | number; // é€šçŸ¥å¯é€‰ } interface McpRequest extends McpMessage { method: string; params?: unknown; } interface McpResponse extends McpMessage { id: string | number; // å“åº”å¿…éœ€ result?: unknown; error?: { code: number; message: string; data?: unknown; }; } // èƒ½åŠ›åå•†ç»“æ„ interface McpCapabilities { experimental?: Record\u003cstring, any\u003e; // åŠŸèƒ½æ ‡å¿— roots?: boolean; // å·¥ä½œåŒºæ ¹ç›®å½• sampling?: boolean; // LLM é‡‡æ ·å§”æ‰˜ prompts?: boolean; // åŠ¨æ€æç¤º resources?: boolean; // èµ„æºæœåŠ¡ tools?: boolean; // å·¥å…·æš´éœ² logging?: boolean; // æ—¥å¿—è½¬å‘ } // MCP æœåŠ¡å™¨å‘é€çš„å·¥å…·è§„èŒƒ interface McpToolSpec { name: string; description?: string; inputSchema: JSONSchema; // å§‹ç»ˆæ˜¯ JSON Schema // MCP ç‰¹å®šå…ƒæ•°æ® isReadOnly?: boolean; requiresConfirmation?: boolean; timeout?: number; maxRetries?: number; } MCP çŠ¶æ€æœº stateDiagram-v2 [*] --\u003e Disconnected Disconnected --\u003e Connecting: connect() Connecting --\u003e Initializing: ä¼ è¾“å°±ç»ª Initializing --\u003e Ready: èƒ½åŠ›å·²äº¤æ¢ Ready --\u003e Ready: è¯·æ±‚/å“åº” Ready --\u003e Ready: é€šçŸ¥ Ready --\u003e Closing: close() Connecting --\u003e Failed: é”™è¯¯ Initializing --\u003e Failed: åå•†å¤±è´¥ Closing --\u003e Disconnected: å·²å…³é—­ Failed --\u003e Disconnected: é‡ç½® ä¼šè¯çŠ¶æ€: å…¨å±€å†…å­˜ interface SessionState { // æ ‡è¯† sessionId: string; // UUID v4 originalCwd: string; cwd: string; // å¯ä»¥é€šè¿‡ bash cd æ”¹å˜ // æˆæœ¬è·Ÿè¸ª (å¯å˜ç´¯åŠ å™¨) totalCostUSD: number; totalAPIDuration: number; modelTokens: Record\u003c string, { inputTokens: number; outputTokens: number; cacheReadInputTokens: number; cacheCreationInputTokens: number; } \u003e; // æ¨¡å‹é€‰æ‹© mainLoopModelOverride?: string; initialMainLoopModel?: string; // æ´»åŠ¨æŒ‡æ ‡ sessionCounter: number; locCounter: number; // ä»£ç è¡Œæ•° prCounter: number; // Pull requests commitCounter: number; // Git commits // çŠ¶æ€æ ‡å¿— lastInteractionTime: number; hasUnknownModelCost: boolean; maxRateLimitFallbackActive: boolean; // å¯ç”¨æ¨¡å‹ modelStrings: string[]; } // ä¼šè¯çŠ¶æ€è®¿é—®æ¨¡å¼ (æ¨æ–­) class SessionManager { private static state: SessionState; // å•ä¾‹ static update\u003cK extends keyof SessionState\u003e( key: K, value: SessionState[K], ): void { this.state[key] = value; this.persistToDisk(); // å¼‚æ­¥,éé˜»å¡ } static increment(metric: keyof SessionState): void { if (typeof this.state[metric] === \"number\") { this.state[metric]++; } } } åŒå‘æµå¼å®ç° å¹³å°çº§æµå¼æ­ç¤ºäº†å¤æ‚çš„åè®®:\n// åŒå‘æµå¼æœ‰æ•ˆè½½è·ç»“æ„ interface BidirectionalStreamingProtocol { // å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ clientPayload: { bytes: string; // Base64 ç¼–ç  encoding: \"base64\"; // è§£ç çš„å†…å®¹ç±»å‹ contentTypes: ContinuedUserInput | ToolResultBlock | ConversationTurnInput; }; // æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ serverPayload: { bytes: string; // Base64 ç¼–ç  encoding: \"base64\"; // è§£ç çš„äº‹ä»¶ç±»å‹ eventTypes: | ContentBlockDeltaEvent | ToolUseRequestEvent | ErrorEvent | MetadataEvent; }; } // åŒå‘æµçš„æµå¼çŠ¶æ€æœº class BidirectionalStreamManager { private encoder = new TextEncoder(); private decoder = new TextDecoder(); private buffer = new Uint8Array(65536); // 64KB ç¼“å†²åŒº async *processStream(stream: ReadableStream) { const reader = stream.getReader(); let partial = \"\"; while (true) { const { done, value } = await reader.read(); if (done) break; // è§£ç å¹¶æŒ‰æ¢è¡Œç¬¦åˆ†å‰² (SSE æ ¼å¼) partial += this.decoder.decode(value, { stream: true }); const lines = partial.split(\"\\n\"); partial = lines.pop() || \"\"; for (const line of lines) { if (line.startsWith(\"data: \")) { const payload = JSON.parse(line.slice(6)); yield this.decodePayload(payload); } } } } private decodePayload(payload: any) { const bytes = Buffer.from(payload.bytes, \"base64\"); // æ ¹æ®åè®®ç¼“å†²åŒºæˆ– JSON è¿›ä¸€æ­¥è§£ç  return JSON.parse(bytes.toString()); } } æ•°æ®ç»“æ„ä¸­çš„æ€§èƒ½ä¼˜åŒ– 1. å¸¸è§å€¼çš„å­—ç¬¦ä¸²é©»ç•™ // æ¨æ–­çš„å­—ç¬¦ä¸²é©»ç•™æ¨¡å¼ class StringIntern { private static pool = new Map\u003cstring, string\u003e(); static intern(str: string): string { if (!this.pool.has(str)) { this.pool.set(str, str); } return this.pool.get(str)!; } } // åœ¨æ¶ˆæ¯å¤„ç†ä¸­çš„ä½¿ç”¨ message.type = StringIntern.intern(rawType); // 'user', 'assistant' ç­‰ message.stop_reason = StringIntern.intern(reason); // 'end_turn', 'tool_use' ç­‰ 2. å»¶è¿Ÿå†…å®¹å—è§£æ // å†…å®¹å—å¯èƒ½ä½¿ç”¨å»¶è¿Ÿè§£æä»¥æé«˜æ€§èƒ½ class LazyContentBlock { private _raw: string; private _parsed?: any; constructor(raw: string) { this._raw = raw; } get content() { if (!this._parsed) { this._parsed = this.parse(this._raw); } return this._parsed; } private parse(raw: string): any { // ä»…åœ¨è®¿é—®æ—¶è¿›è¡Œæ˜‚è´µçš„è§£æ return JSON.parse(raw); } } 3. ReadFileState å¼±å¼•ç”¨ // å…·æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†çš„æ–‡ä»¶ç¼“å­˜ class ReadFileState { private cache = new Map\u003cstring, WeakRef\u003cFileContent\u003e\u003e(); private registry = new FinalizationRegistry((path: string) =\u003e { this.cache.delete(path); }); set(path: string, content: FileContent) { const ref = new WeakRef(content); this.cache.set(path, ref); this.registry.register(content, path); } get(path: string): FileContent | undefined { const ref = this.cache.get(path); if (ref) { const content = ref.deref(); if (!content) { this.cache.delete(path); } return content; } } } ","wordCount":"1761","inLanguage":"en","image":"https://starslayerx.github.io/images/og-default.avif","datePublished":"2025-11-14T10:00:00+01:00","dateModified":"2025-11-14T10:00:00+01:00","author":{"@type":"Person","name":"Starslayerx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-02%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},"publisher":{"@type":"Organization","name":"Starslayerx' Blog","logo":{"@type":"ImageObject","url":"https://starslayerx.github.io/favicon.svg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://starslayerx.github.io/ accesskey=h title="Starslayerx' Blog (Alt + H)"><img src=https://starslayerx.github.io/favicon.svg alt aria-label=logo height=35>Starslayerx' Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://starslayerx.github.io/zh-cn/ title=ç®€ä½“ä¸­æ–‡ aria-label=ç®€ä½“ä¸­æ–‡>Zh-Cn</a></li></ul></div></div><ul id=menu><li><a href=https://starslayerx.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://starslayerx.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://starslayerx.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://starslayerx.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://starslayerx.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://starslayerx.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://starslayerx.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„</h1><div class=post-meta><span title='2025-11-14 10:00:00 +0100 +0100'>November 14, 2025</span>&nbsp;Â·&nbsp;<span>9 min</span>&nbsp;Â·&nbsp;<span>1761 words</span>&nbsp;Â·&nbsp;<span>Starslayerx</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#æµå¼çŠ¶æ€æœº-æ¶ˆæ¯å¦‚ä½•è½¬æ¢>æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢</a></li><li><a href=#contentblock-å¤šæ€æ„å»ºå—>ContentBlock: å¤šæ€æ„å»ºå—</a><ul><li><a href=#æµå¼-json-æŒ‘æˆ˜>æµå¼ JSON æŒ‘æˆ˜</a></li></ul></li><li><a href=#æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ-ä»ç”¨æˆ·è¾“å…¥åˆ°-llm-å†è¿”å›>æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ: ä»ç”¨æˆ·è¾“å…¥åˆ° LLM å†è¿”å›</a><ul><li><a href=#climessage-ç»“æ„-ä¸æ­¢è¡¨é¢æ‰€è§>CliMessage ç»“æ„: ä¸æ­¢è¡¨é¢æ‰€è§</a></li><li><a href=#å˜å¼‚ç‚¹å’ŒçŠ¶æ€è½¬æ¢>å˜å¼‚ç‚¹å’ŒçŠ¶æ€è½¬æ¢</a></li></ul></li><li><a href=#ç³»ç»Ÿæç¤º-åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£…>ç³»ç»Ÿæç¤º: åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£…</a><ul><li><a href=#å†…å­˜å¸ƒå±€-claudemd-åˆ†å±‚åŠ è½½>å†…å­˜å¸ƒå±€: CLAUDE.md åˆ†å±‚åŠ è½½</a></li></ul></li><li><a href=#å·¥å…·ç›¸å…³çš„æ•°æ®ç»“æ„>å·¥å…·ç›¸å…³çš„æ•°æ®ç»“æ„</a><ul><li><a href=#tooldefinition-å®Œæ•´çš„å·¥å…·æ¥å£>ToolDefinition: å®Œæ•´çš„å·¥å…·æ¥å£</a></li><li><a href=#æ‰§è¡Œä¸Šä¸‹æ–‡-å·¥å…·éœ€è¦çš„ä¸€åˆ‡>æ‰§è¡Œä¸Šä¸‹æ–‡: å·¥å…·éœ€è¦çš„ä¸€åˆ‡</a></li></ul></li><li><a href=#mcp-åè®®ç»“æ„>MCP åè®®ç»“æ„</a><ul><li><a href=#mcp-çŠ¶æ€æœº>MCP çŠ¶æ€æœº</a></li></ul></li><li><a href=#ä¼šè¯çŠ¶æ€-å…¨å±€å†…å­˜>ä¼šè¯çŠ¶æ€: å…¨å±€å†…å­˜</a></li><li><a href=#åŒå‘æµå¼å®ç°>åŒå‘æµå¼å®ç°</a></li><li><a href=#æ•°æ®ç»“æ„ä¸­çš„æ€§èƒ½ä¼˜åŒ–>æ•°æ®ç»“æ„ä¸­çš„æ€§èƒ½ä¼˜åŒ–</a><ul><li><a href=#1-å¸¸è§å€¼çš„å­—ç¬¦ä¸²é©»ç•™>1. <strong>å¸¸è§å€¼çš„å­—ç¬¦ä¸²é©»ç•™</strong></a></li><li><a href=#2-å»¶è¿Ÿå†…å®¹å—è§£æ>2. <strong>å»¶è¿Ÿå†…å®¹å—è§£æ</strong></a></li><li><a href=#3-readfilestate-å¼±å¼•ç”¨>3. <strong>ReadFileState å¼±å¼•ç”¨</strong></a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=-æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„>ğŸ“Š æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„<a hidden class=anchor aria-hidden=true href=#-æ•°æ®ç»“æ„ä¸ä¿¡æ¯æ¶æ„>#</a></h1><pre tabindex=0><code class=language-mermaid data-lang=mermaid>stateDiagram-v2
    [*] --&gt; UserInput: ç”¨æˆ·è¾“å…¥/ç²˜è´´
    UserInput --&gt; CliMessage: CLI å¤„ç†è¾“å…¥
    CliMessage --&gt; APIMessage: ä¸º LLM æ ¼å¼åŒ–
    APIMessage --&gt; LLMStream: API è¯·æ±‚

    LLMStream --&gt; StreamEvent: æœåŠ¡å™¨å‘é€æ•°æ®å—
    StreamEvent --&gt; ContentBlockDelta: è§£æå¢é‡
    ContentBlockDelta --&gt; AccumulatedMessage: æ„å»ºæ¶ˆæ¯

    AccumulatedMessage --&gt; ToolUseBlock: åŒ…å«å·¥å…·è¯·æ±‚?
    ToolUseBlock --&gt; ToolExecution: æ‰§è¡Œå·¥å…·
    ToolExecution --&gt; ToolProgress: ç”Ÿæˆè¿›åº¦
    ToolProgress --&gt; CliMessage: è¿›åº¦æ›´æ–°
    ToolExecution --&gt; ToolResult: å®Œæˆæ‰§è¡Œ
    ToolResult --&gt; ToolResultBlock: æ ¼å¼åŒ–ç»“æœ
    ToolResultBlock --&gt; CliMessage: å·¥å…·ç»“æœæ¶ˆæ¯

    AccumulatedMessage --&gt; CliMessage: æœ€ç»ˆåŠ©æ‰‹æ¶ˆæ¯
    CliMessage --&gt; [*]: æ˜¾ç¤ºç»™ç”¨æˆ·

    CliMessage --&gt; APIMessage: å¾ªç¯ç»§ç»­
</code></pre><h2 id=æµå¼çŠ¶æ€æœº-æ¶ˆæ¯å¦‚ä½•è½¬æ¢>æµå¼çŠ¶æ€æœº: æ¶ˆæ¯å¦‚ä½•è½¬æ¢<a hidden class=anchor aria-hidden=true href=#æµå¼çŠ¶æ€æœº-æ¶ˆæ¯å¦‚ä½•è½¬æ¢>#</a></h2><p>Claude Code æ•°æ®æ¶æ„æœ€ä»¤äººç€è¿·çš„æ–¹é¢æ˜¯å®ƒå¦‚ä½•åœ¨ä¿æŒæµå¼æ€§èƒ½çš„åŒæ—¶,ç®¡ç†æ•°æ®åœ¨å¤šä¸ªè¡¨ç¤ºå½¢å¼ä¹‹é—´çš„è½¬æ¢ã€‚è®©æˆ‘ä»¬ä»æ ¸å¿ƒåˆ›æ–°å¼€å§‹:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// åŒé‡è¡¨ç¤ºæ¶ˆæ¯ç³»ç»Ÿ (ä»åˆ†æä¸­æ¨æ–­)
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>MessageTransformPipeline</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// é˜¶æ®µ 1: CLI å†…éƒ¨è¡¨ç¤º
</span></span></span><span class=line><span class=cl>  <span class=nx>cliMessage</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span> <span class=o>|</span> <span class=s2>&#34;assistant&#34;</span> <span class=o>|</span> <span class=s2>&#34;attachment&#34;</span> <span class=o>|</span> <span class=s2>&#34;progress&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>uuid</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// CLI ç‰¹å®šçš„è·Ÿè¸ª
</span></span></span><span class=line><span class=cl>    <span class=nx>timestamp</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>message?</span>: <span class=kt>APICompatibleMessage</span><span class=p>;</span> <span class=c1>// ä»…ç”¨äº user/assistant
</span></span></span><span class=line><span class=cl>    <span class=nx>attachment?</span>: <span class=kt>AttachmentContent</span><span class=p>;</span> <span class=c1>// ä»…ç”¨äº attachment
</span></span></span><span class=line><span class=cl>    <span class=nx>progress?</span>: <span class=kt>ProgressUpdate</span><span class=p>;</span> <span class=c1>// ä»…ç”¨äº progress
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// é˜¶æ®µ 2: API çº¿ä¸Šæ ¼å¼
</span></span></span><span class=line><span class=cl>  <span class=nx>apiMessage</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span> <span class=o>|</span> <span class=s2>&#34;assistant&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>content</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nx>ContentBlock</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ²¡æœ‰ CLI ç‰¹å®šå­—æ®µ
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// é˜¶æ®µ 3: æµå¼ç´¯åŠ å™¨
</span></span></span><span class=line><span class=cl>  <span class=nx>streamAccumulator</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>partial</span>: <span class=kt>Partial</span><span class=p>&lt;</span><span class=nt>APIMessage</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>    <span class=nx>deltas</span>: <span class=kt>ContentBlockDelta</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=nx>buffers</span>: <span class=kt>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>string</span><span class=p>&gt;;</span> <span class=c1>// tool_use_id â†’ ç´¯ç§¯çš„ JSON
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦</strong>: è¿™ç§ä¸‰é˜¶æ®µè¡¨ç¤ºå…è®¸ Claude Code åœ¨å¤„ç†å¤æ‚æµå¼åè®®çš„åŒæ—¶ä¿æŒ UI å“åº”æ€§ã€‚CLI å¯ä»¥ä½¿ç”¨ <code>CliMessage</code> å…ƒæ•°æ®æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨,è€Œå®é™…çš„ LLM é€šä¿¡ä½¿ç”¨ç®€æ´çš„ <code>APIMessage</code> æ ¼å¼ã€‚</p><h2 id=contentblock-å¤šæ€æ„å»ºå—>ContentBlock: å¤šæ€æ„å»ºå—<a hidden class=anchor aria-hidden=true href=#contentblock-å¤šæ€æ„å»ºå—>#</a></h2><p>åŸºäºåç¼–è¯‘åˆ†æ,Claude Code ä¸ºå†…å®¹å®ç°äº†ä¸€ä¸ªå¤æ‚çš„ç±»å‹ç³»ç»Ÿ:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// ContentBlock å¯è¾¨è¯†è”åˆç±»å‹ (é‡æ„)
</span></span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>ContentBlock</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>TextBlock</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>ImageBlock</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>ToolUseBlock</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>ToolResultBlock</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>ThinkingBlock</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>DocumentBlock</span> <span class=c1>// å¹³å°ç‰¹å®š
</span></span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>VideoBlock</span> <span class=c1>// å¹³å°ç‰¹å®š
</span></span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>GuardContentBlock</span> <span class=c1>// å¹³å°ç‰¹å®š
</span></span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>ReasoningBlock</span> <span class=c1>// å¹³å°ç‰¹å®š
</span></span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=nx>CachePointBlock</span><span class=p>;</span> <span class=c1>// å¹³å°ç‰¹å®š
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åŸºäºæ¨æ–­ä½¿ç”¨çš„æ€§èƒ½æ³¨è§£
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>ContentBlockMetrics</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>TextBlock</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>memorySize</span><span class=o>:</span> <span class=s2>&#34;O(text.length)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>parseTime</span><span class=o>:</span> <span class=s2>&#34;O(1)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>serializeTime</span><span class=o>:</span> <span class=s2>&#34;O(n)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>streamable</span>: <span class=kt>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>ImageBlock</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>memorySize</span><span class=o>:</span> <span class=s2>&#34;O(1) + external&#34;</span><span class=p>;</span> <span class=c1>// å¼•ç”¨åˆ° base64/S3
</span></span></span><span class=line><span class=cl>    <span class=nx>parseTime</span><span class=o>:</span> <span class=s2>&#34;O(1)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>serializeTime</span><span class=o>:</span> <span class=s2>&#34;O(size)&#34;</span> <span class=o>|</span> <span class=s2>&#34;O(1) for S3&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>streamable</span>: <span class=kt>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>ToolUseBlock</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>memorySize</span><span class=o>:</span> <span class=s2>&#34;O(JSON.stringify(input).length)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>parseTime</span><span class=o>:</span> <span class=s2>&#34;O(n) for JSON parse&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>serializeTime</span><span class=o>:</span> <span class=s2>&#34;O(n)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>streamable</span>: <span class=kt>true</span><span class=p>;</span> <span class=c1>// JSON å¯ä»¥æµå¼ä¼ è¾“
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=æµå¼-json-æŒ‘æˆ˜>æµå¼ JSON æŒ‘æˆ˜<a hidden class=anchor aria-hidden=true href=#æµå¼-json-æŒ‘æˆ˜>#</a></h3><p>Claude Code æœ€å·§å¦™çš„åˆ›æ–°ä¹‹ä¸€æ˜¯å¤„ç†å·¥å…·è¾“å…¥çš„æµå¼ JSON:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æ¨æ–­çš„æµå¼ JSON è§£æå™¨å®ç°
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>StreamingToolInputParser</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>buffer</span>: <span class=kt>string</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>depth</span>: <span class=kt>number</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>inString</span>: <span class=kt>boolean</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>escape</span>: <span class=kt>boolean</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addChunk</span><span class=p>(</span><span class=nx>chunk</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>ParseResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>+=</span> <span class=nx>chunk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è·Ÿè¸ª JSON ç»“æ„æ·±åº¦
</span></span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>char</span> <span class=k>of</span> <span class=nx>chunk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>inString</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>char</span> <span class=o>===</span> <span class=s2>&#34;{&#34;</span> <span class=o>||</span> <span class=nx>char</span> <span class=o>===</span> <span class=s2>&#34;[&#34;</span><span class=p>)</span> <span class=k>this</span><span class=p>.</span><span class=nx>depth</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>char</span> <span class=o>===</span> <span class=s2>&#34;}&#34;</span> <span class=o>||</span> <span class=nx>char</span> <span class=o>===</span> <span class=s2>&#34;]&#34;</span><span class=p>)</span> <span class=k>this</span><span class=p>.</span><span class=nx>depth</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// è·Ÿè¸ªå­—ç¬¦ä¸²è¾¹ç•Œ
</span></span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>char</span> <span class=o>===</span> <span class=s1>&#39;&#34;&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>escape</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>inString</span> <span class=o>=</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>inString</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>escape</span> <span class=o>=</span> <span class=nx>char</span> <span class=o>===</span> <span class=s2>&#34;\\&#34;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>escape</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åœ¨æ·±åº¦ä¸º 0 æ—¶å°è¯•è§£æ
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>depth</span> <span class=o>===</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>buffer</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span> <span class=nx>complete</span>: <span class=kt>true</span><span class=p>,</span> <span class=nx>value</span>: <span class=kt>JSON.parse</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>buffer</span><span class=p>)</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°è¯•è‡ªåŠ¨å…³é—­æœªé—­åˆçš„å­—ç¬¦ä¸²
</span></span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>inString</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>complete</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>value</span>: <span class=kt>JSON.parse</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>buffer</span> <span class=o>+</span> <span class=s1>&#39;&#34;&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>              <span class=nx>repaired</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>};</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>catch</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span> <span class=nx>complete</span>: <span class=kt>false</span><span class=p>,</span> <span class=nx>error</span>: <span class=kt>e</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>complete</span>: <span class=kt>false</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>è¿™ä¸ªè§£æå™¨å¯ä»¥å¤„ç†æ¥è‡ª LLM çš„å¢é‡ JSON å—,ä¸€æ—¦ç»“æ„çœ‹èµ·æ¥å®Œæ•´å°±å°è¯•è§£æã€‚</p><h2 id=æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ-ä»ç”¨æˆ·è¾“å…¥åˆ°-llm-å†è¿”å›>æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ: ä»ç”¨æˆ·è¾“å…¥åˆ° LLM å†è¿”å›<a hidden class=anchor aria-hidden=true href=#æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ-ä»ç”¨æˆ·è¾“å…¥åˆ°-llm-å†è¿”å›>#</a></h2><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TB
    subgraph &#34;è¾“å…¥å¤„ç†&#34;
        UserText[ç”¨æˆ·æ–‡æœ¬è¾“å…¥]
        SlashCmd[&#34;/å‘½ä»¤&#34;]
        BashCmd[!shell å‘½ä»¤]
        MemoryCmd[#è®°å¿†ç¬”è®°]
        PastedContent[ç²˜è´´çš„å›¾ç‰‡/æ–‡æœ¬]

        UserText --&gt; NormalMessage[åˆ›å»ºç”¨æˆ· CliMessage]
        SlashCmd --&gt; CommandProcessor[å¤„ç†å‘½ä»¤]
        BashCmd --&gt; SyntheticTool[åˆæˆ BashTool æ¶ˆæ¯]
        MemoryCmd --&gt; MemoryUpdate[æ›´æ–° CLAUDE.md]
        PastedContent --&gt; ContentDetection{æ£€æµ‹ç±»å‹}

        ContentDetection --&gt;|å›¾ç‰‡| ImageBlock[åˆ›å»º ImageBlock]
        ContentDetection --&gt;|æ–‡æœ¬| TextBlock[åˆ›å»º TextBlock]
    end

    subgraph &#34;æ¶ˆæ¯è½¬æ¢&#34;
        NormalMessage --&gt; StripMetadata[ç§»é™¤ CLI å­—æ®µ]
        SyntheticTool --&gt; StripMetadata
        ImageBlock --&gt; StripMetadata
        TextBlock --&gt; StripMetadata

        StripMetadata --&gt; APIMessage[æ¸…æ´çš„ API æ¶ˆæ¯]
        APIMessage --&gt; TokenCount{è®¡æ•° Token}

        TokenCount --&gt;|è¶…è¿‡é™åˆ¶| Compact[å‹ç¼©è¿‡ç¨‹]
        TokenCount --&gt;|æœªè¶…é™åˆ¶| Send[å‘é€åˆ° LLM]

        Compact --&gt; SummaryMessage[æ‘˜è¦æ¶ˆæ¯]
        SummaryMessage --&gt; Send
    end
</code></pre><h3 id=climessage-ç»“æ„-ä¸æ­¢è¡¨é¢æ‰€è§>CliMessage ç»“æ„: ä¸æ­¢è¡¨é¢æ‰€è§<a hidden class=anchor aria-hidden=true href=#climessage-ç»“æ„-ä¸æ­¢è¡¨é¢æ‰€è§>#</a></h3><p><code>CliMessage</code> ç±»å‹å……å½“åº”ç”¨ç¨‹åºçš„ä¸­æ¢ç¥ç»ç³»ç»Ÿ:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>CliMessage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span> <span class=o>|</span> <span class=s2>&#34;assistant&#34;</span> <span class=o>|</span> <span class=s2>&#34;attachment&#34;</span> <span class=o>|</span> <span class=s2>&#34;progress&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>uuid</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>timestamp</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ä»…ç”¨äº user/assistant æ¶ˆæ¯
</span></span></span><span class=line><span class=cl>  <span class=nx>message</span><span class=o>?:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span> <span class=o>|</span> <span class=s2>&#34;assistant&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>id?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// LLM æä¾›çš„ ID
</span></span></span><span class=line><span class=cl>    <span class=nx>model?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// å“ªä¸ªæ¨¡å‹å“åº”
</span></span></span><span class=line><span class=cl>    <span class=nx>stop_reason?</span>: <span class=kt>StopReason</span><span class=p>;</span> <span class=c1>// ä¸ºä»€ä¹ˆåœæ­¢ç”Ÿæˆ
</span></span></span><span class=line><span class=cl>    <span class=nx>stop_sequence?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// å‘½ä¸­çš„ç‰¹å®šåœæ­¢åºåˆ—
</span></span></span><span class=line><span class=cl>    <span class=nx>usage?</span>: <span class=kt>TokenUsage</span><span class=p>;</span> <span class=c1>// è¯¦ç»†çš„ token è®¡æ•°
</span></span></span><span class=line><span class=cl>    <span class=nx>content</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nx>ContentBlock</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// CLI ç‰¹å®šçš„å…ƒæ•°æ®
</span></span></span><span class=line><span class=cl>  <span class=nx>costUSD?</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// è®¡ç®—çš„æˆæœ¬
</span></span></span><span class=line><span class=cl>  <span class=nx>durationMs?</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// API è°ƒç”¨æŒç»­æ—¶é—´
</span></span></span><span class=line><span class=cl>  <span class=nx>requestId?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// ç”¨äºè°ƒè¯•
</span></span></span><span class=line><span class=cl>  <span class=nx>isApiErrorMessage?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// é”™è¯¯æ˜¾ç¤ºæ ‡å¿—
</span></span></span><span class=line><span class=cl>  <span class=nx>isMeta?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// ç³»ç»Ÿç”Ÿæˆçš„æ¶ˆæ¯
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ç±»å‹ç‰¹å®šå­—æ®µ
</span></span></span><span class=line><span class=cl>  <span class=nx>attachment?</span>: <span class=kt>AttachmentContent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>progress</span><span class=o>?:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolUseID</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentToolUseID?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// ç”¨äº AgentTool å­å·¥å…·
</span></span></span><span class=line><span class=cl>    <span class=nx>data</span>: <span class=kt>any</span><span class=p>;</span> <span class=c1>// å·¥å…·ç‰¹å®šçš„è¿›åº¦
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æ€§èƒ½ç‰¹æ€§
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>CliMessagePerformance</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>creation</span><span class=o>:</span> <span class=s2>&#34;O(1)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>serialization</span><span class=o>:</span> <span class=s2>&#34;O(content size)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>memoryRetention</span><span class=o>:</span> <span class=s2>&#34;å¤§å†…å®¹ä½¿ç”¨å¼±å¼•ç”¨&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>garbageCollection</span><span class=o>:</span> <span class=s2>&#34;ä»å†å²æ•°ç»„ä¸­ç§»é™¤æ—¶ç¬¦åˆå›æ”¶æ¡ä»¶&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=å˜å¼‚ç‚¹å’ŒçŠ¶æ€è½¬æ¢>å˜å¼‚ç‚¹å’ŒçŠ¶æ€è½¬æ¢<a hidden class=anchor aria-hidden=true href=#å˜å¼‚ç‚¹å’ŒçŠ¶æ€è½¬æ¢>#</a></h3><p>Claude Code ä»”ç»†æ§åˆ¶æ•°æ®ç»“æ„å¯ä»¥è¢«ä¿®æ”¹çš„ä½ç½®:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æ¨æ–­çš„å˜å¼‚æ§åˆ¶æ¨¡å¼
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MessageMutationControl</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å˜å¼‚ç‚¹ 1: æµå¼ç´¯ç§¯
</span></span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>accumulateStreamDelta</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span>: <span class=kt>Partial</span><span class=p>&lt;</span><span class=nt>CliMessage</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>    <span class=nx>delta</span>: <span class=kt>ContentBlockDelta</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>delta</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;text_delta&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>lastBlock</span> <span class=o>=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>[</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>lastBlock</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=s2>&#34;text&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>lastBlock</span><span class=p>.</span><span class=nx>text</span> <span class=o>+=</span> <span class=nx>delta</span><span class=p>.</span><span class=nx>text</span><span class=p>;</span> <span class=c1>// å˜å¼‚
</span></span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å˜å¼‚ç‚¹ 2: å·¥å…·ç»“æœæ³¨å…¥
</span></span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>injectToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>history</span>: <span class=kt>CliMessage</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolResult</span>: <span class=kt>ToolResultBlock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>newMessage</span>: <span class=kt>CliMessage</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>isMeta</span>: <span class=kt>true</span><span class=p>,</span> <span class=c1>// ç³»ç»Ÿç”Ÿæˆ
</span></span></span><span class=line><span class=cl>      <span class=nx>message</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>content</span><span class=o>:</span> <span class=p>[</span><span class=nx>toolResult</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ... å…¶ä»–å­—æ®µ
</span></span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>history</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>newMessage</span><span class=p>);</span> <span class=c1>// å˜å¼‚
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å˜å¼‚ç‚¹ 3: æˆæœ¬è®¡ç®—
</span></span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>updateCostMetadata</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>CliMessage</span><span class=p>,</span> <span class=nx>usage</span>: <span class=kt>TokenUsage</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=p>.</span><span class=nx>costUSD</span> <span class=o>=</span> <span class=nx>calculateCost</span><span class=p>(</span><span class=nx>usage</span><span class=p>,</span> <span class=nx>message</span><span class=p>.</span><span class=nx>model</span><span class=p>);</span> <span class=c1>// å˜å¼‚
</span></span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=p>.</span><span class=nx>durationMs</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>-</span> <span class=nx>parseISO</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>timestamp</span><span class=p>);</span> <span class=c1>// å˜å¼‚
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=ç³»ç»Ÿæç¤º-åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£…>ç³»ç»Ÿæç¤º: åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£…<a hidden class=anchor aria-hidden=true href=#ç³»ç»Ÿæç¤º-åŠ¨æ€ä¸Šä¸‹æ–‡ç»„è£…>#</a></h2><p>å¯èƒ½æœ€å¤æ‚çš„æ•°æ®ç»“æ„æ˜¯åŠ¨æ€ç»„è£…çš„ç³»ç»Ÿæç¤º:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// ç³»ç»Ÿæç¤ºç»„è£…æµæ°´çº¿ (é‡æ„)
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>SystemPromptPipeline</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sources</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>baseInstructions</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// é™æ€åŸºç¡€
</span></span></span><span class=line><span class=cl>    <span class=nx>claudeMdContent</span>: <span class=kt>ClaudeMdLayer</span><span class=p>[];</span> <span class=c1>// åˆ†å±‚çš„
</span></span></span><span class=line><span class=cl>    <span class=nx>gitContext</span>: <span class=kt>GitContextData</span><span class=p>;</span> <span class=c1>// å®æ—¶
</span></span></span><span class=line><span class=cl>    <span class=nx>directoryStructure</span>: <span class=kt>TreeData</span><span class=p>;</span> <span class=c1>// ç¼“å­˜/æ–°é²œ
</span></span></span><span class=line><span class=cl>    <span class=nx>toolDefinitions</span>: <span class=kt>ToolSpec</span><span class=p>[];</span> <span class=c1>// å¯ç”¨å·¥å…·
</span></span></span><span class=line><span class=cl>    <span class=nx>modelAdaptations</span>: <span class=kt>ModelSpecificPrompt</span><span class=p>;</span> <span class=c1>// æ¯ä¸ªæ¨¡å‹
</span></span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>assembly</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>order</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;base&#34;</span><span class=p>,</span> <span class=s2>&#34;model&#34;</span><span class=p>,</span> <span class=s2>&#34;claude.md&#34;</span><span class=p>,</span> <span class=s2>&#34;git&#34;</span><span class=p>,</span> <span class=s2>&#34;files&#34;</span><span class=p>,</span> <span class=s2>&#34;tools&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>separators</span>: <span class=kt>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>string</span><span class=p>&gt;;</span> <span class=c1>// éƒ¨åˆ†åˆ†éš”ç¬¦
</span></span></span><span class=line><span class=cl>    <span class=nx>sizeLimit</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// Token é¢„ç®—
</span></span></span><span class=line><span class=cl>    <span class=nx>prioritization</span><span class=o>:</span> <span class=s2>&#34;recency&#34;</span> <span class=o>|</span> <span class=s2>&#34;relevance&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// GitContext ç»“æ„æ­ç¤ºäº†å®æ—¶æ„ŸçŸ¥
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>GitContextData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>currentBranch</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>modified</span>: <span class=kt>string</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=nx>untracked</span>: <span class=kt>string</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=nx>staged</span>: <span class=kt>string</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>recentCommits</span>: <span class=kt>Array</span><span class=o>&lt;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>hash</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>author</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>uncommittedDiff?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// æ˜‚è´µ,æœ‰æ¡ä»¶
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=å†…å­˜å¸ƒå±€-claudemd-åˆ†å±‚åŠ è½½>å†…å­˜å¸ƒå±€: CLAUDE.md åˆ†å±‚åŠ è½½<a hidden class=anchor aria-hidden=true href=#å†…å­˜å¸ƒå±€-claudemd-åˆ†å±‚åŠ è½½>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>é¡¹ç›®æ ¹ç›®å½•
</span></span><span class=line><span class=cl>â”œâ”€â”€ .claude/
</span></span><span class=line><span class=cl>â”‚   â”œâ”€â”€ CLAUDE.md (æœ¬åœ° - æœ€é«˜ä¼˜å…ˆçº§)
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ settings.json
</span></span><span class=line><span class=cl>â”œâ”€â”€ ~/
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ .claude/
</span></span><span class=line><span class=cl>â”‚       â””â”€â”€ CLAUDE.md (ç”¨æˆ· - ç¬¬äºŒä¼˜å…ˆçº§)
</span></span><span class=line><span class=cl>â”œâ”€â”€ &lt;project-root&gt;/
</span></span><span class=line><span class=cl>â”‚   â””â”€â”€ .claude/
</span></span><span class=line><span class=cl>â”‚       â””â”€â”€ CLAUDE.md (é¡¹ç›® - ç¬¬ä¸‰ä¼˜å…ˆçº§)
</span></span><span class=line><span class=cl>â””â”€â”€ /etc/claude-code/
</span></span><span class=line><span class=cl>    â””â”€â”€ CLAUDE.md (æ‰˜ç®¡ - æœ€ä½ä¼˜å…ˆçº§)
</span></span></code></pre></div><p>åŠ è½½æœºåˆ¶å®ç°äº†é«˜æ•ˆçš„åˆå¹¶ç­–ç•¥:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æ¨æ–­çš„ CLAUDE.md åŠ è½½ç®—æ³•
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ClaudeMdLoader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=p>{</span> <span class=na>content</span><span class=err>:</span> <span class=na>string</span><span class=err>;</span> <span class=na>mtime</span><span class=err>:</span> <span class=na>number</span> <span class=p>}&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>loadMerged</span><span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>layers</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;/etc/claude-code/CLAUDE.md&#34;</span><span class=p>,</span> <span class=c1>// æ‰˜ç®¡
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;~/.claude/CLAUDE.md&#34;</span><span class=p>,</span> <span class=c1>// ç”¨æˆ·
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;&lt;project&gt;/.claude/CLAUDE.md&#34;</span><span class=p>,</span> <span class=c1>// é¡¹ç›®
</span></span></span><span class=line><span class=cl>      <span class=s2>&#34;.claude/CLAUDE.md&#34;</span><span class=p>,</span> <span class=c1>// æœ¬åœ°
</span></span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>contents</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>path</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>loadWithCache</span><span class=p>(</span><span class=nx>path</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ä½¿ç”¨è¦†ç›–è¯­ä¹‰åˆå¹¶
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>mergeWithOverrides</span><span class=p>(</span><span class=nx>contents</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>mergeWithOverrides</span><span class=p>(</span><span class=nx>contents</span>: <span class=kt>string</span><span class=p>[])</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åé¢çš„å±‚è¦†ç›–å‰é¢çš„å±‚
</span></span></span><span class=line><span class=cl>    <span class=c1>// @override æŒ‡ä»¤ç”¨äºæ˜¾å¼è¦†ç›–
</span></span></span><span class=line><span class=cl>    <span class=c1>// @append æŒ‡ä»¤ç”¨äºæ·»åŠ 
</span></span></span><span class=line><span class=cl>    <span class=c1>// é»˜è®¤: ç”¨åˆ†éš”ç¬¦è¿æ¥
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=å·¥å…·ç›¸å…³çš„æ•°æ®ç»“æ„>å·¥å…·ç›¸å…³çš„æ•°æ®ç»“æ„<a hidden class=anchor aria-hidden=true href=#å·¥å…·ç›¸å…³çš„æ•°æ®ç»“æ„>#</a></h2><h3 id=tooldefinition-å®Œæ•´çš„å·¥å…·æ¥å£>ToolDefinition: å®Œæ•´çš„å·¥å…·æ¥å£<a hidden class=anchor aria-hidden=true href=#tooldefinition-å®Œæ•´çš„å·¥å…·æ¥å£>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>ToolDefinition</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ ‡è¯†
</span></span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>description</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>prompt?</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// é¢å¤–çš„ LLM æŒ‡ä»¤
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ¨¡å¼ (åŒé‡è¡¨ç¤º)
</span></span></span><span class=line><span class=cl>  <span class=nx>inputSchema</span>: <span class=kt>ZodSchema</span><span class=p>;</span> <span class=c1>// è¿è¡Œæ—¶éªŒè¯
</span></span></span><span class=line><span class=cl>  <span class=nx>inputJSONSchema?</span>: <span class=kt>JSONSchema</span><span class=p>;</span> <span class=c1>// LLM é€šä¿¡
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ‰§è¡Œ
</span></span></span><span class=line><span class=cl>  <span class=nx>call</span>: <span class=kt>AsyncGenerator</span><span class=p>&lt;</span><span class=nt>ToolProgress</span> <span class=err>|</span> <span class=na>ToolResult</span><span class=p>,</span> <span class=na>void</span><span class=p>,</span> <span class=na>void</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æƒé™
</span></span></span><span class=line><span class=cl>  <span class=nx>checkPermissions</span><span class=o>?:</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ToolUseContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>permContext</span>: <span class=kt>ToolPermissionContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PermissionDecision</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// è¾“å‡ºæ ¼å¼åŒ–
</span></span></span><span class=line><span class=cl>  <span class=nx>mapToolResultToToolResultBlockParam</span><span class=o>:</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>result</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>toolUseId</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>ContentBlock</span> <span class=o>|</span> <span class=nx>ContentBlock</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å…ƒæ•°æ®
</span></span></span><span class=line><span class=cl>  <span class=nx>isReadOnly</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isMcp?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isEnabled</span><span class=o>?:</span> <span class=p>(</span><span class=nx>config</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>getPath</span><span class=o>?:</span> <span class=p>(</span><span class=nx>input</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=kt>string</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// UI
</span></span></span><span class=line><span class=cl>  <span class=nx>renderToolUseMessage</span><span class=o>?:</span> <span class=p>(</span><span class=nx>input</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>ReactElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å·¥å…·å®šä¹‰çš„å†…å­˜ç‰¹æ€§
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>ToolDefinitionMemory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>staticSize</span><span class=o>:</span> <span class=s2>&#34;æ¯ä¸ªå·¥å…·çº¦ 2KB&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>zodSchema</span><span class=o>:</span> <span class=s2>&#34;å»¶è¿Ÿç¼–è¯‘,å·²ç¼“å­˜&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>jsonSchema</span><span class=o>:</span> <span class=s2>&#34;ç”Ÿæˆä¸€æ¬¡,è®°å¿†åŒ–&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>closures</span><span class=o>:</span> <span class=s2>&#34;ä¿ç•™ä¸Šä¸‹æ–‡å¼•ç”¨&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=æ‰§è¡Œä¸Šä¸‹æ–‡-å·¥å…·éœ€è¦çš„ä¸€åˆ‡>æ‰§è¡Œä¸Šä¸‹æ–‡: å·¥å…·éœ€è¦çš„ä¸€åˆ‡<a hidden class=anchor aria-hidden=true href=#æ‰§è¡Œä¸Šä¸‹æ–‡-å·¥å…·éœ€è¦çš„ä¸€åˆ‡>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>ToolUseContext</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å–æ¶ˆ
</span></span></span><span class=line><span class=cl>  <span class=nx>abortController</span>: <span class=kt>AbortController</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ–‡ä»¶çŠ¶æ€è·Ÿè¸ª
</span></span></span><span class=line><span class=cl>  <span class=nx>readFileState</span>: <span class=kt>Map</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>content</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>timestamp</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// mtime
</span></span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æƒé™è§£æ
</span></span></span><span class=line><span class=cl>  <span class=nx>getToolPermissionContext</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>ToolPermissionContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// é€‰é¡¹åŒ…
</span></span></span><span class=line><span class=cl>  <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>tools</span>: <span class=kt>ToolDefinition</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=nx>mainLoopModel</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>debug?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>verbose?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>isNonInteractiveSession?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>maxThinkingTokens?</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// MCP è¿æ¥
</span></span></span><span class=line><span class=cl>  <span class=nx>mcpClients?</span>: <span class=kt>McpClient</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æƒé™ä¸Šä¸‹æ–‡æ­ç¤ºäº†å¤æ‚çš„å®‰å…¨æ¨¡å‹
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>ToolPermissionContext</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mode</span><span class=o>:</span> <span class=s2>&#34;default&#34;</span> <span class=o>|</span> <span class=s2>&#34;acceptEdits&#34;</span> <span class=o>|</span> <span class=s2>&#34;bypassPermissions&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>additionalWorkingDirectories</span>: <span class=kt>Set</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// åˆ†å±‚è§„åˆ™ç³»ç»Ÿ
</span></span></span><span class=line><span class=cl>  <span class=nx>alwaysAllowRules</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>PermissionRuleScope</span><span class=p>,</span> <span class=na>string</span><span class=err>[]</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=nx>alwaysDenyRules</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>PermissionRuleScope</span><span class=p>,</span> <span class=na>string</span><span class=err>[]</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>PermissionRuleScope</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=s2>&#34;cliArg&#34;</span> <span class=c1>// æœ€é«˜ä¼˜å…ˆçº§
</span></span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=s2>&#34;localSettings&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=s2>&#34;projectSettings&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=s2>&#34;policySettings&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>|</span> <span class=s2>&#34;userSettings&#34;</span><span class=p>;</span> <span class=c1>// æœ€ä½ä¼˜å…ˆçº§
</span></span></span></code></pre></div><h2 id=mcp-åè®®ç»“æ„>MCP åè®®ç»“æ„<a hidden class=anchor aria-hidden=true href=#mcp-åè®®ç»“æ„>#</a></h2><p>å¤šäº‘/è¿›ç¨‹åè®®æ­ç¤ºäº†å¤æ‚çš„ RPC ç³»ç»Ÿ:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// JSON-RPC 2.0 åŠå…¶æ‰©å±•
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>McpMessage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>jsonrpc</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>id?</span>: <span class=kt>string</span> <span class=o>|</span> <span class=kt>number</span><span class=p>;</span> <span class=c1>// é€šçŸ¥å¯é€‰
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>McpRequest</span> <span class=kr>extends</span> <span class=nx>McpMessage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>method</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>params?</span>: <span class=kt>unknown</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>McpResponse</span> <span class=kr>extends</span> <span class=nx>McpMessage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span>: <span class=kt>string</span> <span class=o>|</span> <span class=kt>number</span><span class=p>;</span> <span class=c1>// å“åº”å¿…éœ€
</span></span></span><span class=line><span class=cl>  <span class=nx>result?</span>: <span class=kt>unknown</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span><span class=o>?:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>code</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>data?</span>: <span class=kt>unknown</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// èƒ½åŠ›åå•†ç»“æ„
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>McpCapabilities</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>experimental?</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>any</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// åŠŸèƒ½æ ‡å¿—
</span></span></span><span class=line><span class=cl>  <span class=nx>roots?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// å·¥ä½œåŒºæ ¹ç›®å½•
</span></span></span><span class=line><span class=cl>  <span class=nx>sampling?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// LLM é‡‡æ ·å§”æ‰˜
</span></span></span><span class=line><span class=cl>  <span class=nx>prompts?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// åŠ¨æ€æç¤º
</span></span></span><span class=line><span class=cl>  <span class=nx>resources?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// èµ„æºæœåŠ¡
</span></span></span><span class=line><span class=cl>  <span class=nx>tools?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// å·¥å…·æš´éœ²
</span></span></span><span class=line><span class=cl>  <span class=nx>logging?</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// æ—¥å¿—è½¬å‘
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// MCP æœåŠ¡å™¨å‘é€çš„å·¥å…·è§„èŒƒ
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>McpToolSpec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>description?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>inputSchema</span>: <span class=kt>JSONSchema</span><span class=p>;</span> <span class=c1>// å§‹ç»ˆæ˜¯ JSON Schema
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// MCP ç‰¹å®šå…ƒæ•°æ®
</span></span></span><span class=line><span class=cl>  <span class=nx>isReadOnly?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>requiresConfirmation?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>timeout?</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>maxRetries?</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=mcp-çŠ¶æ€æœº>MCP çŠ¶æ€æœº<a hidden class=anchor aria-hidden=true href=#mcp-çŠ¶æ€æœº>#</a></h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>stateDiagram-v2
    [*] --&gt; Disconnected
    Disconnected --&gt; Connecting: connect()
    Connecting --&gt; Initializing: ä¼ è¾“å°±ç»ª
    Initializing --&gt; Ready: èƒ½åŠ›å·²äº¤æ¢

    Ready --&gt; Ready: è¯·æ±‚/å“åº”
    Ready --&gt; Ready: é€šçŸ¥

    Ready --&gt; Closing: close()
    Connecting --&gt; Failed: é”™è¯¯
    Initializing --&gt; Failed: åå•†å¤±è´¥

    Closing --&gt; Disconnected: å·²å…³é—­
    Failed --&gt; Disconnected: é‡ç½®
</code></pre><h2 id=ä¼šè¯çŠ¶æ€-å…¨å±€å†…å­˜>ä¼šè¯çŠ¶æ€: å…¨å±€å†…å­˜<a hidden class=anchor aria-hidden=true href=#ä¼šè¯çŠ¶æ€-å…¨å±€å†…å­˜>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>SessionState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// æ ‡è¯†
</span></span></span><span class=line><span class=cl>  <span class=nx>sessionId</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// UUID v4
</span></span></span><span class=line><span class=cl>  <span class=nx>originalCwd</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cwd</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// å¯ä»¥é€šè¿‡ bash cd æ”¹å˜
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æˆæœ¬è·Ÿè¸ª (å¯å˜ç´¯åŠ å™¨)
</span></span></span><span class=line><span class=cl>  <span class=nx>totalCostUSD</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>totalAPIDuration</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>modelTokens</span>: <span class=kt>Record</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>inputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>outputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>cacheReadInputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>cacheCreationInputTokens</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ¨¡å‹é€‰æ‹©
</span></span></span><span class=line><span class=cl>  <span class=nx>mainLoopModelOverride?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>initialMainLoopModel?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ´»åŠ¨æŒ‡æ ‡
</span></span></span><span class=line><span class=cl>  <span class=nx>sessionCounter</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>locCounter</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// ä»£ç è¡Œæ•°
</span></span></span><span class=line><span class=cl>  <span class=nx>prCounter</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// Pull requests
</span></span></span><span class=line><span class=cl>  <span class=nx>commitCounter</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// Git commits
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// çŠ¶æ€æ ‡å¿—
</span></span></span><span class=line><span class=cl>  <span class=nx>lastInteractionTime</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>hasUnknownModelCost</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>maxRateLimitFallbackActive</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// å¯ç”¨æ¨¡å‹
</span></span></span><span class=line><span class=cl>  <span class=nx>modelStrings</span>: <span class=kt>string</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ä¼šè¯çŠ¶æ€è®¿é—®æ¨¡å¼ (æ¨æ–­)
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>SessionManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>state</span>: <span class=kt>SessionState</span><span class=p>;</span> <span class=c1>// å•ä¾‹
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>update</span><span class=p>&lt;</span><span class=nt>K</span> <span class=na>extends</span> <span class=na>keyof</span> <span class=na>SessionState</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span>: <span class=kt>K</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>value</span>: <span class=kt>SessionState</span><span class=p>[</span><span class=nx>K</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>persistToDisk</span><span class=p>();</span> <span class=c1>// å¼‚æ­¥,éé˜»å¡
</span></span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>increment</span><span class=p>(</span><span class=nx>metric</span>: <span class=kt>keyof</span> <span class=nx>SessionState</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>[</span><span class=nx>metric</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;number&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>[</span><span class=nx>metric</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=åŒå‘æµå¼å®ç°>åŒå‘æµå¼å®ç°<a hidden class=anchor aria-hidden=true href=#åŒå‘æµå¼å®ç°>#</a></h2><p>å¹³å°çº§æµå¼æ­ç¤ºäº†å¤æ‚çš„åè®®:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// åŒå‘æµå¼æœ‰æ•ˆè½½è·ç»“æ„
</span></span></span><span class=line><span class=cl><span class=kr>interface</span> <span class=nx>BidirectionalStreamingProtocol</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
</span></span></span><span class=line><span class=cl>  <span class=nx>clientPayload</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>bytes</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// Base64 ç¼–ç 
</span></span></span><span class=line><span class=cl>    <span class=nx>encoding</span><span class=o>:</span> <span class=s2>&#34;base64&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è§£ç çš„å†…å®¹ç±»å‹
</span></span></span><span class=line><span class=cl>    <span class=nx>contentTypes</span>: <span class=kt>ContinuedUserInput</span> <span class=o>|</span> <span class=nx>ToolResultBlock</span> <span class=o>|</span> <span class=nx>ConversationTurnInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
</span></span></span><span class=line><span class=cl>  <span class=nx>serverPayload</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>bytes</span>: <span class=kt>string</span><span class=p>;</span> <span class=c1>// Base64 ç¼–ç 
</span></span></span><span class=line><span class=cl>    <span class=nx>encoding</span><span class=o>:</span> <span class=s2>&#34;base64&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è§£ç çš„äº‹ä»¶ç±»å‹
</span></span></span><span class=line><span class=cl>    <span class=nx>eventTypes</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=o>|</span> <span class=nx>ContentBlockDeltaEvent</span>
</span></span><span class=line><span class=cl>      <span class=o>|</span> <span class=nx>ToolUseRequestEvent</span>
</span></span><span class=line><span class=cl>      <span class=o>|</span> <span class=nx>ErrorEvent</span>
</span></span><span class=line><span class=cl>      <span class=o>|</span> <span class=nx>MetadataEvent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åŒå‘æµçš„æµå¼çŠ¶æ€æœº
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>BidirectionalStreamManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>encoder</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TextEncoder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>decoder</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TextDecoder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=mi>65536</span><span class=p>);</span> <span class=c1>// 64KB ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=o>*</span><span class=nx>processStream</span><span class=p>(</span><span class=nx>stream</span>: <span class=kt>ReadableStream</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>reader</span> <span class=o>=</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>getReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>partial</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>done</span><span class=p>,</span> <span class=nx>value</span> <span class=p>}</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>reader</span><span class=p>.</span><span class=nx>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// è§£ç å¹¶æŒ‰æ¢è¡Œç¬¦åˆ†å‰² (SSE æ ¼å¼)
</span></span></span><span class=line><span class=cl>      <span class=nx>partial</span> <span class=o>+=</span> <span class=k>this</span><span class=p>.</span><span class=nx>decoder</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=p>{</span> <span class=nx>stream</span>: <span class=kt>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>lines</span> <span class=o>=</span> <span class=nx>partial</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&#34;\n&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>partial</span> <span class=o>=</span> <span class=nx>lines</span><span class=p>.</span><span class=nx>pop</span><span class=p>()</span> <span class=o>||</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>line</span> <span class=k>of</span> <span class=nx>lines</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>line</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s2>&#34;data: &#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>line</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>6</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span> <span class=k>this</span><span class=p>.</span><span class=nx>decodePayload</span><span class=p>(</span><span class=nx>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>decodePayload</span><span class=p>(</span><span class=nx>payload</span>: <span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>bytes</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>payload</span><span class=p>.</span><span class=nx>bytes</span><span class=p>,</span> <span class=s2>&#34;base64&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¹æ®åè®®ç¼“å†²åŒºæˆ– JSON è¿›ä¸€æ­¥è§£ç 
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>toString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=æ•°æ®ç»“æ„ä¸­çš„æ€§èƒ½ä¼˜åŒ–>æ•°æ®ç»“æ„ä¸­çš„æ€§èƒ½ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#æ•°æ®ç»“æ„ä¸­çš„æ€§èƒ½ä¼˜åŒ–>#</a></h2><h3 id=1-å¸¸è§å€¼çš„å­—ç¬¦ä¸²é©»ç•™>1. <strong>å¸¸è§å€¼çš„å­—ç¬¦ä¸²é©»ç•™</strong><a hidden class=anchor aria-hidden=true href=#1-å¸¸è§å€¼çš„å­—ç¬¦ä¸²é©»ç•™>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// æ¨æ–­çš„å­—ç¬¦ä¸²é©»ç•™æ¨¡å¼
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>StringIntern</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>static</span> <span class=nx>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>string</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>intern</span><span class=p>(</span><span class=nx>str</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>str</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>str</span><span class=p>,</span> <span class=nx>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åœ¨æ¶ˆæ¯å¤„ç†ä¸­çš„ä½¿ç”¨
</span></span></span><span class=line><span class=cl><span class=nx>message</span><span class=p>.</span><span class=kr>type</span> <span class=o>=</span> <span class=nx>StringIntern</span><span class=p>.</span><span class=nx>intern</span><span class=p>(</span><span class=nx>rawType</span><span class=p>);</span> <span class=c1>// &#39;user&#39;, &#39;assistant&#39; ç­‰
</span></span></span><span class=line><span class=cl><span class=nx>message</span><span class=p>.</span><span class=nx>stop_reason</span> <span class=o>=</span> <span class=nx>StringIntern</span><span class=p>.</span><span class=nx>intern</span><span class=p>(</span><span class=nx>reason</span><span class=p>);</span> <span class=c1>// &#39;end_turn&#39;, &#39;tool_use&#39; ç­‰
</span></span></span></code></pre></div><h3 id=2-å»¶è¿Ÿå†…å®¹å—è§£æ>2. <strong>å»¶è¿Ÿå†…å®¹å—è§£æ</strong><a hidden class=anchor aria-hidden=true href=#2-å»¶è¿Ÿå†…å®¹å—è§£æ>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// å†…å®¹å—å¯èƒ½ä½¿ç”¨å»¶è¿Ÿè§£æä»¥æé«˜æ€§èƒ½
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>LazyContentBlock</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>_raw</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>_parsed?</span>: <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>raw</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_raw</span> <span class=o>=</span> <span class=nx>raw</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>content() {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>_parsed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>_parsed</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_raw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_parsed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>raw</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä»…åœ¨è®¿é—®æ—¶è¿›è¡Œæ˜‚è´µçš„è§£æ
</span></span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>raw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=3-readfilestate-å¼±å¼•ç”¨>3. <strong>ReadFileState å¼±å¼•ç”¨</strong><a hidden class=anchor aria-hidden=true href=#3-readfilestate-å¼±å¼•ç”¨>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=c1>// å…·æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†çš„æ–‡ä»¶ç¼“å­˜
</span></span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ReadFileState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>,</span> <span class=na>WeakRef</span><span class=p>&lt;</span><span class=nt>FileContent</span><span class=p>&gt;&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>registry</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FinalizationRegistry</span><span class=p>((</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>set</span><span class=p>(</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>content</span>: <span class=kt>FileContent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ref</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakRef</span><span class=p>(</span><span class=nx>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>ref</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>registry</span><span class=p>.</span><span class=nx>register</span><span class=p>(</span><span class=nx>content</span><span class=p>,</span> <span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>get</span><span class=p>(</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>FileContent</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ref</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>ref</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>content</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>.</span><span class=nx>deref</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://starslayerx.github.io/tags/agent/>Agent</a></li></ul><nav class=paginav><a class=prev href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-03%E6%8E%A7%E5%88%B6%E6%B5%81/><span class=title>Â« Prev</span><br><span>Claude Code åˆ†æ 03ï¼šæ§åˆ¶æµ</span>
</a><a class=next href=https://starslayerx.github.io/posts/claude-code-%E5%88%86%E6%9E%90-01%E4%BE%9D%E8%B5%96%E9%A1%B9/><span class=title>Next Â»</span><br><span>Claude Code åˆ†æ 01ï¼šä¾èµ–é¡¹</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on x" href="https://x.com/intent/tweet/?text=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f&amp;hashtags=Agent"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f&amp;title=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84&amp;summary=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84&amp;source=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f&title=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on whatsapp" href="https://api.whatsapp.com/send?text=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%20-%20https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on telegram" href="https://telegram.me/share/url?text=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Claude Code åˆ†æ 02ï¼šæ•°æ®ç»“æ„ on ycombinator" href="https://news.ycombinator.com/submitlink?t=Claude%20Code%20%e5%88%86%e6%9e%90%2002%ef%bc%9a%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84&u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fclaude-code-%25E5%2588%2586%25E6%259E%2590-02%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%2593%25E6%259E%2584%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://starslayerx.github.io/>Starslayerx' Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>