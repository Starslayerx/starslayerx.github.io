<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>FastAPI app and request | Starslayerx' Blog</title><meta name=keywords content="FastAPI"><meta name=description content='在 FastAPI 中，Request 对象和 FastAPI 应用实例 (app) 是核心概念，它们在应用状态管理和依赖注入中扮演着关键角色。
本文将介绍它们的关系、设计理念，以及如何利用 app.state 实现单例模式。

FastAPI 对象
FastAPI 对象是整个应用的核心实例：
from fastapi import FastAPI

app = FastAPI(title="示例应用")
核心职责

路由管理：通过 @app.get()、@app.post() 等装饰器定义 URL 到视图函数的映射。
中间件和事件管理：可注册中间件处理请求/响应，支持 startup 与 shutdown 事件。
应用状态管理：提供 app.state，可存放全局单例对象、数据库连接池、配置等。
异常处理与依赖注入：管理异常处理器，并协助依赖注入机制。

单例模式存储
这里要使用 app 的 State 对象存储单例，app 中定义如下
# app
self.state: Annotated[
    State,
    Doc(
        """
        A state object for the application. This is the same object for the
        entire application, it doesn&#39;t change from request to request.

        You normally wouldn&#39;t use this in FastAPI, for most of the cases you
        would instead use FastAPI dependencies.

        This is simply inherited from Starlette.

        Read more about it in the
        [Starlette docs for Applications](https://www.starlette.dev/applications/#storing-state-on-the-app-instance).
        """
    ),
] = State()
State 源码如下，简单看就是一个字典'><meta name=author content="Starslayerx"><link rel=canonical href=https://starslayerx.github.io/posts/fastapi-app-and-request/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://starslayerx.github.io/favicon.svg><link rel=apple-touch-icon href=https://starslayerx.github.io/favicon.svg><link rel=mask-icon href=https://starslayerx.github.io/favicon.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://starslayerx.github.io/posts/fastapi-app-and-request/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://starslayerx.github.io/posts/fastapi-app-and-request/"><meta property="og:site_name" content="Starslayerx' Blog"><meta property="og:title" content="FastAPI app and request"><meta property="og:description" content='在 FastAPI 中，Request 对象和 FastAPI 应用实例 (app) 是核心概念，它们在应用状态管理和依赖注入中扮演着关键角色。 本文将介绍它们的关系、设计理念，以及如何利用 app.state 实现单例模式。
FastAPI 对象 FastAPI 对象是整个应用的核心实例：
from fastapi import FastAPI app = FastAPI(title="示例应用") 核心职责 路由管理：通过 @app.get()、@app.post() 等装饰器定义 URL 到视图函数的映射。 中间件和事件管理：可注册中间件处理请求/响应，支持 startup 与 shutdown 事件。 应用状态管理：提供 app.state，可存放全局单例对象、数据库连接池、配置等。 异常处理与依赖注入：管理异常处理器，并协助依赖注入机制。 单例模式存储 这里要使用 app 的 State 对象存储单例，app 中定义如下
# app self.state: Annotated[ State, Doc( """ A state object for the application. This is the same object for the entire application, it doesn&#39;t change from request to request. You normally wouldn&#39;t use this in FastAPI, for most of the cases you would instead use FastAPI dependencies. This is simply inherited from Starlette. Read more about it in the [Starlette docs for Applications](https://www.starlette.dev/applications/#storing-state-on-the-app-instance). """ ), ] = State() State 源码如下，简单看就是一个字典'><meta property="og:locale" content="en-US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-25T08:00:00+08:00"><meta property="article:modified_time" content="2025-11-25T08:00:00+08:00"><meta property="article:tag" content="FastAPI"><meta property="og:image" content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:title content="FastAPI app and request"><meta name=twitter:description content='在 FastAPI 中，Request 对象和 FastAPI 应用实例 (app) 是核心概念，它们在应用状态管理和依赖注入中扮演着关键角色。
本文将介绍它们的关系、设计理念，以及如何利用 app.state 实现单例模式。

FastAPI 对象
FastAPI 对象是整个应用的核心实例：
from fastapi import FastAPI

app = FastAPI(title="示例应用")
核心职责

路由管理：通过 @app.get()、@app.post() 等装饰器定义 URL 到视图函数的映射。
中间件和事件管理：可注册中间件处理请求/响应，支持 startup 与 shutdown 事件。
应用状态管理：提供 app.state，可存放全局单例对象、数据库连接池、配置等。
异常处理与依赖注入：管理异常处理器，并协助依赖注入机制。

单例模式存储
这里要使用 app 的 State 对象存储单例，app 中定义如下
# app
self.state: Annotated[
    State,
    Doc(
        """
        A state object for the application. This is the same object for the
        entire application, it doesn&#39;t change from request to request.

        You normally wouldn&#39;t use this in FastAPI, for most of the cases you
        would instead use FastAPI dependencies.

        This is simply inherited from Starlette.

        Read more about it in the
        [Starlette docs for Applications](https://www.starlette.dev/applications/#storing-state-on-the-app-instance).
        """
    ),
] = State()
State 源码如下，简单看就是一个字典'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://starslayerx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"FastAPI app and request","item":"https://starslayerx.github.io/posts/fastapi-app-and-request/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"FastAPI app and request","name":"FastAPI app and request","description":"在 FastAPI 中，Request 对象和 FastAPI 应用实例 (app) 是核心概念，它们在应用状态管理和依赖注入中扮演着关键角色。 本文将介绍它们的关系、设计理念，以及如何利用 app.state 实现单例模式。\nFastAPI 对象 FastAPI 对象是整个应用的核心实例：\nfrom fastapi import FastAPI app = FastAPI(title=\u0026#34;示例应用\u0026#34;) 核心职责 路由管理：通过 @app.get()、@app.post() 等装饰器定义 URL 到视图函数的映射。 中间件和事件管理：可注册中间件处理请求/响应，支持 startup 与 shutdown 事件。 应用状态管理：提供 app.state，可存放全局单例对象、数据库连接池、配置等。 异常处理与依赖注入：管理异常处理器，并协助依赖注入机制。 单例模式存储 这里要使用 app 的 State 对象存储单例，app 中定义如下\n# app self.state: Annotated[ State, Doc( \u0026#34;\u0026#34;\u0026#34; A state object for the application. This is the same object for the entire application, it doesn\u0026#39;t change from request to request. You normally wouldn\u0026#39;t use this in FastAPI, for most of the cases you would instead use FastAPI dependencies. This is simply inherited from Starlette. Read more about it in the [Starlette docs for Applications](https://www.starlette.dev/applications/#storing-state-on-the-app-instance). \u0026#34;\u0026#34;\u0026#34; ), ] = State() State 源码如下，简单看就是一个字典\n","keywords":["FastAPI"],"articleBody":"在 FastAPI 中，Request 对象和 FastAPI 应用实例 (app) 是核心概念，它们在应用状态管理和依赖注入中扮演着关键角色。 本文将介绍它们的关系、设计理念，以及如何利用 app.state 实现单例模式。\nFastAPI 对象 FastAPI 对象是整个应用的核心实例：\nfrom fastapi import FastAPI app = FastAPI(title=\"示例应用\") 核心职责 路由管理：通过 @app.get()、@app.post() 等装饰器定义 URL 到视图函数的映射。 中间件和事件管理：可注册中间件处理请求/响应，支持 startup 与 shutdown 事件。 应用状态管理：提供 app.state，可存放全局单例对象、数据库连接池、配置等。 异常处理与依赖注入：管理异常处理器，并协助依赖注入机制。 单例模式存储 这里要使用 app 的 State 对象存储单例，app 中定义如下\n# app self.state: Annotated[ State, Doc( \"\"\" A state object for the application. This is the same object for the entire application, it doesn't change from request to request. You normally wouldn't use this in FastAPI, for most of the cases you would instead use FastAPI dependencies. This is simply inherited from Starlette. Read more about it in the [Starlette docs for Applications](https://www.starlette.dev/applications/#storing-state-on-the-app-instance). \"\"\" ), ] = State() State 源码如下，简单看就是一个字典\n# State class State: \"\"\" An object that can be used to store arbitrary state. Used for `request.state` and `app.state`. \"\"\" _state: dict[str, Any] def __init__(self, state: dict[str, Any] | None = None): if state is None: state = {} super().__setattr__(\"_state\", state) def __setattr__(self, key: Any, value: Any) -\u003e None: self._state[key] = value def __getattr__(self, key: Any) -\u003e Any: try: return self._state[key] except KeyError: message = \"'{}' object has no attribute '{}'\" raise AttributeError(message.format(self.__class__.__name__, key)) def __delattr__(self, key: Any) -\u003e None: del self._state[key] 使用示例\n@asynccontextmanager async def lifespan(app: FastAPI) -\u003e AsyncGenerator[None, None]: \"\"\" FastAPI 应用生命周期管理 启动时初始化资源,关闭时清理资源 \"\"\" # 初始化单例 print(\"[应用启动] 创建 Admin Agent 服务实例...\") admin_agent_service = AdminService(mcp_server_configuration) app.state.admin_agent_service = admin_agent_service await admin_agent_service.initialize() # 立即初始化 Agent yield # 应用运行其间 # 关闭数据库连接池 await close_database() # 关闭 Redis 连接 await close_redis() 当需要获取该单例的时候，通过依赖注入得到\ndef get_admin_service(request: Request) -\u003e AdminService: \"\"\"获取 Admin Agent 服务实例 (app.state)\"\"\" return request.app.state.admin_agent_service @app.post() async def send_admin_message(request: Request) -\u003e StreamingResponse: ... # 获取 Admin Agent 服务实例 admin_service = get_admin_service(request) ... return StreamingResponse( media_type=\"application/x-ndjson\", headers={ \"Cache-Control\": \"no-cache\", \"Connection\": \"keep-alive\", \"X-Accel-Buffering\": \"no\", } ) 作用：确保整个应用中只有一个 AdminService 实例被创建和共享。 优势： 避免重复初始化资源 统一管理全局服务 可在请求中安全访问 Request 对象 Request 对象封装了一次 HTTP 请求的上下文：\ndef get_admin_service(request: Request) -\u003e AdminService: \"\"\"获取 Admin Agent 服务实例 (app.state)\"\"\" return request.app.state.admin_agent_service 核心职责 封装请求信息：包含方法、路径、headers、query 参数、body 等。 提供应用访问入口：request.app 指向该请求所属的 FastAPI 实例。 支持依赖注入：可以作为依赖函数参数，让函数获取应用状态或服务实例。 Request 与 app 的关联\n解耦请求与全局变量\n请求处理函数无需直接引用全局 app，通过 request.app 即可访问应用实例和状态。\n支持多实例应用\n同一个 Python 进程可以启动多个 FastAPI 实例，每个实例的 state 独立。请求绑定到具体实例，request.app 指向对应实例。\n依赖注入友好\n在依赖函数中，通过 Request 获取 app.state 中的单例对象：\nfrom fastapi import Depends def get_admin_service(request: Request) -\u003e AdminService: return request.app.state.admin_service @app.get(\"/admin\") async def admin_endpoint(service: AdminService = Depends(get_admin_service)): return {\"message\": service.hello()} 工作流程： FastAPI 收到请求，创建 Request 对象。 DI 系统调用 get_admin_service，将 Request 注入。 函数通过 request.app.state.admin_service 获取全局单例。 依赖对象传入 endpoint。 总结 app：FastAPI 实例，负责路由、事件、中间件、依赖和状态管理。 app.state：存储单例对象和全局资源，实现单例模式。 Request：每次请求的封装，携带请求信息和对 app 的引用。 request.app.state：结合依赖注入，让每个请求安全访问全局单例对象，无需使用全局变量。 这种设计模式既保证了应用单例对象的统一管理，又支持依赖注入和多实例应用，非常适合现代 Web 应用开发。\n","wordCount":"388","inLanguage":"en","image":"https://starslayerx.github.io/images/og-default.avif","datePublished":"2025-11-25T08:00:00+08:00","dateModified":"2025-11-25T08:00:00+08:00","author":{"@type":"Person","name":"Starslayerx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://starslayerx.github.io/posts/fastapi-app-and-request/"},"publisher":{"@type":"Organization","name":"Starslayerx' Blog","logo":{"@type":"ImageObject","url":"https://starslayerx.github.io/favicon.svg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://starslayerx.github.io/ accesskey=h title="Starslayerx' Blog (Alt + H)"><img src=https://starslayerx.github.io/favicon.svg alt aria-label=logo height=35>Starslayerx' Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://starslayerx.github.io/zh-cn/ title=简体中文 aria-label=简体中文>Zh-Cn</a></li></ul></div></div><ul id=menu><li><a href=https://starslayerx.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://starslayerx.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://starslayerx.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://starslayerx.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://starslayerx.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://starslayerx.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://starslayerx.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">FastAPI app and request</h1><div class=post-meta><span title='2025-11-25 08:00:00 +0800 +0800'>November 25, 2025</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>388 words</span>&nbsp;·&nbsp;<span>Starslayerx</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#fastapi-对象>FastAPI 对象</a><ul><li><a href=#核心职责>核心职责</a></li><li><a href=#单例模式存储>单例模式存储</a></li></ul></li><li><a href=#request-对象>Request 对象</a><ul><li><a href=#核心职责-1>核心职责</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></details></div><div class=post-content><p>在 FastAPI 中，<code>Request</code> 对象和 <code>FastAPI</code> 应用实例 (<code>app</code>) 是核心概念，它们在应用状态管理和依赖注入中扮演着关键角色。
本文将介绍它们的关系、设计理念，以及如何利用 <code>app.state</code> 实现单例模式。</p><hr><h2 id=fastapi-对象>FastAPI 对象<a hidden class=anchor aria-hidden=true href=#fastapi-对象>#</a></h2><p><code>FastAPI</code> 对象是整个应用的核心实例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>title</span><span class=o>=</span><span class=s2>&#34;示例应用&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=核心职责>核心职责<a hidden class=anchor aria-hidden=true href=#核心职责>#</a></h3><ul><li><strong>路由管理</strong>：通过 <code>@app.get()</code>、<code>@app.post()</code> 等装饰器定义 URL 到视图函数的映射。</li><li><strong>中间件和事件管理</strong>：可注册中间件处理请求/响应，支持 <code>startup</code> 与 <code>shutdown</code> 事件。</li><li><strong>应用状态管理</strong>：提供 <code>app.state</code>，可存放全局单例对象、数据库连接池、配置等。</li><li><strong>异常处理与依赖注入</strong>：管理异常处理器，并协助依赖注入机制。</li></ul><h3 id=单例模式存储>单例模式存储<a hidden class=anchor aria-hidden=true href=#单例模式存储>#</a></h3><p>这里要使用 app 的 State 对象存储单例，app 中定义如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># app</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>state</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>State</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Doc</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        A state object for the application. This is the same object for the
</span></span></span><span class=line><span class=cl><span class=s2>        entire application, it doesn&#39;t change from request to request.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        You normally wouldn&#39;t use this in FastAPI, for most of the cases you
</span></span></span><span class=line><span class=cl><span class=s2>        would instead use FastAPI dependencies.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        This is simply inherited from Starlette.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Read more about it in the
</span></span></span><span class=line><span class=cl><span class=s2>        [Starlette docs for Applications](https://www.starlette.dev/applications/#storing-state-on-the-app-instance).
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span> <span class=o>=</span> <span class=n>State</span><span class=p>()</span>
</span></span></code></pre></div><p>State 源码如下，简单看就是一个字典</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=c1># State</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>State</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    An object that can be used to store arbitrary state.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Used for `request.state` and `app.state`.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_state</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>state</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>state</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__setattr__</span><span class=p>(</span><span class=s2>&#34;_state&#34;</span><span class=p>,</span> <span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__setattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_state</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Any</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_state</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span> <span class=o>=</span> <span class=s2>&#34;&#39;</span><span class=si>{}</span><span class=s2>&#39; object has no attribute &#39;</span><span class=si>{}</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>AttributeError</span><span class=p>(</span><span class=n>message</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__delattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>_state</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span></code></pre></div><p>使用示例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>lifespan</span><span class=p>(</span><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AsyncGenerator</span><span class=p>[</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    FastAPI 应用生命周期管理
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    启动时初始化资源,关闭时清理资源
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 初始化单例</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[应用启动] 创建 Admin Agent 服务实例...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>admin_agent_service</span> <span class=o>=</span> <span class=n>AdminService</span><span class=p>(</span><span class=n>mcp_server_configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>admin_agent_service</span> <span class=o>=</span> <span class=n>admin_agent_service</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>admin_agent_service</span><span class=o>.</span><span class=n>initialize</span><span class=p>()</span>  <span class=c1># 立即初始化 Agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>yield</span>  <span class=c1># 应用运行其间</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 关闭数据库连接池</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>close_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 关闭 Redis 连接</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>close_redis</span><span class=p>()</span>
</span></span></code></pre></div><p>当需要获取该单例的时候，通过依赖注入得到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_admin_service</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AdminService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取 Admin Agent 服务实例 (app.state)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>request</span><span class=o>.</span><span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>admin_agent_service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>send_admin_message</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>StreamingResponse</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取 Admin Agent 服务实例</span>
</span></span><span class=line><span class=cl>    <span class=n>admin_service</span> <span class=o>=</span> <span class=n>get_admin_service</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>StreamingResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>media_type</span><span class=o>=</span><span class=s2>&#34;application/x-ndjson&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Cache-Control&#34;</span><span class=p>:</span> <span class=s2>&#34;no-cache&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Connection&#34;</span><span class=p>:</span> <span class=s2>&#34;keep-alive&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;X-Accel-Buffering&#34;</span><span class=p>:</span> <span class=s2>&#34;no&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><ul><li><strong>作用</strong>：确保整个应用中只有一个 <code>AdminService</code> 实例被创建和共享。</li><li><strong>优势</strong>：<ul><li>避免重复初始化资源</li><li>统一管理全局服务</li><li>可在请求中安全访问</li></ul></li></ul><h2 id=request-对象>Request 对象<a hidden class=anchor aria-hidden=true href=#request-对象>#</a></h2><p><code>Request</code> 对象封装了一次 HTTP 请求的上下文：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_admin_service</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AdminService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取 Admin Agent 服务实例 (app.state)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>request</span><span class=o>.</span><span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>admin_agent_service</span>
</span></span></code></pre></div><h3 id=核心职责-1>核心职责<a hidden class=anchor aria-hidden=true href=#核心职责-1>#</a></h3><ul><li><strong>封装请求信息</strong>：包含方法、路径、headers、query 参数、body 等。</li><li><strong>提供应用访问入口</strong>：<code>request.app</code> 指向该请求所属的 <code>FastAPI</code> 实例。</li><li><strong>支持依赖注入</strong>：可以作为依赖函数参数，让函数获取应用状态或服务实例。</li></ul><p><code>Request</code> 与 <code>app</code> 的关联</p><ol><li><p><strong>解耦请求与全局变量</strong></p><p>请求处理函数无需直接引用全局 <code>app</code>，通过 <code>request.app</code> 即可访问应用实例和状态。</p></li><li><p><strong>支持多实例应用</strong></p><p>同一个 Python 进程可以启动多个 FastAPI 实例，每个实例的 <code>state</code> 独立。请求绑定到具体实例，<code>request.app</code> 指向对应实例。</p></li><li><p><strong>依赖注入友好</strong></p><p>在依赖函数中，通过 <code>Request</code> 获取 <code>app.state</code> 中的单例对象：</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Depends</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_admin_service</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AdminService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>request</span><span class=o>.</span><span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>admin_service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/admin&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>admin_endpoint</span><span class=p>(</span><span class=n>service</span><span class=p>:</span> <span class=n>AdminService</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_admin_service</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=n>service</span><span class=o>.</span><span class=n>hello</span><span class=p>()}</span>
</span></span></code></pre></div><ul><li><strong>工作流程</strong>：<ol><li>FastAPI 收到请求，创建 <code>Request</code> 对象。</li><li>DI 系统调用 <code>get_admin_service</code>，将 <code>Request</code> 注入。</li><li>函数通过 <code>request.app.state.admin_service</code> 获取全局单例。</li><li>依赖对象传入 endpoint。</li></ol></li></ul><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><ul><li><code>app</code>：FastAPI 实例，负责路由、事件、中间件、依赖和状态管理。</li><li><code>app.state</code>：存储单例对象和全局资源，实现单例模式。</li><li><code>Request</code>：每次请求的封装，携带请求信息和对 <code>app</code> 的引用。</li><li><code>request.app.state</code>：结合依赖注入，让每个请求安全访问全局单例对象，无需使用全局变量。</li></ul><p>这种设计模式既保证了应用单例对象的统一管理，又支持依赖注入和多实例应用，非常适合现代 Web 应用开发。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://starslayerx.github.io/tags/fastapi/>FastAPI</a></li></ul><nav class=paginav><a class=prev href=https://starslayerx.github.io/posts/docker-context/><span class=title>« Prev</span><br><span>Docker Context</span>
</a><a class=next href=https://starslayerx.github.io/posts/python-asyncio-02-asyncio-basics-part-2/><span class=title>Next »</span><br><span>Python Asyncio 02: Asyncio Basics Part 2</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on x" href="https://x.com/intent/tweet/?text=FastAPI%20app%20and%20request&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f&amp;hashtags=FastAPI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f&amp;title=FastAPI%20app%20and%20request&amp;summary=FastAPI%20app%20and%20request&amp;source=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f&title=FastAPI%20app%20and%20request"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on whatsapp" href="https://api.whatsapp.com/send?text=FastAPI%20app%20and%20request%20-%20https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on telegram" href="https://telegram.me/share/url?text=FastAPI%20app%20and%20request&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FastAPI app and request on ycombinator" href="https://news.ycombinator.com/submitlink?t=FastAPI%20app%20and%20request&u=https%3a%2f%2fstarslayerx.github.io%2fposts%2ffastapi-app-and-request%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://starslayerx.github.io/>Starslayerx' Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>