<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Microservice with FastAPI | Starslayerx' Blog</title><meta name=keywords content="Microservice,FastAPI"><meta name=description content="What are microservices ?
什么是微服务? 微服务可以有多种不同的定义方式, 具体取决于希望强调微服务架构的哪个方面, 不同作者会给出略有不同但相关的定义
Sam Newman, 微服务领域最有影响力的作者之一, 给出了一个极简的定义:

“Microservices are small, autonomous services that work together.”

这个定义强调了这样一个事实: 微服务是彼此独立运行的应用程序, 但它们可以协作完成任务. 该定义还强调微服务是 “small (小的)”, 这里的 small 并不是指微服务代码量的大小, 而是指微服务具有狭窄且定义清晰的职责范围, 符合单一职责原则(Single Responsibility Principle) —— 即“只做一件事，并把它做好”.
James Lewis 和 Martin Fowler 撰写的一篇开创性文章提供了一个更详细的定义, 他们将微服务定义为一种架构风格(architectural style)

“an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API”"><meta name=author content="Starslayerx"><link rel=canonical href=https://starslayerx.github.io/posts/microservice-with-fastapi/><link crossorigin=anonymous href=/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://starslayerx.github.io/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://starslayerx.github.io/favicon.svg><link rel=apple-touch-icon href=https://starslayerx.github.io/favicon.svg><link rel=mask-icon href=https://starslayerx.github.io/favicon.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://starslayerx.github.io/posts/microservice-with-fastapi/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://starslayerx.github.io/posts/microservice-with-fastapi/"><meta property="og:site_name" content="Starslayerx' Blog"><meta property="og:title" content="Microservice with FastAPI"><meta property="og:description" content="What are microservices ? 什么是微服务? 微服务可以有多种不同的定义方式, 具体取决于希望强调微服务架构的哪个方面, 不同作者会给出略有不同但相关的定义
Sam Newman, 微服务领域最有影响力的作者之一, 给出了一个极简的定义:
“Microservices are small, autonomous services that work together.”
这个定义强调了这样一个事实: 微服务是彼此独立运行的应用程序, 但它们可以协作完成任务. 该定义还强调微服务是 “small (小的)”, 这里的 small 并不是指微服务代码量的大小, 而是指微服务具有狭窄且定义清晰的职责范围, 符合单一职责原则(Single Responsibility Principle) —— 即“只做一件事，并把它做好”.
James Lewis 和 Martin Fowler 撰写的一篇开创性文章提供了一个更详细的定义, 他们将微服务定义为一种架构风格(architectural style)
“an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API”"><meta property="og:locale" content="en-US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-15T08:00:00+08:00"><meta property="article:modified_time" content="2025-08-15T08:00:00+08:00"><meta property="article:tag" content="Microservice"><meta property="article:tag" content="FastAPI"><meta property="og:image" content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://starslayerx.github.io/images/og-default.avif"><meta name=twitter:title content="Microservice with FastAPI"><meta name=twitter:description content="What are microservices ?
什么是微服务? 微服务可以有多种不同的定义方式, 具体取决于希望强调微服务架构的哪个方面, 不同作者会给出略有不同但相关的定义
Sam Newman, 微服务领域最有影响力的作者之一, 给出了一个极简的定义:

“Microservices are small, autonomous services that work together.”

这个定义强调了这样一个事实: 微服务是彼此独立运行的应用程序, 但它们可以协作完成任务. 该定义还强调微服务是 “small (小的)”, 这里的 small 并不是指微服务代码量的大小, 而是指微服务具有狭窄且定义清晰的职责范围, 符合单一职责原则(Single Responsibility Principle) —— 即“只做一件事，并把它做好”.
James Lewis 和 Martin Fowler 撰写的一篇开创性文章提供了一个更详细的定义, 他们将微服务定义为一种架构风格(architectural style)

“an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API”"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://starslayerx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Microservice with FastAPI","item":"https://starslayerx.github.io/posts/microservice-with-fastapi/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Microservice with FastAPI","name":"Microservice with FastAPI","description":"What are microservices ? 什么是微服务? 微服务可以有多种不同的定义方式, 具体取决于希望强调微服务架构的哪个方面, 不同作者会给出略有不同但相关的定义\nSam Newman, 微服务领域最有影响力的作者之一, 给出了一个极简的定义:\n“Microservices are small, autonomous services that work together.”\n这个定义强调了这样一个事实: 微服务是彼此独立运行的应用程序, 但它们可以协作完成任务. 该定义还强调微服务是 “small (小的)”, 这里的 small 并不是指微服务代码量的大小, 而是指微服务具有狭窄且定义清晰的职责范围, 符合单一职责原则(Single Responsibility Principle) —— 即“只做一件事，并把它做好”.\nJames Lewis 和 Martin Fowler 撰写的一篇开创性文章提供了一个更详细的定义, 他们将微服务定义为一种架构风格(architectural style)\n“an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API”\n","keywords":["Microservice","FastAPI"],"articleBody":"What are microservices ? 什么是微服务? 微服务可以有多种不同的定义方式, 具体取决于希望强调微服务架构的哪个方面, 不同作者会给出略有不同但相关的定义\nSam Newman, 微服务领域最有影响力的作者之一, 给出了一个极简的定义:\n“Microservices are small, autonomous services that work together.”\n这个定义强调了这样一个事实: 微服务是彼此独立运行的应用程序, 但它们可以协作完成任务. 该定义还强调微服务是 “small (小的)”, 这里的 small 并不是指微服务代码量的大小, 而是指微服务具有狭窄且定义清晰的职责范围, 符合单一职责原则(Single Responsibility Principle) —— 即“只做一件事，并把它做好”.\nJames Lewis 和 Martin Fowler 撰写的一篇开创性文章提供了一个更详细的定义, 他们将微服务定义为一种架构风格(architectural style)\n“an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API”\n这个定义强调了服务的自主性(autonomy), 指出它们运行在各自独立的进程中. Lewis 和 Fowler 同样强调了微服务职责的狭窄性(narrow scope of responsibilities), 称其为“small”, 并明确指出微服务之间通过轻量协议(如HTTP)进行通信\n定义\n微服务是一种架构风格，其中系统的各个组件被设计为可独立部署的服务(independently deployable services). 微服务围绕明确的业务子领域(business subdomains)进行设计，并通过如 HTTP 等轻量协议(lightweight protocols)相互通信 从以上定义中我们可以看到, 微服务可以被定义为一种架构风格, 其中服务作为组件执行一组小而明确的相关功能. 这意味着微服务是围绕特定的业务子领域来设计和构建的, 例如处理支付、发送邮件或处理客户订单等.\n微服务作为独立的进程进行部署, 通常运行在独立的环境中, 并通过定义清晰的接口暴露其能力\nA basic API implementation 这里通过一个 CoffeeMesh 项目的 orders service (订单服务) api 介绍微服务\n首先给出 OpenAPI 格式的 API 定义文档 oas.yaml, 可以通过 Swagger UI 来查看该文档内容 (OAS 代表 OpenAPI specification/规范, 是一种标准的 REST API 文档)\n具体 API 如下\n/orders: 检索订单(GET) 和 创建订单(POST) /orders/{order_id}: 检索某个订单的细节(GET), 更新订单(PUT) 和 删除订单(DELETE) /orders/{order_id}/cancel: 删除某个订单 /orders/{order_id}/pay: 支付订单 除了 API endpoints, 还有 data models (在 OpenAPI 中被称为 schemas). Schemas 告诉客户端需要什么样的数据载荷(payload)以及什么是类型.\n例如,OrderItemSchema 指定了 product 和 size 是必填的, 而 quantity 属性是可选的, 当这个属性消失的时候, 默认值为 1\n# file: oas.yaml OrderItemSchema: type: object required: - product - size properties: product: type: string size: type: string enum: - small - medium - big quantity: type: integer default: 1 minimum: 1 请求处理流大概下面这样: HTTP request -\u003e Uvicorn -\u003e FastAPI(Starlette routing -\u003e data -\u003e api endpoints) -\u003e Pydantic\n下面是一个 orders API 的最小实现\nfrom datetime import datetime from uuid import UUID from starlette.responses import Response from starlette import status from orders.app import app order = { \"id\": \"ff0f1355-e821-4178-9567-550dec27a373\", \"status\": \"delivered\", \"created\": datetime.utcnow(), \"order\": [ { \"product\": \"cappuccino\", \"size\": \"medium\", \"quantity\": 1, } ] } @app.get(\"/orders\") def get_orders(): return {\"orders\": [orders]} @app.post(\"/orders\", status_code=status.HTTP_201_CREATED) def create_order(): return order @app.get(\"/orders/{order_id}\") def get_order(order_id: UUID): return order @app.get(\"/orders/{order_id}\") def update_order(order_id: UUID): return order @app.delete(\"/orders/{order_id}\", status_code=status.HTTP_204_NO_CONTENT) def delete_order(order: UUID): return Response(status_code=HTTPStatus.NO_CONTENT.value) @app.post(\"/orders/{order_id}/cancel\") def cancel_order(order_id: UUID): return order @app.post(\"/orders/{order_id}/pay\") def pay_order(order_id: UUID): return order 现在有了 API 的基本骨架, 后面将继续实现 incoming payload 和 outgoing response 的验证\nImplementing data validation models with pydantic 这里介绍 data validation 和 marshalling\n“Marshalling” 指的是将一个内存中的数据结构转换成一种适合存储或通过网络传输的格式. 在 Web API 的上下文中, Marshalling 特指将一个对象转换为一个数据结构(比如 JSON 或 XML). 以便将其序列化为所选的内容类型, 同时明确指定对象属性的映射关系\n点单系统包含了3个shcemas: CreateOrderSchema, GetOrderSchema 和 OrderItemSchema, 可以在oas.yaml查看\n下面使用 Pydantic 实现对应 schema, 可以在 schema.py找到\nfrom enum import Enum class Size(Enum): small = \"small\" medium = \"medium\" big = \"big\" class StatusEnum(Enum): created = \"created\" paid = \"paid\" progress = \"progress\" cancelled = \"cancelled\" dispatched = \"dispatched\" delivered = \"delivered\" 对于只能从特定值中选择的类型, 定义枚举类型 Size 和 StatusEnum\nclass OrderItemSchema(BaseModel): product: str size: Size quantity: conint(ge=1, strict=True) | None = 1 将 OrderItemSchema 的属性设置为 conint, 这将强制使用整数值, 并且规定数值要大于等于1, 以及默认值1\nclass CreateOrderSchema(BaseModel): order: conlist(OrderItemSchema, min_items=1) class GetOrderSchema(CreateOrderSchema): id: UUID created: datetime status: StatusEnum class GetOrdersSchema(BaseModel): orders: List[GetOrderSchema] 使用 pydantic 的 conlist 类型定义了 CreateOrderSchema 的 order 属性, 要求列表至少有一个元素\nValidating request payloads with pydantic 上面实现了模型定义, 现在通过将其声明为视图函数的一个参数来拦截请求负载, 并通过将其类型设置为相关的 Pydantic 模型进行验证\n代码可以在api.py里找到\nfrom uuid import UUID from starlette.response import Response from starlette import status from orders.app import app from orders.api.schemas import CreateOrderSchema # 导入数据模型 @app.post(\"/orders\", status_code=status.HTTP_201_CREATED) def create_order(order_details: CreateOrderSchema): return order @app.get(\"/orders/{order_id}\") def get_order(order_id: UUID): return order @app.put(\"/orders/{order_id}\") def update_order(order_id: UUID, order_details: CreateOrderSchema): return order 如果发送一个有问题的数据(例如移除 product 字段), FastAPI 将会生成一份错误消息.\n{ \"detail\": [ { \"loc\": [ \"body\", \"order\", 0, \"product\" ], \"msg\": \"field required\", \"type\": \"value_error.missing\" } ] } 该错误消息使用 JSON Pointer 来指示问题所在, JSON Pointer 是一种语法, 用来表示 JSON 文档中特定值的路径\n例如, loc: /body/order/0/product 大概等同于 Pytohn 中的以下表示法 loc['body']['order'][0]['product']\nbody 指的是请求的主体部分 order 指的是主体中的 order 键 0 指的是 order 列表中的第一个元素 product 指的是这个元素中的 product 键 有时候参数可能是可选的, 但是并不能为 null. 这里使用 Pydantic 的 validator() 装饰器来添加额外的规则\nfrom pydantic import BaseModel, conint, validator ... class OrderItemSchema(BaseModel): product: int size: Size quantity: conint(ge=1, strict=True) | None = 1 @validator('quantity') def quantity_non_nullable(): assert value is not None, \"quantity may not be None\" return value Marshalling and validating response payloads with pydantic 这里定义一下返回类型 api.py\nfrom starlette.responses import Response from starlette import status from orders.api.schemas import ( GetOrderSchema, CreateOrderSchema, GetOrdersSchema, ) @app.get(\"/orders\", response_model=GetOrdersSchema) def get_orders(): return [ order ] @app.post( \"/orders\", status_code=status.HTTP_201_CREATED, response_model=GetOrderSchema ) def create_order(order_details: CreateOrderSchema): return order 现在, 如果 response payload 中缺少了返回类型需要的属性, FastAPI 则会报错, 如果有多的属性, 则会被去除\nAdding an in-memory list of orders to the API 现在通过一个简单的内存列表来管理订单状态\nimport time import uuid from datetime import datetime from uuid import UUID from fastapi import HTTPException from starlette.responses import Response from starlette import status from orders.app import app from orders.api.schemas import GetOrderSchema, CreateOrderSchema ORDERS = [] # in memory list # 获取订单列表 @app.get(\"/orders\", respones_model=GetOrderSchema) def get_orders(): return ORDERS # return order list # 创建订单 @app.post( \"/orders\", status_code=status.HTTP_201_CREATED, response_model=GetOrderSchema, ) def create_order(order_details: CreateOrderSchema): # convert Pydantic model -\u003e dict: v1 use .dict(); v2 use .model_dump() order = order_details.model_dump() order[\"id\"] = uuid.uuid4() # 获取订单 @app.get(\"/orders/{order_id}\", response_model=GetOrderSchema) def get_order(order_id: UUID): for order in ORDERS: if order[\"id\"] == order_id: return order raise HTTPException( status_code=404, detail=f\"Order with ID {order_id} not found\", ) # 更新订单 @app.put(\"/orders/{order_id}\", response_model=GetOrderSchema) def update_order(order_id: UUID, order_details: CreateOrderSchema): for order in ORDERS: if order[\"id\"] == order_id: order.update(order_details.model_dump()) return order raise HTTPException( status_code=404, detail=f\"Order with ID {order_id} not found\", ) # 删除订单 @app.delete( \"/orders/{order_id}\", status_code=status.HTTP_204_NO_CONTENT, response_class=Response ) def delete_order(order_id: UUID): for index, order in enumerate(ORDERS): if order[\"id\"] == order_id: ORDERS.pop(index) return Response(status_code=HTTPStatus.NO_CONTENT.value) raise HTTPException( status_code=404, detail=f\"Order with ID {order_id} not found\", ) # 取消订单 @app.post(\"/orders/{order_id}/cancel\", response_model=GetOrderSchema) def cancel_order(order_id: UUID): for order in ORDERS: if order[\"id\"] == order_id: order[\"status\"] = \"cancelled\" return order raise HTTPException( status_code=404, detail=f\"Order with ID {order_id} not found\", ) # 支付订单 @app.get(\"/orders/{order_id}/pay\", response_model=GetOrderSchema) def pay_order(order_id: UUID): for order in ORDERS: if order[\"id\"] == order_id: order[\"status\"] = \"progress\" return order raise HTTPException( status_code=404, detail=f\"Order with ID {order_id} not found\"\u003c\u003e ) Microservice Principles 微服务设计原则: 如何将系统拆分为微服务 service decomposition, 以及如何估计其质量 下面是三个设计原则:\nDatabase-per-service principle 服务独立数据库原则 Loose coupling principle 松耦合原则 Single Responsibility Principle (SRP) 单一职责原则 遵循这些原则将帮助你避免构建一个\"分布式单体应用\"(distributed monolith)的风险\nData-per-service principle 服务独立数据库原则是指, 每个微服务拥有一系列具体的数据, 并且其他微服务只能通过 API 访问.\n这并不意味着每个微服务都要连接到不同的数据库中, 可以是关系数据库中的不同 tables, 或者非关系数据库中的 collections, 关键是数据被某个服务拥有, 不能被其他服务直接访问.\n例如, 为了计算价格, orders service 从 Production database 中获取每个物品的价格, 它也需要知道用户是否有折扣优惠, 这个需要从 User database 获取. 然而, 不能直接诶访问这两个数据库, order service 需要从 products service 和 users service 获取数据.\nLoose coupling principle 松耦合原则要求在设计服务的时候, 必须清晰的关注分离点, 松耦合的服务不依赖另一个服务的实现细节, 这项原则有两个实际的应用:\n每个服务都可以独立于其他服务工作: 如果一个服务在不调用另一个服务的情况下无法完成一个简单的请求, 那么这两个服务之间没有清晰的关注点分离, 他们应被视为一个整体 每个服务都可以在不影响其他服务工作的情况下进行更新: 如果一个服务的更新需要其他服务, 那么这些服务之间存在紧密耦合, 需要重新设计 例如, 一个基于历史数据计算销售预测的服务(Sales Forecast Service), 以及一个拥有历史销售数据的服务(Historical Data Service), 为了计算预测, 销售服务会调用历史数据服务的API来获取历史数据. 在这种情况下, 销售预测服务在不调用历史数据服务的情况下无法响应任何请求, 因此两个服务之间存在紧密耦合.\n解决方案是重新设计这两个服务, 使它们不相互依赖, 或者将它们合并成一个单一的服务.\nSingle responsibility principle 单一职责原则(SRP)指出, 我们要设计职责少、理想情况下只有一个职责的组件. 当应用于微服务设计架构时, 这意味着我们应努力围绕单一的业务能力或子域来设计服务.\nDecomposing micorservices by business capabilities 下面将 CoffeeMesh 系统根据业务内容分成以下部分\n产品团队对应产品服务 原料团队对应原料服务 销售团队对应销售服务 金融团队对应金融服务 厨房团队对应厨房服务 配送团队对应配送服务 在上面的微服务架构中, 将不同的业务定义为一个微服务, 这样是为了方便, 但并不一定要这样实现\n如上的设计规则, 满足了 SRP 原则, 每个模块都处理自己的数据, 但是这种设计并不满足松耦合原则(loose couping principle), 产品服务需要确定每款产品的库存,由于库存数据在原料服务中, 这就需要依赖原料服务, 而为每个产品都设计一个面向原料服务的 API 显然不太合理.\n因此, 这两个服务应该耦合在一起, 最终的服务结构如下:\nProducts service: Products and Ingredients team Sales service: Sales team Kitchen service: Kitchen team Finance service: Finance team Delivery service: Delivery service Service decomposition by subdomains 通过子领域分解是一种从 领域驱动设计(domain-driven desgin, DDD) 中汲取灵感的方法. 领域驱动设计是一种软件开发方法, 它专注于使用业务用户相同的语言来对业务流程和流向进行建模, 当应用于微服务设计时, DDD 能够帮助定义每个服务的核心职责和边界\n对于 CoffeeMesh 项目, 我们希望根据下单的过程, 以及配送给客户的过程来建模, 将其分解为以下8步:\n当用户登陆网站后, 像用户展示产品列表. 每个产品都表示是否有库存. 用户可以根据是否有库存和价格来排序 用户选择产品后下单 用户为订单付费 一但用户付费, 就将订单细节传递给 kitchen 服务 kitchen 服务根据订单制作咖啡 用户可以查询订单进度 一但订单制作完成, 就安排配送 用户可以追踪无人机的配送进度, 直到配送到用户手中 根据上面步骤, 将模块划分为以下几个子领域 (subdomains)\nProduction Subdomain 产品子领域\n第一个服务用于 CoffeeMesh 产品目录的子域, 这个子域告诉用户哪些产品可用, 哪些不可用. 为此, 产品子域会追踪每种产品和原料的库存\nOrders Subdomain 订单子域\n第二步代表一个允许用户选择产品的子域, 这个子域用于管理订单的声明周期. 该子域拥有用户订单的数据, 并提供一个接口来管理订单和检查其状态. 订单领域还负责第四步的第二部分: 在成功处理付款后, 将订单传递给厨房. 同时也满足了第六步的要求: 允许用户检查其订单状态. 作为订单管理者, 订单子域还会与配送子域协作来安排配送.\nPayments Subdomain 支付子域\n第三步代表一个处理用户支付的子域. 该子域包括用户支付处理的专门逻辑, 包括银行卡验证, 与第三方支付提供商集成, 处理不同支付方式等. 支付子领域拥有与用户支付相关的数据.\nKitchen Subdomain 厨房子域\n第五步代表一个与厨房协作来管理客户订单生产的子域. 厨房的生产系统是全自动的, 厨房子域与厨房系统进行接口交互, 以安排客户订单的生产并追踪其进度.一旦订单生产完成, 厨房子域会通知订单子域, 后者随后安排配送. 厨房子域拥有与客户订单生产相关的数据, 并公开一个接口, 允许我们向厨房发送订单并跟踪其进度. 订单子域通过与厨房子域的接口交互, 来更新订单状态, 以满足第六步的需求.\nDelivery Subdomain 配送子域\n第七步代表一个与自动化配送系统进行接口交互的子域. 该子域包含专门的逻辑, 用于解析客户的地理位置并计算到达他们的最佳路线. 它管理着配送无人机机队并优化配送, 同时拥有与所有配送相关的数据. 订单子域通过与配送子域的接口交互, 来更新客户订单的行程, 以满足第八步的需求.\n通过以上分析, 将 CoffeeMesh 分解为5个子领域, 这些子领域可以被映射为微服务, 每个子领域都封装了定义明确, 职责清晰且拥有自己的逻辑区域. 领域驱动设计的微服务也满足了之前的微服务设计原则: 所有这些子域都可以在不依赖其他微服务的情况下执行其核心任务, 因此是松耦合的; 每个服务都拥有自己的数据, 因此符合服务独立数据库原则; 最后, 每个服务都在一个定义狭窄的子域内执行任务, 这符合单一职责原则.\nWrapping Up 上面介绍了微服务的概念, 并通过一个 CoffeeMesh 的项目解释了如何将其分解(decompose)为微服务架构, 分别通过业务分解和通过子领域分解, 以及设计微服务的3条原则:\nDatabase-per-service principle 数据库独享原则 Loose coupling principle 松耦合原则 Single responsibility principle 单一责任原则 ","wordCount":"1167","inLanguage":"en","image":"https://starslayerx.github.io/images/og-default.avif","datePublished":"2025-08-15T08:00:00+08:00","dateModified":"2025-08-15T08:00:00+08:00","author":{"@type":"Person","name":"Starslayerx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://starslayerx.github.io/posts/microservice-with-fastapi/"},"publisher":{"@type":"Organization","name":"Starslayerx' Blog","logo":{"@type":"ImageObject","url":"https://starslayerx.github.io/favicon.svg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://starslayerx.github.io/ accesskey=h title="Starslayerx' Blog (Alt + H)"><img src=https://starslayerx.github.io/favicon.svg alt aria-label=logo height=35>Starslayerx' Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://starslayerx.github.io/zh-cn/ title=简体中文 aria-label=简体中文>Zh-Cn</a></li></ul></div></div><ul id=menu><li><a href=https://starslayerx.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://starslayerx.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://starslayerx.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://starslayerx.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://starslayerx.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://starslayerx.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://starslayerx.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Microservice with FastAPI</h1><div class=post-meta><span title='2025-08-15 08:00:00 +0800 +0800'>August 15, 2025</span>&nbsp;·&nbsp;<span>6 min</span>&nbsp;·&nbsp;<span>1167 words</span>&nbsp;·&nbsp;<span>Starslayerx</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#what-are-microservices->What are microservices ?</a></li><li><a href=#a-basic-api-implementation>A basic API implementation</a><ul><li><a href=#implementing-data-validation-models-with-pydantic>Implementing data validation models with pydantic</a></li><li><a href=#validating-request-payloads-with-pydantic>Validating request payloads with pydantic</a></li><li><a href=#marshalling-and-validating-response-payloads-with-pydantic>Marshalling and validating response payloads with pydantic</a></li><li><a href=#adding-an-in-memory-list-of-orders-to-the-api>Adding an in-memory list of orders to the API</a></li><li><a href=#microservice-principles>Microservice Principles</a><ul><li><a href=#data-per-service-principle>Data-per-service principle</a></li><li><a href=#loose-coupling-principle>Loose coupling principle</a></li><li><a href=#single-responsibility-principle>Single responsibility principle</a></li></ul></li><li><a href=#decomposing-micorservices-by-business-capabilities>Decomposing micorservices by business capabilities</a><ul><li><a href=#service-decomposition-by-subdomains>Service decomposition by subdomains</a></li></ul></li><li><a href=#wrapping-up>Wrapping Up</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=what-are-microservices->What are microservices ?<a hidden class=anchor aria-hidden=true href=#what-are-microservices->#</a></h2><p>什么是微服务? 微服务可以有多种不同的定义方式, 具体取决于希望强调微服务架构的哪个方面, 不同作者会给出略有不同但相关的定义</p><p>Sam Newman, 微服务领域最有影响力的作者之一, 给出了一个极简的定义:</p><blockquote><p>“Microservices are small, autonomous services that work together.”</p></blockquote><p>这个定义强调了这样一个事实: 微服务是彼此独立运行的应用程序, 但它们可以协作完成任务. 该定义还强调微服务是 “small (小的)”, 这里的 small 并不是指微服务代码量的大小, 而是指微服务具有狭窄且定义清晰的职责范围, 符合单一职责原则(<strong>Single Responsibility Principle</strong>) —— 即“只做一件事，并把它做好”.</p><p>James Lewis 和 Martin Fowler 撰写的一篇开创性文章提供了一个更详细的定义, 他们将微服务定义为一种架构风格(architectural style)</p><blockquote><p>“an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API”</p></blockquote><p>这个定义强调了服务的自主性(autonomy), 指出它们运行在各自独立的进程中. Lewis 和 Fowler 同样强调了微服务职责的狭窄性(narrow scope of responsibilities), 称其为“small”, 并明确指出微服务之间通过轻量协议(如HTTP)进行通信</p><ul><li><strong>定义</strong><br>微服务是一种架构风格，其中系统的各个组件被设计为可独立部署的服务(independently deployable services). 微服务围绕明确的业务子领域(business subdomains)进行设计，并通过如 HTTP 等轻量协议(lightweight protocols)相互通信</li></ul><p>从以上定义中我们可以看到, 微服务可以被定义为一种架构风格, 其中服务作为组件执行一组小而明确的相关功能. 这意味着微服务是围绕特定的业务子领域来设计和构建的, 例如处理支付、发送邮件或处理客户订单等.</p><p>微服务作为独立的进程进行部署, 通常运行在独立的环境中, 并通过定义清晰的接口暴露其能力</p><h2 id=a-basic-api-implementation>A basic API implementation<a hidden class=anchor aria-hidden=true href=#a-basic-api-implementation>#</a></h2><p>这里通过一个 CoffeeMesh 项目的 orders service (订单服务) api 介绍微服务</p><p>首先给出 OpenAPI 格式的 API 定义文档 <a href=https://github.com/abunuwas/microservice-apis/blob/master/ch02/oas.yaml>oas.yaml</a>, 可以通过 <a href=https://editor.swagger.io/>Swagger UI</a> 来查看该文档内容 (OAS 代表 OpenAPI specification/规范, 是一种标准的 REST API 文档)</p><p>具体 API 如下</p><ul><li><code>/orders</code>: 检索订单(GET) 和 创建订单(POST)</li><li><code>/orders/{order_id}</code>: 检索某个订单的细节(GET), 更新订单(PUT) 和 删除订单(DELETE)</li><li><code>/orders/{order_id}/cancel</code>: 删除某个订单</li><li><code>/orders/{order_id}/pay</code>: 支付订单</li></ul><p>除了 API endpoints, 还有 data models (在 OpenAPI 中被称为 <em>schemas</em>). Schemas 告诉客户端需要什么样的数据载荷(payload)以及什么是类型.</p><p>例如,<strong>OrderItemSchema</strong> 指定了 <strong>product</strong> 和 <strong>size</strong> 是必填的, 而 <strong>quantity</strong> 属性是可选的, 当这个属性消失的时候, 默认值为 1</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># file: oas.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>OrderItemSchema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>required</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>product</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>small</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>medium</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>big</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>quantity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>integer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>minimum</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span></code></pre></div><p>请求处理流大概下面这样:
HTTP request -> Uvicorn -> FastAPI(Starlette routing -> data -> api endpoints) -> Pydantic</p><p>下面是一个 orders API 的最小实现</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>uuid</span> <span class=kn>import</span> <span class=n>UUID</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.responses</span> <span class=kn>import</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette</span> <span class=kn>import</span> <span class=n>status</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>orders.app</span> <span class=kn>import</span> <span class=n>app</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>order</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;ff0f1355-e821-4178-9567-550dec27a373&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;delivered&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;created&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;order&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;product&#34;</span><span class=p>:</span> <span class=s2>&#34;cappuccino&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;size&#34;</span><span class=p>:</span> <span class=s2>&#34;medium&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;quantity&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_orders</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;orders&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>orders</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>,</span> <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_201_CREATED</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.delete</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_204_NO_CONTENT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete_order</span><span class=p>(</span><span class=n>order</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=n>HTTPStatus</span><span class=o>.</span><span class=n>NO_CONTENT</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>/cancel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cancel_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>/pay&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pay_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span></code></pre></div><p>现在有了 API 的基本骨架, 后面将继续实现 incoming payload 和 outgoing response 的验证</p><h3 id=implementing-data-validation-models-with-pydantic>Implementing data validation models with pydantic<a hidden class=anchor aria-hidden=true href=#implementing-data-validation-models-with-pydantic>#</a></h3><p>这里介绍 data validation 和 marshalling</p><blockquote><p>&ldquo;Marshalling&rdquo; 指的是将一个内存中的数据结构转换成一种适合存储或通过网络传输的格式.
在 Web API 的上下文中, Marshalling 特指将一个对象转换为一个数据结构(比如 JSON 或 XML).
以便将其序列化为所选的内容类型, 同时明确指定对象属性的映射关系</p></blockquote><p>点单系统包含了3个shcemas: <code>CreateOrderSchema</code>, <code>GetOrderSchema</code> 和 <code>OrderItemSchema</code>, 可以在<a href=https://github.com/abunuwas/microservice-apis/blob/master/ch02/oas.yaml#L211>oas.yaml</a>查看</p><p>下面使用 Pydantic 实现对应 schema, 可以在 <a href=https://github.com/abunuwas/microservice-apis/blob/master/ch02/orders/api/schemas.py>schema.py</a>找到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Size</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>small</span> <span class=o>=</span> <span class=s2>&#34;small&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>medium</span> <span class=o>=</span> <span class=s2>&#34;medium&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>big</span> <span class=o>=</span> <span class=s2>&#34;big&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StatusEnum</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>created</span> <span class=o>=</span> <span class=s2>&#34;created&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>paid</span> <span class=o>=</span> <span class=s2>&#34;paid&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>progress</span> <span class=o>=</span> <span class=s2>&#34;progress&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cancelled</span> <span class=o>=</span> <span class=s2>&#34;cancelled&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>dispatched</span> <span class=o>=</span> <span class=s2>&#34;dispatched&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>delivered</span> <span class=o>=</span> <span class=s2>&#34;delivered&#34;</span>
</span></span></code></pre></div><p>对于只能从特定值中选择的类型, 定义枚举类型 <code>Size</code> 和 <code>StatusEnum</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderItemSchema</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>product</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>:</span> <span class=n>Size</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span><span class=p>:</span> <span class=n>conint</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>strict</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=mi>1</span>
</span></span></code></pre></div><p>将 <code>OrderItemSchema</code> 的属性设置为 <code>conint</code>, 这将强制使用整数值, 并且规定数值要大于等于1, 以及默认值1</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateOrderSchema</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=p>:</span> <span class=n>conlist</span><span class=p>(</span><span class=n>OrderItemSchema</span><span class=p>,</span> <span class=n>min_items</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetOrderSchema</span><span class=p>(</span><span class=n>CreateOrderSchema</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=n>UUID</span>
</span></span><span class=line><span class=cl>    <span class=n>created</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=n>StatusEnum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetOrdersSchema</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>orders</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>GetOrderSchema</span><span class=p>]</span>
</span></span></code></pre></div><p>使用 pydantic 的 <code>conlist</code> 类型定义了 <code>CreateOrderSchema</code> 的 <code>order</code> 属性, 要求列表至少有一个元素</p><h3 id=validating-request-payloads-with-pydantic>Validating request payloads with pydantic<a hidden class=anchor aria-hidden=true href=#validating-request-payloads-with-pydantic>#</a></h3><p>上面实现了模型定义, 现在通过将其声明为视图函数的一个参数来拦截请求负载, 并通过将其类型设置为相关的 Pydantic 模型进行验证</p><p>代码可以在<a href=https://github.com/abunuwas/microservice-apis/blob/master/ch02/orders/api/api.py>api.py</a>里找到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>uuid</span> <span class=kn>import</span> <span class=n>UUID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.response</span> <span class=kn>import</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette</span> <span class=kn>import</span> <span class=n>status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>orders.app</span> <span class=kn>import</span> <span class=n>app</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>orders.api.schemas</span> <span class=kn>import</span> <span class=n>CreateOrderSchema</span> <span class=c1># 导入数据模型</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>,</span> <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_201_CREATED</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>order_details</span><span class=p>:</span> <span class=n>CreateOrderSchema</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.put</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>,</span> <span class=n>order_details</span><span class=p>:</span> <span class=n>CreateOrderSchema</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span></code></pre></div><p>如果发送一个有问题的数据(例如移除 product 字段), FastAPI 将会生成一份错误消息.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-JSON data-lang=JSON><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;detail&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;loc&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;body&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;order&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;product&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;msg&#34;</span><span class=p>:</span> <span class=s2>&#34;field required&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;value_error.missing&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>该错误消息使用 JSON Pointer 来指示问题所在, JSON Pointer 是一种语法, 用来表示 JSON 文档中特定值的路径</p><p>例如, <code>loc: /body/order/0/product</code> 大概等同于 Pytohn 中的以下表示法 <code>loc['body']['order'][0]['product']</code></p><ul><li>body 指的是请求的主体部分</li><li>order 指的是主体中的 order 键</li><li>0 指的是 order 列表中的第一个元素</li><li>product 指的是这个元素中的 product 键</li></ul><p>有时候参数可能是可选的, 但是并不能为 null. 这里使用 Pydantic 的 <code>validator()</code> 装饰器来添加额外的规则</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>conint</span><span class=p>,</span> <span class=n>validator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OrderItemSchema</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>product</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>:</span> <span class=n>Size</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span><span class=p>:</span> <span class=n>conint</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>strict</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@validator</span><span class=p>(</span><span class=s1>&#39;quantity&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>quantity_non_nullable</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>,</span> <span class=s2>&#34;quantity may not be None&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>value</span>
</span></span></code></pre></div><h3 id=marshalling-and-validating-response-payloads-with-pydantic>Marshalling and validating response payloads with pydantic<a hidden class=anchor aria-hidden=true href=#marshalling-and-validating-response-payloads-with-pydantic>#</a></h3><p>这里定义一下返回类型 <a href=https://github.com/abunuwas/microservice-apis/blob/master/ch02/orders/api/api.py>api.py</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.responses</span> <span class=kn>import</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette</span> <span class=kn>import</span> <span class=n>status</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>orders.api.schemas</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>GetOrderSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>CreateOrderSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>GetOrdersSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrdersSchema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_orders</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/orders&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_201_CREATED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrderSchema</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>order_details</span><span class=p>:</span> <span class=n>CreateOrderSchema</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>order</span>
</span></span></code></pre></div><p>现在, 如果 response payload 中缺少了返回类型需要的属性, FastAPI 则会报错, 如果有多的属性, 则会被去除</p><h3 id=adding-an-in-memory-list-of-orders-to-the-api>Adding an in-memory list of orders to the API<a hidden class=anchor aria-hidden=true href=#adding-an-in-memory-list-of-orders-to-the-api>#</a></h3><p>现在通过一个简单的内存列表来管理订单状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>uuid</span> <span class=kn>import</span> <span class=n>UUID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.responses</span> <span class=kn>import</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette</span> <span class=kn>import</span> <span class=n>status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>orders.app</span> <span class=kn>import</span> <span class=n>app</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>orders.api.schemas</span> <span class=kn>import</span> <span class=n>GetOrderSchema</span><span class=p>,</span> <span class=n>CreateOrderSchema</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ORDERS</span> <span class=o>=</span> <span class=p>[]</span> <span class=c1># in memory list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取订单列表</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders&#34;</span><span class=p>,</span> <span class=n>respones_model</span><span class=o>=</span><span class=n>GetOrderSchema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_orders</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ORDERS</span> <span class=c1># return order list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建订单</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/orders&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_201_CREATED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrderSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_order</span><span class=p>(</span><span class=n>order_details</span><span class=p>:</span> <span class=n>CreateOrderSchema</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># convert Pydantic model -&gt; dict: v1 use .dict(); v2 use .model_dump()</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span> <span class=o>=</span> <span class=n>order_details</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取订单</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrderSchema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>ORDERS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Order with ID </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更新订单</span>
</span></span><span class=line><span class=cl><span class=nd>@app.put</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrderSchema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>,</span> <span class=n>order_details</span><span class=p>:</span> <span class=n>CreateOrderSchema</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>ORDERS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>order_details</span><span class=o>.</span><span class=n>model_dump</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Order with ID </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除订单</span>
</span></span><span class=line><span class=cl><span class=nd>@app.delete</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_204_NO_CONTENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_class</span><span class=o>=</span><span class=n>Response</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>order</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ORDERS</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ORDERS</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>Response</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=n>HTTPStatus</span><span class=o>.</span><span class=n>NO_CONTENT</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Order with ID </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 取消订单</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>/cancel&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrderSchema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cancel_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>ORDERS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;cancelled&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Order with ID </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 支付订单</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/</span><span class=si>{order_id}</span><span class=s2>/pay&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>GetOrderSchema</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pay_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=n>UUID</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>order</span> <span class=ow>in</span> <span class=n>ORDERS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>order</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>order_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>order</span><span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;progress&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>order</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=mi>404</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Order with ID </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> not found&#34;</span><span class=o>&lt;&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><h3 id=microservice-principles>Microservice Principles<a hidden class=anchor aria-hidden=true href=#microservice-principles>#</a></h3><p>微服务设计原则: 如何将系统拆分为微服务 <em>service decomposition</em>, 以及如何估计其质量
下面是三个设计原则:</p><ul><li>Database-per-service principle 服务独立数据库原则</li><li>Loose coupling principle 松耦合原则</li><li>Single Responsibility Principle (SRP) 单一职责原则</li></ul><p>遵循这些原则将帮助你避免构建一个"分布式单体应用"(distributed monolith)的风险</p><h4 id=data-per-service-principle>Data-per-service principle<a hidden class=anchor aria-hidden=true href=#data-per-service-principle>#</a></h4><p>服务独立数据库原则是指, 每个微服务拥有一系列具体的数据, 并且其他微服务只能通过 API 访问.</p><p>这并不意味着每个微服务都要连接到不同的数据库中, 可以是关系数据库中的不同 tables, 或者非关系数据库中的 collections, 关键是数据被某个服务拥有, 不能被其他服务直接访问.</p><p>例如, 为了计算价格, orders service 从 Production database 中获取每个物品的价格, 它也需要知道用户是否有折扣优惠, 这个需要从 User database 获取. 然而, 不能直接诶访问这两个数据库, order service 需要从 products service 和 users service 获取数据.</p><h4 id=loose-coupling-principle>Loose coupling principle<a hidden class=anchor aria-hidden=true href=#loose-coupling-principle>#</a></h4><p>松耦合原则要求在设计服务的时候, 必须清晰的关注分离点, 松耦合的服务不依赖另一个服务的实现细节, 这项原则有两个实际的应用:</p><ul><li>每个服务都可以独立于其他服务工作: 如果一个服务在不调用另一个服务的情况下无法完成一个简单的请求, 那么这两个服务之间没有清晰的关注点分离, 他们应被视为一个整体</li><li>每个服务都可以在不影响其他服务工作的情况下进行更新: 如果一个服务的更新需要其他服务, 那么这些服务之间存在紧密耦合, 需要重新设计</li></ul><p>例如, 一个基于历史数据计算销售预测的服务(Sales Forecast Service), 以及一个拥有历史销售数据的服务(Historical Data Service), 为了计算预测, 销售服务会调用历史数据服务的API来获取历史数据. 在这种情况下, 销售预测服务在不调用历史数据服务的情况下无法响应任何请求, 因此两个服务之间存在紧密耦合.</p><p>解决方案是重新设计这两个服务, 使它们不相互依赖, 或者将它们合并成一个单一的服务.</p><h4 id=single-responsibility-principle>Single responsibility principle<a hidden class=anchor aria-hidden=true href=#single-responsibility-principle>#</a></h4><p>单一职责原则(SRP)指出, 我们要设计职责少、理想情况下只有一个职责的组件.
当应用于微服务设计架构时, 这意味着我们应努力围绕单一的业务能力或子域来设计服务.</p><h3 id=decomposing-micorservices-by-business-capabilities>Decomposing micorservices by business capabilities<a hidden class=anchor aria-hidden=true href=#decomposing-micorservices-by-business-capabilities>#</a></h3><p>下面将 CoffeeMesh 系统根据业务内容分成以下部分</p><ul><li>产品团队对应产品服务</li><li>原料团队对应原料服务</li><li>销售团队对应销售服务</li><li>金融团队对应金融服务</li><li>厨房团队对应厨房服务</li><li>配送团队对应配送服务</li></ul><p>在上面的微服务架构中, 将不同的业务定义为一个微服务, 这样是为了方便, 但并不一定要这样实现</p><p>如上的设计规则, 满足了 SRP 原则, 每个模块都处理自己的数据, 但是这种设计并不满足松耦合原则(loose couping principle), 产品服务需要确定每款产品的库存,由于库存数据在原料服务中, 这就需要依赖原料服务, 而为每个产品都设计一个面向原料服务的 API 显然不太合理.</p><p>因此, 这两个服务应该耦合在一起, 最终的服务结构如下:</p><ul><li>Products service: Products and Ingredients team</li><li>Sales service: Sales team</li><li>Kitchen service: Kitchen team</li><li>Finance service: Finance team</li><li>Delivery service: Delivery service</li></ul><h4 id=service-decomposition-by-subdomains>Service decomposition by subdomains<a hidden class=anchor aria-hidden=true href=#service-decomposition-by-subdomains>#</a></h4><p>通过子领域分解是一种从 领域驱动设计(domain-driven desgin, DDD) 中汲取灵感的方法.
领域驱动设计是一种软件开发方法, 它专注于使用业务用户相同的语言来对业务流程和流向进行建模, 当应用于微服务设计时, DDD 能够帮助定义每个服务的核心职责和边界</p><p>对于 CoffeeMesh 项目, 我们希望根据下单的过程, 以及配送给客户的过程来建模, 将其分解为以下8步:</p><ol><li>当用户登陆网站后, 像用户展示产品列表. 每个产品都表示是否有库存. 用户可以根据是否有库存和价格来排序</li><li>用户选择产品后下单</li><li>用户为订单付费</li><li>一但用户付费, 就将订单细节传递给 kitchen 服务</li><li>kitchen 服务根据订单制作咖啡</li><li>用户可以查询订单进度</li><li>一但订单制作完成, 就安排配送</li><li>用户可以追踪无人机的配送进度, 直到配送到用户手中</li></ol><p>根据上面步骤, 将模块划分为以下几个子领域 (subdomains)</p><ul><li><p>Production Subdomain 产品子领域<br>第一个服务用于 CoffeeMesh 产品目录的子域, 这个子域告诉用户哪些产品可用, 哪些不可用. 为此, 产品子域会追踪每种产品和原料的库存</p></li><li><p>Orders Subdomain 订单子域<br>第二步代表一个允许用户选择产品的子域, 这个子域用于管理订单的声明周期. 该子域拥有用户订单的数据, 并提供一个接口来管理订单和检查其状态. 订单领域还负责第四步的第二部分: 在成功处理付款后, 将订单传递给厨房. 同时也满足了第六步的要求: 允许用户检查其订单状态. 作为订单管理者, 订单子域还会与配送子域协作来安排配送.</p></li><li><p>Payments Subdomain 支付子域<br>第三步代表一个处理用户支付的子域. 该子域包括用户支付处理的专门逻辑, 包括银行卡验证, 与第三方支付提供商集成, 处理不同支付方式等. 支付子领域拥有与用户支付相关的数据.</p></li><li><p>Kitchen Subdomain 厨房子域<br>第五步代表一个与厨房协作来管理客户订单生产的子域. 厨房的生产系统是全自动的, 厨房子域与厨房系统进行接口交互, 以安排客户订单的生产并追踪其进度.一旦订单生产完成, 厨房子域会通知订单子域, 后者随后安排配送. 厨房子域拥有与客户订单生产相关的数据, 并公开一个接口, 允许我们向厨房发送订单并跟踪其进度. 订单子域通过与厨房子域的接口交互, 来更新订单状态, 以满足第六步的需求.</p></li><li><p>Delivery Subdomain 配送子域<br>第七步代表一个与自动化配送系统进行接口交互的子域. 该子域包含专门的逻辑, 用于解析客户的地理位置并计算到达他们的最佳路线. 它管理着配送无人机机队并优化配送, 同时拥有与所有配送相关的数据. 订单子域通过与配送子域的接口交互, 来更新客户订单的行程, 以满足第八步的需求.</p></li></ul><p>通过以上分析, 将 CoffeeMesh 分解为5个子领域, 这些子领域可以被映射为微服务, 每个子领域都封装了定义明确, 职责清晰且拥有自己的逻辑区域. 领域驱动设计的微服务也满足了之前的微服务设计原则: 所有这些子域都可以在不依赖其他微服务的情况下执行其核心任务, 因此是松耦合的; 每个服务都拥有自己的数据, 因此符合服务独立数据库原则; 最后, 每个服务都在一个定义狭窄的子域内执行任务, 这符合单一职责原则.</p><h3 id=wrapping-up>Wrapping Up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h3><p>上面介绍了微服务的概念, 并通过一个 CoffeeMesh 的项目解释了如何将其分解(decompose)为微服务架构, 分别通过业务分解和通过子领域分解, 以及设计微服务的3条原则:</p><ul><li>Database-per-service principle 数据库独享原则</li><li>Loose coupling principle 松耦合原则</li><li>Single responsibility principle 单一责任原则</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://starslayerx.github.io/tags/microservice/>Microservice</a></li><li><a href=https://starslayerx.github.io/tags/fastapi/>FastAPI</a></li></ul><nav class=paginav><a class=prev href=https://starslayerx.github.io/posts/intorduce-uuid/><span class=title>« Prev</span><br><span>Intorduce UUID</span>
</a><a class=next href=https://starslayerx.github.io/posts/python-generics/><span class=title>Next »</span><br><span>Python Generics</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on x" href="https://x.com/intent/tweet/?text=Microservice%20with%20FastAPI&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f&amp;hashtags=Microservice%2cFastAPI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f&amp;title=Microservice%20with%20FastAPI&amp;summary=Microservice%20with%20FastAPI&amp;source=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f&title=Microservice%20with%20FastAPI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on whatsapp" href="https://api.whatsapp.com/send?text=Microservice%20with%20FastAPI%20-%20https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on telegram" href="https://telegram.me/share/url?text=Microservice%20with%20FastAPI&amp;url=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Microservice with FastAPI on ycombinator" href="https://news.ycombinator.com/submitlink?t=Microservice%20with%20FastAPI&u=https%3a%2f%2fstarslayerx.github.io%2fposts%2fmicroservice-with-fastapi%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://starslayerx.github.io/>Starslayerx' Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>